<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iterum R&D Chef Notebook</title>
    
    <!-- Immediate Auth Check - Redirect if not logged in -->
    <script>
        // Check for active session IMMEDIATELY
        (function() {
            const sessionActive = localStorage.getItem('session_active');
            const currentUser = localStorage.getItem('current_user');
            
            if (!sessionActive || !currentUser) {
                console.log('🔒 No active session - redirecting to launch page');
                window.location.href = 'launch.html';
            } else {
                console.log('✅ Session active - loading dashboard');
            }
        })();
    </script>
    
    <!-- Load Auth System -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-header.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="stylesheet" href="assets/css/dashboard-enhanced.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    <style>
        /* Landing Page Specific Styles */
        .landing-hero {
            background: linear-gradient(135deg, var(--iterum-primary), var(--iterum-secondary));
            color: white;
            padding: var(--spacing-16) var(--spacing-6);
            text-align: center;
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-8);
            position: relative;
            overflow: hidden;
        }
        
        .landing-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .landing-hero h1 {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-4);
            position: relative;
            z-index: 1;
        }
        
        .landing-hero p {
            font-size: var(--font-size-lg);
            opacity: 0.9;
            margin-bottom: var(--spacing-6);
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .hero-cta {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-full);
            text-decoration: none;
            font-weight: var(--font-weight-semibold);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }
        
                .hero-cta:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Project Status Display */
        .project-status-display {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-top: 0.5rem;
          font-size: 0.875rem;
        }
        
        .project-status-label {
          color: var(--gray-600);
          font-weight: 500;
        }
        
        .project-status-value {
          color: var(--iterum-primary);
          font-weight: 600;
          padding: 0.25rem 0.5rem;
          background: rgba(99, 102, 241, 0.1);
          border-radius: 0.375rem;
        }
        
        /* Modern Dashboard Welcome Header */
        .dashboard-welcome {
          background: linear-gradient(135deg, #4a7c2c 0%, #2d5a1a 100%);
          color: white;
          padding: 48px 40px;
          border-radius: 24px;
          margin-bottom: 32px;
          box-shadow: 0 20px 60px rgba(74, 124, 44, 0.3);
          position: relative;
          overflow: hidden;
        }
        
        .dashboard-welcome::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="2" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="2" fill="white" opacity="0.1"/></svg>');
          opacity: 0.3;
        }
        
        .welcome-content {
          position: relative;
          z-index: 1;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 24px;
        }
        
        .welcome-text {
          flex: 1;
          min-width: 300px;
        }
        
        .welcome-title {
          font-size: 2.25rem;
          font-weight: 900;
          margin-bottom: 12px;
          line-height: 1.2;
        }
        
        .welcome-greeting {
          opacity: 0.95;
        }
        
        .welcome-user-name {
          background: rgba(255,255,255,0.15);
          padding: 4px 16px;
          border-radius: 12px;
          backdrop-filter: blur(10px);
        }
        
        .welcome-subtitle {
          font-size: 1.125rem;
          opacity: 0.9;
        }
        
        .welcome-actions {
          display: flex;
          gap: 12px;
        }
        
        .btn-hero {
          padding: 14px 28px;
          border-radius: 12px;
          border: none;
          font-weight: 700;
          font-size: 15px;
          cursor: pointer;
          transition: all 0.2s ease;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }
        
        .btn-hero-primary {
          background: rgba(255,255,255,0.25);
          color: white;
          border: 2px solid rgba(255,255,255,0.3);
          backdrop-filter: blur(10px);
        }
        
        .btn-hero-primary:hover {
          background: rgba(255,255,255,0.35);
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn-hero-secondary {
          background: white;
          color: #4a7c2c;
        }
        
        .btn-hero-secondary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
          .welcome-content {
            flex-direction: column;
            align-items: flex-start;
          }
          
          .welcome-title {
            font-size: 1.75rem;
          }
          
          .welcome-actions {
            width: 100%;
          }
          
          .btn-hero {
            flex: 1;
          }
        }
        
        /* Enhanced Modal Animations */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes modalPulse {
          0%, 100% { 
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
          }
          50% { 
            transform: scale(1.02);
            box-shadow: 0 0 0 20px rgba(251, 191, 36, 0);
          }
        }
        
        @keyframes attentionBounce {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
        }
        
        .auth-modal-overlay {
          animation: fadeIn 0.5s ease-out;
        }
        
        .auth-modal-overlay > div {
          animation: modalPulse 3s infinite, attentionBounce 2s infinite;
        }
        
        .modal-attention {
          animation: modalPulse 2s infinite !important;
        }
        
        @keyframes flash {
          0%, 50% { opacity: 1; }
          25%, 75% { opacity: 0.5; }
        }
        
        .flash-warning {
          animation: flash 1s infinite;
        }
        
        /* Project Statistics Display */
        .project-stats-display {
          margin-top: 0.5rem;
        }
        
        .project-stats {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          font-size: 0.75rem;
        }
        
        .stat-item {
          padding: 0.25rem 0.5rem;
          background: rgba(156, 163, 175, 0.1);
          border-radius: 0.25rem;
          color: var(--gray-700);
          font-weight: 500;
        }
        
        .stat-item.total {
          background: rgba(99, 102, 241, 0.1);
          color: var(--iterum-primary);
          font-weight: 600;
        }
        
        /* Button Styles */
        .btn-secondary {
          background: var(--gray-100);
          color: var(--gray-700);
          border: 1px solid var(--gray-300);
        }
        
        .btn-secondary:hover {
          background: var(--gray-200);
          border-color: var(--gray-400);
        }
        
        /* Feature Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }
        
        .feature-card {
            background: white;
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            text-align: center;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--iterum-primary), var(--iterum-secondary));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }
        
        .feature-card:hover::before {
            transform: scaleX(1);
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }

        /* Recipe Ideas Notepad Styles */
        .ideas-notepad-section {
          margin: var(--spacing-8) 0;
        }

        .ideas-notepad-header {
          text-align: center;
          margin-bottom: var(--spacing-6);
        }

        .ideas-notepad-header h2 {
          margin-bottom: var(--spacing-2);
        }

        .ideas-notepad-grid {
          display: grid;
          grid-template-columns: 2fr 1fr;
          gap: var(--spacing-6);
          margin-bottom: var(--spacing-6);
        }

        .quick-idea-card,
        .recent-ideas-card {
          background: white;
          border-radius: var(--radius-xl);
          padding: var(--spacing-6);
          box-shadow: var(--shadow-lg);
          border: 1px solid var(--border-color);
        }

        .idea-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: var(--spacing-4);
          padding-bottom: var(--spacing-3);
          border-bottom: 1px solid var(--border-color);
        }

        .idea-counter {
          font-size: var(--font-size-sm);
          color: var(--gray-600);
          background: var(--gray-100);
          padding: 0.25rem 0.75rem;
          border-radius: var(--radius-full);
        }

        .idea-form {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-4);
        }

        .ideas-list {
          max-height: 300px;
          overflow-y: auto;
        }

        .idea-item {
          padding: var(--spacing-3);
          border: 1px solid var(--border-color);
          border-radius: var(--radius-lg);
          margin-bottom: var(--spacing-2);
          background: var(--gray-50);
          transition: all var(--transition-normal);
        }

        .idea-item:hover {
          background: var(--gray-100);
          transform: translateY(-1px);
        }

        .idea-item-title {
          font-weight: var(--font-weight-semibold);
          color: var(--gray-900);
          margin-bottom: var(--spacing-1);
        }

        .idea-item-description {
          font-size: var(--font-size-sm);
          color: var(--gray-600);
          margin-bottom: var(--spacing-2);
        }

        .idea-item-url {
          margin-bottom: var(--spacing-2);
        }

        .idea-item-url a {
          font-size: var(--font-size-sm);
          color: var(--blue-600);
          text-decoration: none;
          transition: color var(--transition-normal);
        }

        .idea-item-url a:hover {
          color: var(--blue-800);
          text-decoration: underline;
        }

        /* URL Input Group Styles */
        .url-input-group {
          display: flex;
          gap: var(--spacing-2);
          align-items: center;
        }

        .url-input-group .form-input {
          flex: 1;
        }

        .url-input-group .btn {
          white-space: nowrap;
          flex-shrink: 0;
        }

        .url-fetch-status {
          margin-top: var(--spacing-2);
          font-size: var(--font-size-sm);
          min-height: 1.5rem;
        }

        .url-fetch-status.loading {
          color: var(--blue-600);
        }

        .url-fetch-status.success {
          color: var(--green-600);
        }

        .url-fetch-status.error {
          color: var(--red-600);
        }

        .idea-item-meta {
          display: flex;
          gap: var(--spacing-2);
          font-size: var(--font-size-xs);
          color: var(--gray-500);
        }

        .idea-item-actions {
          display: flex;
          gap: var(--spacing-2);
          margin-top: var(--spacing-2);
        }

        .ideas-summary-card {
          background: white;
          border-radius: var(--radius-xl);
          padding: var(--spacing-6);
          box-shadow: var(--shadow-lg);
          border: 1px solid var(--border-color);
        }

        .ideas-summary-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: var(--spacing-4);
          padding-bottom: var(--spacing-3);
          border-bottom: 1px solid var(--border-color);
        }

        .ideas-search {
          display: flex;
          gap: var(--spacing-3);
          margin-bottom: var(--spacing-4);
        }

        .ideas-search input {
          flex: 1;
        }

        @media (max-width: 768px) {
          .ideas-notepad-grid {
            grid-template-columns: 1fr;
          }
        }
        
        .feature-card h3 {
            color: var(--iterum-primary);
            margin-bottom: var(--spacing-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }
        
        .feature-card p {
            color: var(--gray-600);
            line-height: var(--line-height-relaxed);
        }
        
        .feature-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--iterum-primary), var(--iterum-secondary));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-2xl);
            margin: 0 auto var(--spacing-4) auto;
            color: white;
        }
        
        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }
        
        .dashboard-card {
            background: white;
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            transition: all var(--transition-normal);
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-4);
        }
        
        .dashboard-card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--gray-800);
        }
        
        .dashboard-card-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--iterum-primary);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-8);
        }
        
        .stat-item {
            background: white;
            padding: var(--spacing-4);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--gray-200);
        }
        
        .stat-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--iterum-primary);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .landing-hero {
                padding: var(--spacing-12) var(--spacing-4);
            }
            
            .landing-hero h1 {
                font-size: var(--font-size-3xl);
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Professional loading indicator with auto-hide -->
    <div id="simple-loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); z-index: 9999; display: flex; align-items: center; justify-content: center;">
      <div style="text-align: center;">
        <div style="width: 60px; height: 60px; border: 5px solid #e5e7eb; border-top: 5px solid #4a7c2c; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px;"></div>
        <p style="color: #1f2937; font-weight: 700; font-size: 18px; letter-spacing: 0.5px;">Loading Iterum...</p>
        <p style="color: #64748b; font-size: 14px; margin-top: 8px;">Preparing your workspace</p>
      </div>
    </div>
    
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    
    <!-- EMERGENCY: Remove loading after 1 second no matter what -->
    <script>
      (function() {
        setTimeout(function() {
          var loading = document.getElementById('simple-loading');
          if (loading) {
            loading.remove();
            document.body.style.display = 'block';
            console.log('⚡ Emergency loading removal triggered');
          }
        }, 1000);
      })();
    </script>
    
    <!-- Authentication will be handled by popup modals instead of loading overlay -->
    <!-- The unified authentication system will show popup modals upon launch -->

    <!-- Reorganized Header for Better Screen Fit -->
    <header class="iterum-header">
      <div class="header-container">
        <!-- Logo Section - Compact -->
        <a href="index.html" class="header-logo">
          <div class="header-logo-icon">
            <span>🍃</span>
          </div>
          <div class="header-logo-text">
            <div class="header-logo-title">Iterum R&D</div>
            <div class="header-logo-subtitle">Chef Notebook</div>
          </div>
        </a>

        <!-- Center Navigation - Compact -->
        <nav class="header-navigation">
          <a href="index.html" class="header-nav-item active" data-page="index">
            <span class="nav-icon">🏠</span>
            <span class="nav-text">Dashboard</span>
          </a>
          <a href="recipe-library.html" class="header-nav-item" data-page="recipe-library">
            <span class="nav-icon">📚</span>
            <span class="nav-text">Library</span>
          </a>
          <a href="recipe-developer.html" class="header-nav-item" data-page="recipe-developer">
            <span class="nav-icon">🧪</span>
            <span class="nav-text">Developer</span>
          </a>
          <a href="recipe-upload.html" class="header-nav-item" data-page="recipe-upload">
            <span class="nav-icon">⚡</span>
            <span class="nav-text">Upload</span>
          </a>
          <a href="bulk-recipe-import.html" class="header-nav-item" data-page="bulk-import">
            <span class="nav-icon">🚀</span>
            <span class="nav-text">Bulk Import</span>
          </a>
          <a href="menu-builder.html" class="header-nav-item" data-page="menu-builder">
            <span class="nav-icon">🍽️</span>
            <span class="nav-text">Menus</span>
          </a>
          <a href="ingredients.html" class="header-nav-item" data-page="ingredients">
            <span class="nav-icon">🥬</span>
            <span class="nav-text">Ingredients</span>
          </a>
          <a href="equipment-management.html" class="header-nav-item" data-page="equipment-management">
            <span class="nav-icon">🔧</span>
            <span class="nav-text">Equipment</span>
          </a>
          <a href="vendor-management.html" class="header-nav-item" data-page="vendor-management">
            <span class="nav-icon">🏪</span>
            <span class="nav-text">Vendors</span>
          </a>
        </nav>

        <!-- Right Side - Compact User Section -->
        <div class="header-user-section">
          <!-- Modern Project Selector with Dropdown -->
          <div class="header-project-selector-container">
            <div class="project-selector-display" onclick="window.projectUIManager?.showProjectDropdown()" title="Click to switch projects or create new">
              <span class="project-selector-icon">📋</span>
              <span class="project-selector-name" data-project-name>Master Project</span>
              <svg class="project-selector-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>


          <!-- User Info Tab - Only visible after authentication -->
          <div class="header-user-tab" onclick="toggleUserDropdown()" id="header-user-tab" style="display: none;">
            <div class="header-user-avatar" id="user-avatar">
              <span id="user-avatar-initial">👤</span>
            </div>
            <div class="header-user-info">
              <div class="header-user-name" id="current-user">Guest User</div>
              <div class="header-user-role">Chef</div>
            </div>
            <svg class="header-user-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>

          <!-- User Dropdown Menu -->
          <div class="header-user-dropdown" id="user-dropdown">
            <div class="header-user-dropdown-header">
              <div class="header-user-dropdown-title" id="dropdown-user-name">Guest User</div>
              <div class="header-user-dropdown-subtitle" id="dropdown-user-role">Chef</div>
            </div>
            
            <div class="header-user-dropdown-menu">
              <div class="header-user-dropdown-item" onclick="showProfileEditModal(); toggleUserDropdown();">
                <span>👤</span>
                <span>Edit Profile</span>
              </div>
              <div class="header-user-dropdown-item" onclick="showForgotPasswordModal(); toggleUserDropdown();">
                <span>🔑</span>
                <span>Change Password</span>
              </div>
            </div>
            
            <div class="header-user-dropdown-divider"></div>
            
            <div class="header-user-dropdown-menu">
              <div class="header-user-dropdown-item" onclick="alert('Additional settings coming soon!')">
                <span>⚙️</span>
                <span>Settings</span>
              </div>
              <div class="header-user-dropdown-item danger" onclick="handleSignOut()">
                <span>🚪</span>
                <span>Sign Out</span>
              </div>
            </div>
            
            <div class="header-user-dropdown-footer">
              <div class="header-user-dropdown-footer-text">Iterum R&D v1.0</div>
            </div>
          </div>

          <!-- Mobile Navigation Toggle -->
          <button class="header-mobile-toggle" onclick="toggleMobileNav()">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <nav id="mobile-nav" class="header-mobile-nav">
        <!-- Project Selector for Mobile -->
        <div style="margin-bottom: 1rem;">
          <select id="mobile-project-selector" class="header-project-selector" style="width: 100%;">
            <option value="">Select Project...</option>
          </select>
          <div class="project-status-display" style="margin-top: 0.5rem; text-align: center;">
            <span class="project-status-label">Current:</span>
            <span class="project-status-value" data-project-name>Master Project</span>
          </div>
          <div class="project-stats-display" data-project-stats style="margin-top: 0.5rem; text-align: center;">
            <div class="project-stats">
              <span class="stat-item">🥕 0 Ingredients</span>
              <span class="stat-item">📖 0 Recipes</span>
              <span class="stat-item">🍽️ 0 Menus</span>
              <span class="stat-item total">📊 0 Total Items</span>
            </div>
          </div>
        </div>
        
        <!-- New Project Button for Mobile -->
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-primary w-full" onclick="window.projectUIManager?.showManageModal()">
            <span>📋</span>
            <span>Manage Projects</span>
          </button>
        </div>

        <!-- Authentication Button - Show if not authenticated -->
        <div style="margin-bottom: 1rem;">
          <button class="btn btn-secondary w-full" onclick="window.location.href='launch.html'" id="auth-button" style="display: none;">
            <span>🔐</span>
            <span>Sign In / Switch User</span>
          </button>
        </div>

        <!-- Authentication Status -->
        <div id="auth-status" style="margin-bottom: 1rem; padding: 10px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; text-align: center; font-size: 14px;">
          <span>⏳</span>
          <span>Initializing authentication...</span>
        </div>

        <!-- Debug button removed for production -->

        <!-- Mobile Navigation Items -->
        <a href="index.html" class="header-mobile-nav-item" data-page="index">
          <span class="nav-icon">🏠</span>
          <span>Dashboard</span>
        </a>
        <a href="recipe-library.html" class="header-mobile-nav-item" data-page="recipe-library">
          <span class="nav-icon">📚</span>
          <span>Library</span>
        </a>
        <a href="recipe-developer.html" class="header-mobile-nav-item" data-page="recipe-developer">
          <span class="nav-icon">🧪</span>
          <span>Developer</span>
        </a>
        <a href="recipe-upload.html" class="header-mobile-nav-item" data-page="recipe-upload">
          <span class="nav-icon">⚡</span>
          <span>Upload</span>
        </a>
        <a href="menu-builder.html" class="header-mobile-nav-item" data-page="menu-builder">
          <span class="nav-icon">🍽️</span>
          <span>Menu</span>
        </a>
        <a href="ingredients.html" class="header-mobile-nav-item" data-page="ingredients">
          <span class="nav-icon">🥬</span>
          <span>Ingredients</span>
        </a>
        <a href="equipment-management.html" class="header-mobile-nav-item" data-page="equipment-management">
          <span class="nav-icon">🔧</span>
          <span>Equipment</span>
        </a>
        <a href="vendor-management.html" class="header-mobile-nav-item" data-page="vendor-management">
          <span class="nav-icon">🏪</span>
          <span>Vendors</span>
        </a>
      </nav>
    </header>

    <!-- Main Content -->
    <main>
      <div class="container">
        <!-- Enhanced Hero -->
        <div class="dashboard-hero">
          <div class="hero-content">
            <div class="hero-greeting">
              <span id="greeting-text">Good morning</span>, <span id="welcome-user-name">Chef</span>!
            </div>
            <div class="hero-subtitle">Your culinary workspace is ready</div>
            <div class="hero-actions">
              <button onclick="window.location.href='bulk-recipe-import.html'" class="hero-btn hero-btn-primary">
                <span>🚀</span>
                <span>Bulk Import</span>
              </button>
              <button onclick="window.location.href='recipe-developer.html'" class="hero-btn hero-btn-secondary">
                <span>🧪</span>
                <span>New Recipe</span>
              </button>
              <button onclick="window.location.href='menu-builder.html'" class="hero-btn hero-btn-secondary">
                <span>🍽️</span>
                <span>Menu Builder</span>
              </button>
              <button onclick="window.location.href='project-hub.html'" class="hero-btn hero-btn-secondary">
                <span>📋</span>
                <span>Projects</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Enhanced Stats -->
        <section class="stats-section">
          <div class="stats-grid-enhanced">
            <div class="stat-card-enhanced blue" data-icon="📚">
              <div class="stat-icon-enhanced">📚</div>
              <div class="stat-value-enhanced" id="total-recipes">0</div>
              <div class="stat-label-enhanced">Recipes</div>
              <div class="stat-subtext">In your collection</div>
            </div>
            <div class="stat-card-enhanced green" data-icon="🥬">
              <div class="stat-icon-enhanced">🥬</div>
              <div class="stat-value-enhanced" id="total-ingredients">--</div>
              <div class="stat-label-enhanced">Ingredients</div>
              <div class="stat-subtext">In database</div>
            </div>
            <div class="stat-card-enhanced orange" data-icon="🍽️">
              <div class="stat-icon-enhanced">🍽️</div>
              <div class="stat-value-enhanced" id="total-menus">0</div>
              <div class="stat-label-enhanced">Menu Items</div>
              <div class="stat-subtext">Across all menus</div>
            </div>
            <div class="stat-card-enhanced purple" data-icon="📋">
              <div class="stat-icon-enhanced">📋</div>
              <div class="stat-value-enhanced" id="active-projects">0</div>
              <div class="stat-label-enhanced">Projects</div>
              <div class="stat-subtext">Active workspaces</div>
            </div>
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions-section">
          <div class="section-header-enhanced">
            <h2 class="section-title-enhanced">🚀 Quick Actions</h2>
          </div>
          <div class="quick-actions-grid-enhanced">
            <a href="recipe-developer.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🧪</div>
              <div class="action-title-enhanced">New Recipe</div>
              <div class="action-desc-enhanced">Create from scratch</div>
            </a>
            <a href="bulk-recipe-import.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🚀</div>
              <div class="action-title-enhanced">Bulk Import</div>
              <div class="action-desc-enhanced">Import 10+ at once</div>
            </a>
            <a href="recipe-photo-studio.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">📸</div>
              <div class="action-title-enhanced">Photo Studio</div>
              <div class="action-desc-enhanced">Add beautiful photos</div>
            </a>
            <a href="menu-builder.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🍽️</div>
              <div class="action-title-enhanced">Menu Builder</div>
              <div class="action-desc-enhanced">Design & cost menus</div>
            </a>
            <a href="ingredients.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🥬</div>
              <div class="action-title-enhanced">Ingredients</div>
              <div class="action-desc-enhanced">Manage database</div>
            </a>
            <a href="vendor-management.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🏪</div>
              <div class="action-title-enhanced">Vendors</div>
              <div class="action-desc-enhanced">Suppliers & pricing</div>
            </a>
            <a href="equipment-management.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">🔧</div>
              <div class="action-title-enhanced">Equipment</div>
              <div class="action-desc-enhanced">Track kitchen tools</div>
            </a>
            <a href="project-hub.html" class="action-card-enhanced">
              <div class="action-icon-enhanced">📋</div>
              <div class="action-title-enhanced">Project Hub</div>
              <div class="action-desc-enhanced">Manage projects</div>
            </a>
            <a href="data-backup-center.html" class="action-card-enhanced" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
              <div class="action-icon-enhanced">💾</div>
              <div class="action-title-enhanced">Backup Center</div>
              <div class="action-desc-enhanced">Protect your data</div>
            </a>
            <a href="inventory.html" class="action-card-enhanced" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
              <div class="action-icon-enhanced">📦</div>
              <div class="action-title-enhanced">Inventory</div>
              <div class="action-desc-enhanced">Track stock levels</div>
            </a>
            <a href="production-planning.html" class="action-card-enhanced" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
              <div class="action-icon-enhanced">📋</div>
              <div class="action-title-enhanced">Production</div>
              <div class="action-desc-enhanced">Plan & scale recipes</div>
            </a>
          </div>
        </section>
          
          <div class="ideas-notepad-grid">
            <!-- Quick Idea Capture -->
            <div class="quick-idea-card">
              <div class="idea-card-header">
                <h3 class="heading-3">Quick Idea Capture</h3>
                <span class="idea-counter">💭 <span id="idea-count">0</span> ideas captured</span>
              </div>
              
              <form id="quick-idea-form" class="idea-form">
                <div class="form-group">
                  <label for="idea-title" class="form-label">Recipe Idea Title</label>
                  <input type="text" id="idea-title" class="form-input" placeholder="e.g., Spicy Mango Salsa, Chocolate Lavender Cake..." required>
                </div>
                
                <div class="form-group">
                  <label for="idea-description" class="form-label">Description & Inspiration</label>
                  <textarea id="idea-description" class="form-textarea" placeholder="What inspired this idea? What flavors, textures, or techniques are you thinking about?" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="idea-cuisine" class="form-label">Cuisine Type</label>
                    <select id="idea-cuisine" class="form-select">
                      <option value="">Select Cuisine...</option>
                      <option value="italian">Italian</option>
                      <option value="mexican">Mexican</option>
                      <option value="asian">Asian</option>
                      <option value="mediterranean">Mediterranean</option>
                      <option value="american">American</option>
                      <option value="french">French</option>
                      <option value="indian">Indian</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="idea-difficulty" class="form-label">Difficulty Level</label>
                    <select id="idea-difficulty" class="form-select">
                      <option value="">Select Difficulty...</option>
                      <option value="easy">Easy</option>
                      <option value="medium">Medium</option>
                      <option value="hard">Hard</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="idea-ingredients" class="form-label">Key Ingredients (Optional)</label>
                  <textarea id="idea-ingredients" class="form-textarea" placeholder="List any key ingredients you have in mind..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                  <label for="idea-url" class="form-label">URL (Optional)</label>
                  <div class="url-input-group">
                    <input type="url" id="idea-url" class="form-input" placeholder="https://example.com/recipe-inspiration">
                    <button type="button" class="btn btn-info btn-sm" onclick="fetchRecipeFromURL()" title="Fetch recipe data from URL" id="fetch-recipe-btn">
                      🔗 Fetch Recipe
                    </button>
                  </div>
                  <div id="url-fetch-status" class="url-fetch-status"></div>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">💾 Save Idea</button>
                  <button type="button" class="btn btn-secondary" onclick="clearIdeaForm()">Clear Form</button>
                  <button type="button" class="btn btn-success" onclick="createRecipeFromIdea()">🧪 Create Recipe</button>
                </div>
              </form>
            </div>
            
            <!-- Recent Ideas -->
            <div class="recent-ideas-card">
              <div class="idea-card-header">
                <h3 class="heading-3">Recent Ideas</h3>
                <button class="btn btn-sm btn-secondary" onclick="viewAllIdeas()">View All</button>
              </div>
              
              <div id="recent-ideas-list" class="ideas-list">
                <p class="text-gray-500">No ideas captured yet</p>
              </div>
            </div>
          </div>
          
          <!-- Ideas Summary -->
          <div class="ideas-summary-card">
            <div class="ideas-summary-header">
              <h3 class="heading-3">Ideas Summary</h3>
              <div class="summary-stats">
                <span class="stat-item">💡 <span id="total-ideas">0</span> Total Ideas</span>
                <span class="stat-item">🧪 <span id="ideas-in-progress">0</span> In Progress</span>
                <span class="stat-item">✅ <span id="completed-recipes">0</span> Completed</span>
              </div>
            </div>
            
            <div class="ideas-search">
              <input type="text" id="ideas-search" class="form-input" placeholder="Search through your recipe ideas...">
              <button class="btn btn-secondary" onclick="searchIdeas()">🔍 Search</button>
            </div>
            
            <div id="ideas-search-results" class="search-results">
              <!-- Search results will appear here -->
            </div>
          </div>
        </section>

        <!-- Dashboard Cards -->
        <section class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">Recent Activity</div>
            </div>
            <div id="recent-activity">
              <p class="text-gray-500">No recent activity</p>
            </div>
          </div>
          
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">Quick Actions</div>
            </div>
            <div class="flex flex-col gap-3">
              <a href="recipe-upload.html" class="btn btn-primary">
                <span>⚡</span>
                <span>Upload New Recipe</span>
              </a>
              <a href="price-list-upload.html" class="btn btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <span>💰</span>
                <span>Upload Price List</span>
              </a>
              <a href="ingredients.html" class="btn btn-secondary">
                <span>🥬</span>
                <span>Add Ingredient</span>
              </a>
              <a href="menu-builder.html" class="btn btn-secondary">
                <span>🍽️</span>
                <span>Create Menu</span>
              </a>
            </div>
          </div>
          
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <div class="dashboard-card-title">Project Management</div>
            </div>
            <div class="flex flex-col gap-3">
              <button onclick="createNewProject()" class="btn btn-primary">➕ Create New Project</button>
              <button onclick="manageProjects()" class="btn btn-secondary">📋 Manage Projects</button>
              <div id="project-status" class="text-sm text-gray-600">
                <p>No active projects</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Daily Notes & Calendar Section -->
        <section class="notes-calendar-section">
          <div class="notes-calendar-header">
            <h2 class="heading-2">📅 Daily Notes & Calendar</h2>
            <div class="notes-actions">
              <button class="btn btn-primary" onclick="openCalendarView()">📅 Full Calendar</button>
              <button class="btn btn-secondary" onclick="exportNotes()">📤 Export Notes</button>
            </div>
          </div>
          
          <div class="notes-calendar-grid">
            <!-- Daily Notes Form -->
            <div class="daily-notes-card">
              <div class="notes-card-header">
                <h3 class="heading-3">Today's Notes</h3>
                <div class="date-selector">
                  <input type="date" id="notes-date" class="form-input" onchange="loadDailyNotes(this.value)">
                </div>
              </div>
              
              <form id="daily-notes-form" class="notes-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="kitchen-notes" class="form-label">Kitchen Notes</label>
                    <textarea id="kitchen-notes" class="form-textarea" placeholder="Kitchen observations, equipment issues, staff notes..."></textarea>
                  </div>
                  <div class="form-group">
                    <label for="service-notes" class="form-label">Service Notes</label>
                    <textarea id="service-notes" class="form-textarea" placeholder="Customer feedback, service improvements, special requests..."></textarea>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="recipe-notes" class="form-label">Recipe Development</label>
                    <textarea id="recipe-notes" class="form-textarea" placeholder="Recipe experiments, modifications, new ideas..."></textarea>
                  </div>
                  <div class="form-group">
                    <label for="ingredient-notes" class="form-label">Ingredient Notes</label>
                    <textarea id="ingredient-notes" class="form-textarea" placeholder="Ingredient quality, supplier notes, cost changes..."></textarea>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="menu-notes" class="form-label">Menu Planning</label>
                    <textarea id="menu-notes" class="form-textarea" placeholder="Menu changes, seasonal updates, pricing notes..."></textarea>
                  </div>
                  <div class="form-group">
                    <label for="general-notes" class="form-label">General Notes</label>
                    <textarea id="general-notes" class="form-textarea" placeholder="Any other observations or ideas..."></textarea>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">💾 Save Notes</button>
                  <button type="button" class="btn btn-secondary" onclick="clearNotesForm()">Clear Form</button>
                  <button type="button" class="btn btn-secondary" onclick="loadPreviousNotes()">📚 Previous Notes</button>
                </div>
              </form>
            </div>
            
            <!-- Quick Calendar View -->
            <div class="quick-calendar-card">
              <div class="notes-card-header">
                <h3 class="heading-3">Quick Calendar</h3>
                <div class="calendar-nav">
                  <button class="btn btn-sm btn-secondary" onclick="previousMonth()">‹</button>
                  <span id="current-month" class="month-display">December 2024</span>
                  <button class="btn btn-sm btn-secondary" onclick="nextMonth()">›</button>
                </div>
              </div>
              
              <div class="mini-calendar" id="mini-calendar">
                <!-- Calendar will be populated by JavaScript -->
              </div>
              
              <div class="calendar-events">
                <h4 class="heading-4">Today's Events</h4>
                <div id="today-events" class="events-list">
                  <p class="text-gray-500">No events scheduled</p>
                </div>
                <button class="btn btn-secondary" onclick="addQuickEvent()">➕ Add Event</button>
              </div>
            </div>
          </div>
          
          <!-- Notes Summary -->
          <div class="notes-summary-card">
            <div class="notes-card-header">
              <h3 class="heading-3">Notes Summary</h3>
              <div class="summary-stats">
                <span class="stat-item">📝 <span id="total-notes">0</span> Notes</span>
                <span class="stat-item">📅 <span id="notes-days">0</span> Days</span>
                <span class="stat-item">🔍 <span id="searchable-notes">0</span> Searchable</span>
              </div>
            </div>
            
            <div class="notes-search">
              <input type="text" id="notes-search" class="form-input" placeholder="Search through all notes...">
              <button class="btn btn-secondary" onclick="searchNotes()">🔍 Search</button>
            </div>
            
            <div id="notes-search-results" class="search-results">
              <!-- Search results will appear here -->
            </div>
          </div>
        </section>
      </div>
    </main>
    <script>
      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing Iterum App...');
        
        // Initialize the authentication system
        if (window.IterumApp) {
          window.IterumApp.init();
        }
        
        // Initialize header user synchronization
        if (window.HeaderUserSync) {
          window.HeaderUserSync.init();
        }
        
        // Initialize project management system
        if (window.projectManager) {
          window.projectManager.init();
        }
        
        // Check if user is already authenticated and show user toggle
        checkAndShowUserToggle();
        
        // Listen for project changes to reload recipe ideas
        document.addEventListener('projectChanged', function(event) {
          console.log('📋 Project changed, reloading recipe ideas...');
          if (event.detail && event.detail.project) {
            // Reload ideas for the new project
            loadRecipeIdeas();
            updateIdeasDisplay();
            updateIdeasStats();
          }
        });
        
        console.log('✅ Iterum App initialized');
      });
      
      // Check if user is authenticated and show user toggle
      function checkAndShowUserToggle() {
        const currentUser = localStorage.getItem('current_user');
        const sessionActive = localStorage.getItem('session_active');
        
        if (currentUser && sessionActive === 'true') {
          try {
            const user = JSON.parse(currentUser);
            showUserToggle(user);
          } catch (error) {
            console.error('❌ Error parsing user data:', error);
          }
        }
      }
      
      // Show user toggle after authentication
      function showUserToggle(user) {
        const userTab = document.getElementById('header-user-tab');
        const currentUserElement = document.getElementById('current-user');
        const dropdownUserName = document.getElementById('dropdown-user-name');
        const userAvatarInitial = document.getElementById('user-avatar-initial');
        
        if (userTab && currentUserElement && dropdownUserName && userAvatarInitial) {
          // Update user info
          currentUserElement.textContent = user.name;
          dropdownUserName.textContent = user.name;
          userAvatarInitial.textContent = user.name.charAt(0).toUpperCase();
          
          // Show user toggle
          userTab.style.display = 'flex';
          
          console.log('✅ User toggle displayed for:', user.name);
        }
      }
      
      // Listen for user authentication events
      document.addEventListener('userLoggedIn', function(event) {
        if (event.detail && event.detail.user) {
          showUserToggle(event.detail.user);
        }
      });
      
      
      // Listen for showUserToggle event from authentication system
      document.addEventListener('showUserToggle', function(event) {
        if (event.detail && event.detail.user) {
          showUserToggle(event.detail.user);
        }
      });

      // Mobile navigation toggle
      function toggleMobileNav() {
        const mobileNav = document.getElementById('mobile-nav');
        if (mobileNav) {
          mobileNav.classList.toggle('show');
        }
      }

      // Initialize notes and calendar functionality
      function initializeNotesAndCalendar() {
        // Set current date
        const today = new Date();
        document.getElementById('notes-date').value = today.toISOString().split('T')[0];
        
        // Initialize mini calendar
        initializeMiniCalendar();
        
        // Load today's notes
        loadDailyNotes(today.toISOString().split('T')[0]);
        
        // Set up form submission
        const notesForm = document.getElementById('daily-notes-form');
        if (notesForm) {
          notesForm.addEventListener('submit', handleNotesSubmit);
        }
        
        // Update stats
        updateNotesStats();
      }

      // Initialize mini calendar
      function initializeMiniCalendar() {
        const calendar = document.getElementById('mini-calendar');
        if (!calendar) return;
        
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        updateCalendarDisplay(currentMonth, currentYear);
        updateMonthDisplay(currentMonth, currentYear);
      }

      // Update calendar display
      function updateCalendarDisplay(month, year) {
        const calendar = document.getElementById('mini-calendar');
        if (!calendar) return;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        let calendarHTML = `
          <div class="calendar-weekdays">
            <div class="calendar-day weekday">Sun</div>
            <div class="calendar-day weekday">Mon</div>
            <div class="calendar-day weekday">Tue</div>
            <div class="calendar-day weekday">Wed</div>
            <div class="calendar-day weekday">Thu</div>
            <div class="calendar-day weekday">Fri</div>
            <div class="calendar-day weekday">Sat</div>
          </div>
          <div class="calendar-grid">
        `;
        
        for (let i = 0; i < 42; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          
          const isCurrentMonth = date.getMonth() === month;
          const isToday = date.toDateString() === new Date().toDateString();
          const hasNotes = checkIfDateHasNotes(date.toISOString().split('T')[0]);
          
          let dayClass = 'calendar-day';
          if (!isCurrentMonth) dayClass += ' other-month';
          if (isToday) dayClass += ' today';
          if (hasNotes) dayClass += ' has-notes';
          
          calendarHTML += `<div class="${dayClass}" onclick="selectCalendarDate('${date.toISOString().split('T')[0]}')">${date.getDate()}</div>`;
        }
        
        calendarHTML += '</div>';
        calendar.innerHTML = calendarHTML;
      }

      // Update month display
      function updateMonthDisplay(month, year) {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const monthDisplay = document.getElementById('current-month');
        if (monthDisplay) {
          monthDisplay.textContent = `${monthNames[month]} ${year}`;
        }
      }

      // Navigate to previous month
      function previousMonth() {
        const monthDisplay = document.getElementById('current-month');
        if (!monthDisplay) return;
        
        const currentText = monthDisplay.textContent;
        const [month, year] = currentText.split(' ');
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        let currentMonth = monthNames.indexOf(month);
        let currentYear = parseInt(year);
        
        if (currentMonth === 0) {
          currentMonth = 11;
          currentYear--;
        } else {
          currentMonth--;
        }
        
        updateCalendarDisplay(currentMonth, currentYear);
        updateMonthDisplay(currentMonth, currentYear);
      }

      // Navigate to next month
      function nextMonth() {
        const monthDisplay = document.getElementById('current-month');
        if (!monthDisplay) return;
        
        const currentText = monthDisplay.textContent;
        const [month, year] = currentText.split(' ');
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        let currentMonth = monthNames.indexOf(month);
        let currentYear = parseInt(year);
        
        if (currentMonth === 11) {
          currentMonth = 0;
          currentYear++;
        } else {
          currentMonth++;
        }
        
        updateCalendarDisplay(currentMonth, currentYear);
        updateMonthDisplay(currentMonth, currentYear);
      }

      // Select calendar date
      function selectCalendarDate(dateString) {
        document.getElementById('notes-date').value = dateString;
        loadDailyNotes(dateString);
      }

      // Check if date has notes
      function checkIfDateHasNotes(dateString) {
        let notes = {};
        
        // Try to load from user-specific file first, fallback to localStorage
        if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
          const userId = window.userDataManager.getCurrentUserId();
          const filename = `user_${userId}_daily_notes.json`;
          notes = window.userDataManager.loadUserFile(filename) || {};
        } else {
          // Fallback to localStorage
          notes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
        }
        
        return notes[dateString] && Object.values(notes[dateString]).some(note => note.trim() !== '');
      }

      // Handle notes form submission
      function handleNotesSubmit(event) {
        event.preventDefault();
        
        const date = document.getElementById('notes-date').value;
        const notes = {
          kitchen: document.getElementById('kitchen-notes').value,
          service: document.getElementById('service-notes').value,
          recipe: document.getElementById('recipe-notes').value,
          ingredient: document.getElementById('ingredient-notes').value,
          menu: document.getElementById('menu-notes').value,
          general: document.getElementById('general-notes').value
        };
        
        saveDailyNotes(date, notes);
        
        // Show success message
        showNotification('Notes saved successfully!', 'success');
        
        // Update stats
        updateNotesStats();
        
        // Refresh calendar to show notes indicators
        initializeMiniCalendar();
      }

      // Save daily notes
      function saveDailyNotes(date, notes) {
        // Try to save to user-specific file first, fallback to localStorage
        if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
          const userId = window.userDataManager.getCurrentUserId();
          const filename = `user_${userId}_daily_notes.json`;
          const allNotes = window.userDataManager.loadUserFile(filename) || {};
          allNotes[date] = notes;
          window.userDataManager.saveUserFile(filename, allNotes);
          console.log('💾 Notes saved to user file for:', date);
        } else {
          // Fallback to localStorage
          const allNotes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
          allNotes[date] = notes;
          localStorage.setItem('iterum_notes', JSON.stringify(allNotes));
          console.log('💾 Notes saved to localStorage for:', date);
        }
      }

      // Load daily notes
      function loadDailyNotes(date) {
        let allNotes = {};
        
        // Try to load from user-specific file first, fallback to localStorage
        if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
          const userId = window.userDataManager.getCurrentUserId();
          const filename = `user_${userId}_daily_notes.json`;
          allNotes = window.userDataManager.loadUserFile(filename) || {};
          console.log('📖 Notes loaded from user file for:', date);
        } else {
          // Fallback to localStorage
          allNotes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
          console.log('📖 Notes loaded from localStorage for:', date);
        }
        
        const notes = allNotes[date] || {};
        
        document.getElementById('kitchen-notes').value = notes.kitchen || '';
        document.getElementById('service-notes').value = notes.service || '';
        document.getElementById('recipe-notes').value = notes.recipe || '';
        document.getElementById('ingredient-notes').value = notes.ingredient || '';
        document.getElementById('menu-notes').value = notes.menu || '';
        document.getElementById('general-notes').value = notes.general || '';
      }

      // Clear notes form
      function clearNotesForm() {
        document.getElementById('daily-notes-form').reset();
        showNotification('Form cleared!', 'info');
      }

      // Load previous notes
      function loadPreviousNotes() {
        const date = document.getElementById('notes-date').value;
        const currentDate = new Date(date);
        currentDate.setDate(currentDate.getDate() - 1);
        
        const previousDate = currentDate.toISOString().split('T')[0];
        document.getElementById('notes-date').value = previousDate;
        loadDailyNotes(previousDate);
        
        showNotification('Previous day notes loaded!', 'info');
      }

      // Update notes statistics
      function updateNotesStats() {
        let allNotes = {};
        
        // Try to load from user-specific file first, fallback to localStorage
        if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
          const userId = window.userDataManager.getCurrentUserId();
          const filename = `user_${userId}_daily_notes.json`;
          allNotes = window.userDataManager.loadUserFile(filename) || {};
        } else {
          // Fallback to localStorage
          allNotes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
        }
        
        const dates = Object.keys(allNotes);
        const totalNotes = dates.reduce((count, date) => {
          const dayNotes = allNotes[date];
          return count + Object.values(dayNotes).filter(note => note.trim() !== '').length;
        }, 0);
        
        document.getElementById('total-notes').textContent = totalNotes;
        document.getElementById('notes-days').textContent = dates.length;
        document.getElementById('searchable-notes').textContent = totalNotes;
      }

      // Search notes
      function searchNotes() {
        const searchTerm = document.getElementById('notes-search').value.toLowerCase();
        if (!searchTerm.trim()) {
          showNotification('Please enter a search term', 'warning');
          return;
        }
        
        let allNotes = {};
        
        // Try to load from user-specific file first, fallback to localStorage
        if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
          const userId = window.userDataManager.getCurrentUserId();
          const filename = `user_${userId}_daily_notes.json`;
          allNotes = window.userDataManager.loadUserFile(filename) || {};
        } else {
          // Fallback to localStorage
          allNotes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
        }
        
        const results = [];
        
        Object.entries(allNotes).forEach(([date, notes]) => {
          Object.entries(notes).forEach(([category, content]) => {
            if (content.toLowerCase().includes(searchTerm)) {
              results.push({
                date,
                category,
                content: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                fullContent: content
              });
            }
          });
        });
        
        displaySearchResults(results);
      }

      // Display search results
      function displaySearchResults(results) {
        const resultsContainer = document.getElementById('notes-search-results');
        if (!resultsContainer) return;
        
        if (results.length === 0) {
          resultsContainer.innerHTML = '<p class="text-gray-500">No notes found matching your search.</p>';
          return;
        }
        
        let resultsHTML = `<h4 class="heading-4 mb-3">Found ${results.length} results:</h4>`;
        results.forEach(result => {
          resultsHTML += `
            <div class="search-result-item p-3 bg-gray-50 rounded-lg mb-2">
              <div class="flex justify-between items-start mb-2">
                <span class="font-medium text-sm">${result.category}</span>
                <span class="text-xs text-gray-500">${new Date(result.date).toLocaleDateString()}</span>
              </div>
              <p class="text-sm text-gray-700">${result.content}</p>
            </div>
          `;
        });
        
        resultsContainer.innerHTML = resultsHTML;
      }

      // Add quick event
      function addQuickEvent() {
        const eventName = prompt('Enter event name:');
        if (eventName && eventName.trim()) {
          const today = new Date().toISOString().split('T')[0];
          const events = JSON.parse(localStorage.getItem('iterum_events') || '{}');
          
          if (!events[today]) events[today] = [];
          events[today].push({
            id: Date.now(),
            name: eventName.trim(),
            time: '12:00'
          });
          
          localStorage.setItem('iterum_events', JSON.stringify(events));
          updateTodayEvents();
          showNotification('Event added!', 'success');
        }
      }

      // Update today's events
      function updateTodayEvents() {
        const today = new Date().toISOString().split('T')[0];
        const events = JSON.parse(localStorage.getItem('iterum_events') || '{}');
        const todayEvents = events[today] || [];
        
        const eventsContainer = document.getElementById('today-events');
        if (!eventsContainer) return;
        
        if (todayEvents.length === 0) {
          eventsContainer.innerHTML = '<p class="text-gray-500">No events scheduled</p>';
          return;
        }
        
        let eventsHTML = '';
        todayEvents.forEach(event => {
          eventsHTML += `
            <div class="event-item flex justify-between items-center p-2 bg-iterum-primary-light rounded mb-2">
              <span class="text-sm font-medium">${event.name}</span>
              <span class="text-xs text-gray-600">${event.time}</span>
            </div>
          `;
        });
        
        eventsContainer.innerHTML = eventsHTML;
      }

      // Open calendar view
      function openCalendarView() {
        showNotification('Full calendar view coming soon!', 'info');
        // TODO: Implement full calendar view
      }

      // Export notes
      function exportNotes() {
        const allNotes = JSON.parse(localStorage.getItem('iterum_notes') || '{}');
        const dataStr = JSON.stringify(allNotes, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `iterum-notes-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showNotification('Notes exported successfully!', 'success');
      }

      // Show notification
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
        
        const colors = {
          success: 'bg-green-500 text-white',
          error: 'bg-red-500 text-white',
          warning: 'bg-yellow-500 text-white',
          info: 'bg-blue-500 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        
        // Auto remove
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Toggle user dropdown
      function toggleUserDropdown() {
        const dropdown = document.getElementById('user-dropdown');
        if (dropdown) {
          dropdown.classList.toggle('show');
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('user-dropdown');
        const userTab = document.querySelector('.header-user-tab');
        
        if (dropdown && !userTab.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });
    </script>

    <!-- Load Critical Scripts Only - DEFER non-critical to prevent hanging -->
    
    <!-- Firebase Auth (Critical - Async Module) -->
    <script type="module" async src="assets/js/firebase-auth.js"></script>
    <script type="module" async src="assets/js/firestore-sync.js"></script>
    
    <!-- Header User Display (Critical) -->
    <script defer src="assets/js/header-user-display.js"></script>
    
    <!-- Profile & Email (Defer - not needed immediately) -->
    <script defer src="assets/js/profile-editor.js"></script>
    <script defer src="assets/js/email-verification-banner.js"></script>
    
    <!-- Non-Critical Scripts - Load ASYNC after page ready -->
    <script defer src="assets/js/project-management-system.js"></script>
    <script defer src="assets/js/project-ui-manager.js"></script>
    <script defer src="assets/js/userControlledStorage.js"></script>
    <script defer src="assets/js/data-tagging-system.js"></script>
    <script defer src="assets/js/ingredientLibrary.js"></script>
    
    <!-- Notebook Features Script -->
    <script>
      // Notebook Features
      function initNotebookFeatures() {
        console.log('📓 Initializing notebook features...');
        
        // Set today's date
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateElement = document.getElementById('notebook-date');
        if (dateElement) {
          dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
        
        // Load daily notes
        loadDailyNotes();
        
        // Load recipe ideas as sticky notes
        loadRecipeIdeasSticky();
      }

      function saveDailyNotes() {
        const notesElement = document.getElementById('daily-notes');
        if (!notesElement) return;
        
        const notes = notesElement.value;
        const today = new Date().toISOString().split('T')[0];
        
        const dailyNotes = JSON.parse(localStorage.getItem('daily_notes') || '{}');
        dailyNotes[today] = notes;
        
        localStorage.setItem('daily_notes', JSON.stringify(dailyNotes));
        
        // Show success
        showNotebookToast('📝 Daily notes saved!', 'success');
      }

      function loadDailyNotes() {
        const today = new Date().toISOString().split('T')[0];
        const dailyNotes = JSON.parse(localStorage.getItem('daily_notes') || '{}');
        const notesElement = document.getElementById('daily-notes');
        
        if (notesElement && dailyNotes[today]) {
          notesElement.value = dailyNotes[today];
        }
      }

      function loadRecipeIdeasSticky() {
        const ideas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
        const container = document.getElementById('ideas-sticky-notes');
        
        if (!container) return;
        
        if (ideas.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #64748b; font-style: italic; padding: 40px;">No ideas yet. Add your first inspiration!</p>';
          return;
        }
        
        // Show last 6 ideas as sticky notes
        const recentIdeas = ideas.slice(-6).reverse();
        container.innerHTML = recentIdeas.map(idea => `
          <div class="idea-sticky-note">
            <div class="idea-text">${idea.title}</div>
            ${idea.description ? `<div style="font-size: 13px; color: #475569; margin: 8px 0; font-family: Inter, sans-serif;">${idea.description.substring(0, 80)}${idea.description.length > 80 ? '...' : ''}</div>` : ''}
            <div class="idea-meta">${idea.cuisine || 'Uncategorized'} • ${new Date(idea.createdAt).toLocaleDateString()}</div>
          </div>
        `).join('');
      }

      function showNewIdeaModal() {
        // Scroll to the detailed form
        const section = document.querySelector('.ideas-notepad-section');
        if (section) {
          section.scrollIntoView({ behavior: 'smooth' });
        }
      }

      function showNotebookToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: ${type === 'success' ? '#22c55e' : '#3b82f6'};
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          font-weight: 600;
          animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Initialize on load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotebookFeatures);
      } else {
        initNotebookFeatures();
      }
    </script>
    
    <!-- Initialize User System -->
    <script>
      // Ensure authentication system is loaded and working
      function initializeUserSystem() {
        console.log('🔍 Initializing user system...');
        
        // Check if AuthManager is available
        if (window.authManager) {
          console.log('✅ AuthManager system loaded successfully');
          
          const user = window.authManager.currentUser;
          console.log('🔍 Current user:', user);
          console.log('🔍 Is authenticated:', window.authManager.isAuthenticated);
          
          // Authentication system handles user display automatically via header-user-display.js
          console.log('🔍 User display handled by header-user-display.js');
          
          // Initialize project system
          console.log('🔍 Initializing project system...');
          if (window.projectManager) {
            console.log('✅ Project manager available');
            // Update project UI
            window.projectManager.updateProjectUI();
          } else {
            console.error('❌ Project manager not available');
          }
          
          // Initialize data tagging system
          console.log('🔍 Initializing data tagging system...');
          if (window.dataTagger) {
            console.log('✅ Data tagger available');
            // Update project stats display
            if (window.projectManager?.currentProject) {
              const stats = window.dataTagger.getProjectStats(window.projectManager.currentProject.id);
              console.log('🔍 Initial project stats:', stats);
            }
          } else {
            console.error('❌ Data tagger not available');
          }
          
          // Initialize ingredient library
          console.log('🥬 Initializing ingredient library...');
          if (window.ingredientLibrary) {
            console.log('✅ Ingredient library available');
            // Wait a bit for ingredient library to load, then update stats
            setTimeout(() => {
              updateIngredientStats();
            }, 1000);
            console.log('✅ Ingredient library initialization scheduled');
          } else {
            console.error('❌ Ingredient library not available');
          }
          
          // Listen for project changes
          window.addEventListener('projectChanged', (event) => {
            console.log('🔍 Project changed event received:', event.detail);
            const { project, isMaster } = event.detail;
            
            // Update project status display
            const projectNameElements = document.querySelectorAll('[data-project-name]');
            projectNameElements.forEach(element => {
              element.textContent = project?.name || 'Unknown Project';
            });
            
            // Show/hide import from master button based on project type
            const importButtons = document.querySelectorAll('[data-import-from-master]');
            importButtons.forEach(button => {
              if (isMaster) {
                button.style.display = 'none'; // Hide on master project
              } else {
                button.style.display = ''; // Show on specific projects
              }
            });
          });
          
          
          // Add click handler for user tab to toggle dropdown
          const userTab = document.querySelector('.header-user-tab');
          const userDropdown = document.getElementById('user-dropdown');
          
          console.log('🔍 User tab found:', userTab);
          console.log('🔍 User dropdown found:', userDropdown);
          
          if (userTab && userDropdown) {
            userTab.addEventListener('click', function(e) {
              e.stopPropagation();
              console.log('🔍 User tab clicked - toggling dropdown');
              userDropdown.classList.toggle('show');
            });
            console.log('✅ Click handler added to user tab');
            
            // Authentication system is ready
            console.log('✅ User dropdown interaction ready');
          } else {
            console.error('❌ User tab or dropdown not found');
          }
        }
      }
      
      // LIGHTWEIGHT initialization to prevent hanging
      console.log('✅ Lightweight init - preventing browser hang');
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log('✅ Page ready');
        });
      }
      
      console.log('🚀 Page scripts loaded - deferred scripts will load async');
      
      // Debug function for authentication system
      window.debugAuthSystem = function() {
        console.log('🐛 Debug Auth System');
        console.log('window.authManager:', window.authManager);
        console.log('window.firebaseAuth:', window.firebaseAuth);
        console.log('window.firebaseAuthUI:', window.firebaseAuthUI);
        console.log('Current user:', window.authManager?.currentUser);
        console.log('Is authenticated:', window.authManager?.isAuthenticated);
        console.log('Session active:', localStorage.getItem('session_active'));
        console.log('Current user stored:', localStorage.getItem('current_user'));
        
        // Use auth diagnostics
        if (window.authDiagnostics) {
          console.log('✅ Use authDiagnostics.check() for full status');
          authDiagnostics.check();
        } else if (window.authManager) {
          console.log('✅ AuthManager loaded and working');
        } else {
          alert('AuthManager not available. Check console for details.');
        }
      };
      
      // Test function for debugging
      async function testUserSystemOnIndex() {
        console.log('🧪 Testing authentication system on index page...');
        console.log('window.authManager:', window.authManager);
        
        if (window.authManager) {
          console.log('✅ AuthManager system is available');
          console.log('Current user:', window.authManager.currentUser);
          console.log('Is authenticated:', window.authManager.isAuthenticated);
          alert('AuthManager loaded successfully! Check console for details.\n\nUse authDiagnostics.check() for full status.');
        } else {
          console.log('❌ AuthManager is not available');
          alert('AuthManager is not available. Check console for details.');
        }
      }

      // Test function for debugging project system
      function testProjectSystemOnIndex() {
        console.log('📋 Testing project system on index page...');
        console.log('window.projectManager:', window.projectManager);
        console.log('window.projectManager type:', typeof window.projectManager);
        console.log('window.projectManager constructor:', window.projectManager?.constructor?.name);

        if (window.projectManager) {
          console.log('✅ Project manager is available');
          console.log('🔍 Project manager properties:', Object.keys(window.projectManager));
          console.log('🔍 Current project:', window.projectManager.currentProject);
          console.log('🔍 Total projects:', window.projectManager.projects?.length);

          // Test creating a project
          try {
            console.log('🔍 Creating test project...');
            const newProject = window.projectManager.createProject({
              name: 'Test Project ' + Date.now(),
              description: 'This is a test project for the Iterum Chef Notebook.',
              isMaster: false
            });

            console.log('🔍 Test project creation result:', newProject);

            if (newProject) {
              console.log('✅ Test project created successfully:', newProject);
              console.log('🔍 Current project after creation:', window.projectManager.currentProject);
              console.log('🔍 Total projects after creation:', window.projectManager.projects.length);
              alert('Test project created successfully! Check console for details.');
            } else {
              console.log('❌ Failed to create test project');
              alert('Failed to create test project. Check console for details.');
            }
          } catch (error) {
            console.error('❌ Error creating test project:', error);
            alert('Error creating test project: ' + error.message);
          }
        } else {
          console.log('❌ Project manager is not available');
          alert('Project manager is not available. Check console for details.');
                 }
       }

       // Project Management Functions
       function createNewProject() {
         console.log('🔍 Creating new project...');
         
         if (!window.projectManager) {
           console.error('❌ Project manager not available');
           alert('Project management system is not loaded. Please refresh the page and try again.');
           return;
         }
         
         // Show the project creation modal
         try {
           window.projectManager.showProjectModal();
           console.log('✅ Project creation modal opened');
         } catch (error) {
           console.error('❌ Error opening project modal:', error);
           alert('Error opening project creation modal: ' + error.message);
         }
       }

       function manageProjects() {
         console.log('🔍 Managing projects...');
         
         if (!window.projectManager) {
           console.error('❌ Project manager not available');
           alert('Project management system is not loaded. Please refresh the page and try again.');
           return;
         }
         
         // Show the project management modal
         try {
           window.projectManager.showProjectModal('manage');
           console.log('✅ Project management modal opened');
         } catch (error) {
           console.error('❌ Error opening project management modal:', error);
           alert('Error opening project management modal: ' + error.message);
         }
       }

                  function showProjectInfo() {
             console.log('🔍 Showing project info...');
             
             if (!window.projectManager) {
               console.error('❌ Project manager not available');
               alert('Project management system is not loaded. Please refresh the page and try again.');
               return;
             }
             
             const currentProject = window.projectManager.getCurrentProject();
             const allProjects = window.projectManager.projects || [];
             
             if (currentProject) {
               const projectInfo = `Current Project: ${currentProject.name}\nType: ${currentProject.isMaster ? 'Master Project' : 'Regular Project'}\nDescription: ${currentProject.description || 'No description'}\nTotal Projects: ${allProjects.length}`;
               alert(projectInfo);
             } else {
               alert('No current project selected.');
             }
           }
           
           // Ingredient Management Functions
           function showIngredientSearch() {
             console.log('🔍 Opening ingredient search...');
             window.open('ingredients.html', '_blank');
           }
           
           function showAddIngredient() {
             console.log('➕ Opening add ingredient form...');
             window.open('ingredients.html#add', '_blank');
           }
           
           function updateIngredientStats() {
             console.log('📊 Updating ingredient statistics...');
             
             try {
               // Load from localStorage directly
               const ingredientsDb = localStorage.getItem('ingredients_database');
               const customIngredients = localStorage.getItem('custom_ingredients');
               
               let totalCount = 0;
               
               if (ingredientsDb) {
                 const parsed = JSON.parse(ingredientsDb);
                 totalCount = Array.isArray(parsed) ? parsed.length : 0;
               }
               
               if (customIngredients) {
                 const customParsed = JSON.parse(customIngredients);
                 totalCount += Array.isArray(customParsed) ? customParsed.length : 0;
               }
               
               const countElement = document.getElementById('total-ingredients');
               if (countElement) {
                 countElement.textContent = totalCount;
                 console.log(`✅ Updated ingredient stats: ${totalCount} total`);
               }
             } catch (error) {
               console.error('❌ Error updating ingredient stats:', error);
               const countElement = document.getElementById('total-ingredients');
               if (countElement) countElement.textContent = '0';
             }
           }
           
           // Call immediately on load
           updateIngredientStats();
           
           // Also update when page becomes visible
           document.addEventListener('visibilitychange', function() {
             if (!document.hidden) {
               updateIngredientStats();
             }
           });

       // Test function for debugging data tagging system
       function testDataTaggingSystemOnIndex() {
         console.log('🏷️ Testing data tagging system on index page...');
         console.log('window.dataTagger:', window.dataTagger);
         console.log('window.dataTagger type:', typeof window.dataTagger);
         console.log('window.dataTagger constructor:', window.dataTagger?.constructor?.name);

         if (window.dataTagger) {
           console.log('✅ Data tagger is available');
           console.log('🔍 Data tagger properties:', Object.keys(window.dataTagger));
           
           // Test creating some sample tags
           try {
             console.log('🔍 Creating test data tags...');
             
             // Get current project
             const currentProject = window.projectManager?.getCurrentProject();
             if (currentProject) {
               console.log('🔍 Current project for tagging:', currentProject);
               
               // Tag some sample items
               const testIngredients = ['ingredient_001', 'ingredient_002', 'ingredient_003'];
               const testRecipes = ['recipe_001', 'recipe_002'];
               const testMenus = ['menu_001'];
               
               // Tag ingredients
               testIngredients.forEach(ingredientId => {
                 window.dataTagger.tagItem(currentProject.id, 'ingredients', ingredientId);
               });
               
               // Tag recipes
               testRecipes.forEach(recipeId => {
                 window.dataTagger.tagItem(currentProject.id, 'recipes', recipeId);
               });
               
               // Tag menus
               testMenus.forEach(menuId => {
                 window.dataTagger.tagItem(currentProject.id, 'menus', menuId);
               });
               
               // Get project stats
               const stats = window.dataTagger.getProjectStats(currentProject.id);
               console.log('🔍 Project stats after tagging:', stats);
               
               // Update project UI to show new stats
               if (window.projectManager) {
                 window.projectManager.updateProjectUI();
               }
               
               alert(`Test data tags created successfully!\n\nProject: ${currentProject.name}\nIngredients: ${stats.ingredients}\nRecipes: ${stats.recipes}\nMenus: ${stats.menus}\nTotal: ${stats.total}\n\nCheck console for details.`);
             } else {
               console.log('❌ No current project available');
               alert('No current project available. Please create or select a project first.');
             }
           } catch (error) {
             console.error('❌ Error creating test data tags:', error);
             alert('Error creating test data tags: ' + error.message);
           }
         } else {
           console.log('❌ Data tagger is not available');
           alert('Data tagger is not available. Check console for details.');
         }
       }

       // Recipe Ideas System
       let recipeIdeas = [];
       let ideasCounter = 0;

       // Initialize ideas system
       function initializeIdeasSystem() {
         console.log('💡 Initializing Recipe Ideas System...');
         
         // Wait for project manager to be ready
         if (window.projectManager && window.projectManager.getCurrentProject()) {
           console.log('✅ Project manager ready, loading ideas...');
           loadRecipeIdeas();
           updateIdeasDisplay();
           updateIdeasStats();
         } else {
           console.log('⏳ Project manager not ready, waiting...');
           // Retry after a short delay
           setTimeout(() => {
             if (window.projectManager && window.projectManager.getCurrentProject()) {
               console.log('✅ Project manager now ready, loading ideas...');
               loadRecipeIdeas();
               updateIdeasDisplay();
               updateIdeasStats();
             } else {
               console.log('⚠️ Project manager still not ready, using fallback...');
               // Use fallback initialization
               loadRecipeIdeas();
               updateIdeasDisplay();
               updateIdeasStats();
             }
           }, 500);
         }
         
         // Set up form submission
         const ideaForm = document.getElementById('quick-idea-form');
         if (ideaForm) {
           ideaForm.addEventListener('submit', handleIdeaSubmission);
         }

         // Set up URL field blur event for automatic recipe fetching
         const urlInput = document.getElementById('idea-url');
         if (urlInput) {
           urlInput.addEventListener('blur', function() {
             // Only fetch if there's a URL and it looks like a recipe site
             const url = this.value.trim();
             if (url && (url.includes('recipe') || url.includes('food') || url.includes('cooking') || url.includes('chef'))) {
               // Small delay to let user finish typing
               setTimeout(() => {
                 if (this.value.trim() === url) {
                   fetchRecipeFromURL();
                 }
               }, 500);
             }
           });
         }
       }
       
       // Load recipe ideas from project-aware storage
       function loadRecipeIdeas() {
         console.log('🔍 Starting recipe ideas load...');
         console.log('🔍 Project manager available:', !!window.projectManager);
         console.log('🔍 Current project:', window.projectManager?.getCurrentProject());
         
         try {
           // Try to load from project-aware storage first
           if (window.projectManager && window.projectManager.getCurrentProject()) {
             const currentProject = window.projectManager.getCurrentProject();
             const projectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
             console.log('🔍 Project key generated:', projectKey);
             
             const storedIdeas = localStorage.getItem(projectKey);
             console.log('🔍 Stored ideas found:', !!storedIdeas);
             
             if (storedIdeas) {
               recipeIdeas = JSON.parse(storedIdeas);
               console.log('📥 Loaded', recipeIdeas.length, 'recipe ideas from project:', projectKey);
             } else {
               recipeIdeas = [];
               console.log('📭 No recipe ideas found for current project');
               
               // Check if there are ideas in global storage that should be migrated
               migrateGlobalIdeasToProject();
             }
           } else {
             console.log('📭 No project manager or current project, using global storage');
             // Fallback to global storage
             const globalIdeas = localStorage.getItem('recipe_ideas');
             console.log('🔍 Global ideas found:', !!globalIdeas);
             
             recipeIdeas = JSON.parse(globalIdeas || '[]');
             console.log('📥 Loaded', recipeIdeas.length, 'recipe ideas from global storage');
           }
           
           ideasCounter = recipeIdeas.length;
           console.log('✅ Recipe ideas load complete. Total ideas:', ideasCounter);
           
         } catch (error) {
           console.error('❌ Error loading recipe ideas:', error);
           recipeIdeas = [];
           ideasCounter = 0;
         }
       }
       
       // Migrate global ideas to current project
       function migrateGlobalIdeasToProject() {
         try {
           const globalIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
           if (globalIdeas.length > 0 && window.projectManager && window.projectManager.getCurrentProject()) {
             console.log('🔄 Migrating', globalIdeas.length, 'ideas from global storage to current project...');
             
             // Copy ideas to current project
             recipeIdeas = [...globalIdeas];
             ideasCounter = recipeIdeas.length;
             
             // Save to project storage
             saveRecipeIdeas();
             
             // Clear global storage
             localStorage.removeItem('recipe_ideas');
             
             console.log('✅ Successfully migrated ideas to project:', window.projectManager.getCurrentProject().name);
           }
           
           // Also migrate in-progress recipes
           migrateGlobalRecipesToProject();
         } catch (error) {
           console.error('❌ Error migrating global ideas:', error);
         }
       }
       
       // Migrate global in-progress recipes to current project
       function migrateGlobalRecipesToProject() {
         try {
           const globalRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
           if (globalRecipes.length > 0 && window.projectManager && window.projectManager.getCurrentProject()) {
             console.log('🔄 Migrating', globalRecipes.length, 'in-progress recipes from global storage to current project...');
             
             // Save to project storage
             const projectKey = window.projectManager.getProjectStorageKey('recipes_in_progress');
             localStorage.setItem(projectKey, JSON.stringify(globalRecipes));
             
             // Clear global storage
             localStorage.removeItem('recipes_in_progress');
             
             console.log('✅ Successfully migrated in-progress recipes to project:', window.projectManager.getCurrentProject().name);
           }
         } catch (error) {
           console.error('❌ Error migrating global recipes:', error);
         }
       }

       // Save recipe ideas to project-aware storage
       function saveRecipeIdeas() {
         try {
           if (window.projectManager && window.projectManager.getCurrentProject()) {
             // Save to project-specific storage
             const projectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
             localStorage.setItem(projectKey, JSON.stringify(recipeIdeas));
             console.log('💾 Saved', recipeIdeas.length, 'recipe ideas to project:', projectKey);
           } else {
             // Fallback to global storage
             localStorage.setItem('recipe_ideas', JSON.stringify(recipeIdeas));
             console.log('💾 Saved', recipeIdeas.length, 'recipe ideas to global storage');
           }
         } catch (error) {
           console.error('❌ Error saving recipe ideas:', error);
         }
       }

       // Handle idea form submission
       function handleIdeaSubmission(event) {
         event.preventDefault();
         
         const formData = new FormData(event.target);
         const ideaData = {
           id: 'idea_' + Date.now(),
           title: formData.get('idea-title') || document.getElementById('idea-title').value,
           description: formData.get('idea-description') || document.getElementById('idea-description').value,
           cuisine: formData.get('idea-cuisine') || document.getElementById('idea-cuisine').value,
           difficulty: formData.get('idea-difficulty') || document.getElementById('idea-difficulty').value,
           ingredients: formData.get('idea-ingredients') || document.getElementById('idea-ingredients').value,
           url: formData.get('idea-url') || document.getElementById('idea-url').value,
           status: 'idea', // idea, in-progress, completed
           createdAt: new Date().toISOString(),
           lastUpdated: new Date().toISOString()
         };

         // Add to ideas array
         recipeIdeas.unshift(ideaData);
         ideasCounter++;
         
         // Save to project-aware storage
         saveRecipeIdeas();
         
         // Update display
         updateIdeasDisplay();
         updateIdeasStats();
         
         // Clear form
         clearIdeaForm();
         
         console.log('✅ Recipe idea saved:', ideaData);
         alert('Recipe idea saved successfully!');
       }

       // Clear idea form
       function clearIdeaForm() {
         document.getElementById('idea-title').value = '';
         document.getElementById('idea-description').value = '';
         document.getElementById('idea-cuisine').value = '';
         document.getElementById('idea-difficulty').value = '';
         document.getElementById('idea-ingredients').value = '';
         document.getElementById('idea-url').value = '';
       }

       // Update ideas display
       function updateIdeasDisplay() {
         const recentIdeasList = document.getElementById('recent-ideas-list');
         const ideaCount = document.getElementById('idea-count');
         
         if (ideaCount) {
           ideaCount.textContent = ideasCounter;
         }
         
         if (recentIdeasList) {
           const recentIdeas = recipeIdeas.slice(0, 5); // Show last 5 ideas
           
           if (recentIdeas.length === 0) {
             recentIdeasList.innerHTML = '<p class="text-gray-500">No ideas captured yet</p>';
             return;
           }
           
           recentIdeasList.innerHTML = recentIdeas.map(idea => `
             <div class="idea-item">
               <div class="idea-item-title">${idea.title}</div>
               <div class="idea-item-description">${idea.description}</div>
               ${idea.url ? `<div class="idea-item-url"><a href="${idea.url}" target="_blank" class="text-blue-600 hover:text-blue-800">🔗 View Source</a></div>` : ''}
               <div class="idea-item-meta">
                 ${idea.cuisine ? `<span>🌍 ${idea.cuisine}</span>` : ''}
                 ${idea.difficulty ? `<span>📊 ${idea.difficulty}</span>` : ''}
                 <span>📅 ${new Date(idea.createdAt).toLocaleDateString()}</span>
               </div>
               <div class="idea-item-actions">
                 <button onclick="editIdea('${idea.id}')" class="btn btn-sm btn-secondary">✏️ Edit</button>
                 <button onclick="createRecipeFromIdea('${idea.id}')" class="btn btn-sm btn-success">🧪 Create Recipe</button>
                 <button onclick="deleteIdea('${idea.id}')" class="btn btn-sm btn-danger">🗑️ Delete</button>
               </div>
             </div>
           `).join('');
         }
       }

       // Update ideas statistics
       function updateIdeasStats() {
         const totalIdeas = document.getElementById('total-ideas');
         const ideasInProgress = document.getElementById('ideas-in-progress');
         const completedRecipes = document.getElementById('completed-recipes');
         
         if (totalIdeas) totalIdeas.textContent = recipeIdeas.length;
         if (ideasInProgress) ideasInProgress.textContent = recipeIdeas.filter(idea => idea.status === 'in-progress').length;
         if (completedRecipes) completedRecipes.textContent = recipeIdeas.filter(idea => idea.status === 'completed').length;
       }

       // Edit idea
       function editIdea(ideaId) {
         const idea = recipeIdeas.find(i => i.id === ideaId);
         if (!idea) return;
         
         // Populate form with idea data
         document.getElementById('idea-title').value = idea.title;
         document.getElementById('idea-description').value = idea.description;
         document.getElementById('idea-cuisine').value = idea.cuisine;
         document.getElementById('idea-difficulty').value = idea.difficulty;
         document.getElementById('idea-ingredients').value = idea.ingredients;
         document.getElementById('idea-url').value = idea.url || '';
         
         // Remove old idea and add updated one
         recipeIdeas = recipeIdeas.filter(i => i.id !== ideaId);
         ideasCounter--;
         
         // Update display
         updateIdeasDisplay();
         updateIdeasStats();
         
         alert('Idea loaded for editing. Make your changes and click "Save Idea" to update.');
       }

       // Delete idea
       function deleteIdea(ideaId) {
         if (confirm('Are you sure you want to delete this recipe idea?')) {
           recipeIdeas = recipeIdeas.filter(i => i.id !== ideaId);
           ideasCounter--;
           
           // Save to project-aware storage
           saveRecipeIdeas();
           updateIdeasDisplay();
           updateIdeasStats();
           
           console.log('🗑️ Recipe idea deleted:', ideaId);
         }
       }

       // Create recipe from idea
       function createRecipeFromIdea(ideaId = null) {
         let idea = null;
         
         if (ideaId) {
           idea = recipeIdeas.find(i => i.id === ideaId);
         } else {
           // Get current form data
           const title = document.getElementById('idea-title').value;
           const description = document.getElementById('idea-description').value;
           
           if (!title.trim()) {
             alert('Please enter a recipe idea title first.');
             return;
           }
           
           idea = {
             title: title,
             description: description,
             cuisine: document.getElementById('idea-cuisine').value,
             difficulty: document.getElementById('idea-difficulty').value,
             ingredients: document.getElementById('idea-ingredients').value,
             url: document.getElementById('idea-url').value
           };
         }
         
         if (!idea) return;
         
         // Create recipe data
         const recipeData = {
           title: idea.title,
           description: idea.description,
           cuisine: idea.cuisine,
           difficulty: idea.difficulty,
           url: idea.url,
           status: 'in-progress',
           source: 'idea',
           ideaId: ideaId,
           createdAt: new Date().toISOString()
         };
         
         // Save recipe to project-aware storage for the developer page
         let existingRecipes = [];
         
         if (window.projectManager && window.projectManager.getCurrentProject()) {
           // Try to load from project-specific storage
           const projectKey = window.projectManager.getProjectStorageKey('recipes_in_progress');
           const storedRecipes = localStorage.getItem(projectKey);
           if (storedRecipes) {
             existingRecipes = JSON.parse(storedRecipes);
           }
         } else {
           // Fallback to global storage
           existingRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
         }
         
         existingRecipes.push(recipeData);
         
         // Save back to project-aware storage
         if (window.projectManager && window.projectManager.getCurrentProject()) {
           const projectKey = window.projectManager.getProjectStorageKey('recipes_in_progress');
           localStorage.setItem(projectKey, JSON.stringify(existingRecipes));
           console.log('💾 Saved in-progress recipe to project:', projectKey);
         } else {
           localStorage.setItem('recipes_in_progress', JSON.stringify(existingRecipes));
           console.log('💾 Saved in-progress recipe to global storage');
         }
         
         // Update idea status if it was from an existing idea
         if (ideaId) {
           const ideaIndex = recipeIdeas.findIndex(i => i.id === ideaId);
           if (ideaIndex !== -1) {
             recipeIdeas[ideaIndex].status = 'in-progress';
             recipeIdeas[ideaIndex].lastUpdated = new Date().toISOString();
             // Save to project-aware storage
             saveRecipeIdeas();
             updateIdeasDisplay();
             updateIdeasStats();
           }
         }
         
         // Redirect to recipe developer page
         window.open('recipe-developer.html', '_blank');
         
         console.log('🧪 Recipe created from idea:', recipeData);
         alert('Recipe created successfully! Redirecting to Recipe Developer...');
       }

       // View all ideas
       function viewAllIdeas() {
         const ideasList = recipeIdeas.map(idea => `
           ${idea.title} - ${idea.status} - ${new Date(idea.createdAt).toLocaleDateString()}
           ${idea.url ? `\n   URL: ${idea.url}` : ''}
         `).join('\n');
         
         alert('All Recipe Ideas:\n\n' + ideasList);
       }

       // Search ideas
       function searchIdeas() {
         const searchTerm = document.getElementById('ideas-search').value.toLowerCase();
         const resultsContainer = document.getElementById('ideas-search-results');
         
         if (!searchTerm.trim()) {
           resultsContainer.innerHTML = '<p class="text-gray-500">Enter a search term to find ideas</p>';
           return;
         }
         
         const matchingIdeas = recipeIdeas.filter(idea => 
           idea.title.toLowerCase().includes(searchTerm) ||
           idea.description.toLowerCase().includes(searchTerm) ||
           idea.cuisine.toLowerCase().includes(searchTerm) ||
           idea.ingredients.toLowerCase().includes(searchTerm)
         );
         
         if (matchingIdeas.length === 0) {
           resultsContainer.innerHTML = '<p class="text-gray-500">No ideas found matching your search</p>';
           return;
         }
         
         resultsContainer.innerHTML = matchingIdeas.map(idea => `
           <div class="idea-item">
             <div class="idea-item-title">${idea.title}</div>
             <div class="idea-item-description">${idea.description}</div>
             ${idea.url ? `<div class="idea-item-url"><a href="${idea.url}" target="_blank" class="text-blue-600 hover:text-blue-800">🔗 View Source</a></div>` : ''}
             <div class="idea-item-meta">
               ${idea.cuisine ? `<span>🌍 ${idea.cuisine}</span>` : ''}
               ${idea.difficulty ? `<span>📊 ${idea.difficulty}</span>` : ''}
               <span>📅 ${new Date(idea.createdAt).toLocaleDateString()}</span>
               <span>📊 ${idea.status}</span>
             </div>
           </div>
         `).join('');
       }

       // Initialize ideas system when page loads
       document.addEventListener('DOMContentLoaded', function() {
         // ... existing initialization code ...
         
         // Initialize ideas system
         initializeIdeasSystem();
       });

       // Initialize Main Iterum App with Forced User Selection
       document.addEventListener('DOMContentLoaded', async function() {
         console.log('🚀 Initializing Iterum App with Forced User Selection...');
         
         // Wait for all systems to load
         await new Promise(resolve => setTimeout(resolve, 1000));
         
         // Initialize the main app
         if (window.IterumApp) {
           try {
             console.log('🔧 Starting main app initialization...');
             await window.IterumApp.init();
             console.log('✅ Main app initialization complete');
           } catch (error) {
             console.error('❌ Main app initialization failed:', error);
           }
         } else {
           console.error('❌ IterumApp not found - authentication system may not work properly');
         }
         
         // Show loading overlay until authentication is complete
         const loadingOverlay = document.getElementById('loading-overlay');
         if (loadingOverlay) {
           loadingOverlay.style.display = 'flex';
           loadingOverlay.style.opacity = '1';
           console.log('🔒 Showing authentication overlay...');
         }
       });

       // Manual refresh function for debugging
       function refreshRecipeIdeas() {
         console.log('🔄 Manually refreshing recipe ideas...');
         loadRecipeIdeas();
         updateIdeasDisplay();
         updateIdeasStats();
       }

       // Make refresh function globally available for debugging
       window.refreshRecipeIdeas = refreshRecipeIdeas;
       
       // Debug function to check storage state
       function debugRecipeIdeasStorage() {
         console.log('🔍 === RECIPE IDEAS STORAGE DEBUG ===');
         console.log('🔍 Current recipeIdeas array:', recipeIdeas);
         console.log('🔍 Ideas counter:', ideasCounter);
         
         if (window.projectManager) {
           const currentProject = window.projectManager.getCurrentProject();
           console.log('🔍 Current project:', currentProject);
           
           if (currentProject) {
             const projectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
             console.log('🔍 Project storage key:', projectKey);
             
             const storedIdeas = localStorage.getItem(projectKey);
             console.log('🔍 Stored ideas in project:', storedIdeas ? JSON.parse(storedIdeas) : 'null');
           }
         }
         
         const globalIdeas = localStorage.getItem('recipe_ideas');
         console.log('🔍 Global storage ideas:', globalIdeas ? JSON.parse(globalIdeas) : 'null');
         
         console.log('🔍 === END DEBUG ===');
       }
       
       // Make debug function globally available
       window.debugRecipeIdeasStorage = debugRecipeIdeasStorage;
       
       // Test function to create a sample idea and verify storage
       function testRecipeIdeasStorage() {
         console.log('🧪 Testing recipe ideas storage...');
         
         // Create a test idea
         const testIdea = {
           id: 'test_idea_' + Date.now(),
           title: 'Test Recipe Idea',
           description: 'This is a test recipe idea to verify storage is working',
           cuisine: 'Test Cuisine',
           difficulty: 'easy',
           ingredients: 'Test ingredients',
           url: 'https://example.com/test-recipe',
           status: 'idea',
           createdAt: new Date().toISOString(),
           lastUpdated: new Date().toISOString()
         };
         
         // Add to ideas array
         recipeIdeas.unshift(testIdea);
         ideasCounter++;
         
         // Save to storage
         saveRecipeIdeas();
         
         // Update display
         updateIdeasDisplay();
         updateIdeasStats();
         
         console.log('✅ Test idea created and saved');
         console.log('🧪 Current ideas count:', ideasCounter);
         
         // Debug storage state
         debugRecipeIdeasStorage();
         
         alert('Test idea created! Check console for debug info.');
       }
       
       // Make test function globally available
       window.testRecipeIdeasStorage = testRecipeIdeasStorage;

       // Function to fetch recipe data from URL
       async function fetchRecipeFromURL() {
         const urlInput = document.getElementById('idea-url');
         const statusDiv = document.getElementById('url-fetch-status');
         const fetchBtn = document.getElementById('fetch-recipe-btn');
         const url = urlInput.value.trim();
         
         if (!url) {
           statusDiv.textContent = 'Please enter a URL first';
           statusDiv.className = 'url-fetch-status error';
           return;
         }
         
         if (!url.startsWith('http://') && !url.startsWith('https://')) {
           statusDiv.textContent = 'Please enter a valid URL starting with http:// or https://';
           statusDiv.className = 'url-fetch-status error';
           return;
         }
         
         try {
           statusDiv.textContent = '🔍 Fetching recipe data...';
           statusDiv.className = 'url-fetch-status loading';
           
           // Update button state
           if (fetchBtn) {
             fetchBtn.disabled = true;
             fetchBtn.innerHTML = '⏳ Fetching...';
           }
           
           // Use a CORS proxy to fetch the URL content
           const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
           const response = await fetch(proxyUrl);
           
           if (!response.ok) {
             throw new Error(`HTTP error! status: ${response.status}`);
           }
           
           const data = await response.json();
           
           if (!data.contents) {
             throw new Error('No content received from URL');
           }
           
           // Parse the HTML content
           const parser = new DOMParser();
           const doc = parser.parseFromString(data.contents, 'text/html');
           
           // Extract recipe information using common selectors
           const recipeData = extractRecipeData(doc, url);
           
           if (recipeData.title) {
             // Populate the form fields with extracted data
             populateFormWithRecipeData(recipeData);
             
             statusDiv.textContent = '✅ Recipe data fetched successfully!';
             statusDiv.className = 'url-fetch-status success';
           } else {
             statusDiv.textContent = '⚠️ No recipe data found. You may need to enter details manually.';
             statusDiv.className = 'url-fetch-status error';
           }
           
         } catch (error) {
           console.error('Error fetching recipe from URL:', error);
           statusDiv.textContent = `❌ Error: ${error.message}`;
           statusDiv.className = 'url-fetch-status error';
         } finally {
           // Reset button state
           if (fetchBtn) {
             fetchBtn.disabled = false;
             fetchBtn.innerHTML = '🔗 Fetch Recipe';
           }
         }
       }

       // Function to extract recipe data from HTML
       function extractRecipeData(doc, url) {
         const recipeData = {
           title: '',
           description: '',
           ingredients: '',
           cuisine: '',
           difficulty: ''
         };
         
         // Try to extract title from various common selectors
         const titleSelectors = [
           'h1[class*="recipe"]',
           'h1[class*="title"]',
           'h1[class*="dish"]',
           'h1[class*="food"]',
           'h1',
           'title'
         ];
         
         for (const selector of titleSelectors) {
           const element = doc.querySelector(selector);
           if (element && element.textContent.trim()) {
             recipeData.title = element.textContent.trim();
             break;
           }
         }
         
         // Try to extract description
         const descSelectors = [
           'meta[name="description"]',
           'meta[property="og:description"]',
           'p[class*="description"]',
           'p[class*="summary"]',
           'div[class*="description"]'
         ];
         
         for (const selector of descSelectors) {
           const element = doc.querySelector(selector);
           if (element) {
             const content = element.getAttribute('content') || element.textContent.trim();
             if (content) {
               recipeData.description = content;
               break;
             }
           }
         }
         
         // Try to extract ingredients
         const ingredientSelectors = [
           'ul[class*="ingredient"]',
           'ol[class*="ingredient"]',
           'div[class*="ingredient"]',
           'li[class*="ingredient"]'
         ];
         
         for (const selector of ingredientSelectors) {
           const elements = doc.querySelectorAll(selector);
           if (elements.length > 0) {
             const ingredients = Array.from(elements).map(el => el.textContent.trim()).filter(text => text.length > 0);
             if (ingredients.length > 0) {
               recipeData.ingredients = ingredients.join('\n');
               break;
             }
           }
         }
         
         // Try to detect cuisine type from content
         const content = doc.body.textContent.toLowerCase();
         const cuisineKeywords = {
           'italian': ['italian', 'pasta', 'pizza', 'risotto', 'bruschetta'],
           'mexican': ['mexican', 'taco', 'burrito', 'enchilada', 'guacamole'],
           'asian': ['asian', 'chinese', 'japanese', 'thai', 'vietnamese', 'sushi', 'curry'],
           'mediterranean': ['mediterranean', 'greek', 'spanish', 'lebanese', 'hummus'],
           'american': ['american', 'burger', 'bbq', 'southern', 'cajun'],
           'french': ['french', 'bistro', 'boulangerie', 'croissant'],
           'indian': ['indian', 'curry', 'masala', 'naan', 'tandoori']
         };
         
         for (const [cuisine, keywords] of Object.entries(cuisineKeywords)) {
           if (keywords.some(keyword => content.includes(keyword))) {
             recipeData.cuisine = cuisine;
             break;
           }
         }
         
         // Try to detect difficulty from content
         const difficultyKeywords = {
           'easy': ['easy', 'simple', 'quick', 'basic'],
           'medium': ['medium', 'moderate', 'intermediate'],
           'hard': ['hard', 'difficult', 'advanced', 'complex', 'challenging']
         };
         
         for (const [difficulty, keywords] of Object.entries(difficultyKeywords)) {
           if (keywords.some(keyword => content.includes(keyword))) {
             recipeData.difficulty = difficulty;
             break;
           }
         }
         
         return recipeData;
       }

       // Function to populate form with fetched recipe data
       function populateFormWithRecipeData(recipeData) {
         if (recipeData.title) {
           document.getElementById('idea-title').value = recipeData.title;
         }
         
         if (recipeData.description) {
           document.getElementById('idea-description').value = recipeData.description;
         }
         
         if (recipeData.ingredients) {
           document.getElementById('idea-ingredients').value = recipeData.ingredients;
         }
         
         if (recipeData.cuisine) {
           document.getElementById('idea-cuisine').value = recipeData.cuisine;
         }
         
         if (recipeData.difficulty) {
           document.getElementById('idea-difficulty').value = recipeData.difficulty;
         }
         
         console.log('✅ Form populated with recipe data:', recipeData);
       }

      // Make fetch function globally available
      window.fetchRecipeFromURL = fetchRecipeFromURL;
    </script>

    <!-- Initialize App -->
    <script>
      console.log('🚀 Iterum App Loading...');
      
      // Global error handler - prevent loading screen from getting stuck
      window.addEventListener('error', function(e) {
        console.error('❌ Global error caught:', e.message);
        // Force show page even if there's an error
        removeLoadingIndicator();
      });
      
      // Force remove loading indicator immediately - prevent stuck loading screen
      function removeLoadingIndicator() {
        try {
      const loadingIndicator = document.getElementById('simple-loading');
      if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        loadingIndicator.remove();
            console.log('✅ Loading indicator removed');
          }
          document.body.style.display = 'block';
          document.body.style.overflow = 'auto';
          document.body.style.pointerEvents = 'auto';
          console.log('✅ Page visible and interactive');
        } catch (error) {
          console.error('Error removing loading indicator:', error);
        }
      }
      
      // Remove immediately
      removeLoadingIndicator();
      
      // Also remove after delays as failsafe (triple redundancy)
      setTimeout(removeLoadingIndicator, 100);
      setTimeout(removeLoadingIndicator, 500);
      setTimeout(removeLoadingIndicator, 1000);
      setTimeout(removeLoadingIndicator, 2000); // Extra failsafe
      
      // Emergency: If still visible after 3 seconds, force remove
      setTimeout(() => {
        const loading = document.getElementById('simple-loading');
        if (loading && loading.style.display !== 'none') {
          console.warn('⚠️ EMERGENCY: Force removing stuck loading screen');
          removeLoadingIndicator();
        }
      }, 3000);
      
      // Welcome Modal Function
      function showWelcomeModal(user) {
        const modal = document.createElement('div');
        modal.className = 'welcome-modal-overlay';
        modal.innerHTML = `
          <div class="welcome-modal-backdrop" onclick="this.parentElement.remove()"></div>
          <div class="welcome-modal-content">
            <div class="welcome-modal-icon">👋</div>
            <h2 class="welcome-modal-title">Welcome Back!</h2>
            <p class="welcome-modal-user">${user.name || user.email}</p>
            <p class="welcome-modal-message">
              Your workspace is ready. Let's create something amazing today!
            </p>
            <div class="welcome-modal-stats">
              <div class="welcome-stat">
                <div class="welcome-stat-number" id="modal-recipes">0</div>
                <div class="welcome-stat-label">Recipes</div>
              </div>
              <div class="welcome-stat">
                <div class="welcome-stat-number" id="modal-menus">0</div>
                <div class="welcome-stat-label">Menus</div>
              </div>
              <div class="welcome-stat">
                <div class="welcome-stat-number" id="modal-ingredients">0</div>
                <div class="welcome-stat-label">Ingredients</div>
              </div>
            </div>
            <div class="welcome-modal-actions">
              <button onclick="this.closest('.welcome-modal-overlay').remove(); window.location.href='recipe-upload.html'" class="btn-welcome btn-welcome-primary">
                <span>⚡</span>
                <span>Quick Upload</span>
              </button>
              <button onclick="this.closest('.welcome-modal-overlay').remove()" class="btn-welcome btn-welcome-secondary">
                <span>✓</span>
                <span>Get Started</span>
              </button>
            </div>
          </div>
        `;
        
        // Add styles
        if (!document.getElementById('welcome-modal-styles')) {
          const styles = document.createElement('style');
          styles.id = 'welcome-modal-styles';
          styles.textContent = `
            .welcome-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
              animation: fadeIn 0.3s ease;
            }
            
            .welcome-modal-backdrop {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              backdrop-filter: blur(8px);
            }
            
            .welcome-modal-content {
              position: relative;
              background: white;
              border-radius: 24px;
              padding: 48px 40px;
              max-width: 550px;
              width: 90%;
              text-align: center;
              box-shadow: 0 25px 50px rgba(0,0,0,0.3);
              animation: modalSlideUp 0.4s ease;
            }
            
            @keyframes modalSlideUp {
              from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
              }
              to {
                opacity: 1;
                transform: translateY(0) scale(1);
              }
            }
            
            .welcome-modal-icon {
              font-size: 80px;
              margin-bottom: 20px;
            }
            
            .welcome-modal-title {
              font-size: 2rem;
              font-weight: 900;
              color: #1e293b;
              margin-bottom: 12px;
            }
            
            .welcome-modal-user {
              font-size: 1.25rem;
              font-weight: 700;
              color: #4a7c2c;
              margin-bottom: 16px;
            }
            
            .welcome-modal-message {
              color: #64748b;
              font-size: 1.0625rem;
              margin-bottom: 32px;
              line-height: 1.6;
            }
            
            .welcome-modal-stats {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 20px;
              margin-bottom: 32px;
              padding: 24px;
              background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
              border-radius: 16px;
            }
            
            .welcome-stat {
              text-align: center;
            }
            
            .welcome-stat-number {
              font-size: 2rem;
              font-weight: 900;
              color: #4a7c2c;
              margin-bottom: 4px;
            }
            
            .welcome-stat-label {
              font-size: 0.875rem;
              color: #64748b;
              font-weight: 600;
            }
            
            .welcome-modal-actions {
              display: flex;
              gap: 12px;
              justify-content: center;
            }
            
            .btn-welcome {
              padding: 14px 28px;
              border-radius: 12px;
              border: none;
              font-weight: 700;
              font-size: 15px;
              cursor: pointer;
              transition: all 0.2s ease;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            }
            
            .btn-welcome-primary {
              background: linear-gradient(135deg, #4a7c2c 0%, #2d5a1a 100%);
              color: white;
            }
            
            .btn-welcome-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(74,124,44,0.3);
            }
            
            .btn-welcome-secondary {
              background: #f3f4f6;
              color: #1e293b;
            }
            
            .btn-welcome-secondary:hover {
              background: #e5e7eb;
            }
            
            @media (max-width: 640px) {
              .welcome-modal-content {
                padding: 32px 24px;
              }
              
              .welcome-modal-title {
                font-size: 1.5rem;
              }
              
              .welcome-modal-actions {
                flex-direction: column;
                width: 100%;
              }
              
              .btn-welcome {
                width: 100%;
                justify-content: center;
              }
            }
          `;
          document.head.appendChild(styles);
        }
        
        document.body.appendChild(modal);
        
        // Update greeting based on time
        const hour = new Date().getHours();
        const greetingEl = document.getElementById('greeting-text');
        if (greetingEl) {
          if (hour < 12) greetingEl.textContent = 'Good morning';
          else if (hour < 18) greetingEl.textContent = 'Good afternoon';
          else greetingEl.textContent = 'Good evening';
        }
        
        // Update username in header
        const welcomeUserName = document.getElementById('welcome-user-name');
        if (welcomeUserName) {
          welcomeUserName.textContent = user.name || user.email.split('@')[0];
        }
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          if (modal.parentElement) {
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 300);
          }
        }, 5000);
      }
      
      // User Menu Functions
      function toggleUserMenu() {
        const menu = document.getElementById('user-dropdown-menu');
        if (menu.style.display === 'none') {
          menu.style.display = 'block';
        } else {
          menu.style.display = 'none';
        }
      }

      function updateUserDisplay() {
        console.log('🔄 Updating user display...');
        console.log('AuthManager available?', !!window.authManager);
        
        // User display is now handled by header-user-display.js
        // This function is kept for backwards compatibility but redirects to new system
        
        if (!window.authManager) {
          console.warn('⚠️ AuthManager not available yet - may still be loading');
          return;
        }
        
        console.log('User authenticated?', window.authManager.isAuthenticated);
        
        if (window.authManager && window.authManager.isAuthenticated) {
          const user = window.authManager.currentUser;
          const userName = user.name || user.email.split('@')[0];
          const userEmail = user.email || 'No email';
          
          console.log('👤 Updating display for:', userName, userEmail);
          
          // Get initials for avatar
          const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          
          // Update all user name displays
          const nameElements = document.querySelectorAll('#header-user-name, #dropdown-user-name');
          console.log('Found', nameElements.length, 'name elements');
          nameElements.forEach(el => {
            el.textContent = userName;
          });
          
          // Update all email displays
          const emailElements = document.querySelectorAll('#header-user-email, #dropdown-user-email');
          console.log('Found', emailElements.length, 'email elements');
          emailElements.forEach(el => {
            el.textContent = userEmail;
          });
          
          // Update avatar initials
          const avatarElements = document.querySelectorAll('#user-avatar-text, #dropdown-avatar-text');
          console.log('Found', avatarElements.length, 'avatar elements');
          avatarElements.forEach(el => {
            el.textContent = initials;
          });
          
          console.log('✅ User display updated successfully:', userName);
        } else {
          console.log('⚠️ No user to display - not authenticated');
          
          // Update UI to show "Not signed in" state
          document.querySelectorAll('#header-user-name, #dropdown-user-name').forEach(el => {
            el.textContent = 'Guest';
          });
          
          document.querySelectorAll('#header-user-email, #dropdown-user-email').forEach(el => {
            el.textContent = 'Not signed in';
          });
          
          document.querySelectorAll('#user-avatar-text, #dropdown-avatar-text').forEach(el => {
            el.textContent = '?';
          });
        }
      }

      function showAccountSettings(event) {
        event.preventDefault();
        toggleUserMenu();
        
        const user = window.authManager ? window.authManager.currentUser : null;
        
        if (!user) {
          alert('Please sign in to access account settings');
          window.location.href = 'launch.html';
          return;
        }
        
        // Show account settings modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        modal.innerHTML = `
          <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="font-size: 28px; font-weight: 800; margin: 0 0 24px 0; color: #1f2937;">Account Settings</h2>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px;">Name</label>
              <div style="padding: 12px 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                ${user.name || 'Not set'}
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px;">Email</label>
              <div style="padding: 12px 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                ${user.email || 'Not set'}
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px;">Account Type</label>
              <div style="padding: 12px 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                ${user.type === 'trial' ? '🎁 Free Trial' : user.type === 'google' ? '🔵 Google Account' : user.type === 'email' ? '📧 Email Account' : 'Local Account'}
              </div>
            </div>
            
            <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
              <div style="color: #0369a1; font-size: 14px; line-height: 1.6;">
                <strong>💡 Note:</strong> To change your account information, please contact support or create a new account.
              </div>
            </div>
            
            <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;">
              Close
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      }

      function showTrialInfo(event) {
        event.preventDefault();
        toggleUserMenu();
        
        const user = window.authManager ? window.authManager.currentUser : null;
        
        if (!user) {
          alert('Please sign in to view trial status');
          return;
        }
        
        if (user.type === 'trial') {
          const trialEnd = new Date(user.trialEndDate);
          const now = new Date();
          const daysRemaining = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          `;
          
          modal.innerHTML = `
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 64px; margin-bottom: 12px;">🎁</div>
                <h2 style="font-size: 28px; font-weight: 800; margin: 0 0 8px 0; color: #1f2937;">Your Free Trial</h2>
              </div>
              
              <div style="background: ${daysRemaining > 7 ? '#d1fae5' : daysRemaining > 3 ? '#fef3c7' : '#fee2e2'}; border-radius: 12px; padding: 24px; margin-bottom: 24px; text-align: center;">
                <div style="font-size: 48px; font-weight: 900; color: ${daysRemaining > 7 ? '#065f46' : daysRemaining > 3 ? '#92400e' : '#991b1b'};">
                  ${daysRemaining > 0 ? daysRemaining : 0}
                </div>
                <div style="font-size: 16px; font-weight: 600; color: ${daysRemaining > 7 ? '#065f46' : daysRemaining > 3 ? '#92400e' : '#991b1b'};">
                  Days Remaining
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Trial Started:</div>
                <div style="font-weight: 600; color: #1f2937;">${new Date(user.trialStartDate).toLocaleDateString()}</div>
              </div>
              
              <div style="margin-bottom: 24px;">
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Trial Ends:</div>
                <div style="font-weight: 600; color: #1f2937;">${trialEnd.toLocaleDateString()}</div>
              </div>
              
              ${daysRemaining <= 3 && daysRemaining > 0 ? `
              <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 20px;">
                <div style="color: #991b1b; font-weight: 600; margin-bottom: 4px;">⚠️ Trial Ending Soon!</div>
                <div style="color: #991b1b; font-size: 14px;">Subscribe now to keep your data and access.</div>
              </div>
              ` : ''}
              
              <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;">
                Close
              </button>
            </div>
          `;
          
          document.body.appendChild(modal);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
          });
        } else {
          alert('You are using a ' + (user.type === 'google' ? 'Google' : 'standard') + ' account. Trial information is only available for trial users.');
        }
      }

      function signOut(event) {
        event.preventDefault();
        
        if (confirm('Are you sure you want to sign out?')) {
          toggleUserMenu();
          
          if (window.authManager) {
            window.authManager.signOut();
          } else {
            // Manual sign out
            localStorage.removeItem('current_user');
            localStorage.removeItem('session_active');
            localStorage.removeItem('last_login');
            window.location.href = 'launch.html';
          }
        }
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const menu = document.getElementById('user-dropdown-menu');
        const button = document.getElementById('user-menu-button');
        
        if (menu && button && !button.contains(event.target) && !menu.contains(event.target)) {
          menu.style.display = 'none';
        }
      });
      
      // When DOM is ready, initialize
      document.addEventListener('DOMContentLoaded', function() {
        console.log('✅ DOM loaded');
        console.log('🔐 Auth system is enabled and loading...');
        
        // Wait for AuthManager to initialize
        setTimeout(() => {
          console.log('🔍 Checking for user data...');
          
          // Update user display
          updateUserDisplay();
          
          // Check authentication status (from AuthManager)
          if (window.authManager && window.authManager.isAuthenticated) {
            const user = window.authManager.currentUser;
            console.log('👤 User logged in:', user.name || user.email);
          
          // Show welcome modal popup
          setTimeout(() => {
            showWelcomeModal(user);
          }, 800);
          } else {
            console.log('⚠️ No user logged in - Auth guard will handle redirect');
            // Auth guard will handle showing sign-in modal
          }
        }, 100);
      });
      
      // Track page view analytics
      window.addEventListener('load', function() {
        if (window.analyticsTracker) {
          window.analyticsTracker.trackPageView('dashboard', 'Iterum Culinary App - Dashboard');
        }
      });
    </script>
    
    <!-- Backup Manager -->
    <script src="assets/js/backup-manager.js" defer></script>
    
    <!-- Auto-Sync Manager -->
    <script src="assets/js/auto-sync-manager.js" defer></script>
    
    <!-- Auth Guard - Final check at end -->
    <script defer src="assets/js/auth_guard.js"></script>
</body>
</html>