<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Management - Iterum Culinary App</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 90px 20px 20px 20px;
        }
        
        .kitchen-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .tool-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .tool-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .tool-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .tool-desc {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .tool-action {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .tool-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .output-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-top: 20px;
            display: none;
        }
        
        .output-area.active {
            display: block;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .prep-component {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .priority-high {
            border-left-color: #ef4444;
        }
        
        .priority-medium {
            border-left-color: #f59e0b;
        }
        
        .priority-low {
            border-left-color: #10b981;
        }
    </style>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
</head>
<body style="padding-top: 80px;">
    <div class="kitchen-container">
        <div class="page-header">
            <h1>🔪 Kitchen Management System</h1>
            <p>Professional tools for recipe books, build sheets, checklists & prep lists</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Logged in as: <span id="current-user-email">Loading...</span></p>
        </div>

        <div class="tools-grid">
            <!-- Recipe Book PDF -->
            <div class="tool-card" onclick="showRecipeBookOptions()">
                <div class="tool-icon">📕</div>
                <div class="tool-title">Recipe Book PDF</div>
                <div class="tool-desc">
                    Generate professional PDF recipe book with all your recipes, components, and plating instructions.
                </div>
                <button class="tool-action">📥 Generate PDF</button>
            </div>

            <!-- Build Sheets -->
            <div class="tool-card" onclick="showBuildSheets()">
                <div class="tool-icon">📋</div>
                <div class="tool-title">Build Sheets</div>
                <div class="tool-desc">
                    Create detailed build sheets for each recipe with components, yields, and par levels.
                </div>
                <button class="tool-action">📄 View Build Sheets</button>
            </div>

            <!-- Pre-Service Checklist -->
            <div class="tool-card" onclick="showPreServiceChecklist()">
                <div class="tool-icon">✅</div>
                <div class="tool-title">Pre-Service Checklist</div>
                <div class="tool-desc">
                    Quality control checklist for equipment, ingredients, prep, and station readiness.
                </div>
                <button class="tool-action">✓ Open Checklist</button>
            </div>

            <!-- Next Day Prep List -->
            <div class="tool-card" onclick="showPrepList()">
                <div class="tool-icon">📝</div>
                <div class="tool-title">Next Day Prep List</div>
                <div class="tool-desc">
                    Generate prep list for tomorrow with priorities, shopping list, and task breakdown.
                </div>
                <button class="tool-action">📅 Generate Prep List</button>
            </div>

            <!-- Version History -->
            <div class="tool-card" onclick="showVersionHistory()">
                <div class="tool-icon">🕐</div>
                <div class="tool-title">Recipe Versions</div>
                <div class="tool-desc">
                    Track recipe changes over time, compare versions, and restore previous versions.
                </div>
                <button class="tool-action">📜 View History</button>
            </div>

            <!-- Export All -->
            <div class="tool-card" onclick="exportAll()">
                <div class="tool-icon">📦</div>
                <div class="tool-title">Export All</div>
                <div class="tool-desc">
                    Download all kitchen documents (recipe book, build sheets, checklists) as ZIP file.
                </div>
                <button class="tool-action">💾 Export Everything</button>
            </div>
        </div>

        <!-- Output Area -->
        <div id="output-area" class="output-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="output-title" style="font-size: 1.8rem; font-weight: 700;">Output</h2>
                <button onclick="closeOutput()" style="padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">✕ Close</button>
            </div>
            <div id="output-content"></div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="margin-top: 30px;">
            <div class="card-header-gradient">
                <h2 class="card-title">Quick Actions</h2>
            </div>
            <div style="padding: 20px;">
                <div class="button-group">
                    <button class="btn" onclick="location.href='index.html'">🏠 Dashboard</button>
                    <button class="btn" onclick="location.href='recipe-library.html'">📚 Recipe Library</button>
                    <button class="btn" onclick="location.href='ingredient-highlights.html'">✨ Ingredient Highlights</button>
                    <button class="btn" onclick="location.href='server-info-sheet.html'">📋 Server Info</button>
                    <button class="btn" onclick="location.href='menu-builder.html'">🍽️ Menu Builder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth -->
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/state-persistence-manager.js"></script>
    <script src="assets/js/universal-recipe-manager.js"></script>
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <script src="assets/js/kitchen-management-system.js"></script>
    
    <script>
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for auth
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (!window.authManager || !window.authManager.isAuthenticated) {
                alert('Please sign in to access Kitchen Management');
                window.location.href = 'index.html';
                return;
            }

            const user = window.authManager.currentUser;
            document.getElementById('current-user-email').textContent = user.email;
            
            // Initialize kitchen system
            await window.kitchenManagementSystem.init(user.userId || user.id, user.email);
        });

        function showRecipeBookOptions() {
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '📕 Recipe Book PDF Generator';
            content.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">PDF Options</h3>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-components" checked>
                            Include recipe components and sub-recipes
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-photos">
                            Include recipe photos
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-nutrition" checked>
                            Include nutritional information
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-costs">
                            Include cost breakdown
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="pdf-format">
                            <option value="standard">Standard (Easy to read)</option>
                            <option value="compact">Compact (Save paper)</option>
                            <option value="full">Full Details (Everything)</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="generatePDF()" style="width: 100%;">
                        📥 Download Recipe Book PDF
                    </button>
                </div>
                
                <div id="pdf-status" style="margin-top: 15px; padding: 15px; background: #f1f5f9; border-radius: 8px; display: none;">
                    <p style="margin: 0;">Generating PDF...</p>
                </div>
            `;
            
            output.classList.add('active');
        }

        function showBuildSheets() {
            const recipes = window.kitchenManagementSystem.currentRecipes;
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '📋 Recipe Build Sheets';
            
            if (recipes.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 4rem;">📋</div>
                        <h3 style="margin: 20px 0 10px;">No Recipes Found</h3>
                        <p>Create some recipes first to generate build sheets.</p>
                        <button class="btn" onclick="location.href='recipe-developer.html'" style="margin-top: 20px;">
                            👨‍🍳 Create Recipe
                        </button>
                    </div>
                `;
                output.classList.add('active');
                return;
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #64748b; margin-bottom: 15px;">Select a recipe to view its build sheet:</p>
                    <select class="form-select" id="recipe-select" onchange="displayBuildSheet(this.value)">
                        <option value="">-- Select Recipe --</option>
                        ${recipes.map(r => `<option value="${r.id}">${r.title || r.name}</option>`).join('')}
                    </select>
                </div>
                <div id="build-sheet-content"></div>
            `;
            
            output.classList.add('active');
        }

        function displayBuildSheet(recipeId) {
            if (!recipeId) return;
            
            const buildSheet = window.kitchenManagementSystem.generateBuildSheet(recipeId);
            const content = document.getElementById('build-sheet-content');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">${buildSheet.recipeName}</h2>
                        <p class="card-subtitle">Build Sheet - Version ${buildSheet.version}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Overview -->
                        <div class="stats-row" style="margin-bottom: 25px;">
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.servings}</div>
                                <div class="stat-label">Servings</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.prepTime}m</div>
                                <div class="stat-label">Prep</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.cookTime}m</div>
                                <div class="stat-label">Cook</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.difficulty}</div>
                                <div class="stat-label">Difficulty</div>
                            </div>
                        </div>

                        <!-- Components -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">Components</h3>
                        ${buildSheet.components.map(comp => `
                            <div class="prep-component">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <h4 style="font-weight: 600; font-size: 1.1rem;">${comp.name}</h4>
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">
                                        ${comp.shelfLife}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #64748b;">
                                    <div><strong>Daily Par:</strong> ${comp.dailyPar}</div>
                                    <div><strong>Yield:</strong> ${comp.yield}</div>
                                    <div><strong>Portion:</strong> ${comp.portionSize}</div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <strong style="display: block; margin-bottom: 8px;">Ingredients:</strong>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        ${comp.ingredients.map(ing => `
                                            <li>${ing.name || ing.ingredientName} - ${ing.quantity} ${ing.unit}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                                
                                <div>
                                    <strong style="display: block; margin-bottom: 8px;">Instructions:</strong>
                                    <ol style="margin: 0; padding-left: 20px;">
                                        ${comp.instructions.map(inst => `<li>${inst}</li>`).join('')}
                                    </ol>
                                </div>
                            </div>
                        `).join('')}

                        <!-- Plating -->
                        ${buildSheet.plating.length > 0 ? `
                            <h3 style="font-size: 1.3rem; font-weight: 600; margin: 25px 0 15px;">Plating Instructions</h3>
                            <ol style="padding-left: 20px;">
                                ${buildSheet.plating.map(step => `<li style="margin-bottom: 8px;">${step}</li>`).join('')}
                            </ol>
                        ` : ''}

                        <!-- Quality Checks -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 25px 0 15px;">Quality Standards</h3>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            ${buildSheet.qualityChecks.map(check => `
                                <div style="margin-bottom: 8px;">☐ ${check}</div>
                            `).join('')}
                        </div>

                        <!-- Actions -->
                        <div class="button-group" style="margin-top: 25px;">
                            <button class="btn" onclick="printBuildSheet('${recipeId}')">🖨️ Print</button>
                            <button class="btn" onclick="downloadBuildSheet('${recipeId}')">📥 Download PDF</button>
                            <button class="btn" onclick="emailBuildSheet('${recipeId}')">📧 Email</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPreServiceChecklist() {
            const checklist = window.kitchenManagementSystem.generatePreServiceChecklist();
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '✅ Pre-Service Quality Checklist';
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">Pre-Service Checklist</h2>
                        <p class="card-subtitle">${checklist.date} | ${checklist.restaurant}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        ${checklist.sections.map((section, sectionIndex) => `
                            <div style="margin-bottom: 30px;">
                                <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: #667eea;">
                                    ${section.name}
                                </h3>
                                ${section.items.map((item, itemIndex) => `
                                    <div class="checklist-item">
                                        <input 
                                            type="checkbox" 
                                            id="check-${sectionIndex}-${itemIndex}"
                                            onchange="updateChecklistProgress()"
                                        >
                                        <label for="check-${sectionIndex}-${itemIndex}" style="flex: 1; cursor: pointer;">
                                            ${item.task}
                                            ${item.shelfLife ? `<span style="color: #64748b; font-size: 0.85rem;"> (${item.shelfLife})</span>` : ''}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #0284c7;" id="checklist-progress">0%</div>
                                    <div style="color: #64748b;">Complete</div>
                                </div>
                                <button class="btn" onclick="saveChecklist()">💾 Save Progress</button>
                            </div>
                        </div>
                        
                        <div class="button-group" style="margin-top: 20px;">
                            <button class="btn" onclick="printChecklist()">🖨️ Print</button>
                            <button class="btn" onclick="downloadChecklistPDF()">📥 Download PDF</button>
                            <button class="btn" onclick="resetChecklist()">🔄 Reset All</button>
                        </div>
                    </div>
                </div>
            `;
            
            output.classList.add('active');
            updateChecklistProgress();
        }

        function showPrepList() {
            const prepList = window.kitchenManagementSystem.generateNextDayPrepList();
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '📝 Next Day Prep List';
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">Prep List for ${prepList.prepDate}</h2>
                        <p class="card-subtitle">${prepList.restaurant}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Components to Prep -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">Components to Prep</h3>
                        <p style="color: #64748b; margin-bottom: 15px;">Sorted by priority (shelf life)</p>
                        
                        ${prepList.components.map(comp => `
                            <div class="prep-component priority-${comp.priority >= 4 ? 'high' : comp.priority >= 3 ? 'medium' : 'low'}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="font-weight: 600; font-size: 1.1rem;">${comp.componentName}</h4>
                                        <p style="color: #64748b; font-size: 0.9rem; margin: 5px 0;">For: ${comp.recipeName}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: #667eea;">${comp.dailyPar}</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">${comp.shelfLife}</div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 0.9rem;">Yield:</strong> ${comp.yield} | 
                                    <strong style="font-size: 0.9rem;">Portion:</strong> ${comp.portionSize}
                                </div>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Instructions</summary>
                                    <ol style="margin: 10px 0 0 20px;">
                                        ${comp.instructions.map(inst => `<li style="margin-bottom: 5px;">${inst}</li>`).join('')}
                                    </ol>
                                </details>
                            </div>
                        `).join('')}

                        <!-- Shopping List -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 30px 0 15px;">Shopping List</h3>
                        <div class="card" style="background: #f8fafc;">
                            ${Array.from(new Set(prepList.shopping.map(i => i.category))).map(category => `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="font-weight: 600; color: #667eea; margin-bottom: 10px;">${category}</h4>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        ${prepList.shopping.filter(i => i.category === category).map(ing => `
                                            <li>${ing.name} - ${ing.quantity} ${ing.unit}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Prep Notes -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 30px 0 15px;">Prep Notes</h3>
                        <ul style="padding-left: 20px;">
                            ${prepList.notes.map(note => `<li style="margin-bottom: 8px;">${note}</li>`).join('')}
                        </ul>

                        <!-- Actions -->
                        <div class="button-group" style="margin-top: 25px;">
                            <button class="btn" onclick="printPrepList()">🖨️ Print</button>
                            <button class="btn" onclick="downloadPrepListPDF()">📥 Download PDF</button>
                            <button class="btn" onclick="emailPrepList()">📧 Email to Team</button>
                        </div>
                    </div>
                </div>
            `;
            
            output.classList.add('active');
        }

        function showVersionHistory() {
            const recipes = window.kitchenManagementSystem.currentRecipes;
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '🕐 Recipe Version History';
            
            content.innerHTML = `
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">Select Recipe</h3>
                    <select class="form-select" id="version-recipe-select" onchange="displayVersionHistory(this.value)">
                        <option value="">-- Select Recipe --</option>
                        ${recipes.map(r => `<option value="${r.id}">${r.title || r.name}</option>`).join('')}
                    </select>
                </div>
                <div id="version-history-content" style="margin-top: 20px;"></div>
            `;
            
            output.classList.add('active');
        }

        function displayVersionHistory(recipeId) {
            if (!recipeId) return;
            
            const history = window.kitchenManagementSystem.getVersionHistory(recipeId);
            const recipe = window.kitchenManagementSystem.currentRecipes.find(r => r.id === recipeId);
            const content = document.getElementById('version-history-content');
            
            if (history.length === 0) {
                content.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem;">📜</div>
                        <p style="color: #64748b; margin-top: 15px;">No version history yet for this recipe.</p>
                        <p style="color: #64748b; font-size: 0.9rem;">Versions will be saved automatically when you update the recipe.</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">
                        ${recipe.title || recipe.name} - ${history.length} Version(s)
                    </h3>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${history.reverse().map((version, index) => `
                            <div style="padding: 15px; background: ${index === 0 ? '#f0f9ff' : '#f8fafc'}; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${index === 0 ? '#0284c7' : '#cbd5e1'};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <div>
                                        <span style="font-weight: 600;">Version ${version.versionNumber}</span>
                                        ${index === 0 ? '<span style="background: #0284c7; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px;">CURRENT</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #64748b;">
                                        ${new Date(version.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">
                                    Modified by: ${version.modifiedBy}
                                </div>
                                <div style="font-size: 0.95rem;">
                                    Changes: ${version.changes}
                                </div>
                                <div class="button-group" style="margin-top: 10px;">
                                    <button class="btn" onclick="viewVersionDetail('${recipeId}', ${version.versionNumber})" style="font-size: 0.85rem; padding: 6px 12px;">👁️ View</button>
                                    ${index !== 0 ? `<button class="btn" onclick="restoreVersion('${recipeId}', ${version.versionNumber})" style="font-size: 0.85rem; padding: 6px 12px;">🔄 Restore</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function updateChecklistProgress() {
            const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const total = checkboxes.length;
            const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            const progressEl = document.getElementById('checklist-progress');
            if (progressEl) {
                progressEl.textContent = `${percent}%`;
            }
        }

        function closeOutput() {
            document.getElementById('output-area').classList.remove('active');
        }

        async function generatePDF() {
            const statusEl = document.getElementById('pdf-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<p>📕 Generating PDF... Please wait...</p>';
            
            try {
                const options = {
                    includeComponents: document.getElementById('pdf-components').checked,
                    includePhotos: document.getElementById('pdf-photos').checked,
                    includeNutrition: document.getElementById('pdf-nutrition').checked,
                    includeCosts: document.getElementById('pdf-costs').checked,
                    format: document.getElementById('pdf-format').value
                };
                
                const pdfData = await window.kitchenManagementSystem.generateRecipeBookPDF(options);
                
                // Use jsPDF to create actual PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add cover page
                doc.setFontSize(28);
                doc.text(pdfData.coverPage.title, 20, 40);
                doc.setFontSize(14);
                doc.text(pdfData.coverPage.subtitle, 20, 55);
                doc.setFontSize(10);
                doc.text(`By: ${pdfData.coverPage.author}`, 20, 70);
                doc.text(pdfData.coverPage.date, 20, 80);
                
                // Add table of contents
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Table of Contents', 20, 20);
                doc.setFontSize(10);
                let y = 35;
                pdfData.tableOfContents.forEach((item, index) => {
                    doc.text(`${index + 1}. ${item.title}`, 25, y);
                    doc.text(`${item.category}`, 150, y);
                    y += 7;
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                });
                
                // Add recipes
                pdfData.recipes.forEach(recipe => {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text(recipe.title, 20, 20);
                    doc.setFontSize(10);
                    doc.text(`Category: ${recipe.category}`, 20, 30);
                    doc.text(`Servings: ${recipe.servings} | Prep: ${recipe.prepTime}m | Cook: ${recipe.cookTime}m`, 20, 37);
                    
                    // Add ingredients
                    y = 50;
                    doc.setFontSize(12);
                    doc.text('Ingredients:', 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    (recipe.ingredients || []).forEach(ing => {
                        const ingText = `• ${ing.name || ing.ingredientName} - ${ing.quantity} ${ing.unit}`;
                        doc.text(ingText, 25, y);
                        y += 6;
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                    });
                    
                    // Add instructions
                    y += 5;
                    doc.setFontSize(12);
                    doc.text('Instructions:', 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    (recipe.instructions || []).forEach((inst, index) => {
                        const lines = doc.splitTextToSize(`${index + 1}. ${inst}`, 170);
                        lines.forEach(line => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(line, 25, y);
                            y += 6;
                        });
                    });
                });
                
                // Download
                const fileName = `${pdfData.coverPage.title.replace(/[^a-z0-9]/gi, '_')}_RecipeBook.pdf`;
                doc.save(fileName);
                
                statusEl.innerHTML = '<p style="color: #10b981;">✅ PDF Generated Successfully!</p>';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                statusEl.innerHTML = '<p style="color: #ef4444;">❌ Error generating PDF: ' + error.message + '</p>';
            }
        }

        function printBuildSheet(recipeId) {
            window.print();
        }

        function downloadBuildSheet(recipeId) {
            alert('Build sheet PDF download will be implemented');
        }

        function emailBuildSheet(recipeId) {
            alert('Email functionality will be implemented');
        }

        function printChecklist() {
            window.print();
        }

        function downloadChecklistPDF() {
            alert('Checklist PDF download will be implemented');
        }

        function resetChecklist() {
            if (confirm('Reset all checkboxes?')) {
                document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                updateChecklistProgress();
            }
        }

        function saveChecklist() {
            const checkboxStates = {};
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach((cb, index) => {
                checkboxStates[cb.id] = cb.checked;
            });
            
            const saveKey = `checklist_${new Date().toISOString().split('T')[0]}`;
            localStorage.setItem(saveKey, JSON.stringify(checkboxStates));
            
            alert('✅ Checklist progress saved!');
        }

        function printPrepList() {
            window.print();
        }

        function downloadPrepListPDF() {
            alert('Prep list PDF download will be implemented');
        }

        function emailPrepList() {
            alert('Email functionality will be implemented');
        }

        function viewVersionDetail(recipeId, versionNumber) {
            alert(`Viewing version ${versionNumber} details...`);
        }

        function restoreVersion(recipeId, versionNumber) {
            if (confirm(`Restore recipe to version ${versionNumber}?`)) {
                alert('Version restore will be implemented');
            }
        }

        async function exportAll() {
            alert('📦 Exporting all kitchen documents...\n\nThis will include:\n- Recipe Book PDF\n- All Build Sheets\n- Checklists\n- Prep Lists\n\nDownload will start shortly.');
            
            try {
                const docs = await window.kitchenManagementSystem.exportKitchenDocuments();
                console.log('Exported documents:', docs);
                
                // For now, download the recipe book PDF
                await generatePDF();
            } catch (error) {
                alert('Error exporting: ' + error.message);
            }
        }
    </script>
</body>
</html>

