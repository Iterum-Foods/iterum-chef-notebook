<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iterum - Emergency Access</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .status {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .icon {
            text-align: center;
            font-size: 64px;
            margin-bottom: 20px;
        }
        .button {
            display: block;
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .button.success {
            background: #10b981;
        }
        .button.success:hover {
            background: #059669;
        }
        .button.warning {
            background: #f59e0b;
        }
        .button.warning:hover {
            background: #d97706;
        }
        .info-box {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .info-box h3 {
            color: #0c4a6e;
            margin-bottom: 10px;
        }
        .info-box p {
            color: #0369a1;
            line-height: 1.6;
        }
        .error-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .error-box h3 {
            color: #991b1b;
            margin-bottom: 10px;
        }
        .error-box p {
            color: #dc2626;
            line-height: 1.6;
        }
        .debug-info {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .links {
            margin-top: 30px;
            text-align: center;
        }
        .links a {
            color: #3b82f6;
            text-decoration: none;
            margin: 0 10px;
            font-weight: 600;
        }
        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üö®</div>
        <h1>Emergency Access Mode</h1>
        <p class="status">The app is experiencing technical difficulties. Use this page to access the app safely.</p>

        <div class="error-box">
            <h3>‚ö†Ô∏è Known Issue</h3>
            <p>The main app is currently crashing at the sign-in screen. This emergency page bypasses the problematic authentication system.</p>
        </div>

        <div class="info-box">
            <h3>‚úÖ What This Page Does</h3>
            <p>This emergency access page creates a temporary offline profile and loads the app without the crashing authentication system.</p>
        </div>

        <button class="button success" onclick="createEmergencyProfile()">
            üöÄ Create Emergency Profile & Enter App
        </button>

        <button class="button" onclick="accessDiagnostic()">
            üîç Run Diagnostic Test
        </button>

        <button class="button warning" onclick="clearAllData()">
            üóëÔ∏è Clear All Data & Reset
        </button>

        <div id="debug-output" class="debug-info" style="display: none;">
            <strong>Debug Output:</strong>
            <pre id="debug-text"></pre>
        </div>

        <div class="links">
            <a href="menu-builder-improved.html">Menu Builder</a>
            <a href="recipe-developer.html">Recipe Developer</a>
            <a href="test_auth_diagnostic.html">Diagnostic Page</a>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message) {
            console.log(message);
            debugLog.push(message);
            updateDebugOutput();
        }

        function updateDebugOutput() {
            const debugOutput = document.getElementById('debug-output');
            const debugText = document.getElementById('debug-text');
            debugOutput.style.display = 'block';
            debugText.textContent = debugLog.join('\n');
        }

        function createEmergencyProfile() {
            log('üöÄ Creating emergency profile...');

            try {
                // Clear any existing broken sessions
                log('üßπ Clearing potentially broken session data...');
                localStorage.removeItem('session_active');
                localStorage.removeItem('mandatory_auth_overlay');
                
                // Create a simple offline profile
                const emergencyUser = {
                    id: 'emergency_' + Date.now(),
                    userId: 'emergency_' + Date.now(),
                    name: 'Emergency User',
                    email: 'emergency@iterum.local',
                    type: 'offline',
                    createdAt: new Date().toISOString(),
                    isEmergency: true
                };

                log('üë§ Emergency user created: ' + emergencyUser.name);

                // Save to localStorage
                localStorage.setItem('current_user', JSON.stringify(emergencyUser));
                localStorage.setItem('session_active', 'true');
                localStorage.setItem('last_login', new Date().toISOString());

                log('üíæ Saved to localStorage');

                // Save user to profiles list
                let savedUsers = [];
                try {
                    const existing = localStorage.getItem('saved_users');
                    if (existing) {
                        savedUsers = JSON.parse(existing);
                    }
                } catch (e) {
                    log('‚ö†Ô∏è Could not load existing users: ' + e.message);
                }

                // Add emergency user if not already present
                const userExists = savedUsers.some(u => u.id === emergencyUser.id);
                if (!userExists) {
                    savedUsers.push(emergencyUser);
                    localStorage.setItem('saved_users', JSON.stringify(savedUsers));
                    log('üìù Added to saved users list');
                }

                // Set flag to bypass authentication on main page
                sessionStorage.setItem('emergency_access', 'true');
                sessionStorage.setItem('bypass_auth', 'true');

                log('‚úÖ Emergency profile created successfully!');
                log('üîÑ Redirecting to main app...');

                // Wait a moment then redirect
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                log('‚ùå Error creating emergency profile: ' + error.message);
                alert('Failed to create emergency profile: ' + error.message);
            }
        }

        function accessDiagnostic() {
            log('üîç Accessing diagnostic page...');
            window.location.href = 'test_auth_diagnostic.html';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will clear ALL app data including profiles, recipes, and settings. Are you sure?')) {
                return;
            }

            log('üóëÔ∏è Clearing all data...');

            try {
                // Clear localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('iterum_') ||
                        key.includes('user') ||
                        key.includes('session') ||
                        key.includes('auth') ||
                        key.includes('profile')
                    )) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log('üóëÔ∏è Removed: ' + key);
                });

                // Clear sessionStorage
                sessionStorage.clear();
                log('üßπ Cleared sessionStorage');

                log('‚úÖ All data cleared successfully!');
                alert('All data cleared! The page will reload.');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                log('‚ùå Error clearing data: ' + error.message);
                alert('Failed to clear data: ' + error.message);
            }
        }

        // Auto-check system status on load
        window.addEventListener('load', () => {
            log('üìä Checking system status...');
            
            // Check localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('‚úÖ localStorage is working');
            } catch (e) {
                log('‚ùå localStorage is NOT working: ' + e.message);
            }

            // Check existing session
            try {
                const currentUser = localStorage.getItem('current_user');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    log('üë§ Found existing user: ' + user.name);
                } else {
                    log('‚ÑπÔ∏è No existing user found');
                }
            } catch (e) {
                log('‚ö†Ô∏è Could not check existing user: ' + e.message);
            }

            log('üìã System check complete. Ready for emergency access.');
        });
    </script>
</body>
</html>
