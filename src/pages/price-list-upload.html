<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price List Upload - Iterum Culinary</title>
    
    <!-- Auth System -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    <script src="assets/js/header-user-display.js"></script>
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- External Libraries for File Parsing -->
    <!-- SheetJS for Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js for PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5a1a 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(74, 124, 44, 0.3);
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.125rem;
            opacity: 0.95;
        }

        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-zone:hover {
            border-color: #4a7c2c;
            background: #f0fdf4;
        }

        .upload-zone.dragover {
            border-color: #4a7c2c;
            background: #dcfce7;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .upload-subtitle {
            color: #64748b;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5a1a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 124, 44, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1e293b;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .file-input {
            display: none;
        }

        .matching-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: none;
        }

        .matching-section.active {
            display: block;
        }

        .match-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .stat-card.matched {
            background: #dcfce7;
            border-color: #16a34a;
        }

        .stat-card.unmatched {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .stat-card.total {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .match-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .match-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
        }

        .match-table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .match-table tr:hover {
            background: #f8fafc;
        }

        .match-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .match-status.matched {
            background: #dcfce7;
            color: #16a34a;
        }

        .match-status.unmatched {
            background: #fef3c7;
            color: #92400e;
        }

        .match-dropdown {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            max-width: 300px;
        }

        .match-dropdown:focus {
            outline: none;
            border-color: #4a7c2c;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c2c 0%, #16a34a 100%);
            transition: width 0.3s ease;
        }

        .format-guide {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .format-guide h3 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 1.125rem;
        }

        .format-guide ul {
            list-style: none;
            padding: 0;
        }

        .format-guide li {
            padding: 8px 0;
            color: #1e40af;
        }

        .format-guide li::before {
            content: "‚úì ";
            color: #16a34a;
            font-weight: bold;
            margin-right: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .template-section {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .template-section h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4a7c2c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .price-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            width: 120px;
            text-align: right;
        }

        .price-input:focus {
            outline: none;
            border-color: #4a7c2c;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .confidence-high {
            background: #dcfce7;
            color: #16a34a;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
    
    <!-- Unified Navigation & Project Selector -->
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
</head>
<body style="padding-top: 80px;">
    <!-- Header placeholder - will be injected by header-user-display.js -->
    <!-- Header injected by unified-nav-header.js -->

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>üí∞ Price List Upload & Matching</h1>
            <p>Upload vendor price lists and automatically match with your inventory and ingredients</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2 style="margin-bottom: 20px; color: #1e293b;">Upload Price List</h2>
            
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-title">Drag & Drop or Click to Upload</div>
                <div class="upload-subtitle">Supports CSV, Excel (.xlsx, .xls), PDF, and text files</div>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span>üìÅ</span>
                    <span>Choose File</span>
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.pdf,.txt" onchange="handleFileSelect(event)">
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #64748b; font-size: 0.875rem;">
                <strong>Supported:</strong> 
                <span style="background: #dcfce7; padding: 4px 8px; border-radius: 6px; margin: 0 4px;">üìä Excel</span>
                <span style="background: #fef3c7; padding: 4px 8px; border-radius: 6px; margin: 0 4px;">üìÑ PDF</span>
                <span style="background: #dbeafe; padding: 4px 8px; border-radius: 6px; margin: 0 4px;">üìã CSV</span>
            </div>

            <div class="format-guide">
                <h3>üìã Supported Format</h3>
                <ul>
                    <li>Columns: Item Name, SKU/Code, Unit Size, Unit, Price</li>
                    <li>Additional columns: Description, Category, Brand</li>
                    <li>Example: "Chicken Breast, CHK-001, 5, lb, 12.99"</li>
                    <li>Header row optional but recommended</li>
                </ul>
            </div>

            <div class="template-section">
                <h3>üì• Download Template</h3>
                <p style="margin-bottom: 15px; color: #92400e;">Not sure about the format? Download our template:</p>
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    <span>üì•</span>
                    <span>Download CSV Template</span>
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p style="color: #64748b; font-weight: 600;">Processing price list and matching items...</p>
        </div>

        <!-- Matching Section -->
        <div class="matching-section" id="matchingSection">
            <h2 style="margin-bottom: 20px; color: #1e293b;">Review Matches</h2>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="match-stats">
                <div class="stat-card matched">
                    <div class="stat-number" id="matchedCount">0</div>
                    <div class="stat-label">Automatically Matched</div>
                </div>
                <div class="stat-card unmatched">
                    <div class="stat-number" id="unmatchedCount">0</div>
                    <div class="stat-label">Needs Review</div>
                </div>
                <div class="stat-card total">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="showMatched()">
                    <span>‚úì</span>
                    <span>Show Matched</span>
                </button>
                <button class="btn btn-secondary" onclick="showUnmatched()">
                    <span>‚ö†Ô∏è</span>
                    <span>Show Unmatched</span>
                </button>
                <button class="btn btn-secondary" onclick="showAll()">
                    <span>üìã</span>
                    <span>Show All</span>
                </button>
            </div>

            <table class="match-table">
                <thead>
                    <tr>
                        <th style="min-width: 200px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">üìã Item Name</th>
                        <th style="min-width: 140px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">üí∞ Price</th>
                        <th style="min-width: 220px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">üìè Unit Amount</th>
                        <th style="min-width: 140px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">üì¶ Case Size</th>
                        <th style="background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">Status</th>
                        <th style="min-width: 280px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">üîó Match to Ingredient</th>
                    </tr>
                </thead>
                <tbody id="matchTableBody">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
            
            <!-- Help Text -->
            <div style="margin-top: 20px; padding: 16px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">üí° Editing Tips:</div>
                <ul style="margin: 0; padding-left: 20px; color: #1e40af; line-height: 1.8;">
                    <li><strong>Price:</strong> Edit directly - changes are saved automatically</li>
                    <li><strong>Unit Amount:</strong> Enter quantity (e.g., 5 for 5lb bags)</li>
                    <li><strong>Unit Type:</strong> Select from dropdown (lb, kg, gal, etc.)</li>
                    <li><strong>Case Size:</strong> How many units per case (e.g., 12 for a 12-pack)</li>
                    <li><strong>Match:</strong> Select the ingredient this item should link to</li>
                </ul>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="cancelImport()">
                    <span>‚úï</span>
                    <span>Cancel</span>
                </button>
                <button class="btn btn-primary" onclick="saveMatches()">
                    <span>‚úì</span>
                    <span>Save & Import Prices</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let priceListData = [];
        let ingredientsDatabase = [];
        let currentFilter = 'all'; // 'all', 'matched', 'unmatched'

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üí∞ Price List Upload page loaded');
            loadIngredientsDatabase();
            setupDragAndDrop();
        });

        // Load ingredients from localStorage (or API)
        function loadIngredientsDatabase() {
            const savedIngredients = localStorage.getItem('ingredients_database');
            if (savedIngredients) {
                ingredientsDatabase = JSON.parse(savedIngredients);
                console.log('‚úÖ Loaded ' + ingredientsDatabase.length + ' ingredients from database');
            } else {
                // Sample data if none exists
                ingredientsDatabase = [
                    { id: 1, name: 'Chicken Breast', category: 'Protein', unit: 'lb' },
                    { id: 2, name: 'Olive Oil', category: 'Oil', unit: 'gal' },
                    { id: 3, name: 'Tomatoes', category: 'Produce', unit: 'lb' },
                    { id: 4, name: 'Flour', category: 'Dry Goods', unit: 'lb' },
                    { id: 5, name: 'Salt', category: 'Seasoning', unit: 'lb' }
                ];
                console.log('‚ÑπÔ∏è Using sample ingredients database');
            }
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const zone = document.getElementById('uploadZone');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Process uploaded file
        function handleFile(file) {
            console.log('üìÑ Processing file:', file.name);
            
            // Show loading
            document.getElementById('loadingState').classList.add('active');
            document.querySelector('.upload-section').style.display = 'none';

            const extension = file.name.split('.').pop().toLowerCase();

            if (extension === 'csv' || extension === 'txt') {
                // Parse CSV
                const reader = new FileReader();
                reader.onload = function(e) {
                    setTimeout(() => parseCSV(e.target.result), 500);
                };
                reader.readAsText(file);
            } 
            else if (extension === 'xlsx' || extension === 'xls') {
                // Parse Excel
                parseExcel(file);
            }
            else if (extension === 'pdf') {
                // Parse PDF
                parsePDF(file);
            }
            else {
                alert('‚ùå Unsupported file format. Please use CSV, Excel, or PDF.');
                resetUpload();
            }
        }

        // Parse Excel files
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convert to CSV format
                    const csvContent = XLSX.utils.sheet_to_csv(firstSheet);
                    
                    console.log('‚úÖ Excel parsed successfully');
                    setTimeout(() => parseCSV(csvContent), 500);
                } catch (error) {
                    console.error('‚ùå Error parsing Excel:', error);
                    alert('Error parsing Excel file: ' + error.message);
                    resetUpload();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse PDF files
        async function parsePDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                
                // Extract text from all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('‚úÖ PDF text extracted');
                
                // Try to parse as structured data
                parsePDFText(fullText);
                
            } catch (error) {
                console.error('‚ùå Error parsing PDF:', error);
                alert('Error parsing PDF file: ' + error.message);
                resetUpload();
            }
        }

        // Parse extracted PDF text into price list
        function parsePDFText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const data = [];
            
            // Try to detect price patterns
            // Common patterns: "Item Name $12.99" or "Item Name 5lb $12.99"
            const pricePattern = /\$?\d+\.?\d*/;
            
            for (const line of lines) {
                // Skip obvious header lines
                if (line.toLowerCase().includes('total') || 
                    line.toLowerCase().includes('invoice') ||
                    line.toLowerCase().includes('page') ||
                    line.length < 5) {
                    continue;
                }
                
                // Try to extract price
                const priceMatch = line.match(/\$?(\d+\.\d{2})/);
                if (!priceMatch) continue;
                
                const price = parseFloat(priceMatch[1]);
                
                // Remove price from line to get item name
                let itemName = line.replace(priceMatch[0], '').trim();
                
                // Try to extract unit/size (5lb, 1gal, etc.)
                const unitMatch = itemName.match(/(\d+)\s*(lb|lbs|kg|g|oz|gal|qt|ea|each|ct|count)/i);
                let unitSize = '';
                let unit = 'ea';
                
                if (unitMatch) {
                    unitSize = unitMatch[1];
                    unit = unitMatch[2].toLowerCase().replace('lbs', 'lb');
                    itemName = itemName.replace(unitMatch[0], '').trim();
                }
                
                // Try to extract SKU/code
                const skuMatch = itemName.match(/\b([A-Z]{2,4}-?\d{2,6})\b/);
                let sku = '';
                if (skuMatch) {
                    sku = skuMatch[1];
                    itemName = itemName.replace(skuMatch[0], '').trim();
                }
                
                if (itemName && price > 0) {
                    const item = {
                        itemName: itemName,
                        sku: sku,
                        unitSize: unitSize,
                        unit: unit,
                        price: price,
                        caseSize: null, // Will be set by user
                        matched: false,
                        matchedIngredient: null,
                        confidence: 0
                    };

                    // Try to auto-match
                    const match = findBestMatch(item.itemName);
                    if (match) {
                        item.matched = true;
                        item.matchedIngredient = match.ingredient;
                        item.confidence = match.confidence;
                    }

                    data.push(item);
                }
            }

            if (data.length === 0) {
                alert('‚ö†Ô∏è Could not find any price data in the PDF. Please check the format or try a different file.');
                resetUpload();
                return;
            }

            priceListData = data;
            console.log('‚úÖ Parsed ' + data.length + ' items from PDF');
            showMatches();
        }

        // Parse CSV content
        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const data = [];

            // Skip header row if it exists
            const startIndex = lines[0].toLowerCase().includes('item') || lines[0].toLowerCase().includes('name') ? 1 : 0;

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Parse CSV (handle quoted fields)
                const fields = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const cleanFields = fields.map(f => f.replace(/^"|"$/g, '').trim());

                if (cleanFields.length >= 3) {
                    const item = {
                        itemName: cleanFields[0] || '',
                        sku: cleanFields[1] || '',
                        unitSize: cleanFields[2] || '',
                        unit: cleanFields[3] || 'ea',
                        price: parseFloat(cleanFields[4]) || 0,
                        caseSize: parseInt(cleanFields[5]) || null, // New field
                        matched: false,
                        matchedIngredient: null,
                        confidence: 0
                    };

                    // Try to auto-match
                    const match = findBestMatch(item.itemName);
                    if (match) {
                        item.matched = true;
                        item.matchedIngredient = match.ingredient;
                        item.confidence = match.confidence;
                    }

                    data.push(item);
                }
            }

            priceListData = data;
            console.log('‚úÖ Parsed ' + data.length + ' items');
            showMatches();
        }

        // Find best matching ingredient
        function findBestMatch(itemName) {
            if (!itemName) return null;

            const searchTerm = itemName.toLowerCase();
            let bestMatch = null;
            let bestScore = 0;

            for (const ingredient of ingredientsDatabase) {
                const ingredientName = ingredient.name.toLowerCase();
                let score = 0;

                // Exact match
                if (ingredientName === searchTerm) {
                    score = 100;
                }
                // Contains full search term
                else if (ingredientName.includes(searchTerm)) {
                    score = 80;
                }
                // Search term contains ingredient name
                else if (searchTerm.includes(ingredientName)) {
                    score = 70;
                }
                // Word-by-word matching
                else {
                    const searchWords = searchTerm.split(/\s+/);
                    const ingredientWords = ingredientName.split(/\s+/);
                    let matchedWords = 0;

                    for (const word of searchWords) {
                        if (ingredientWords.some(iw => iw.includes(word) || word.includes(iw))) {
                            matchedWords++;
                        }
                    }

                    score = (matchedWords / Math.max(searchWords.length, ingredientWords.length)) * 60;
                }

                if (score > bestScore && score > 50) { // Minimum 50% confidence
                    bestScore = score;
                    bestMatch = ingredient;
                }
            }

            if (bestMatch) {
                return {
                    ingredient: bestMatch,
                    confidence: Math.round(bestScore)
                };
            }

            return null;
        }

        // Show matching results
        function showMatches() {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('matchingSection').classList.add('active');

            const matched = priceListData.filter(item => item.matched).length;
            const total = priceListData.length;
            const progress = total > 0 ? (matched / total * 100) : 0;

            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = total - matched;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressFill').style.width = progress + '%';

            renderTable();
        }

        // Render table rows
        function renderTable() {
            const tbody = document.getElementById('matchTableBody');
            tbody.innerHTML = '';

            const filteredData = priceListData.filter(item => {
                if (currentFilter === 'matched') return item.matched;
                if (currentFilter === 'unmatched') return !item.matched;
                return true;
            });

            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const statusBadge = item.matched
                    ? `<span class="match-status matched">‚úì Matched</span>`
                    : `<span class="match-status unmatched">‚ö†Ô∏è Unmatched</span>`;

                const confidenceBadge = item.matched
                    ? `<span class="confidence-badge ${getConfidenceClass(item.confidence)}">${item.confidence}%</span>`
                    : '';

                const matchedIngredient = item.matchedIngredient
                    ? `${item.matchedIngredient.name} ${confidenceBadge}`
                    : 'No match found';

                const ingredientOptions = createIngredientDropdown(item, index);

                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: #0f172a; margin-bottom: 4px;">${item.itemName}</div>
                        <div style="font-size: 0.85rem; color: #64748b;">SKU: ${item.sku || 'N/A'}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; font-size: 1.2rem; color: #0f172a;">$</span>
                            <input type="number" 
                                   step="0.01" 
                                   min="0"
                                   class="price-input" 
                                   value="${item.price.toFixed(2)}" 
                                   onchange="updatePrice(${index}, this.value)"
                                   style="width: 100px; padding: 10px 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-weight: 600; font-size: 1rem; color: #0f172a;">
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" 
                                   value="${item.unitSize || ''}" 
                                   min="0"
                                   step="0.1"
                                   onchange="updateUnitSize(${index}, this.value)"
                                   style="width: 80px; padding: 10px 12px; border: 2px solid #cbd5e1; border-radius: 8px; text-align: center; font-weight: 600;"
                                   placeholder="10">
                            <select onchange="updateUnit(${index}, this.value)" 
                                    style="padding: 10px 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-weight: 600;">
                                <option value="ea" ${item.unit === 'ea' ? 'selected' : ''}>Each</option>
                                <option value="lb" ${item.unit === 'lb' ? 'selected' : ''}>lb</option>
                                <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="oz" ${item.unit === 'oz' ? 'selected' : ''}>oz</option>
                                <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                <option value="gal" ${item.unit === 'gal' ? 'selected' : ''}>gal</option>
                                <option value="qt" ${item.unit === 'qt' ? 'selected' : ''}>qt</option>
                                <option value="pt" ${item.unit === 'pt' ? 'selected' : ''}>pt</option>
                                <option value="cup" ${item.unit === 'cup' ? 'selected' : ''}>cup</option>
                                <option value="box" ${item.unit === 'box' ? 'selected' : ''}>box</option>
                                <option value="case" ${item.unit === 'case' ? 'selected' : ''}>case</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" 
                                   value="${item.caseSize || ''}" 
                                   min="1"
                                   step="1"
                                   onchange="updateCaseSize(${index}, this.value)"
                                   style="width: 90px; padding: 10px 12px; border: 2px solid #cbd5e1; border-radius: 8px; text-align: center; font-weight: 600;"
                                   placeholder="12">
                            <span style="font-size: 0.85rem; color: #64748b;">units</span>
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <select class="match-dropdown" onchange="changeMatch(${index}, this.value)" style="padding: 10px 12px; border: 2px solid #cbd5e1; border-radius: 8px; width: 100%; max-width: 300px;">
                            <option value="">-- Select Ingredient --</option>
                            ${ingredientsDatabase.map(ing => `
                                <option value="${ing.id}" ${item.matchedIngredient?.id === ing.id ? 'selected' : ''}>
                                    ${ing.name}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Create ingredient dropdown
        function createIngredientDropdown(item, index) {
            let options = '<option value="">-- Select Ingredient --</option>';
            
            ingredientsDatabase.forEach(ingredient => {
                const selected = item.matchedIngredient && item.matchedIngredient.id === ingredient.id ? 'selected' : '';
                options += `<option value="${ingredient.id}" ${selected}>${ingredient.name} (${ingredient.category})</option>`;
            });

            return options;
        }

        // Get confidence class
        function getConfidenceClass(confidence) {
            if (confidence >= 80) return 'confidence-high';
            if (confidence >= 60) return 'confidence-medium';
            return 'confidence-low';
        }

        // Change match
        function changeMatch(index, ingredientId) {
            if (ingredientId) {
                const ingredient = ingredientsDatabase.find(ing => ing.id == ingredientId);
                priceListData[index].matched = true;
                priceListData[index].matchedIngredient = ingredient;
                priceListData[index].confidence = 100; // Manual match = 100%
            } else {
                priceListData[index].matched = false;
                priceListData[index].matchedIngredient = null;
                priceListData[index].confidence = 0;
            }
            showMatches();
        }

        // Update price
        function updatePrice(index, newPrice) {
            const price = parseFloat(newPrice) || 0;
            priceListData[index].price = price;
            console.log(`‚úÖ Price updated: ${priceListData[index].itemName} = $${price.toFixed(2)}`);
        }

        // Update unit size
        function updateUnitSize(index, newSize) {
            priceListData[index].unitSize = newSize;
            console.log(`‚úÖ Unit size updated: ${priceListData[index].itemName} = ${newSize}`);
        }

        // Update unit
        function updateUnit(index, newUnit) {
            priceListData[index].unit = newUnit;
            console.log(`‚úÖ Unit updated: ${priceListData[index].itemName} = ${newUnit}`);
        }

        // Update case size
        function updateCaseSize(index, newCaseSize) {
            const caseSize = parseInt(newCaseSize) || null;
            priceListData[index].caseSize = caseSize;
            console.log(`‚úÖ Case size updated: ${priceListData[index].itemName} = ${caseSize} units`);
        }

        // Filter functions
        function showMatched() {
            currentFilter = 'matched';
            renderTable();
        }

        function showUnmatched() {
            currentFilter = 'unmatched';
            renderTable();
        }

        function showAll() {
            currentFilter = 'all';
            renderTable();
        }

        // Save matches
        function saveMatches() {
            const matchedItems = priceListData.filter(item => item.matched);
            
            if (matchedItems.length === 0) {
                alert('‚ö†Ô∏è No matches to save! Please match at least one item.');
                return;
            }

            if (confirm(`Save ${matchedItems.length} price updates to your ingredients?`)) {
                // Save to localStorage (or send to API)
                const priceUpdates = matchedItems.map(item => ({
                    ingredientId: item.matchedIngredient.id,
                    ingredientName: item.matchedIngredient.name,
                    vendorItem: item.itemName,
                    sku: item.sku,
                    unitSize: item.unitSize,
                    unit: item.unit,
                    price: item.price,
                    updatedAt: new Date().toISOString()
                }));

                const existingPrices = JSON.parse(localStorage.getItem('price_history') || '[]');
                existingPrices.push(...priceUpdates);
                localStorage.setItem('price_history', JSON.stringify(existingPrices));

                // Track analytics
                if (window.analyticsTracker) {
                    window.analyticsTracker.trackCustomEvent('price_list_imported', {
                        items_matched: matchedItems.length,
                        items_total: priceListData.length
                    });
                }

                alert(`‚úÖ Successfully imported ${matchedItems.length} price updates!`);
                resetUpload();
            }
        }

        // Cancel import
        function cancelImport() {
            if (confirm('Discard this price list?')) {
                resetUpload();
            }
        }

        // Reset upload
        function resetUpload() {
            priceListData = [];
            document.getElementById('matchingSection').classList.remove('active');
            document.getElementById('loadingState').classList.remove('active');
            document.querySelector('.upload-section').style.display = 'block';
            document.getElementById('fileInput').value = '';
        }

        // Download template
        function downloadTemplate() {
            const template = `Item Name,SKU/Code,Unit Size,Unit,Price
Chicken Breast Boneless,CHK-001,5,lb,12.99
Olive Oil Extra Virgin,OIL-002,1,gal,24.50
Roma Tomatoes,PRD-003,25,lb,18.75
All Purpose Flour,DRY-004,50,lb,22.00
Sea Salt Fine,SZN-005,5,lb,8.99
`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'price-list-template.csv';
            a.click();
            URL.revokeObjectURL(url);

            // Track analytics
            if (window.analyticsTracker) {
                window.analyticsTracker.trackCustomEvent('template_downloaded', {
                    template_type: 'price_list'
                });
            }
        }
    </script>
</body>
</html>

