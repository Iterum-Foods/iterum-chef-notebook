<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Orders - Iterum R&D</title>
    
    <!-- Authentication Guard -->
    <script src="assets/js/auth_guard.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            background: linear-gradient(135deg, #4a7c2c, #6ba83d);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(74, 124, 44, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4a7c2c;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c, #6ba83d);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 44, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .orders-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #4a7c2c, #6ba83d);
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-submitted {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-received {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #4a7c2c, #6ba83d);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4a7c2c;
            box-shadow: 0 0 0 3px rgba(74, 124, 44, 0.1);
        }
        
        .order-items-table {
            margin: 20px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .add-item-row {
            background: #f9fafb;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: end;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1 style="margin: 0 0 10px 0; font-size: 32px; font-weight: 800;">
                        üõí Purchase Orders
                    </h1>
                    <p style="margin: 0; opacity: 0.9;">
                        Manage vendor orders, track deliveries, and update inventory
                    </p>
                </div>
                <a href="index.html" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border: 2px solid white;">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="order-stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-total-orders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-pending-orders">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-received-orders">0</div>
                <div class="stat-label">Received</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total-value">$0</div>
                <div class="stat-label">Total Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-pending-value">$0</div>
                <div class="stat-label">Pending Value</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openCreateOrderModal()">
                ‚ûï Create New Order
            </button>
            <button class="btn btn-secondary" onclick="showLowStockSuggestions()">
                üìä Low Stock Alerts
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='vendor-management.html'">
                üè™ Manage Vendors
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='ingredients.html'">
                ü•¨ Manage Ingredients
            </button>
            <button class="btn btn-secondary" onclick="exportAllOrders()">
                üì§ Export All
            </button>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <table>
                <thead>
                    <tr>
                        <th>PO Number</th>
                        <th>Vendor</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-tbody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">
                            No purchase orders yet. Create your first order!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="create-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">
                    ‚ûï Create Purchase Order
                </h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">
                    Select vendor and add items
                </p>
            </div>
            <div class="modal-body">
                <form id="create-order-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Vendor *</label>
                            <select id="order-vendor" class="form-input" required>
                                <option value="">Select vendor...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Delivery</label>
                            <input type="date" id="order-delivery-date" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Order Notes</label>
                        <textarea id="order-notes" class="form-input" rows="2" 
                                  placeholder="Special instructions, delivery notes..."></textarea>
                    </div>

                    <!-- Order Items Section -->
                    <div class="form-group">
                        <label class="form-label">Order Items</label>
                        <div class="order-items-table">
                            <table>
                                <thead>
                                    <tr style="background: #f3f4f6;">
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;">Item</th>
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;">Qty</th>
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;">Unit</th>
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;">Price</th>
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;">Total</th>
                                        <th style="padding: 12px; background: #f3f4f6; color: #374151;"></th>
                                    </tr>
                                </thead>
                                <tbody id="order-items-list">
                                    <!-- Items will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr style="border-top: 2px solid #e5e7eb;">
                                        <td colspan="4" style="text-align: right; font-weight: 600; padding: 12px;">Subtotal:</td>
                                        <td id="order-subtotal" style="font-weight: 700; color: #4a7c2c; padding: 12px;">$0.00</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" style="text-align: right; font-weight: 600; padding: 12px;">Tax (8%):</td>
                                        <td id="order-tax" style="font-weight: 700; color: #4a7c2c; padding: 12px;">$0.00</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" style="text-align: right; font-weight: 600; padding: 12px;">Shipping:</td>
                                        <td style="padding: 12px;">
                                            <input type="number" id="order-shipping" value="0" step="0.01" 
                                                   style="width: 100px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px;"
                                                   onchange="recalculateOrderTotal()">
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr style="background: #f0f9ff;">
                                        <td colspan="4" style="text-align: right; font-weight: 700; padding: 12px; font-size: 18px;">TOTAL:</td>
                                        <td id="order-total" style="font-weight: 800; color: #4a7c2c; padding: 12px; font-size: 20px;">$0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            
                            <!-- Add Item Row -->
                            <div class="add-item-row">
                                <div style="flex: 2;">
                                    <select id="add-item-ingredient" class="form-input" style="margin: 0;">
                                        <option value="">Select ingredient...</option>
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" id="add-item-quantity" class="form-input" 
                                           placeholder="Qty" step="0.01" style="margin: 0;">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" id="add-item-price" class="form-input" 
                                           placeholder="Price" step="0.01" style="margin: 0;">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addItemToCurrentOrder()" style="margin: 0;">
                                    ‚ûï Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn btn-primary" onclick="saveDraftOrder()" style="flex: 1;">
                            üíæ Save as Draft
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1; background: #10b981;">
                            ‚úì Submit Order
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeCreateOrderModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Order Modal -->
    <div id="view-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;" id="view-order-title">
                    Purchase Order Details
                </h2>
            </div>
            <div class="modal-body" id="view-order-content">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth_lite.js"></script>
    <script src="assets/js/ordering-system.js"></script>
    
    <script>
        let currentOrderDraft = null;
        let vendorsList = [];
        let ingredientsList = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadVendors();
            loadIngredients();
            loadOrders();
            updateStats();
        });

        // Load vendors for dropdown
        function loadVendors() {
            const userId = window.authLite?.getCurrentUser()?.id;
            const key = userId ? `vendors_${userId}` : 'vendors';
            vendorsList = JSON.parse(localStorage.getItem(key) || '[]');
            
            const vendorSelect = document.getElementById('order-vendor');
            vendorSelect.innerHTML = '<option value="">Select vendor...</option>';
            
            vendorsList.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.id;
                option.textContent = `${vendor.company || vendor.name} - ${vendor.name}`;
                vendorSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${vendorsList.length} vendors`);
        }

        // Load ingredients for dropdown
        function loadIngredients() {
            const userId = window.authLite?.getCurrentUser()?.id;
            const key = userId ? `ingredients_${userId}` : 'iterum_ingredients';
            ingredientsList = JSON.parse(localStorage.getItem(key) || '[]');
            
            console.log(`‚úÖ Loaded ${ingredientsList.length} ingredients`);
        }

        // Update vendor-specific ingredients in dropdown
        function updateIngredientsForVendor(vendorName) {
            const ingredientSelect = document.getElementById('add-item-ingredient');
            ingredientSelect.innerHTML = '<option value="">Select ingredient...</option>';
            
            // Filter ingredients by selected vendor
            const vendorIngredients = ingredientsList.filter(ing => 
                ing.primaryVendor === vendorName ||
                ing.vendor_info?.primaryVendor === vendorName ||
                ing.vendor_info?.alternateVendors?.includes(vendorName)
            );
            
            // If no vendor-specific ingredients, show all
            const ingredientsToShow = vendorIngredients.length > 0 ? vendorIngredients : ingredientsList;
            
            ingredientsToShow.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = `${ing.name} (${ing.default_unit || 'ea'})`;
                option.dataset.price = ing.vendor_info?.unitPrice || 0;
                option.dataset.unit = ing.default_unit || 'ea';
                ingredientSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Showing ${ingredientsToShow.length} ingredients for ${vendorName}`);
        }

        // Vendor selection changed
        document.addEventListener('DOMContentLoaded', () => {
            const vendorSelect = document.getElementById('order-vendor');
            if (vendorSelect) {
                vendorSelect.addEventListener('change', (e) => {
                    const vendorId = e.target.value;
                    if (vendorId) {
                        const vendor = vendorsList.find(v => v.id == vendorId);
                        if (vendor) {
                            updateIngredientsForVendor(vendor.name);
                        }
                    }
                });
            }

            // Auto-fill price when ingredient selected
            const ingredientSelect = document.getElementById('add-item-ingredient');
            if (ingredientSelect) {
                ingredientSelect.addEventListener('change', (e) => {
                    const option = e.target.selectedOptions[0];
                    if (option && option.dataset.price) {
                        document.getElementById('add-item-price').value = option.dataset.price;
                    }
                });
            }
        });

        // Open create order modal
        function openCreateOrderModal() {
            currentOrderDraft = {
                items: [],
                subtotal: 0,
                tax: 0,
                shipping: 0,
                total: 0
            };
            
            document.getElementById('create-order-modal').classList.add('active');
            document.getElementById('order-items-list').innerHTML = '';
            updateOrderTotals();
        }

        // Close create order modal
        function closeCreateOrderModal() {
            document.getElementById('create-order-modal').classList.remove('active');
            currentOrderDraft = null;
        }

        // Add item to current order
        function addItemToCurrentOrder() {
            const ingredientSelect = document.getElementById('add-item-ingredient');
            const ingredientId = ingredientSelect.value;
            const quantity = parseFloat(document.getElementById('add-item-quantity').value);
            const price = parseFloat(document.getElementById('add-item-price').value);

            if (!ingredientId || !quantity || !price) {
                alert('Please fill in all fields');
                return;
            }

            const ingredient = ingredientsList.find(ing => ing.id == ingredientId);
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }

            const item = {
                id: Date.now(),
                ingredientId: ingredientId,
                ingredientName: ingredient.name,
                quantity: quantity,
                unit: ingredient.default_unit || 'ea',
                unitPrice: price,
                lineTotal: quantity * price,
                vendorSKU: ingredient.vendor_info?.vendorSKU || ''
            };

            currentOrderDraft.items.push(item);
            addItemToTable(item);
            updateOrderTotals();

            // Clear form
            document.getElementById('add-item-quantity').value = '';
            document.getElementById('add-item-price').value = '';
        }

        // Add item to table display
        function addItemToTable(item) {
            const tbody = document.getElementById('order-items-list');
            const row = document.createElement('tr');
            row.dataset.itemId = item.id;
            row.innerHTML = `
                <td style="padding: 12px;">${item.ingredientName}</td>
                <td style="padding: 12px;">${item.quantity}</td>
                <td style="padding: 12px;">${item.unit}</td>
                <td style="padding: 12px;">$${item.unitPrice.toFixed(2)}</td>
                <td style="padding: 12px; font-weight: 600;">$${item.lineTotal.toFixed(2)}</td>
                <td style="padding: 12px;">
                    <button type="button" onclick="removeOrderItem(${item.id})" 
                            style="color: #ef4444; background: none; border: none; cursor: pointer; font-size: 18px;">
                        √ó
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        // Remove item from order
        function removeOrderItem(itemId) {
            currentOrderDraft.items = currentOrderDraft.items.filter(item => item.id !== itemId);
            document.querySelector(`tr[data-item-id="${itemId}"]`).remove();
            updateOrderTotals();
        }

        // Update order totals
        function updateOrderTotals() {
            const subtotal = currentOrderDraft.items.reduce((sum, item) => sum + item.lineTotal, 0);
            const tax = subtotal * 0.08;
            const shipping = parseFloat(document.getElementById('order-shipping')?.value || 0);
            const total = subtotal + tax + shipping;

            currentOrderDraft.subtotal = subtotal;
            currentOrderDraft.tax = tax;
            currentOrderDraft.shipping = shipping;
            currentOrderDraft.total = total;

            document.getElementById('order-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('order-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
        }

        // Recalculate when shipping changes
        function recalculateOrderTotal() {
            updateOrderTotals();
        }

        // Save as draft
        function saveDraftOrder() {
            if (!currentOrderDraft || currentOrderDraft.items.length === 0) {
                alert('Add at least one item to save order');
                return;
            }

            const vendorId = document.getElementById('order-vendor').value;
            const deliveryDate = document.getElementById('order-delivery-date').value;
            const notes = document.getElementById('order-notes').value;

            const vendor = vendorsList.find(v => v.id == vendorId);
            if (!vendor) {
                alert('Please select a vendor');
                return;
            }

            const order = {
                ...window.orderingSystem.createPurchaseOrder(vendor.id, deliveryDate, notes),
                items: currentOrderDraft.items,
                subtotal: currentOrderDraft.subtotal,
                tax: currentOrderDraft.tax,
                shipping: currentOrderDraft.shipping,
                total: currentOrderDraft.total
            };

            window.orderingSystem.purchaseOrders.push(order);
            window.orderingSystem.saveOrders();

            alert(`‚úÖ Order ${order.poNumber} saved as draft!`);
            closeCreateOrderModal();
            loadOrders();
            updateStats();
        }

        // Submit order form
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('create-order-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    if (!currentOrderDraft || currentOrderDraft.items.length === 0) {
                        alert('Add at least one item to submit order');
                        return;
                    }

                    const vendorId = document.getElementById('order-vendor').value;
                    const deliveryDate = document.getElementById('order-delivery-date').value;
                    const notes = document.getElementById('order-notes').value;

                    const vendor = vendorsList.find(v => v.id == vendorId);
                    if (!vendor) {
                        alert('Please select a vendor');
                        return;
                    }

                    const order = {
                        ...window.orderingSystem.createPurchaseOrder(vendor.id, deliveryDate, notes),
                        items: currentOrderDraft.items,
                        subtotal: currentOrderDraft.subtotal,
                        tax: currentOrderDraft.tax,
                        shipping: currentOrderDraft.shipping,
                        total: currentOrderDraft.total,
                        status: 'submitted',
                        submittedAt: new Date().toISOString()
                    };

                    window.orderingSystem.purchaseOrders.push(order);
                    window.orderingSystem.saveOrders();

                    alert(`‚úÖ Order ${order.poNumber} submitted successfully!`);
                    closeCreateOrderModal();
                    loadOrders();
                    updateStats();
                });
            }
        });

        // Load and display orders
        function loadOrders() {
            if (!window.orderingSystem) {
                setTimeout(loadOrders, 100);
                return;
            }

            const orders = window.orderingSystem.purchaseOrders;
            const tbody = document.getElementById('orders-tbody');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">
                            No purchase orders yet. Create your first order!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .map(order => `
                    <tr>
                        <td style="font-weight: 600;">${order.poNumber}</td>
                        <td>${order.vendorCompany || order.vendorName}</td>
                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td>${order.items.length} items</td>
                        <td style="font-weight: 600;">$${order.total.toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></td>
                        <td>
                            <button onclick="viewOrder('${order.id}')" class="btn-sm" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                üëÅÔ∏è View
                            </button>
                            ${order.status === 'submitted' ? `
                                <button onclick="receiveOrder('${order.id}')" class="btn-sm" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                    ‚úì Receive
                                </button>
                            ` : ''}
                            <button onclick="printOrder('${order.id}')" class="btn-sm" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üñ®Ô∏è Print
                            </button>
                        </td>
                    </tr>
                `).join('');
        }

        // Update statistics
        function updateStats() {
            if (!window.orderingSystem) {
                setTimeout(updateStats, 100);
                return;
            }

            const stats = window.orderingSystem.getOrderStats();
            
            document.getElementById('stat-total-orders').textContent = stats.total;
            document.getElementById('stat-pending-orders').textContent = stats.submitted;
            document.getElementById('stat-received-orders').textContent = stats.received;
            document.getElementById('stat-total-value').textContent = `$${stats.totalValue.toFixed(0)}`;
            document.getElementById('stat-pending-value').textContent = `$${stats.pendingValue.toFixed(0)}`;
        }

        // View order details
        function viewOrder(orderId) {
            const order = window.orderingSystem.purchaseOrders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }

            const modal = document.getElementById('view-order-modal');
            const title = document.getElementById('view-order-title');
            const content = document.getElementById('view-order-content');

            title.textContent = `Purchase Order ${order.poNumber}`;
            content.innerHTML = window.orderingSystem.generatePurchaseOrderHTML(order);
            
            modal.classList.add('active');
        }

        // Receive order
        function receiveOrder(orderId) {
            if (!confirm('Mark this order as received and update inventory?')) {
                return;
            }

            window.orderingSystem.receivePurchaseOrder(orderId);
            alert('‚úÖ Order received! Inventory has been updated.');
            loadOrders();
            updateStats();
        }

        // Print order
        function printOrder(orderId) {
            window.orderingSystem.exportOrderToPDF(orderId);
        }

        // Show low stock suggestions
        function showLowStockSuggestions() {
            const lowStock = window.orderingSystem.getLowStockIngredients(10);
            
            if (lowStock.length === 0) {
                alert('‚úÖ All ingredients are well-stocked!');
                return;
            }

            const message = `‚ö†Ô∏è Low Stock Alert\n\n${lowStock.length} ingredients are running low:\n\n` +
                lowStock.map(item => `‚Ä¢ ${item.ingredientName}: ${item.quantity} ${item.unit}`).join('\n') +
                `\n\nWould you like to create a purchase order?`;

            if (confirm(message)) {
                openCreateOrderModal();
            }
        }

        // Export all orders
        function exportAllOrders() {
            alert('Export feature coming soon!');
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

