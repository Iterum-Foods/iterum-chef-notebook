<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe PDF Upload | Iterum R&D Chef Notebook</title>
  
  <!-- Load Auth System -->
  <script src="assets/js/firebase-config.js"></script>
  <script src="assets/js/auth-manager.js"></script>
  <script src="assets/js/auth-api-helper.js"></script>
  <script src="assets/js/auth-diagnostics.js"></script>
  
  <!-- Tailwind CSS - Built from source -->
  <link rel="stylesheet" href="assets/css/tailwind-output.css">
  <link rel="stylesheet" href="assets/css/iterum-design-system.css">
  <link rel="stylesheet" href="assets/css/premium-ui-system.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    /* Recipe Upload Page Specific Styles */
    .upload-section, .test-section {
      margin-bottom: 2rem;
    }
    
    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .parsing-results {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f8fafc;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
    }
    
    .parsing-results.hidden {
      display: none;
    }
    
    .parsed-section {
      margin-bottom: 1.5rem;
    }
    
    .parsed-section:last-child {
      margin-bottom: 0;
    }
    
    .ingredients-list, .instructions-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .ingredient-item {
      padding: 0.75rem;
      background: white;
      border-radius: 0.375rem;
      border: 1px solid #e2e8f0;
    }
    
    .ingredient-text {
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }
    
    .ingredient-parsed {
      display: flex;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    }
    
    .amount {
      font-weight: 600;
      color: #059669;
    }
    
    .unit {
      font-weight: 500;
      color: #7c3aed;
    }
    
    .name {
      color: #374151;
    }
    
    .instruction-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      background: white;
      border-radius: 0.375rem;
      border: 1px solid #e2e8f0;
    }
    
    .step-number {
      font-weight: 700;
      color: #059669;
      min-width: 2rem;
    }
    
    .instruction-text {
      color: #1e293b;
      line-height: 1.5;
    }
    
    .metadata-item {
      padding: 0.5rem;
      background: white;
      border-radius: 0.375rem;
      border: 1px solid #e2e8f0;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    
    .metadata-item strong {
      color: #059669;
    }
    
    /* Loading states */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* File input styling */
    .form-input[type="file"] {
      padding: 0.5rem;
      border: 2px dashed #cbd5e1;
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .form-input[type="file"]:hover {
      border-color: #94a3b8;
      background: #f1f5f9;
    }
    
    .form-input[type="file"]:focus {
      border-color: #3b82f6;
      background: white;
    }
    
    /* Success message */
    .upload-success {
      background: #dcfce7;
      border: 1px solid #22c55e;
      color: #166534;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      display: none;
    }
    
    .upload-success.show {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Uniform Centered Header -->
  <header class="iterum-header">
    <div class="header-container">
      <!-- Logo Section -->
      <a href="index.html" class="header-logo">
        <div class="header-logo-icon">
          <span>üçÉ</span>
        </div>
        <div class="header-logo-text">
          <div class="header-logo-title">Iterum R&D</div>
          <div class="header-logo-subtitle">Chef Notebook</div>
        </div>
      </a>

      <!-- Center Navigation -->
      <nav class="header-navigation">
        <a href="index.html" class="header-nav-item" data-page="index">
          <span class="nav-icon">üè†</span>
          <span>Dashboard</span>
        </a>
        <a href="recipe-library.html" class="header-nav-item" data-page="recipe-library">
          <span class="nav-icon">üìö</span>
          <span>Library</span>
        </a>
        <a href="recipe-developer.html" class="header-nav-item" data-page="recipe-developer">
          <span class="nav-icon">üß™</span>
          <span>Developer</span>
        </a>
        <a href="recipe-upload.html" class="header-nav-item active" data-page="recipe-upload">
          <span class="nav-icon">‚ö°</span>
          <span>Upload</span>
        </a>
        <a href="menu-builder.html" class="header-nav-item" data-page="menu-builder">
          <span class="nav-icon">üçΩÔ∏è</span>
          <span>Menu</span>
        </a>
        <a href="ingredients.html" class="header-nav-item" data-page="ingredients">
          <span class="nav-icon">ü•¨</span>
          <span>Ingredients</span>
        </a>
        <a href="equipment-management.html" class="header-nav-item" data-page="equipment-management">
          <span class="nav-icon">üîß</span>
          <span>Equipment</span>
        </a>
        <a href="vendor-management.html" class="header-nav-item" data-page="vendor-management">
          <span class="nav-icon">üè™</span>
          <span>Vendors</span>
        </a>
      </nav>

      <!-- Right Side - User Section -->
      <div class="header-user-section">
                        <!-- Project Selector -->
                <div class="header-project-selector-container">
                    <div class="project-selector-display" onclick="window.showProjectSelectionDropdown()">
                        <div class="project-selector-current">
                            <span class="project-selector-icon">üìã</span>
                            <span class="project-selector-name" data-project-name>Master Project</span>
                            <svg class="project-selector-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <div class="project-status-display">
                            <span class="project-status-label">Current:</span>
                            <span class="project-status-value" data-project-name>Master Project</span>
                        </div>
                    </div>
                </div>

        <!-- User Info Tab -->
        <div class="header-user-tab" onclick="toggleUserDropdown()">
          <div class="header-user-avatar" id="user-avatar">
            <span id="user-avatar-initial">üë§</span>
          </div>
          <div class="header-user-info">
            <div class="header-user-name" id="current-user">Guest User</div>
            <div class="header-user-role">Chef</div>
          </div>
          <svg class="header-user-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>

        <!-- Storage Control Button -->
        <button onclick="showStorageControl()" class="btn btn-success btn-sm" title="Storage Control" style="margin-left: 0.5rem;">
          <span>üóÇÔ∏è</span>
          <span>Storage</span>
        </button>

        <!-- User Dropdown Menu -->
        <div class="header-user-dropdown" id="user-dropdown">
          <div class="header-user-dropdown-header">
            <div class="header-user-dropdown-title" id="dropdown-user-name">Guest User</div>
            <div class="header-user-dropdown-subtitle" id="dropdown-user-role">Chef</div>
          </div>
          
          <div class="header-user-dropdown-menu">
            <div class="header-user-dropdown-item" onclick="userSystem.showUserModal()">
              <span>üë§</span>
              <span>Edit Profile</span>
            </div>
            <div class="header-user-dropdown-item" onclick="window.switchUser()">
              <span>üîÑ</span>
              <span>Switch User</span>
            </div>
            <div class="header-user-dropdown-item" onclick="userSystem.showUserModal('create')">
              <span>‚ûï</span>
              <span>Create New User</span>
            </div>
          </div>
          
          <div class="header-user-dropdown-divider"></div>
          
          <div class="header-user-dropdown-menu">
            <div class="header-user-dropdown-item" onclick="userSystem.showSettings()">
              <span>‚öôÔ∏è</span>
              <span>Settings</span>
            </div>
            <div class="header-user-dropdown-item danger" onclick="userSystem.logout()">
              <span>üö™</span>
              <span>Sign Out</span>
            </div>
          </div>
          
          <div class="header-user-dropdown-footer">
            <div class="header-user-dropdown-footer-text">Iterum R&D v1.0</div>
          </div>
        </div>

        <!-- Mobile Navigation Toggle -->
        <button class="header-mobile-toggle" onclick="toggleMobileNav()">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>

      <!-- Mobile Navigation -->
      <nav id="mobile-nav" class="header-mobile-nav">
        <!-- Project Selector for Mobile -->
        <div style="margin-bottom: 1rem;">
          <select id="mobile-project-selector" class="header-project-selector" style="width: 100%;">
            <option value="">Select Project...</option>
          </select>
        </div>

        <!-- Mobile Navigation Items -->
        <a href="index.html" class="header-mobile-nav-item" data-page="index">
          <span class="nav-icon">üè†</span>
          <span>Dashboard</span>
        </a>
        <a href="recipe-library.html" class="header-mobile-nav-item" data-page="recipe-library">
          <span class="nav-icon">üìö</span>
          <span>Library</span>
        </a>
        <a href="recipe-developer.html" class="header-mobile-nav-item" data-page="recipe-developer">
          <span class="nav-icon">üß™</span>
          <span>Developer</span>
        </a>
        <a href="recipe-upload.html" class="header-mobile-nav-item active" data-page="recipe-upload">
          <span class="nav-icon">‚ö°</span>
          <span>Upload</span>
        </a>
        <a href="menu-builder.html" class="header-mobile-nav-item" data-page="menu-builder">
          <span class="nav-icon">üçΩÔ∏è</span>
          <span>Menu</span>
        </a>
        <a href="ingredients.html" class="header-mobile-nav-item" data-page="ingredients">
          <span class="nav-icon">ü•¨</span>
          <span>Ingredients</span>
        </a>
        <a href="equipment-management.html" class="header-mobile-nav-item" data-page="equipment-management">
          <span class="nav-icon">üîß</span>
          <span>Equipment</span>
        </a>
        <a href="vendor-management.html" class="header-mobile-nav-item" data-page="vendor-management">
          <span class="nav-icon">üè™</span>
          <span>Vendors</span>
        </a>
      </nav>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h2 class="loading-title">Recipe Upload</h2>
      <p class="loading-subtitle">Loading your recipe workspace...</p>
      <button onclick="emergencyLoadingFix()" class="btn btn-danger">üöë Emergency Exit</button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container">
    <div class="page-header">
      <h1 class="heading-1">‚ö° Recipe PDF Upload</h1>
      <p class="body-large">Upload and process recipe PDFs with AI-powered text extraction</p>
    </div>

    <!-- Recipe Upload Section -->
    <section class="upload-section">
      <div class="iterum-card iterum-card-elevated">
        <div class="iterum-card-header">
          <h2 class="heading-2">Upload Recipe PDF</h2>
          <p class="body-medium">Select a PDF file to upload and process</p>
        </div>
        
        <div class="iterum-card-body">
          <form id="upload-form" class="upload-form">
            <div class="form-group">
              <label for="project-select" class="form-label">Project</label>
              <select id="project-select" class="form-select" required>
                <option value="">Select a project...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="recipe-name" class="form-label">Recipe Name</label>
              <input type="text" id="recipe-name" class="form-input" placeholder="Enter recipe name" required>
            </div>
            
            <div class="form-group">
              <label for="recipe-description" class="form-label">Description</label>
              <textarea id="recipe-description" class="form-textarea" placeholder="Brief description of the recipe" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label for="pdf-file" class="form-label">PDF File</label>
              <input type="file" id="pdf-file" class="form-input" accept=".pdf" required>
              <p class="form-help">Maximum file size: 10MB</p>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span>üì§</span>
                <span>Upload Recipe</span>
              </button>
              <button type="button" class="btn btn-secondary" onclick="clearUploadForm()">
                <span>üóëÔ∏è</span>
                <span>Clear Form</span>
              </button>
            </div>
            
            <!-- Progress Indicator -->
            <div id="upload-progress" class="upload-progress" style="display: none;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span>‚è≥</span>
                <span><strong>Processing PDF...</strong></span>
              </div>
              <div class="progress-bar" style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); width: 0%; transition: width 0.3s ease;"></div>
              </div>
              <div class="progress-text" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                Extracting text from PDF...
              </div>
            </div>

            <!-- Success Message -->
            <div id="upload-success" class="upload-success">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span>‚úÖ</span>
                <span><strong>Recipe uploaded successfully!</strong></span>
              </div>
              <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                Your recipe has been processed and saved. You can now view and edit it in the Recipe Developer.
              </p>
              
              <!-- Enhanced Recipe Details -->
              <div id="recipe-details" style="margin: 1rem 0; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem; border: 1px solid #0ea5e9;">
                <h4 style="margin: 0 0 0.5rem 0; color: #0369a1;">üìã Recipe Summary</h4>
                <div id="recipe-summary" style="font-size: 0.875rem; color: #0c4a6e;">
                  <!-- Recipe details will be populated here -->
                </div>
              </div>
              
              <div style="margin-top: 1rem;">
                <a href="recipe-developer.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                  <span>üß™</span>
                  <span>Go to Recipe Developer</span>
                </a>
                <button onclick="exportRecipeData()" class="btn btn-secondary" style="margin-left: 0.5rem;">
                  <span>üì•</span>
                  <span>Export Recipe</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Test Recipe Parsing Section -->
    <section class="test-section">
      <div class="iterum-card iterum-card-elevated">
        <div class="iterum-card-header">
          <h2 class="heading-2">Test Recipe Parsing</h2>
          <p class="body-medium">Test the recipe parsing system with sample text</p>
        </div>
        
        <div class="iterum-card-body">
          <div class="form-group">
            <label for="test-recipe-text" class="form-label">Recipe Text</label>
            <textarea id="test-recipe-text" class="form-textarea" placeholder="Paste recipe text here to test parsing..." rows="8"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="testRecipeParsing()">
              <span>üß™</span>
              <span>Test Parsing</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearTestText()">
              <span>üóëÔ∏è</span>
              <span>Clear Text</span>
            </button>
          </div>
          
          <div id="parsing-results" class="parsing-results hidden">
            <h3 class="heading-3">Parsing Results</h3>
            <div id="parsed-ingredients" class="parsed-section">
              <h4 class="heading-4">Ingredients</h4>
              <div id="ingredients-list" class="ingredients-list"></div>
            </div>
            <div id="parsed-instructions" class="parsed-section">
              <h4 class="heading-4">Instructions</h4>
              <div id="instructions-list" class="instructions-list"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
    <!-- Load Firebase Configuration -->
    <script src="assets/js/firebase-config.js"></script>
    
    <!-- Load Firebase Authentication -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    
    <!-- Load Unified Authentication System -->
    <script src="assets/js/unified_auth_system.js"></script>
    
    <!-- Load Page Protection System -->
    <script src="assets/js/page-protection.js"></script>
    
    <!-- Load Header User Synchronization -->
    <script src="assets/js/header_user_sync.js"></script>
    
    <!-- Load Header Sync Loader (ensures sync on all pages) -->
    <script src="assets/js/header_sync_loader.js"></script>
    
    <script src="assets/js/startup-loading-config.js"></script>
    <!-- Enhanced User Management now handled by Firebase Auth -->
    <script src="assets/js/project-management-system.js"></script>
    <script src="assets/js/error_handler.js"></script>
    <script src="assets/js/userControlledStorage.js"></script>
  
  <script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing Recipe Upload Page');
      
      // User system now initializes automatically
      console.log('üîç User system auto-initialization enabled');
      
      // Initialize project manager
      if (window.projectManager) {
        window.projectManager.init();
      }
      
      // Initialize upload form
      initializeRecipeUpload();
      
      // Listen for user authentication events to keep header synchronized
      document.addEventListener('userLoggedIn', function(event) {
        console.log('üîê User logged in event received on recipe upload page');
        if (event.detail && event.detail.user) {
          updateUserInfo();
          initializeProjectSelector();
        }
      });
      
      document.addEventListener('userSwitched', function(event) {
        console.log('üîÑ User switched event received on recipe upload page');
        if (event.detail && event.detail.user) {
          updateUserInfo();
          initializeProjectSelector();
        }
      });
      
      // Listen for project changes
      document.addEventListener('projectChanged', function(event) {
        console.log('üìã Project changed event received on recipe upload page');
        if (event.detail && event.detail.project) {
          // Update project selectors to show current selection
          const projectSelect = document.getElementById('project-select');
          const headerSelector = document.getElementById('header-project-selector');
          const mobileSelector = document.getElementById('mobile-project-selector');
          
          [projectSelect, headerSelector, mobileSelector].forEach(selector => {
            if (selector && event.detail.project) {
              selector.value = event.detail.project.id;
            }
          });
        }
      });
      
      console.log('‚úÖ Recipe Upload Page initialized');
    });

    // User dropdown toggle
    function toggleUserDropdown() {
      const dropdown = document.getElementById('user-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    // Mobile navigation toggle
    function toggleMobileNav() {
      const mobileNav = document.getElementById('mobile-nav');
      if (mobileNav) {
        mobileNav.classList.toggle('show');
      }
    }

    // Initialize recipe upload functionality
    function initializeRecipeUpload() {
      const uploadForm = document.getElementById('upload-form');
      if (uploadForm) {
        uploadForm.addEventListener('submit', handleUploadSubmit);
      }
      
      // Update user info
      updateUserInfo();
      
      // Initialize project selector
      initializeProjectSelector();
    }

    // Handle upload form submission
    function handleUploadSubmit(event) {
      event.preventDefault();
      console.log('üì§ Upload form submitted');
      
      // Get form data
      const projectId = document.getElementById('project-select').value;
      const recipeName = document.getElementById('recipe-name').value;
      const recipeDescription = document.getElementById('recipe-description').value;
      const pdfFile = document.getElementById('pdf-file').files[0];
      
      // Enhanced form validation
      const validationErrors = [];
      
      if (!projectId) {
        validationErrors.push('Please select a project');
      }
      
      if (!recipeName.trim()) {
        validationErrors.push('Please enter a recipe name');
      } else if (recipeName.trim().length < 3) {
        validationErrors.push('Recipe name must be at least 3 characters long');
      }
      
      if (!pdfFile) {
        validationErrors.push('Please select a PDF file');
      } else {
        // Validate file size (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (pdfFile.size > maxSize) {
          validationErrors.push('File size exceeds 10MB limit. Please select a smaller file.');
        }
        
        // Validate file type
        if (pdfFile.type !== 'application/pdf') {
          validationErrors.push('Please select a valid PDF file');
        }
        
        // Check if file is corrupted or empty
        if (pdfFile.size === 0) {
          validationErrors.push('Selected file appears to be empty');
        }
      }
      
      // Show validation errors if any
      if (validationErrors.length > 0) {
        const errorMessage = validationErrors.join('\n‚Ä¢ ');
        alert('Please fix the following errors:\n\n‚Ä¢ ' + errorMessage);
        return;
      }
      
      // Show loading state
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.innerHTML = '<span>‚è≥</span><span>Processing...</span>';
      submitButton.disabled = true;
      
      // Show progress indicator
      const progressDiv = document.getElementById('upload-progress');
      const progressFill = document.querySelector('.progress-fill');
      const progressText = document.querySelector('.progress-text');
      if (progressDiv) {
        progressDiv.style.display = 'block';
        document.getElementById('upload-success').classList.remove('show');
      }
      
      try {
        // Process the PDF file
        processPDFFile(pdfFile, recipeName, recipeDescription, projectId)
          .then(result => {
            console.log('‚úÖ PDF processed successfully:', result);
            
            // Show success message
            const successMessage = document.getElementById('upload-success');
            if (successMessage) {
              successMessage.classList.add('show');
              successMessage.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Show enhanced success details
            showUploadSuccessDetails(result.recipe);
            
            // Clear form
            clearUploadForm();
            
            // Reset button
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
          })
          .catch(error => {
            console.error('‚ùå PDF processing failed:', error);
            alert('Failed to process PDF: ' + error.message);
            
            // Hide progress indicator on error
            const progressDiv = document.getElementById('upload-progress');
            if (progressDiv) {
              progressDiv.style.display = 'none';
            }
            
            // Reset button
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
          });
      } catch (error) {
        console.error('‚ùå Upload error:', error);
        alert('Upload failed: ' + error.message);
        
        // Reset button
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
      }
    }
    
    // Process PDF file
    async function processPDFFile(file, recipeName, description, projectId) {
      return new Promise((resolve, reject) => {
        try {
          const reader = new FileReader();
          
          reader.onload = function(event) {
            try {
              const arrayBuffer = event.target.result;
              
              // Use PDF.js to extract text
              pdfjsLib.getDocument({data: arrayBuffer}).promise.then(function(pdf) {
                console.log('üìÑ PDF loaded, pages:', pdf.numPages);
                
                let fullText = '';
                let pagesProcessed = 0;
                const totalPages = pdf.numPages;
                
                // Update progress
                if (progressText) {
                  progressText.textContent = `Processing PDF with ${totalPages} pages...`;
                }
                
                // Extract text from each page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                  pdf.getPage(pageNum).then(function(page) {
                    page.getTextContent().then(function(textContent) {
                      const pageText = textContent.items.map(item => item.str).join(' ');
                      fullText += pageText + '\n';
                      pagesProcessed++;
                      
                      // Update progress
                      if (progressFill && progressText) {
                        const progressPercent = (pagesProcessed / totalPages) * 100;
                        progressFill.style.width = progressPercent + '%';
                        progressText.textContent = `Processed ${pagesProcessed} of ${totalPages} pages...`;
                      }
                      
                      // When all pages are processed
                      if (pagesProcessed === pdf.numPages) {
                        console.log('üìù Full text extracted:', fullText.length, 'characters');
                        
                        // Update progress to completion
                        if (progressFill && progressText) {
                          progressFill.style.width = '100%';
                          progressText.textContent = 'Saving recipe to storage...';
                        }
                        
                        // Create recipe object
                        const recipe = {
                          id: 'recipe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                          name: recipeName,
                          description: description,
                          projectId: projectId,
                          sourceFile: file.name,
                          uploadedAt: new Date().toISOString(),
                          rawText: fullText,
                          status: 'uploaded',
                          type: 'pdf_upload'
                        };
                        
                        // Save recipe to storage
                        saveRecipeToStorage(recipe);
                        
                        // Hide progress indicator
                        if (progressDiv) {
                          progressDiv.style.display = 'none';
                        }
                        
                        resolve({
                          success: true,
                          recipe: recipe,
                          textLength: fullText.length,
                          pages: pdf.numPages
                        });
                      }
                    });
                  });
                }
              }).catch(function(error) {
                reject(new Error('Failed to process PDF: ' + error.message));
              });
              
            } catch (error) {
              reject(new Error('Failed to read file: ' + error.message));
            }
          };
          
          reader.onerror = function() {
            reject(new Error('Failed to read file'));
          };
          
          // Read file as array buffer
          reader.readAsArrayBuffer(file);
          
        } catch (error) {
          reject(new Error('File processing error: ' + error.message));
        }
      });
    }
    
    // Save recipe to storage
    function saveRecipeToStorage(recipe) {
      try {
        // Get current user from user system
        let currentUser = null;
        if (window.userSystem) {
          currentUser = window.userSystem.getCurrentUser();
        }
        
        if (!currentUser) {
          // Fallback to localStorage
          const storedUser = localStorage.getItem('current_user');
          if (storedUser) {
            currentUser = JSON.parse(storedUser);
          }
        }
        
        if (currentUser) {
          const userId = currentUser.id;
          
          // Enhanced recipe object with more metadata
          const enhancedRecipe = {
            ...recipe,
            userId: userId,
            userName: currentUser.name,
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            version: 1,
            status: 'uploaded',
            type: 'pdf_upload',
            source: 'recipe_upload_page',
            projectId: recipe.projectId || 'master',
            complexity: calculateRecipeComplexity(recipe),
            estimatedPrepTime: estimatePrepTime(recipe),
            tags: generateRecipeTags(recipe)
          };
          
          // Save to multiple storage systems for redundancy
          
          // 1. Primary storage (localStorage)
          const storageKey = `user_${userId}_recipes`;
          let recipes = [];
          const existing = localStorage.getItem(storageKey);
          if (existing) {
            recipes = JSON.parse(existing);
          }
          recipes.push(enhancedRecipe);
          localStorage.setItem(storageKey, JSON.stringify(recipes));
          
          // 2. User-controlled storage system
          if (window.userControlledStorage) {
            // Save to user-specific file storage
            const success = window.userControlledStorage.saveUserFile(`${userId}/recipes.json`, recipes);
            if (success) {
              console.log('‚úÖ Recipe saved to user-controlled storage');
            }
            
            // Also save to project-specific storage if project is selected
            if (recipe.projectId && recipe.projectId !== 'master') {
              const projectKey = `user_${userId}_project_${recipe.projectId}_recipes.json`;
              window.userControlledStorage.saveUserFile(projectKey, [enhancedRecipe]);
            }
          }
          
          // 3. Project-aware storage
          if (window.projectManager && window.projectManager.currentProject) {
            const projectKey = `data_recipes_${window.projectManager.currentProject.id}`;
            let projectRecipes = [];
            const existingProject = localStorage.getItem(projectKey);
            if (existingProject) {
              projectRecipes = JSON.parse(existingProject);
            }
            projectRecipes.push(enhancedRecipe);
            localStorage.setItem(projectKey, JSON.stringify(projectRecipes));
          }
          
          console.log('‚úÖ Recipe saved to multiple storage systems for user:', userId);
          console.log('üìä Total recipes for user:', recipes.length);
          
          // Dispatch events for other components
          window.dispatchEvent(new CustomEvent('recipeUploaded', {
            detail: { recipe: enhancedRecipe, userId: userId }
          }));
          
          // Dispatch data saved event for storage system
          window.dispatchEvent(new CustomEvent('dataSaved', {
            detail: { dataType: 'recipes', data: recipes }
          }));
          
          return enhancedRecipe;
          
        } else {
          console.warn('‚ö†Ô∏è No current user found, cannot save recipe');
          throw new Error('No user logged in');
        }
      } catch (error) {
        console.error('‚ùå Error saving recipe to storage:', error);
        throw error;
      }
    }

    // Calculate recipe complexity based on content
    function calculateRecipeComplexity(recipe) {
      let complexity = 'easy';
      
      if (recipe.rawText) {
        const textLength = recipe.rawText.length;
        const hasComplexInstructions = recipe.rawText.toLowerCase().includes('simmer') || 
                                     recipe.rawText.toLowerCase().includes('braise') ||
                                     recipe.rawText.toLowerCase().includes('reduce');
        
        if (textLength > 2000 || hasComplexInstructions) {
          complexity = 'hard';
        } else if (textLength > 1000) {
          complexity = 'medium';
        }
      }
      
      return complexity;
    }

    // Estimate prep time based on recipe content
    function estimatePrepTime(recipe) {
      let estimatedTime = 30; // Default 30 minutes
      
      if (recipe.rawText) {
        const textLength = recipe.rawText.length;
        const hasComplexSteps = recipe.rawText.toLowerCase().includes('marinate') ||
                               recipe.rawText.toLowerCase().includes('rest') ||
                               recipe.rawText.toLowerCase().includes('chill');
        
        if (textLength > 3000) {
          estimatedTime = 90;
        } else if (textLength > 2000 || hasComplexSteps) {
          estimatedTime = 60;
        } else if (textLength > 1000) {
          estimatedTime = 45;
        }
      }
      
      return estimatedTime;
    }

    // Generate recipe tags based on content
    function generateRecipeTags(recipe) {
      const tags = [];
      
      if (recipe.rawText) {
        const text = recipe.rawText.toLowerCase();
        
        // Cuisine detection
        if (text.includes('italian') || text.includes('pasta') || text.includes('risotto')) {
          tags.push('italian');
        }
        if (text.includes('french') || text.includes('sauce') || text.includes('wine')) {
          tags.push('french');
        }
        if (text.includes('asian') || text.includes('soy') || text.includes('ginger')) {
          tags.push('asian');
        }
        if (text.includes('mexican') || text.includes('chili') || text.includes('tortilla')) {
          tags.push('mexican');
        }
        
        // Cooking method detection
        if (text.includes('grill') || text.includes('bbq')) {
          tags.push('grilled');
        }
        if (text.includes('bake') || text.includes('oven')) {
          tags.push('baked');
        }
        if (text.includes('fry') || text.includes('deep fry')) {
          tags.push('fried');
        }
        if (text.includes('slow cook') || text.includes('crock pot')) {
          tags.push('slow-cooked');
        }
        
        // Dietary tags
        if (text.includes('vegetarian') || text.includes('vegan')) {
          tags.push('vegetarian');
        }
        if (text.includes('gluten-free') || text.includes('gluten free')) {
          tags.push('gluten-free');
        }
        if (text.includes('dairy-free') || text.includes('dairy free')) {
          tags.push('dairy-free');
        }
      }
      
      return tags;
    }

    // Test recipe parsing
    function testRecipeParsing() {
      const text = document.getElementById('test-recipe-text').value;
      if (!text.trim()) {
        alert('Please enter some recipe text to test');
        return;
      }
      
      console.log('üß™ Testing recipe parsing with:', text);
      
      try {
        // Parse the recipe text
        const parsedRecipe = parseRecipeText(text);
        
        // Display results
        displayParsingResults(parsedRecipe);
        
        // Show results section
        document.getElementById('parsing-results').classList.remove('hidden');
        
      } catch (error) {
        console.error('‚ùå Recipe parsing failed:', error);
        alert('Failed to parse recipe: ' + error.message);
      }
    }
    
    // Parse recipe text into structured data
    function parseRecipeText(text) {
      const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      
      const recipe = {
        ingredients: [],
        instructions: [],
        metadata: {}
      };
      
      let currentSection = 'metadata';
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        
        // Detect section headers
        if (line.includes('ingredients') || line.includes('ingredient')) {
          currentSection = 'ingredients';
          continue;
        } else if (line.includes('instructions') || line.includes('directions') || line.includes('method')) {
          currentSection = 'instructions';
          continue;
        } else if (line.includes('prep time') || line.includes('cook time') || line.includes('total time')) {
          currentSection = 'metadata';
        }
        
        // Parse based on current section
        switch (currentSection) {
          case 'ingredients':
            if (line.length > 0 && !line.includes('ingredients')) {
              recipe.ingredients.push({
                text: lines[i],
                parsed: parseIngredientLine(lines[i])
              });
            }
            break;
            
          case 'instructions':
            if (line.length > 0 && !line.includes('instructions')) {
              recipe.instructions.push({
                text: lines[i],
                step: recipe.instructions.length + 1
              });
            }
            break;
            
          case 'metadata':
            if (line.includes('prep time') || line.includes('cook time') || line.includes('total time')) {
              const timeMatch = lines[i].match(/(\d+)\s*(min|hour|hr)/i);
              if (timeMatch) {
                recipe.metadata[line.split(':')[0].trim()] = timeMatch[0];
              }
            } else if (line.includes('servings') || line.includes('yield')) {
              const servingMatch = lines[i].match(/(\d+)/);
              if (servingMatch) {
                recipe.metadata.servings = servingMatch[1];
              }
            }
            break;
        }
      }
      
      return recipe;
    }
    
    // Parse ingredient line
    function parseIngredientLine(line) {
      // Simple ingredient parsing - can be enhanced
      const parts = line.split(/\s+/);
      let amount = '';
      let unit = '';
      let ingredient = '';
      
      // Look for common units and amounts
      const units = ['cup', 'cups', 'tbsp', 'tbs', 'tablespoon', 'tablespoons', 'tsp', 'teaspoon', 'teaspoons', 'oz', 'ounce', 'ounces', 'lb', 'pound', 'pounds', 'g', 'gram', 'grams', 'kg', 'kilogram', 'kilograms', 'ml', 'milliliter', 'milliliters', 'l', 'liter', 'liters'];
      
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i].toLowerCase();
        
        // Check if it's a number or fraction
        if (/^\d+$/.test(part) || /^\d+\/\d+$/.test(part) || /^\d+\.\d+$/.test(part)) {
          amount = part;
        }
        // Check if it's a unit
        else if (units.includes(part)) {
          unit = part;
        }
        // Otherwise it's part of the ingredient name
        else {
          ingredient += (ingredient ? ' ' : '') + parts[i];
        }
      }
      
      return {
        amount: amount,
        unit: unit,
        ingredient: ingredient.trim()
      };
    }
    
    // Display parsing results
    function displayParsingResults(parsedRecipe) {
      // Display ingredients
      const ingredientsList = document.getElementById('ingredients-list');
      if (ingredientsList) {
        ingredientsList.innerHTML = parsedRecipe.ingredients.map(ing => `
          <div class="ingredient-item">
            <div class="ingredient-text">${ing.text}</div>
            ${ing.parsed.amount || ing.parsed.unit ? `
              <div class="ingredient-parsed">
                <span class="amount">${ing.parsed.amount || ''}</span>
                <span class="unit">${ing.parsed.unit || ''}</span>
                <span class="name">${ing.parsed.ingredient || ''}</span>
              </div>
            ` : ''}
          </div>
        `).join('');
      }
      
      // Display instructions
      const instructionsList = document.getElementById('instructions-list');
      if (instructionsList) {
        instructionsList.innerHTML = parsedRecipe.instructions.map(inst => `
          <div class="instruction-item">
            <span class="step-number">${inst.step}.</span>
            <span class="instruction-text">${inst.text}</span>
          </div>
        `).join('');
      }
      
      // Display metadata if available
      if (Object.keys(parsedRecipe.metadata).length > 0) {
        const metadataHtml = Object.entries(parsedRecipe.metadata).map(([key, value]) => 
          `<div class="metadata-item"><strong>${key}:</strong> ${value}</div>`
        ).join('');
        
        // Add metadata section if it doesn't exist
        let metadataSection = document.getElementById('parsed-metadata');
        if (!metadataSection) {
          metadataSection = document.createElement('div');
          metadataSection.id = 'parsed-metadata';
          metadataSection.className = 'parsed-section';
          metadataSection.innerHTML = '<h4 class="heading-4">Recipe Details</h4><div id="metadata-list"></div>';
          document.getElementById('parsing-results').appendChild(metadataSection);
        }
        
        document.getElementById('metadata-list').innerHTML = metadataHtml;
      }
    }

    // Clear upload form
    function clearUploadForm() {
      document.getElementById('upload-form').reset();
      document.getElementById('upload-success').classList.remove('show'); // Hide success message
      
      // Hide progress indicator
      const progressDiv = document.getElementById('upload-progress');
      if (progressDiv) {
        progressDiv.style.display = 'none';
      }
      
      // Reset progress bar
      const progressFill = document.querySelector('.progress-fill');
      if (progressFill) {
        progressFill.style.width = '0%';
      }
    }

    // Clear test text
    function clearTestText() {
      document.getElementById('test-recipe-text').value = '';
      document.getElementById('parsing-results').classList.add('hidden');
    }

    // Show enhanced upload success details
    function showUploadSuccessDetails(recipe) {
      const summaryDiv = document.getElementById('recipe-summary');
      if (summaryDiv && recipe) {
        const complexity = recipe.complexity || 'unknown';
        const prepTime = recipe.estimatedPrepTime || 'unknown';
        const tags = recipe.tags && recipe.tags.length > 0 ? recipe.tags.join(', ') : 'none';
        const textLength = recipe.rawText ? recipe.rawText.length : 0;
        
        summaryDiv.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
            <div><strong>Name:</strong> ${recipe.name}</div>
            <div><strong>Complexity:</strong> <span style="text-transform: capitalize;">${complexity}</span></div>
            <div><strong>Prep Time:</strong> ${prepTime} minutes</div>
            <div><strong>Text Length:</strong> ${textLength.toLocaleString()} characters</div>
            <div><strong>Project:</strong> ${recipe.projectId || 'Master'}</div>
            <div><strong>Status:</strong> <span style="text-transform: capitalize;">${recipe.status}</span></div>
          </div>
          <div style="margin-top: 0.5rem;">
            <strong>Tags:</strong> ${tags}
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #64748b;">
            <strong>Uploaded:</strong> ${new Date(recipe.createdAt).toLocaleString()}
          </div>
        `;
      }
    }

    // Export recipe data
    function exportRecipeData() {
      try {
        // Get the most recently uploaded recipe
        const currentUser = window.userSystem ? window.userSystem.getCurrentUser() : null;
        if (!currentUser) {
          alert('Please log in to export recipe data');
          return;
        }
        
        const storageKey = `user_${currentUser.id}_recipes`;
        const existing = localStorage.getItem(storageKey);
        if (existing) {
          const recipes = JSON.parse(existing);
          if (recipes.length > 0) {
            const latestRecipe = recipes[recipes.length - 1];
            
            // Create export data
            const exportData = {
              exportInfo: {
                type: 'single_recipe',
                recipeName: latestRecipe.name,
                exportedAt: new Date().toISOString(),
                exportedBy: currentUser.name
              },
              recipe: latestRecipe
            };
            
            // Download as JSON file
            const filename = `${latestRecipe.name.replace(/[^a-z0-9]/gi, '_')}_recipe_${new Date().toISOString().split('T')[0]}.json`;
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            console.log('‚úÖ Recipe exported successfully:', filename);
          } else {
            alert('No recipes found to export');
          }
        } else {
          alert('No recipes found to export');
        }
      } catch (error) {
        console.error('‚ùå Error exporting recipe:', error);
        alert('Failed to export recipe: ' + error.message);
      }
    }

    // Update user info display
    function updateUserInfo() {
      if (window.userSystem) {
        const currentUser = window.userSystem.getCurrentUser();
        if (currentUser) {
          document.getElementById('current-user').textContent = currentUser.name;
          document.getElementById('dropdown-user-name').textContent = currentUser.name;
          document.getElementById('user-avatar-initial').textContent = currentUser.name.charAt(0).toUpperCase();
        }
      }
    }

    // Initialize project selector
    function initializeProjectSelector() {
      if (window.projectManager) {
        const projectSelect = document.getElementById('project-select');
        const headerSelector = document.getElementById('header-project-selector');
        const mobileSelector = document.getElementById('mobile-project-selector');
        
        // Wait for project manager to be ready
        setTimeout(() => {
          if (window.projectManager.projects && window.projectManager.projects.length > 0) {
            // Populate project selectors
            const projects = window.projectManager.projects;
            
            [projectSelect, headerSelector, mobileSelector].forEach(selector => {
              if (selector) {
                selector.innerHTML = projects.map(project => `
                  <option value="${project.id}" ${project.id === window.projectManager.currentProject?.id ? 'selected' : ''}>
                    ${project.icon} ${project.name}
                  </option>
                `).join('');
                
                // Add change event listener
                selector.addEventListener('change', function() {
                  const selectedProjectId = this.value;
                  if (selectedProjectId && window.projectManager) {
                    window.projectManager.setCurrentProject(selectedProjectId);
                  }
                });
              }
            });
            
            console.log('‚úÖ Project selectors initialized with', projects.length, 'projects');
          } else {
            console.log('‚è≥ Waiting for projects to load...');
            // Retry after a short delay
            setTimeout(initializeProjectSelector, 500);
          }
        }, 100);
      } else {
        console.log('‚è≥ Project manager not ready, retrying...');
        setTimeout(initializeProjectSelector, 500);
      }
    }

    // Emergency loading fix
    function emergencyLoadingFix() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('user-dropdown');
      const userTab = document.querySelector('.header-user-tab');
      
      if (dropdown && !userTab.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Auto-hide loading screen after 5 seconds as backup
    setTimeout(function() {
      emergencyLoadingFix();
    }, 5000);
  </script>
</body>
</html> 