<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Developer - Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-header.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    <!-- Enhanced User Management now handled by Firebase Auth -->
    <script src="assets/js/project-management-system.js"></script>
    <script src="assets/js/error_handler.js"></script>
    
    <style>
        /* Recipe Developer Specific Styles */
        .recipe-canvas {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-8);
            margin-bottom: var(--spacing-8);
        }
        
        .recipe-section {
            margin-bottom: var(--spacing-6);
            padding: var(--spacing-6);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--gray-50);
        }
        
        .recipe-section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--iterum-primary);
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .ingredient-row:last-child {
            border-bottom: none;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--iterum-primary);
            color: white;
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-4);
        }
        
        .nutrition-item {
            text-align: center;
            padding: var(--spacing-4);
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }
        
        .nutrition-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--iterum-primary);
        }
        
        .nutrition-label {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-top: var(--spacing-1);
        }
        
        /* Recipe Development Layout */
        .recipe-development-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }

        /* Recipe Ideas Sidebar */
        .recipe-ideas-sidebar {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            height: fit-content;
            position: sticky;
            top: var(--spacing-6);
        }

        .sidebar-header {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--iterum-primary);
            margin: 0;
        }

        .ideas-filter {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .ideas-list-container {
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
        }

        .ideas-list {
            padding: var(--spacing-4);
        }

        .idea-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
        }

        .idea-item:hover {
            background: var(--gray-100);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .idea-item.selected {
            background: var(--iterum-primary);
            color: white;
            border-color: var(--iterum-primary);
        }

        .idea-item.selected .idea-meta,
        .idea-item.selected .idea-description {
            color: rgba(255, 255, 255, 0.8);
        }

        .idea-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-sm);
        }

        .idea-description {
            font-size: var(--font-size-xs);
            color: var(--gray-600);
            margin-bottom: var(--spacing-2);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .idea-url {
            margin-bottom: var(--spacing-2);
        }

        .idea-url a {
            font-size: var(--font-size-xs);
            color: var(--blue-600);
            text-decoration: none;
            transition: color var(--transition-normal);
        }

        .idea-url a:hover {
            color: var(--blue-800);
            text-decoration: underline;
        }

        .idea-meta {
            display: flex;
            gap: var(--spacing-2);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .idea-status-badge {
            position: absolute;
            top: var(--spacing-2);
            right: var(--spacing-2);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .idea-status-badge.new {
            background: var(--blue-100);
            color: var(--blue-700);
        }

        .idea-status-badge.in-progress {
            background: var(--yellow-100);
            color: var(--yellow-700);
        }

                 .idea-status-badge.completed {
             background: var(--green-100);
             color: var(--green-700);
         }
         
         .idea-status-badge.history {
             background: #f3e8ff;
             color: #7c3aed;
         }
         
         /* History View Styles */
         .history-item {
             border-left: 4px solid #a78bfa;
         }
         
         .history-modal {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.5);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 1000;
         }
         
         .history-modal-content {
             background: white;
             border-radius: var(--radius-xl);
             padding: var(--spacing-6);
             max-width: 600px;
             max-height: 80vh;
             overflow-y: auto;
             box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
         }
         
         .history-entries {
             margin: var(--spacing-4) 0;
         }
         
         .history-entry {
             padding: var(--spacing-3);
             border: 1px solid var(--gray-200);
             border-radius: var(--radius-md);
             margin-bottom: var(--spacing-2);
             background: var(--gray-50);
         }
         
         .history-entry-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: var(--spacing-2);
         }
         
         .history-version {
             background: #f3e8ff;
             color: #7c3aed;
             padding: 0.25rem 0.5rem;
             border-radius: var(--radius-full);
             font-size: var(--font-size-xs);
             font-weight: var(--font-weight-medium);
         }
         
         .history-date {
             font-size: var(--font-size-sm);
             color: var(--gray-600);
         }
         
         .history-changes {
             display: flex;
             gap: var(--spacing-2);
             flex-wrap: wrap;
         }
         
         .history-changes span {
             background: #eff6ff;
             color: #1d4ed8;
             padding: 0.25rem 0.5rem;
             border-radius: var(--radius-full);
             font-size: var(--font-size-xs);
         }

                 .sidebar-footer {
             padding: var(--spacing-4);
             border-top: 1px solid var(--gray-200);
             display: flex;
             flex-direction: column;
             gap: var(--spacing-2);
         }
         
         /* User Data Info Display */
         .user-data-info {
             padding: var(--spacing-3);
             background: var(--blue-50);
             border: 1px solid var(--blue-200);
             border-radius: var(--radius-md);
             margin: 0 var(--spacing-4);
             font-size: var(--font-size-xs);
         }
         
         .user-data-path, .user-data-status {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: var(--spacing-1);
         }
         
         .user-data-path:last-child, .user-data-status:last-child {
             margin-bottom: 0;
         }
         
         .info-label {
             font-weight: var(--font-weight-medium);
             color: var(--blue-700);
         }
         
         .path-text, .user-name {
             color: var(--blue-800);
             font-family: monospace;
             font-size: 0.75rem;
             max-width: 150px;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
         }

        /* Recipe Header */
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-6);
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .recipe-status-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .status-label {
            font-weight: var(--font-weight-medium);
            color: var(--gray-600);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .status-badge.new {
            background: var(--blue-100);
            color: var(--blue-700);
        }

        .status-badge.in-progress {
            background: var(--yellow-100);
            color: var(--yellow-700);
        }

        .status-badge.completed {
            background: var(--green-100);
            color: var(--green-700);
        }

        .recipe-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .recipe-development-layout {
                grid-template-columns: 1fr;
            }
            
            .recipe-ideas-sidebar {
                position: static;
                margin-bottom: var(--spacing-6);
            }
        }

        /* Recipe Sketch Section */
        .sketch-tools {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--spacing-4);
        }
        
        .sketch-canvas-container {
            position: relative;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            background: var(--gray-50);
            height: 600px;
            overflow: hidden;
            margin-bottom: var(--spacing-4);
        }
        
        .sketch-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
            background: white;
            position: relative;
            z-index: 1;
            touch-action: none;
        }
        
        .sketch-canvas:focus {
            outline: 2px solid var(--iterum-primary);
            outline-offset: 2px;
        }

        .tool-buttons {
            display: flex;
            gap: var(--spacing-2);
        }

        .tool-btn {
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: white;
            color: var(--gray-700);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .tool-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .tool-btn.active {
            background: var(--iterum-primary);
            color: white;
            border-color: var(--iterum-primary);
        }

        .color-palette {
            display: flex;
            gap: var(--spacing-2);
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .color-btn:hover {
            transform: scale(1.1);
            border-color: var(--gray-500);
        }

        .color-btn.active {
            border-color: var(--gray-700);
            transform: scale(1.1);
        }

        .sketch-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-left: auto;
        }

        .sketch-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            background: var(--gray-50);
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-2);
        }

        .placeholder-text {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-1);
        }

        .placeholder-subtext {
            font-size: var(--font-size-sm);
            text-align: center;
            max-width: 300px;
        }

        .ingredient-selector {
            padding: var(--spacing-4);
            background: var(--blue-50);
            border: 1px solid var(--blue-200);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-4);
        }

        .ingredient-selector.hidden {
            display: none;
        }

        .sketch-notes {
            margin-top: var(--spacing-4);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-4);
            justify-content: center;
            margin-top: var(--spacing-8);
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-2);
            }
            
            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Canvas Ready Indicator Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Uniform Centered Header -->
    <header class="iterum-header">
        <div class="header-container">
            <!-- Logo Section -->
            <a href="index.html" class="header-logo">
                <div class="header-logo-icon">
                    <span>🍃</span>
                </div>
                <div class="header-logo-text">
                    <div class="header-logo-title">Iterum R&D</div>
                    <div class="header-logo-subtitle">Chef Notebook</div>
                </div>
            </a>

            <!-- Center Navigation -->
            <nav class="header-navigation">
                <a href="index.html" class="header-nav-item" data-page="index">
                    <span class="nav-icon">🏠</span>
                    <span>Dashboard</span>
                </a>
                <a href="recipe-library.html" class="header-nav-item" data-page="recipe-library">
                    <span class="nav-icon">📚</span>
                    <span>Library</span>
                </a>
                <a href="recipe-developer.html" class="header-nav-item active" data-page="recipe-developer">
                    <span class="nav-icon">🧪</span>
                    <span>Developer</span>
                </a>
                <a href="recipe-upload.html" class="header-nav-item" data-page="recipe-upload">
                    <span class="nav-icon">⚡</span>
                    <span>Upload</span>
                </a>
                <a href="menu-builder.html" class="header-nav-item" data-page="menu-builder">
                    <span class="nav-icon">🍽️</span>
                    <span>Menu</span>
                </a>
                <a href="ingredients.html" class="header-nav-item" data-page="ingredients">
                    <span class="nav-icon">🥬</span>
                    <span>Ingredients</span>
                </a>
                <a href="equipment-management.html" class="header-nav-item" data-page="equipment-management">
                    <span class="nav-icon">🔧</span>
                    <span>Equipment</span>
                </a>
                <a href="vendor-management.html" class="header-nav-item" data-page="vendor-management">
                    <span class="nav-icon">🏪</span>
                    <span>Vendors</span>
                </a>
            </nav>

            <!-- Right Side - User Section -->
            <div class="header-user-section">
                <!-- Project Selector -->
                <div class="header-project-selector-container">
                    <div class="project-selector-display" onclick="window.showProjectSelectionDropdown()">
                        <div class="project-selector-current">
                            <span class="project-selector-icon">📋</span>
                            <span class="project-selector-name" data-project-name>Master Project</span>
                            <svg class="project-selector-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <div class="project-status-display">
                            <span class="project-status-label">Current:</span>
                            <span class="project-status-value" data-project-name>Master Project</span>
                        </div>
                    </div>
                </div>

                <!-- User Info Tab -->
                <div class="header-user-tab" onclick="toggleUserDropdown()">
                    <div class="header-user-avatar" id="user-avatar">
                        <span id="user-avatar-initial">👤</span>
                    </div>
                    <div class="header-user-info">
                        <div class="header-user-name" id="current-user">Guest User</div>
                        <div class="header-user-role">Chef</div>
                    </div>
                    <svg class="header-user-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>

                <!-- User Dropdown Menu -->
                <div class="header-user-dropdown" id="user-dropdown">
                    <div class="header-user-dropdown-header">
                        <div class="header-user-dropdown-title" id="dropdown-user-name">Guest User</div>
                        <div class="header-user-dropdown-subtitle" id="dropdown-user-role">Chef</div>
                    </div>
                    
                    <div class="header-user-dropdown-menu">
                        <div class="header-user-dropdown-item" onclick="userSystem.quickSwitch()">
                            <span>🔄</span>
                            <span>Switch User</span>
                        </div>
                        <div class="header-user-dropdown-item" onclick="userSystem.showUserModal('create')">
                            <span>➕</span>
                            <span>Create New User</span>
                        </div>
                    </div>
                    
                    <div class="header-user-dropdown-divider"></div>
                    
                    <div class="header-user-dropdown-menu">
                        <div class="header-user-dropdown-item" onclick="userSystem.showSettings()">
                            <span>⚙️</span>
                            <span>Settings</span>
                        </div>
                        <div class="header-user-dropdown-item danger" onclick="userSystem.logout()">
                            <span>🚪</span>
                            <span>Sign Out</span>
                        </div>
                    </div>
                    
                    <div class="header-user-dropdown-footer">
                        <div class="header-user-dropdown-footer-text">Iterum R&D v1.0</div>
                    </div>
                </div>

                <!-- Mobile Navigation Toggle -->
                <button class="header-mobile-toggle" onclick="toggleMobileNav()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <nav id="mobile-nav" class="header-mobile-nav">
            <!-- Project Selector for Mobile -->
            <div style="margin-bottom: 1rem;">
                <select id="mobile-project-selector" class="header-project-selector" style="width: 100%;">
                    <option value="">Select Project...</option>
                </select>
            </div>

            <!-- Mobile Navigation Items -->
            <a href="index.html" class="header-mobile-nav-item" data-page="index">
                <span class="nav-icon">🏠</span>
                <span>Dashboard</span>
            </a>
            <a href="recipe-library.html" class="header-mobile-nav-item" data-page="recipe-library">
                <span class="nav-icon">📚</span>
                <span>Library</span>
            </a>
            <a href="recipe-developer.html" class="header-mobile-nav-item active" data-page="recipe-developer">
                <span class="nav-icon">🧪</span>
                <span>Developer</span>
            </a>
            <a href="recipe-upload.html" class="header-mobile-nav-item" data-page="recipe-upload">
                <span class="nav-icon">⚡</span>
                <span>Upload</span>
            </a>
            <a href="menu-builder.html" class="header-mobile-nav-item" data-page="menu-builder">
                <span class="nav-icon">🍽️</span>
                <span>Menu</span>
            </a>
            <a href="ingredients.html" class="header-mobile-nav-item" data-page="ingredients">
                <span class="nav-icon">🥬</span>
                <span>Ingredients</span>
            </a>
            <a href="equipment-management.html" class="header-mobile-nav-item" data-page="equipment-management">
                <span class="nav-icon">🔧</span>
                <span>Equipment</span>
            </a>
            <a href="vendor-management.html" class="header-mobile-nav-item" data-page="vendor-management">
                <span class="nav-icon">🏪</span>
                <span>Vendors</span>
            </a>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="heading-1">Recipe Developer</h1>
                <p class="body-large">Create, refine, and perfect your culinary creations with our professional recipe development tools.</p>
            </div>

            <!-- Recipe Development Layout -->
            <div class="recipe-development-layout">
                <!-- Recipe Ideas Sidebar -->
                <div class="recipe-ideas-sidebar">
                    <div class="ideas-sidebar-header">
                        <h3>💡 Recipe Ideas & History</h3>
                        <div class="ideas-sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshRecipeIdeasOnDeveloperPage()" title="Refresh Ideas">
                                🔄 Refresh
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="createNewRecipe()">
                                🧪 New Recipe
                            </button>
                        </div>
                    </div>
                    
                    <!-- User Data Path Display -->
                    <div class="user-data-info" id="user-data-info">
                        <div class="user-data-path">
                            <span class="info-label">📁 User Data:</span>
                            <span class="path-text" id="user-data-path">Loading...</span>
                        </div>
                        <div class="user-data-status">
                            <span class="info-label">👤 User:</span>
                            <span class="user-name" id="sidebar-user-name">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Ideas Filter -->
                    <div class="ideas-filter">
                        <select id="ideas-status-filter" class="form-select" onchange="filterIdeas()">
                            <option value="all">All Ideas</option>
                            <option value="idea">New Ideas</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="toggleHistoryView()">📚 History</button>
                    </div>
                    
                    <!-- Ideas List -->
                    <div class="ideas-list-container">
                        <div id="ideas-list" class="ideas-list">
                            <!-- Ideas will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Sidebar Footer -->
                    <div class="sidebar-footer">
                        <button class="btn btn-secondary w-full" onclick="createNewRecipe()">🧪 New Recipe</button>
                        <button class="btn btn-primary w-full" onclick="importFromMainPage()">📥 Import Ideas</button>
                        <button class="btn btn-success w-full" onclick="exportAllUserData()">📤 Export All Data</button>
                    </div>
                </div>
                
                <!-- Recipe Canvas -->
                <div class="recipe-canvas">
                    <!-- Recipe Header with Status -->
                    <div class="recipe-header">
                        <div class="recipe-status-display">
                            <span class="status-label">Status:</span>
                            <span id="recipe-status" class="status-badge new">New Recipe</span>
                        </div>
                        <div class="recipe-actions">
                            <button class="btn btn-secondary" onclick="saveRecipe()">💾 Save</button>
                            <button class="btn btn-primary" onclick="saveAndContinue()">💾 Save & Continue</button>
                        </div>
                    </div>
                    
                    <!-- Recipe Name Section -->
                    <div class="recipe-section">
                        <div class="recipe-section-title">
                            <span>📝</span>
                            Recipe Information
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="recipe-name" class="form-label">Recipe Name</label>
                                <input type="text" id="recipe-name" class="form-input" placeholder="Enter recipe name">
                            </div>
                            <div class="form-group">
                                <label for="recipe-category" class="form-label">Category</label>
                                <select id="recipe-category" class="form-select">
                                    <option value="">Select category</option>
                                    <option value="appetizer">Appetizer</option>
                                    <option value="main-course">Main Course</option>
                                    <option value="dessert">Dessert</option>
                                    <option value="beverage">Beverage</option>
                                    <option value="sauce">Sauce</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recipe-cuisine" class="form-label">Cuisine</label>
                                <input type="text" id="recipe-cuisine" class="form-input" placeholder="e.g., Italian, French, Asian">
                            </div>
                            <div class="form-group">
                                <label for="recipe-servings" class="form-label">Servings</label>
                                <input type="number" id="recipe-servings" class="form-input" min="1" value="4">
                            </div>
                        </div>
                    </div>

                <!-- Ingredients Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>🥬</span>
                        Ingredients
                    </div>
                    <div id="ingredients-container">
                        <div class="ingredient-row">
                            <input type="text" class="form-input" placeholder="Ingredient name">
                            <input type="text" class="form-input" placeholder="Amount">
                            <select class="form-select">
                                <option value="g">grams</option>
                                <option value="kg">kilograms</option>
                                <option value="ml">milliliters</option>
                                <option value="l">liters</option>
                                <option value="tsp">teaspoon</option>
                                <option value="tbsp">tablespoon</option>
                                <option value="cup">cup</option>
                                <option value="piece">piece</option>
                            </select>
                            <input type="text" class="form-input" placeholder="Notes">
                            <button class="btn btn-secondary" onclick="removeIngredient(this)">🗑️</button>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addIngredient()">➕ Add Ingredient</button>
                </div>

                <!-- Instructions Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>📋</span>
                        Instructions
                    </div>
                    <div id="instructions-container">
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addInstruction()">➕ Add Step</button>
                </div>

                <!-- Recipe Sketch Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>🎨</span>
                        Recipe Sketch
                    </div>
                    
                    <!-- Sketch Tools -->
                    <div class="sketch-tools mb-4">
                        <div class="tool-buttons">
                            <button onclick="setSketchTool('pen')" id="tool-pen" class="tool-btn active">✏️ Pen</button>
                            <button onclick="setSketchTool('text')" id="tool-text" class="tool-btn">📝 Text</button>
                            <button onclick="setSketchTool('shape')" id="tool-shape" class="tool-btn">🔷 Shape</button>
                            <button onclick="setSketchTool('label')" id="tool-label" class="tool-btn">🏷️ Label</button>
                        </div>
                        
                        <div class="color-palette">
                            <button onclick="setSketchColor('#000000')" class="color-btn active" style="background-color: #000000;"></button>
                            <button onclick="setSketchColor('#dc2626')" class="color-btn" style="background-color: #dc2626;"></button>
                            <button onclick="setSketchColor('#059669')" class="color-btn" style="background-color: #059669;"></button>
                            <button onclick="setSketchColor('#2563eb')" class="color-btn" style="background-color: #2563eb;"></button>
                            <button onclick="setSketchColor('#7c3aed')" class="color-btn" style="background-color: #7c3aed;"></button>
                            <button onclick="setSketchColor('#f59e0b')" class="color-btn" style="background-color: #f59e0b;"></button>
                        </div>
                        
                        <div class="sketch-actions">
                            <button onclick="checkCanvasStatus()" class="btn btn-warning btn-sm">🔍 Check Status</button>
                            <button onclick="testCanvasDrawing()" class="btn btn-success btn-sm">🧪 Test Draw</button>
                            <button onclick="forceReinitializeCanvas()" class="btn btn-danger btn-sm">🔄 Force Reset</button>
                            <button onclick="initializeSketchCanvas()" class="btn btn-info btn-sm">🎨 Init Canvas</button>
                            <button onclick="clearSketch()" class="btn btn-secondary btn-sm">🗑️ Clear</button>
                            <button onclick="downloadSketch()" class="btn btn-primary btn-sm">📥 Download</button>
                        </div>
                    </div>
                    
                    <!-- Sketch Canvas -->
                    <div class="sketch-canvas-container">
                        <canvas id="sketch-canvas" class="sketch-canvas"></canvas>
                        <div id="sketch-placeholder" class="sketch-placeholder">
                            <div class="placeholder-icon">🎨</div>
                            <p class="placeholder-text">Click to start sketching</p>
                            <p class="placeholder-subtext">Draw your recipe concept, plating ideas, or visual notes</p>
                        </div>
                    </div>
                    
                    <!-- Ingredient Selector for Labels -->
                    <div id="ingredient-selector" class="ingredient-selector hidden">
                        <label class="form-label">Select Ingredient to Label</label>
                        <select id="ingredient-dropdown" class="form-select">
                            <option value="">Choose an ingredient...</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-2">Click on the sketch to place ingredient labels</p>
                    </div>
                    
                    <!-- Sketch Notes -->
                    <div class="sketch-notes mt-4">
                        <label for="sketch-notes" class="form-label">Sketch Notes</label>
                        <textarea id="sketch-notes" class="form-textarea" rows="3" placeholder="Add notes about your sketch, plating ideas, or visual concepts..."></textarea>
                    </div>
                </div>

                <!-- Nutritional Information -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>📊</span>
                        Nutritional Information (per serving)
                    </div>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="calories">0</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="protein">0g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="carbs">0g</div>
                            <div class="nutrition-label">Carbohydrates</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="fat">0g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="fiber">0g</div>
                            <div class="nutrition-label">Fiber</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="sugar">0g</div>
                            <div class="nutrition-label">Sugar</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveRecipe()">💾 Save Recipe</button>
                    <button class="btn btn-secondary" onclick="exportRecipe()">📤 Export</button>
                    <button class="btn btn-secondary" onclick="calculateNutrition()">🧮 Calculate Nutrition</button>
                    <button class="btn btn-secondary" onclick="previewRecipe()">👁️ Preview</button>
                </div>
            </div>
        </div>
    </div>
</div>
</main>

    <!-- Essential Scripts -->
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Recipe Developer Page');
            
            // Initialize user system
            // User system now initializes automatically
            console.log('🔍 User system auto-initialization enabled');
            
            // Initialize project manager
            if (window.projectManager) {
                window.projectManager.init();
                console.log('✅ Project manager initialized');
            } else {
                console.log('⚠️ Project manager not available');
            }
            
            // Wait a bit for project manager to be ready, then initialize ideas
            setTimeout(() => {
                console.log('⏳ Initializing ideas sidebar after delay...');
                initializeIdeasSidebar();
                
                // Initialize sketch canvas
                initializeSketchCanvas();
            }, 1000);
            
            // Listen for project changes to reload recipe ideas
            document.addEventListener('projectChanged', function(event) {
                console.log('📋 Project changed on recipe developer page, reloading ideas...');
                if (event.detail && event.detail.project) {
                    // Reload ideas for the new project
                    setTimeout(() => {
                        loadRecipeIdeasFromFiles();
                    }, 500);
                }
            });
            
            console.log('✅ Recipe Developer Page initialized');
        });

        // Wait for app to be ready
        document.addEventListener('iterumAppReady', function() {
            initializeRecipeDeveloper();
            updateUserInfo();
            initializeProjectSelector();
        });
        
        // Listen for user switching events
        document.addEventListener('userSwitched', function(event) {
            console.log('👤 User switched, reloading user data...');
            initializeUserFileStorage();
            loadRecipeIdeasFromFiles();
            clearRecipeForm();
            updateUserInfo();
        });
        
        document.addEventListener('userLoggedIn', function(event) {
            console.log('🔐 User logged in, reloading user data...');
            initializeUserFileStorage();
            loadRecipeIdeasFromFiles();
            updateUserInfo();
        });
        
        document.addEventListener('userLoggedOut', function(event) {
            console.log('🚪 User logged out, clearing user data...');
            currentUser = null;
            userDataPath = null;
            clearRecipeForm();
            loadRecipeIdeasFromFiles(); // This will show empty state
            updateUserInfo();
        });

        // Wait for loading screen to be hidden
        document.addEventListener('loadingScreenHidden', function() {
            initializeRecipeDeveloper();
            updateUserInfo();
            initializeProjectSelector();
        });

        function initializeRecipeDeveloper() {
            console.log('🧪 Initializing Recipe Developer');
            // Initialize recipe developer functionality
            
            // Initialize ideas sidebar
            initializeIdeasSidebar();
            
            // Load current recipe if any
            loadCurrentRecipe();
        }

        // Recipe Ideas Sidebar System
        let currentRecipeId = null;
        let currentRecipeData = null;
        
        // User-specific file storage system
        let userDataPath = null;
        let currentUser = null;
        
        // View state management
        let isHistoryView = false;

        function initializeIdeasSidebar() {
            console.log('💡 Initializing Recipe Ideas Sidebar');
            
            // Initialize user-specific file storage
            initializeUserFileStorage();
            
            // Load ideas from user files
            loadRecipeIdeasFromFiles();
            
            // Set up event listeners
            setupIdeasEventListeners();
        }

        // User-specific file storage system
        function initializeUserFileStorage() {
            console.log('💾 Initializing user file storage system...');
            
            // Get current user from user system
            currentUser = window.userSystem?.getCurrentUser();
            if (!currentUser) {
                console.warn('⚠️ No user logged in, using guest storage');
                currentUser = { id: 'guest', name: 'Guest User' };
            }
            
            // Set user data path (this would be configured based on your file system setup)
            userDataPath = `./user_data/${currentUser.id}`;
            
            console.log('✅ User file storage initialized for:', currentUser.name);
        }
        
        function loadRecipeIdeasFromFiles() {
            const ideasList = document.getElementById('ideas-list');
            if (!ideasList) return;

            console.log('📂 Loading recipe ideas from project-aware storage...');
            
            // Try to load from project-aware storage first
            let recipeIdeas = [];
            let inProgressRecipes = [];
            
            try {
                // Try to load from project-aware storage
                if (window.projectManager && window.projectManager.getCurrentProject()) {
                    // Load recipe ideas from project-specific storage
                    const ideasProjectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
                    const storedIdeas = localStorage.getItem(ideasProjectKey);
                    if (storedIdeas) {
                        recipeIdeas = JSON.parse(storedIdeas);
                        console.log('📥 Loaded', recipeIdeas.length, 'recipe ideas from project:', ideasProjectKey);
                    }
                    
                    // Load in-progress recipes from project-specific storage
                    const recipesProjectKey = window.projectManager.getProjectStorageKey('recipes_in_progress');
                    const storedRecipes = localStorage.getItem(recipesProjectKey);
                    if (storedRecipes) {
                        inProgressRecipes = JSON.parse(storedRecipes);
                        console.log('📥 Loaded', inProgressRecipes.length, 'in-progress recipes from project:', recipesProjectKey);
                    }
                } else {
                    // Fallback to global storage
                    recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                    inProgressRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
                    console.log('📥 Loaded from global storage:', recipeIdeas.length, 'ideas,', inProgressRecipes.length, 'recipes');
                }
                
            } catch (error) {
                console.warn('⚠️ Could not load from project storage, falling back to localStorage:', error);
                
                // Fallback to localStorage for existing data
                recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                inProgressRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
            }
            
            // Combine ideas and in-progress recipes
            const allItems = [...recipeIdeas, ...inProgressRecipes];
            
            if (allItems.length === 0) {
                ideasList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">💡</div>
                        <p>No recipe ideas yet</p>
                        <p class="text-sm">Create ideas on the main page or start a new recipe</p>
                    </div>
                `;
                return;
            }

            // Sort by creation date (newest first)
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            ideasList.innerHTML = allItems.map(item => {
                const isRecipe = item.id && item.id.startsWith('recipe_');
                const status = isRecipe ? 'in-progress' : (item.status || 'idea');
                
                return `
                    <div class="idea-item" onclick="selectIdea('${item.id}', '${isRecipe ? 'recipe' : 'idea'}')" data-id="${item.id}" data-type="${isRecipe ? 'recipe' : 'idea'}">
                        <div class="idea-title">${item.title}</div>
                        <div class="idea-description">${item.description || 'No description'}</div>
                        ${item.url ? `<div class="idea-url"><a href="${item.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">🔗 View Source</a></div>` : ''}
                        <div class="idea-meta">
                            ${item.cuisine ? `<span>🌍 ${item.cuisine}</span>` : ''}
                            ${item.difficulty ? `<span>📊 ${item.difficulty}</span>` : ''}
                            <span>📅 ${new Date(item.createdAt).toLocaleDateString()}</span>
                        </div>
                        <span class="idea-status-badge ${status}">${status}</span>
                    </div>
                `;
            }).join('');
        }
        
        // File storage functions
        function loadUserFile(filename) {
            try {
                // This would integrate with your file system
                // For now, we'll simulate file loading
                const filePath = `${userDataPath}/${filename}`;
                console.log('📂 Attempting to load file:', filePath);
                
                // In a real implementation, this would use File System Access API or similar
                // For now, return null to trigger fallback
                return null;
            } catch (error) {
                console.error('❌ Error loading user file:', error);
                return null;
            }
        }
        
        function saveUserFile(filename, data) {
            try {
                const filePath = `${userDataPath}/${filename}`;
                console.log('💾 Saving to user file:', filePath);
                
                // Convert data to JSON string
                const jsonData = JSON.stringify(data, null, 2);
                
                // In a real implementation, this would save to the file system
                // For now, we'll also save to localStorage as backup
                localStorage.setItem(`user_${currentUser.id}_${filename}`, jsonData);
                
                console.log('✅ Data saved to user file:', filename);
                return true;
            } catch (error) {
                console.error('❌ Error saving user file:', error);
                return false;
            }
        }

        function setupIdeasEventListeners() {
            // Filter change event
            const filterSelect = document.getElementById('ideas-status-filter');
            if (filterSelect) {
                filterSelect.addEventListener('change', filterIdeas);
            }
        }

        function filterIdeas() {
            const filterValue = document.getElementById('ideas-status-filter').value;
            const ideaItems = document.querySelectorAll('.idea-item');
            
            ideaItems.forEach(item => {
                const status = item.querySelector('.idea-status-badge').textContent;
                const shouldShow = filterValue === 'all' || status === filterValue;
                item.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function selectIdea(ideaId, type) {
            console.log('💡 Selecting idea:', ideaId, 'Type:', type);
            
            // Remove previous selection
            document.querySelectorAll('.idea-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            const selectedItem = document.querySelector(`[data-id="${ideaId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            if (type === 'idea') {
                // Load idea into recipe form
                loadIdeaIntoRecipeForm(ideaId);
            } else {
                // Load existing recipe
                loadRecipeIntoForm(ideaId);
            }
        }

        function loadIdeaIntoRecipeForm(ideaId) {
            const recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
            const idea = recipeIdeas.find(i => i.id === ideaId);
            
            if (!idea) {
                console.error('❌ Idea not found:', ideaId);
                return;
            }
            
            // Populate recipe form with idea data
            document.getElementById('recipe-name').value = idea.title;
            document.getElementById('recipe-cuisine').value = idea.cuisine || '';
            document.getElementById('recipe-category').value = '';
            document.getElementById('recipe-servings').value = '4';
            
            // Update status
            updateRecipeStatus('new', 'New Recipe from Idea');
            
            // Clear current recipe data
            currentRecipeId = null;
            currentRecipeData = null;
            
            console.log('💡 Idea loaded into recipe form:', idea);
        }

        function loadRecipeIntoForm(recipeId) {
            const inProgressRecipes = loadInProgressRecipesFromFile();
            const recipe = inProgressRecipes.find(r => r.id === recipeId);
            
            if (!recipe) {
                console.error('❌ Recipe not found:', recipeId);
                return;
            }
            
            // Populate recipe form with existing data
            document.getElementById('recipe-name').value = recipe.title || '';
            document.getElementById('recipe-cuisine').value = recipe.cuisine || '';
            document.getElementById('recipe-category').value = recipe.category || '';
            document.getElementById('recipe-servings').value = recipe.servings || '4';
            
            // Load ingredients if they exist
            if (recipe.ingredients) {
                loadIngredientsIntoForm(recipe.ingredients);
            }
            
            // Load instructions if they exist
            if (recipe.instructions) {
                loadInstructionsIntoForm(recipe.instructions);
            }
            
            // Update status
            updateRecipeStatus('in-progress', 'Recipe in Progress');
            
            // Set current recipe
            currentRecipeId = recipeId;
            currentRecipeData = recipe;
            
            console.log('🧪 Recipe loaded into form from user file:', recipe);
        }

        function loadIngredientsIntoForm(ingredients) {
            const container = document.getElementById('ingredients-container');
            if (!container) return;
            
            // Clear existing ingredients
            container.innerHTML = '';
            
            // Add ingredients
            ingredients.forEach((ingredient, index) => {
                addIngredient(ingredient.name, ingredient.amount, ingredient.unit, ingredient.notes);
            });
        }

        function loadInstructionsIntoForm(instructions) {
            const container = document.getElementById('instructions-container');
            if (!container) return;
            
            // Clear existing instructions
            container.innerHTML = '';
            
            // Add instructions
            instructions.forEach((instruction, index) => {
                addInstruction(instruction);
            });
        }

        function updateRecipeStatus(status, text) {
            const statusElement = document.getElementById('recipe-status');
            if (statusElement) {
                statusElement.className = `status-badge ${status}`;
                statusElement.textContent = text;
            }
        }

        function refreshIdeasList() {
            console.log('🔄 Refreshing ideas list from user files...');
            if (isHistoryView) {
                loadRecipeHistory();
            } else {
                loadRecipeIdeasFromFiles();
            }
        }
        
        // Toggle between ideas and history view
        function toggleHistoryView() {
            isHistoryView = !isHistoryView;
            const historyBtn = document.querySelector('.ideas-filter .btn-secondary');
            
            if (isHistoryView) {
                historyBtn.textContent = '💡 Ideas';
                historyBtn.classList.remove('btn-secondary');
                historyBtn.classList.add('btn-primary');
                document.querySelector('.sidebar-title').textContent = '📚 Recipe History';
                loadRecipeHistory();
            } else {
                historyBtn.textContent = '📚 History';
                historyBtn.classList.remove('btn-primary');
                historyBtn.classList.add('btn-secondary');
                document.querySelector('.sidebar-title').textContent = '💡 Recipe Ideas';
                loadRecipeIdeasFromFiles();
            }
        }
        
        // Load recipe history from user files
        function loadRecipeHistory() {
            const ideasList = document.getElementById('ideas-list');
            if (!ideasList) return;
            
            console.log('📚 Loading recipe history from user files...');
            
            try {
                // Try to load from user-specific file first
                let recipeHistory = [];
                const historyData = loadUserFile('recipe_history.json');
                if (historyData) {
                    recipeHistory = JSON.parse(historyData);
                    console.log('📥 Loaded', recipeHistory.length, 'history entries from user file');
                } else {
                    // Fallback to localStorage
                    recipeHistory = JSON.parse(localStorage.getItem(`user_${currentUser?.id || 'guest'}_recipe_history`) || '[]');
                    console.log('📥 Loaded', recipeHistory.length, 'history entries from localStorage fallback');
                }
                
                if (recipeHistory.length === 0) {
                    ideasList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">📚</div>
                            <p>No recipe history yet</p>
                            <p class="text-sm">Start creating and saving recipes to build history</p>
                        </div>
                    `;
                    return;
                }
                
                // Group history by recipe
                const recipeHistoryMap = new Map();
                recipeHistory.forEach(entry => {
                    if (!recipeHistoryMap.has(entry.recipeId)) {
                        recipeHistoryMap.set(entry.recipeId, []);
                    }
                    recipeHistoryMap.get(entry.recipeId).push(entry);
                });
                
                // Display history grouped by recipe
                ideasList.innerHTML = Array.from(recipeHistoryMap.entries()).map(([recipeId, entries]) => {
                    const latestEntry = entries[0]; // Most recent entry
                    const totalVersions = entries.length;
                    
                    return `
                        <div class="idea-item history-item" onclick="viewRecipeHistory('${recipeId}')" data-id="${recipeId}">
                            <div class="idea-title">${latestEntry.title}</div>
                            <div class="idea-description">
                                📚 ${totalVersions} version${totalVersions > 1 ? 's' : ''} • Last updated: ${new Date(latestEntry.timestamp).toLocaleDateString()}
                            </div>
                            <div class="idea-meta">
                                <span>🕒 ${new Date(latestEntry.timestamp).toLocaleTimeString()}</span>
                                <span>👤 ${latestEntry.userName}</span>
                            </div>
                            <span class="idea-status-badge history">History</span>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('❌ Error loading recipe history:', error);
                ideasList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">❌</div>
                        <p>Error loading history</p>
                        <p class="text-sm">Please try refreshing</p>
                    </div>
                `;
            }
        }
        
        // View detailed recipe history
        function viewRecipeHistory(recipeId) {
            console.log('📚 Viewing recipe history for:', recipeId);
            
            try {
                // Load recipe history
                let recipeHistory = [];
                const historyData = loadUserFile('recipe_history.json');
                if (historyData) {
                    recipeHistory = JSON.parse(historyData);
                } else {
                    recipeHistory = JSON.parse(localStorage.getItem(`user_${currentUser?.id || 'guest'}_recipe_history`) || '[]');
                }
                
                // Filter history for this recipe
                const recipeEntries = recipeHistory.filter(entry => entry.recipeId === recipeId);
                
                if (recipeEntries.length === 0) {
                    alert('No history found for this recipe');
                    return;
                }
                
                // Sort by timestamp (newest first)
                recipeEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Create history summary
                const historySummary = recipeEntries.map((entry, index) => {
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    const time = new Date(entry.timestamp).toLocaleTimeString();
                    const changes = entry.changes;
                    
                    return `
                        <div class="history-entry">
                            <div class="history-entry-header">
                                <span class="history-version">v${entry.version || (index + 1)}</span>
                                <span class="history-date">${date} at ${time}</span>
                            </div>
                            <div class="history-changes">
                                <span>📝 ${changes.ingredients} ingredients</span>
                                <span>📋 ${changes.instructions} steps</span>
                                ${changes.hasSketch ? '<span>🎨 Has sketch</span>' : ''}
                                ${changes.hasNutrition ? '<span>📊 Has nutrition</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Show history in modal or expand the item
                const historyModal = `
                    <div class="history-modal">
                        <div class="history-modal-content">
                            <h3>📚 Recipe History: ${recipeEntries[0].title}</h3>
                            <div class="history-entries">
                                ${historySummary}
                            </div>
                            <button class="btn btn-primary" onclick="closeHistoryModal()">Close</button>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', historyModal);
                
            } catch (error) {
                console.error('❌ Error viewing recipe history:', error);
                alert('Error loading recipe history');
            }
        }
        
        // Close history modal
        function closeHistoryModal() {
            const modal = document.querySelector('.history-modal');
            if (modal) {
                modal.remove();
            }
        }

        function createNewRecipe() {
            console.log('🧪 Creating new recipe...');
            
            // Clear form
            clearRecipeForm();
            
            // Update status
            updateRecipeStatus('new', 'New Recipe');
            
            // Clear current recipe
            currentRecipeId = null;
            currentRecipeData = null;
            
            // Remove selection from sidebar
            document.querySelectorAll('.idea-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function clearRecipeForm() {
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-cuisine').value = '';
            document.getElementById('recipe-category').value = '';
            document.getElementById('recipe-servings').value = '4';
            
            // Clear ingredients
            const ingredientsContainer = document.getElementById('ingredients-container');
            if (ingredientsContainer) {
                ingredientsContainer.innerHTML = `
                    <div class="ingredient-row">
                        <input type="text" class="form-input" placeholder="Ingredient name">
                        <input type="text" class="form-input" placeholder="Amount">
                        <select class="form-select">
                            <option value="g">grams</option>
                            <option value="kg">kilograms</option>
                            <option value="ml">milliliters</option>
                            <option value="l">liters</option>
                            <option value="tsp">teaspoon</option>
                            <option value="tbsp">tablespoon</option>
                            <option value="cup">cup</option>
                            <option value="piece">piece</option>
                        </select>
                        <input type="text" class="form-input" placeholder="Notes">
                        <button class="btn btn-secondary" onclick="removeIngredient(this)">🗑️</button>
                    </div>
                `;
            }
            
            // Clear instructions
            const instructionsContainer = document.getElementById('instructions-container');
            if (instructionsContainer) {
                instructionsContainer.innerHTML = `
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
                    </div>
                `;
            }
        }

        function importFromMainPage() {
            console.log('📥 Importing ideas from main page...');
            
            // Refresh the ideas list
            loadRecipeIdeas();
            
            // Show success message
            alert('Ideas imported successfully! Check the sidebar for your recipe ideas.');
        }

        function saveAndContinue() {
            console.log('💾 Saving and continuing recipe...');
            
            // Save the current recipe
            saveRecipe();
            
            // Keep the form open for continued editing
            console.log('✅ Recipe saved, continue editing...');
        }

        function loadCurrentRecipe() {
            // Check if there's a recipe ID in URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const recipeId = urlParams.get('recipe') || localStorage.getItem('current_recipe_id');
            
            if (recipeId) {
                loadRecipeIntoForm(recipeId);
            }
            
            // Load nutrition data if available
            loadNutritionData();
        }
        
        // Load nutrition data from user files
        function loadNutritionData() {
            try {
                // Try to load from user-specific file first
                let nutritionData = loadUserFile('nutrition_data.json');
                if (nutritionData) {
                    nutritionData = JSON.parse(nutritionData);
                    console.log('📥 Nutrition data loaded from user file');
                } else {
                    // Fallback to localStorage
                    nutritionData = localStorage.getItem(`user_${currentUser?.id || 'guest'}_nutrition_data`);
                    if (nutritionData) {
                        nutritionData = JSON.parse(nutritionData);
                        console.log('📥 Nutrition data loaded from localStorage fallback');
                    }
                }
                
                if (nutritionData) {
                    // Update nutrition display
                    document.getElementById('calories').textContent = nutritionData.calories || '0';
                    document.getElementById('protein').textContent = (nutritionData.protein || '0') + 'g';
                    document.getElementById('carbs').textContent = (nutritionData.carbs || '0') + 'g';
                    document.getElementById('fat').textContent = (nutritionData.fat || '0') + 'g';
                    document.getElementById('fiber').textContent = (nutritionData.fiber || '0') + 'g';
                    document.getElementById('sugar').textContent = (nutritionData.sugar || '0') + 'g';
                }
            } catch (error) {
                console.warn('⚠️ Could not load nutrition data:', error);
            }
        }

        // Recipe Sketch Canvas System
        let sketchCanvas, sketchCtx;
        let isDrawing = false;
        let currentSketchTool = 'pen';
        let currentSketchColor = '#000000';
        let lastX = 0;
        let lastY = 0;
        let ingredientLabels = [];

        function initializeSketchCanvas() {
            console.log('🎨 Initializing Recipe Sketch Canvas');
            
            sketchCanvas = document.getElementById('sketch-canvas');
            if (!sketchCanvas) {
                console.warn('⚠️ Sketch canvas element not found');
                return;
            }
            
            sketchCtx = sketchCanvas.getContext('2d');
            if (!sketchCtx) {
                console.error('❌ Could not get canvas context');
                return;
            }
            
            // Set canvas size to match container
            const container = sketchCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            sketchCanvas.width = rect.width;
            sketchCanvas.height = rect.height;
            
            // Set initial styles
            sketchCtx.strokeStyle = currentSketchColor;
            sketchCtx.lineWidth = 2;
            sketchCtx.lineCap = 'round';
            sketchCtx.lineJoin = 'round';
            
            // Load ingredients for labeling
            loadIngredientsForLabeling();
            
            // Remove any existing event listeners to prevent duplicates
            sketchCanvas.removeEventListener('mousedown', startSketchDrawing);
            sketchCanvas.removeEventListener('mousemove', sketchDraw);
            sketchCanvas.removeEventListener('mouseup', stopSketchDrawing);
            sketchCanvas.removeEventListener('mouseout', stopSketchDrawing);
            sketchCanvas.removeEventListener('click', handleSketchCanvasClick);
            sketchCanvas.removeEventListener('touchstart', handleSketchTouchStart);
            sketchCanvas.removeEventListener('touchmove', handleSketchTouchMove);
            sketchCanvas.removeEventListener('touchend', stopSketchDrawing);
            
            // Add event listeners
            sketchCanvas.addEventListener('mousedown', startSketchDrawing);
            sketchCanvas.addEventListener('mousemove', sketchDraw);
            sketchCanvas.addEventListener('mouseup', stopSketchDrawing);
            sketchCanvas.addEventListener('mouseout', stopSketchDrawing);
            sketchCanvas.addEventListener('click', handleSketchCanvasClick);
            
            // Touch events for mobile
            sketchCanvas.addEventListener('touchstart', handleSketchTouchStart);
            sketchCanvas.addEventListener('touchmove', handleSketchTouchMove);
            sketchCanvas.addEventListener('touchend', stopSketchDrawing);
            
            // Hide placeholder when drawing starts
            sketchCanvas.addEventListener('mousedown', hideSketchPlaceholder);
            sketchCanvas.addEventListener('touchstart', hideSketchPlaceholder);
            
            // Add resize handler
            window.removeEventListener('resize', handleCanvasResize);
            window.addEventListener('resize', handleCanvasResize);
            
            // Show success indicator
            showCanvasReadyIndicator();
            
            // Make canvas visible and clickable
            sketchCanvas.style.pointerEvents = 'auto';
            sketchCanvas.style.cursor = 'crosshair';
            
            console.log('✅ Sketch canvas initialized successfully');
            console.log('🎨 Canvas size:', sketchCanvas.width, 'x', sketchCanvas.height);
            console.log('🎨 Canvas element:', sketchCanvas);
            console.log('🎨 Canvas context:', sketchCtx);
        }
        
        // Show canvas ready indicator
        function showCanvasReadyIndicator() {
            const container = document.querySelector('.sketch-canvas-container');
            if (container) {
                // Add a temporary success message
                const indicator = document.createElement('div');
                indicator.className = 'canvas-ready-indicator';
                indicator.innerHTML = '🎨 Canvas Ready - Click and drag to draw!';
                indicator.style.cssText = `
                    position: absolute;
                    top: 10px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 10;
                    animation: fadeInOut 3s ease-in-out;
                `;
                
                container.appendChild(indicator);
                
                // Remove after animation
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 3000);
                
                // Test the canvas by drawing a small test line
                setTimeout(() => {
                    testCanvasDrawing();
                }, 1000);
            }
        }
        
        // Test canvas drawing functionality
        function testCanvasDrawing() {
            if (!sketchCanvas || !sketchCtx) {
                console.warn('⚠️ Cannot test drawing - canvas not ready');
                return;
            }
            
            try {
                // Draw a small test line to verify canvas is working
                sketchCtx.save();
                sketchCtx.strokeStyle = '#10b981';
                sketchCtx.lineWidth = 3;
                sketchCtx.beginPath();
                sketchCtx.moveTo(10, 10);
                sketchCtx.lineTo(30, 10);
                sketchCtx.stroke();
                sketchCtx.restore();
                
                console.log('✅ Canvas drawing test successful');
                
                // Remove test line after 2 seconds
                setTimeout(() => {
                    if (sketchCanvas && sketchCtx) {
                        sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                        console.log('🧹 Test line cleared');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('❌ Canvas drawing test failed:', error);
            }
        }
        
        // Handle canvas resize
        function handleCanvasResize() {
            if (sketchCanvas) {
                const container = sketchCanvas.parentElement;
                sketchCanvas.width = container.clientWidth;
                sketchCanvas.height = container.clientHeight;
                
                // Redraw all labels after resize
                redrawAllLabels();
                console.log('🔄 Canvas resized');
            }
        }

        function hideSketchPlaceholder() {
            const placeholder = document.getElementById('sketch-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }

        function startSketchDrawing(e) {
            console.log('🎨 Start drawing event triggered');
            
            if (!sketchCanvas || !sketchCtx) {
                console.warn('⚠️ Canvas not initialized in startSketchDrawing');
                return;
            }
            
            isDrawing = true;
            const rect = sketchCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            console.log('✏️ Started drawing at:', lastX, lastY);
            
            // Hide placeholder immediately when drawing starts
            hideSketchPlaceholder();
        }

        function sketchDraw(e) {
            if (!isDrawing || !sketchCanvas || !sketchCtx) {
                if (!isDrawing) console.log('🎨 Not drawing');
                if (!sketchCanvas) console.log('🎨 No canvas');
                if (!sketchCtx) console.log('🎨 No context');
                return;
            }
            
            const rect = sketchCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Ensure we're within canvas bounds
            if (x < 0 || x > sketchCanvas.width || y < 0 || y > sketchCanvas.height) {
                return;
            }
            
            sketchCtx.beginPath();
            sketchCtx.moveTo(lastX, lastY);
            sketchCtx.lineTo(x, y);
            sketchCtx.stroke();
            
            lastX = x;
            lastY = y;
            
            console.log('✏️ Drawing line to:', x, y);
        }

        function stopSketchDrawing() {
            if (isDrawing) {
                isDrawing = false;
                console.log('✏️ Stopped drawing');
            }
        }

        function handleSketchTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            sketchCanvas.dispatchEvent(mouseEvent);
        }

        function handleSketchTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            sketchCanvas.dispatchEvent(mouseEvent);
        }

        function setSketchTool(tool) {
            currentSketchTool = tool;
            
            // Update button styles
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tool-${tool}`).classList.add('active');
            
            // Show/hide ingredient selector
            const ingredientSelector = document.getElementById('ingredient-selector');
            if (tool === 'label') {
                ingredientSelector.classList.remove('hidden');
            } else {
                ingredientSelector.classList.add('hidden');
            }
            
            // Update cursor
            if (tool === 'pen') {
                sketchCanvas.style.cursor = 'crosshair';
            } else if (tool === 'text') {
                sketchCanvas.style.cursor = 'text';
            } else if (tool === 'shape') {
                sketchCanvas.style.cursor = 'crosshair';
            } else if (tool === 'label') {
                sketchCanvas.style.cursor = 'pointer';
            }
            
            console.log('🎨 Sketch tool changed to:', tool);
        }

        function setSketchColor(color) {
            currentSketchColor = color;
            sketchCtx.strokeStyle = color;
            sketchCtx.fillStyle = color;
            
            // Update color button styles
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked color button
            const colorButtons = document.querySelectorAll('.color-btn');
            colorButtons.forEach(btn => {
                if (btn.style.backgroundColor === color) {
                    btn.classList.add('active');
                }
            });
            
            console.log('🎨 Sketch color changed to:', color);
        }

        function clearSketch() {
            if (confirm('Are you sure you want to clear the sketch?')) {
                sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                ingredientLabels = [];
                const placeholder = document.getElementById('sketch-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
                console.log('🗑️ Sketch cleared');
            }
        }

        function downloadSketch() {
            const link = document.createElement('a');
            link.download = `recipe-sketch-${Date.now()}.png`;
            link.href = sketchCanvas.toDataURL();
            link.click();
            console.log('📥 Sketch downloaded');
        }

        function loadIngredientsForLabeling() {
            const dropdown = document.getElementById('ingredient-dropdown');
            if (!dropdown) return;
            
            // Get ingredients from the form
            const ingredientRows = document.querySelectorAll('.ingredient-row input');
            const ingredients = [];
            
            ingredientRows.forEach((input, index) => {
                if (index % 4 === 0 && input.value.trim()) { // Every 4th input is ingredient name
                    ingredients.push(input.value.trim());
                }
            });
            
            // Populate dropdown
            dropdown.innerHTML = '<option value="">Choose an ingredient...</option>';
            ingredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient;
                option.textContent = ingredient;
                dropdown.appendChild(option);
            });
        }

        function handleSketchCanvasClick(e) {
            if (currentSketchTool === 'label') {
                const rect = sketchCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const selectedIngredient = document.getElementById('ingredient-dropdown').value;
                if (selectedIngredient) {
                    addIngredientLabel(x, y, selectedIngredient);
                }
            }
        }

        function addIngredientLabel(x, y, ingredientName) {
            const label = {
                x: x,
                y: y,
                ingredient: ingredientName,
                timestamp: Date.now()
            };
            
            ingredientLabels.push(label);
            drawIngredientLabel(label);
            console.log('🏷️ Added ingredient label:', ingredientName, 'at', x, y);
        }

        function drawIngredientLabel(label) {
            sketchCtx.save();
            sketchCtx.fillStyle = '#ffffff';
            sketchCtx.strokeStyle = currentSketchColor;
            sketchCtx.lineWidth = 2;
            
            // Draw label background
            const text = label.ingredient;
            sketchCtx.font = '12px Arial';
            const textMetrics = sketchCtx.measureText(text);
            const padding = 4;
            const labelWidth = textMetrics.width + padding * 2;
            const labelHeight = 16;
            
            sketchCtx.fillRect(label.x, label.y - labelHeight, labelWidth, labelHeight);
            sketchCtx.strokeRect(label.x, label.y - labelHeight, labelWidth, labelHeight);
            
            // Draw text
            sketchCtx.fillStyle = currentSketchColor;
            sketchCtx.fillText(text, label.x + padding, label.y - 4);
            
            // Draw connecting line
            sketchCtx.beginPath();
            sketchCtx.moveTo(label.x + labelWidth / 2, label.y);
            sketchCtx.lineTo(label.x + labelWidth / 2, label.y + 10);
            sketchCtx.stroke();
            
            sketchCtx.restore();
        }

        function redrawAllLabels() {
            ingredientLabels.forEach(label => {
                drawIngredientLabel(label);
            });
        }

        // Save sketch data with recipe
        function saveSketchData() {
            if (sketchCanvas) {
                const sketchData = {
                    canvasData: sketchCanvas.toDataURL(),
                    notes: document.getElementById('sketch-notes').value,
                    ingredientLabels: ingredientLabels,
                    recipeId: currentRecipeId,
                    userId: currentUser?.id || 'guest',
                    userName: currentUser?.name || 'Guest User',
                    savedAt: new Date().toISOString()
                };
                
                // Save to user-specific file
                const success = saveUserFile('sketch_data.json', sketchData);
                
                if (success) {
                    console.log('💾 Sketch data saved to user file');
                } else {
                    console.warn('⚠️ Failed to save sketch data to user file, using localStorage fallback');
                    localStorage.setItem(`user_${currentUser?.id || 'guest'}_sketch_data`, JSON.stringify(sketchData));
                }
            }
        }

        // Load sketch data
        function loadSketchData() {
            // Try to load from user-specific file first
            let sketchData = null;
            
            try {
                sketchData = loadUserFile('sketch_data.json');
                if (sketchData) {
                    sketchData = JSON.parse(sketchData);
                    console.log('📥 Sketch data loaded from user file');
                }
            } catch (error) {
                console.warn('⚠️ Could not load sketch data from user file, trying localStorage fallback');
                // Fallback to localStorage
                sketchData = localStorage.getItem(`user_${currentUser?.id || 'guest'}_sketch_data`);
                if (sketchData) {
                    sketchData = JSON.parse(sketchData);
                    console.log('📥 Sketch data loaded from localStorage fallback');
                }
            }
            
            if (sketchData && sketchCanvas) {
                try {
                    // Load canvas image
                    if (sketchData.canvasData) {
                        const img = new Image();
                        img.onload = function() {
                            sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                            sketchCtx.drawImage(img, 0, 0);
                            hideSketchPlaceholder();
                        };
                        img.src = sketchData.canvasData;
                    }
                    
                    // Load notes
                    if (sketchData.notes) {
                        document.getElementById('sketch-notes').value = sketchData.notes;
                    }
                    
                    // Load ingredient labels
                    if (sketchData.ingredientLabels) {
                        ingredientLabels = sketchData.ingredientLabels;
                        redrawAllLabels();
                    }
                    
                    console.log('📥 Sketch data loaded successfully');
                } catch (error) {
                    console.error('❌ Error loading sketch data:', error);
                }
            }
        }

        // Recipe Form Functions
        function addIngredient(name = '', amount = '', unit = 'g', notes = '') {
            const container = document.getElementById('ingredients-container');
            if (!container) return;
            
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row';
            ingredientRow.innerHTML = `
                <input type="text" class="form-input" placeholder="Ingredient name" value="${name}">
                <input type="text" class="form-input" placeholder="Amount" value="${amount}">
                <select class="form-select">
                    <option value="g" ${unit === 'g' ? 'selected' : ''}>grams</option>
                    <option value="kg" ${unit === 'kg' ? 'selected' : ''}>kilograms</option>
                    <option value="ml" ${unit === 'ml' ? 'selected' : ''}>milliliters</option>
                    <option value="l" ${unit === 'l' ? 'selected' : ''}>liters</option>
                    <option value="tsp" ${unit === 'tsp' ? 'selected' : ''}>teaspoon</option>
                    <option value="tbsp" ${unit === 'tbsp' ? 'selected' : ''}>tablespoon</option>
                    <option value="cup" ${unit === 'cup' ? 'selected' : ''}>cup</option>
                    <option value="piece" ${unit === 'piece' ? 'selected' : ''}>piece</option>
                </select>
                <input type="text" class="form-input" placeholder="Notes" value="${notes}">
                <button class="btn btn-secondary" onclick="removeIngredient(this)">🗑️</button>
            `;
            
            container.appendChild(ingredientRow);
        }

        function removeIngredient(button) {
            const row = button.closest('.ingredient-row');
            if (row) {
                row.remove();
            }
        }

        function addInstruction(instruction = '') {
            const container = document.getElementById('instructions-container');
            if (!container) return;
            
            const stepNumber = container.children.length + 1;
            const instructionStep = document.createElement('div');
            instructionStep.className = 'instruction-step';
            instructionStep.innerHTML = `
                <div class="step-number">${stepNumber}</div>
                <textarea class="form-textarea" placeholder="Describe this step...">${instruction}</textarea>
            `;
            
            container.appendChild(instructionStep);
        }

        function removeInstruction(button) {
            const step = button.closest('.instruction-step');
            if (step) {
                step.remove();
                // Renumber remaining steps
                const steps = document.querySelectorAll('.instruction-step');
                steps.forEach((step, index) => {
                    const number = step.querySelector('.step-number');
                    if (number) {
                        number.textContent = index + 1;
                    }
                });
            }
        }

        // Save recipe function
        function saveRecipe() {
            console.log('💾 Saving recipe...');
            
            // Collect recipe data
            const recipeData = {
                id: currentRecipeId || 'recipe_' + Date.now(),
                title: document.getElementById('recipe-name').value,
                category: document.getElementById('recipe-category').value,
                cuisine: document.getElementById('recipe-cuisine').value,
                servings: parseInt(document.getElementById('recipe-servings').value) || 4,
                ingredients: collectIngredients(),
                instructions: collectInstructions(),
                status: 'in-progress',
                lastUpdated: new Date().toISOString(),
                userId: currentUser?.id || 'guest',
                userName: currentUser?.name || 'Guest User',
                // Additional metadata
                notes: document.getElementById('sketch-notes')?.value || '',
                sketchData: {
                    hasSketch: ingredientLabels.length > 0,
                    labelCount: ingredientLabels.length,
                    lastSketchUpdate: new Date().toISOString()
                },
                nutritionData: {
                    calories: document.getElementById('calories')?.textContent || '0',
                    protein: document.getElementById('protein')?.textContent || '0g',
                    carbs: document.getElementById('carbs')?.textContent || '0g',
                    fat: document.getElementById('fat')?.textContent || '0g',
                    fiber: document.getElementById('fiber')?.textContent || '0g',
                    sugar: document.getElementById('sugar')?.textContent || '0g'
                },
                metadata: {
                    createdFromIdea: currentRecipeId ? false : true,
                    totalIngredients: collectIngredients().length,
                    totalInstructions: collectInstructions().length,
                    complexity: calculateRecipeComplexity(),
                    estimatedPrepTime: estimatePrepTime(),
                    tags: generateRecipeTags()
                }
            };
            
            if (!recipeData.title.trim()) {
                alert('Please enter a recipe name');
                return;
            }
            
            // Save to user-specific file
            const existingRecipes = loadInProgressRecipesFromFile();
            const existingIndex = existingRecipes.findIndex(r => r.id === recipeData.id);
            
            if (existingIndex !== -1) {
                // Update existing recipe
                existingRecipes[existingIndex] = { ...existingRecipes[existingIndex], ...recipeData };
            } else {
                // Add new recipe
                existingRecipes.push(recipeData);
            }
            
            // Save to user file
            const saveSuccess = saveUserFile('recipes_in_progress.json', existingRecipes);
            
            if (saveSuccess) {
                // Update current recipe
                currentRecipeId = recipeData.id;
                currentRecipeData = recipeData;
                
                // Update status
                updateRecipeStatus('in-progress', 'Recipe Saved to User File');
                
                // Save recipe history
                saveRecipeHistory(recipeData);
                
                // Refresh ideas list
                loadRecipeIdeasFromFiles();
                
                console.log('✅ Recipe saved to user file:', recipeData);
                alert('Recipe saved successfully to your user file!');
            } else {
                console.error('❌ Failed to save recipe to user file');
                alert('Failed to save recipe. Please try again.');
            }
        }
        
        // Save recipe history for versioning
        function saveRecipeHistory(recipeData) {
            try {
                // Load existing history
                let recipeHistory = [];
                try {
                    const historyData = loadUserFile('recipe_history.json');
                    if (historyData) {
                        recipeHistory = JSON.parse(historyData);
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load recipe history, starting fresh');
                }
                
                // Create history entry
                const historyEntry = {
                    recipeId: recipeData.id,
                    title: recipeData.title,
                    action: 'saved',
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id || 'guest',
                    userName: currentUser?.name || 'Guest User',
                    version: recipeData.version || 1,
                    changes: {
                        ingredients: recipeData.ingredients.length,
                        instructions: recipeData.instructions.length,
                        hasSketch: recipeData.sketchData.hasSketch,
                        hasNutrition: recipeData.nutritionData.calories !== '0'
                    }
                };
                
                // Add to history
                recipeHistory.push(historyEntry);
                
                // Keep only last 100 entries per recipe to prevent excessive storage
                const maxHistoryPerRecipe = 100;
                const recipeHistoryMap = new Map();
                recipeHistory.forEach(entry => {
                    if (!recipeHistoryMap.has(entry.recipeId)) {
                        recipeHistoryMap.set(entry.recipeId, []);
                    }
                    recipeHistoryMap.get(entry.recipeId).push(entry);
                });
                
                // Limit history per recipe
                recipeHistory = [];
                recipeHistoryMap.forEach((entries, recipeId) => {
                    const sortedEntries = entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    recipeHistory.push(...sortedEntries.slice(0, maxHistoryPerRecipe));
                });
                
                // Save history to user file
                const success = saveUserFile('recipe_history.json', recipeHistory);
                
                if (success) {
                    console.log('📚 Recipe history saved to user file');
                } else {
                    console.warn('⚠️ Failed to save recipe history to user file, using localStorage fallback');
                    localStorage.setItem(`user_${currentUser?.id || 'guest'}_recipe_history`, JSON.stringify(recipeHistory));
                }
                
            } catch (error) {
                console.error('❌ Error saving recipe history:', error);
            }
        }
        
        // Load in-progress recipes from user file
        function loadInProgressRecipesFromFile() {
            try {
                const recipesData = loadUserFile('recipes_in_progress.json');
                if (recipesData) {
                    return JSON.parse(recipesData);
                }
            } catch (error) {
                console.warn('⚠️ Could not load from user file, using empty array');
            }
            return [];
        }

        function collectIngredients() {
            const ingredients = [];
            const rows = document.querySelectorAll('.ingredient-row');
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                if (inputs[0].value.trim()) {
                    ingredients.push({
                        name: inputs[0].value.trim(),
                        amount: inputs[1].value.trim(),
                        unit: inputs[2].value,
                        notes: inputs[3].value.trim()
                    });
                }
            });
            
            return ingredients;
        }

        function collectInstructions() {
            const instructions = [];
            const steps = document.querySelectorAll('.instruction-step textarea');
            
            steps.forEach(step => {
                if (step.value.trim()) {
                    instructions.push(step.value.trim());
                }
            });
            
            return instructions;
        }

        // Export and other functions
        function exportRecipe() {
            console.log('📤 Exporting recipe...');
            
            if (!currentRecipeData) {
                alert('No recipe to export. Please save a recipe first.');
                return;
            }
            
            // Create export data
            const exportData = {
                ...currentRecipeData,
                exportedAt: new Date().toISOString(),
                exportFormat: 'Iterum Recipe'
            };
            
            // Create downloadable file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentRecipeData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_recipe.json`;
            link.click();
            
            console.log('✅ Recipe exported as JSON file');
            alert('Recipe exported successfully!');
        }
        
                // Export all user data to computer files
        function exportAllUserData() {
            console.log('📤 Exporting all user data...');
            
            if (!currentUser) {
                alert('No user logged in. Please log in to export data.');
                return;
            }
            
            try {
                // Get all user data from files
                const recipeIdeas = loadUserFile('recipe_ideas.json') ? JSON.parse(loadUserFile('recipe_ideas.json')) : [];
                const inProgressRecipes = loadInProgressRecipesFromFile();
                const sketchData = loadUserFile('sketch_data.json') ? JSON.parse(loadUserFile('sketch_data.json')) : [];
                const nutritionData = loadUserFile('nutrition_data.json') ? JSON.parse(loadUserFile('nutrition_data.json')) : [];
                const recipeHistory = loadUserFile('recipe_history.json') ? JSON.parse(loadUserFile('recipe_history.json')) : [];
                
                // Try to load additional data types if available
                let dailyNotes = [];
                let ingredients = [];
                let vendors = [];
                let menus = [];
                let calendarData = {};
                let haccpData = {};
                let inventory = [];
                let errors = [];
                
                if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
                    const userId = window.userDataManager.getCurrentUserId();
                    
                    // Load additional data types
                    dailyNotes = window.userDataManager.loadUserFile(`user_${userId}_daily_notes.json`) || [];
                    ingredients = window.userDataManager.loadUserFile(`user_${userId}_ingredients.json`) || [];
                    vendors = window.userDataManager.loadUserFile(`user_${userId}_vendors.json`) || [];
                    menus = window.userDataManager.loadUserFile(`user_${userId}_menus.json`) || [];
                    calendarData = {
                        journalEntries: window.userDataManager.loadUserFile(`user_${userId}_journal_entries.json`) || [],
                        recipeChanges: window.userDataManager.loadUserFile(`user_${userId}_recipe_changes.json`) || [],
                        maintenanceLog: window.userDataManager.loadUserFile(`user_${userId}_maintenance_log.json`) || []
                    };
                    haccpData = {
                        temperature: window.userDataManager.loadUserFile(`user_${userId}_haccp_temperature.json`) || [],
                        sanitizer: window.userDataManager.loadUserFile(`user_${userId}_haccp_sanitizer.json`) || [],
                        dishwasher: window.userDataManager.loadUserFile(`user_${userId}_haccp_dishwasher.json`) || []
                    };
                    inventory = window.userDataManager.loadUserFile(`user_${userId}_inventory.json`) || [];
                    errors = window.userDataManager.loadUserFile(`user_${userId}_errors.json`) || [];
                }
                
                // Create comprehensive user data package
                const userDataPackage = {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    exportedAt: new Date().toISOString(),
                    exportVersion: '3.0',
                    dataTypes: {
                        recipeIdeas: recipeIdeas.length,
                        inProgressRecipes: inProgressRecipes.length,
                        sketchData: sketchData.length,
                        nutritionData: nutritionData.length,
                        recipeHistory: recipeHistory.length,
                        dailyNotes: dailyNotes.length,
                        ingredients: ingredients.length,
                        vendors: vendors.length,
                        menus: menus.length,
                        calendarData: Object.values(calendarData).reduce((sum, arr) => sum + arr.length, 0),
                        haccpData: Object.values(haccpData).reduce((sum, arr) => sum + arr.length, 0),
                        inventory: inventory.length,
                        errors: errors.length
                    },
                    recipeIdeas: recipeIdeas,
                    inProgressRecipes: inProgressRecipes,
                    sketchData: sketchData,
                    nutritionData: nutritionData,
                    recipeHistory: recipeHistory,
                    dailyNotes: dailyNotes,
                    ingredients: ingredients,
                    vendors: vendors,
                    menus: menus,
                    calendarData: calendarData,
                    haccpData: haccpData,
                    inventory: inventory,
                    errors: errors,
                    metadata: {
                        totalDataSize: JSON.stringify(userDataPackage).length,
                        userCreatedAt: currentUser.createdAt || 'Unknown',
                        lastActivity: new Date().toISOString(),
                        systemInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    }
                };
                
                // Create downloadable file
                const dataStr = JSON.stringify(userDataPackage, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${currentUser.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_complete_culinary_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                console.log('✅ Complete user data exported');
                alert(`Complete data exported for ${currentUser.name}! Includes all recipe data, daily notes, ingredients, vendors, menus, calendar events, HACCP data, inventory, and error logs.`);
                
            } catch (error) {
                console.error('❌ Error exporting user data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        function calculateNutrition() {
            console.log('🧮 Calculating nutrition...');
            
            // Collect ingredients for nutrition calculation
            const ingredients = collectIngredients();
            if (ingredients.length === 0) {
                alert('Please add ingredients before calculating nutrition.');
                return;
            }
            
            // Simple nutrition calculation (this would be enhanced with a real nutrition database)
            const nutritionData = {
                calories: ingredients.length * 150, // Placeholder calculation
                protein: ingredients.length * 8,
                carbs: ingredients.length * 20,
                fat: ingredients.length * 5,
                fiber: ingredients.length * 3,
                sugar: ingredients.length * 2,
                recipeId: currentRecipeId,
                userId: currentUser?.id || 'guest',
                userName: currentUser?.name || 'Guest User',
                calculatedAt: new Date().toISOString(),
                ingredients: ingredients
            };
            
            // Update nutrition display
            document.getElementById('calories').textContent = nutritionData.calories;
            document.getElementById('protein').textContent = nutritionData.protein + 'g';
            document.getElementById('carbs').textContent = nutritionData.carbs + 'g';
            document.getElementById('fat').textContent = nutritionData.fat + 'g';
            document.getElementById('fiber').textContent = nutritionData.fiber + 'g';
            document.getElementById('sugar').textContent = nutritionData.sugar + 'g';
            
            // Save nutrition data to user file
            const success = saveUserFile('nutrition_data.json', nutritionData);
            
            if (success) {
                console.log('💾 Nutrition data saved to user file');
                alert('Nutrition calculated and saved!');
            } else {
                console.warn('⚠️ Failed to save nutrition data to user file, using localStorage fallback');
                localStorage.setItem(`user_${currentUser?.id || 'guest'}_nutrition_data`, JSON.stringify(nutritionData));
                alert('Nutrition calculated!');
            }
        }

        function previewRecipe() {
            console.log('👁️ Previewing recipe...');
            // Implementation for recipe preview
            alert('Preview functionality coming soon!');
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
                
                // Update sidebar user info
                updateSidebarUserInfo();
            }
        }
        
        function updateSidebarUserInfo() {
            const pathElement = document.getElementById('user-data-path');
            const nameElement = document.getElementById('sidebar-user-name');
            
            if (pathElement && nameElement && currentUser) {
                pathElement.textContent = userDataPath || 'Not set';
                nameElement.textContent = currentUser.name || 'Unknown User';
            }
        }

        function initializeProjectSelector() {
            // Project management now handled by new system
        }

        function getCurrentUserId() {
            const currentUser = window.userSystem?.getCurrentUser();
            return currentUser?.id || null;
        }
        
        // Recipe metadata helper functions
        function calculateRecipeComplexity() {
            const ingredients = collectIngredients();
            const instructions = collectInstructions();
            
            let complexity = 1; // Base complexity
            
            // Factor in number of ingredients
            if (ingredients.length > 10) complexity += 2;
            else if (ingredients.length > 5) complexity += 1;
            
            // Factor in number of instructions
            if (instructions.length > 8) complexity += 2;
            else if (instructions.length > 4) complexity += 1;
            
            // Factor in ingredient types (check for complex ingredients)
            const complexIngredients = ingredients.filter(ing => 
                ing.name.toLowerCase().includes('yeast') || 
                ing.name.toLowerCase().includes('dough') ||
                ing.name.toLowerCase().includes('sauce') ||
                ing.name.toLowerCase().includes('stock')
            );
            complexity += complexIngredients.length;
            
            return Math.min(complexity, 5); // Cap at 5
        }
        
        function estimatePrepTime() {
            const ingredients = collectIngredients();
            const instructions = collectInstructions();
            
            let baseTime = 15; // Base 15 minutes
            
            // Add time for each ingredient
            baseTime += ingredients.length * 2;
            
            // Add time for each instruction step
            baseTime += instructions.length * 3;
            
            // Add time for complex operations
            const complexOps = instructions.filter(step => 
                step.toLowerCase().includes('marinate') ||
                step.toLowerCase().includes('rest') ||
                step.toLowerCase().includes('chill') ||
                step.toLowerCase().includes('rise')
            );
            baseTime += complexOps.length * 10;
            
            return baseTime;
        }
        
        function generateRecipeTags() {
            const tags = [];
            const title = document.getElementById('recipe-name').value.toLowerCase();
            const category = document.getElementById('recipe-category').value;
            const cuisine = document.getElementById('recipe-cuisine').value;
            const ingredients = collectIngredients();
            
            // Add category tag
            if (category) tags.push(category);
            
            // Add cuisine tag
            if (cuisine) tags.push(cuisine);
            
            // Add ingredient-based tags
            ingredients.forEach(ingredient => {
                const name = ingredient.name.toLowerCase();
                if (name.includes('chicken')) tags.push('poultry');
                if (name.includes('beef') || name.includes('steak')) tags.push('beef');
                if (name.includes('fish') || name.includes('salmon')) tags.push('seafood');
                if (name.includes('vegetable') || name.includes('carrot')) tags.push('vegetarian');
                if (name.includes('spice') || name.includes('chili')) tags.push('spicy');
            });
            
            // Add complexity tag
            const complexity = calculateRecipeComplexity();
            if (complexity >= 4) tags.push('advanced');
            else if (complexity >= 2) tags.push('intermediate');
            else tags.push('beginner');
            
            // Remove duplicates
            return [...new Set(tags)];
        }

        // Recipe Development Functions
        function addIngredient() {
            const container = document.getElementById('ingredients-container');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <input type="text" class="form-input" placeholder="Ingredient name">
                <input type="text" class="form-input" placeholder="Amount">
                <select class="form-select">
                    <option value="g">grams</option>
                    <option value="kg">kilograms</option>
                    <option value="ml">milliliters</option>
                    <option value="l">liters</option>
                    <option value="tsp">teaspoon</option>
                    <option value="tbsp">tablespoon</option>
                    <option value="cup">cup</option>
                    <option value="piece">piece</option>
                </select>
                <input type="text" class="form-input" placeholder="Notes">
                <button class="btn btn-secondary" onclick="removeIngredient(this)">🗑️</button>
            `;
            container.appendChild(newRow);
        }

        function removeIngredient(button) {
            button.closest('.ingredient-row').remove();
        }

        function addInstruction() {
            const container = document.getElementById('instructions-container');
            const stepCount = container.children.length + 1;
            const newStep = document.createElement('div');
            newStep.className = 'instruction-step';
            newStep.innerHTML = `
                <div class="step-number">${stepCount}</div>
                <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
            `;
            container.appendChild(newStep);
        }

        function saveRecipe() {
            // Save recipe logic
            console.log('💾 Saving recipe...');
        }

        function exportRecipe() {
            // Export logic
            console.log('📤 Exporting recipe...');
        }

        function calculateNutrition() {
            // Calculate nutrition logic
            console.log('🧮 Calculating nutrition...');
        }

        function previewRecipe() {
            // Preview logic
            console.log('👁️ Previewing recipe...');
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Manual refresh function for debugging
        function refreshRecipeIdeasOnDeveloperPage() {
            console.log('🔄 Manually refreshing recipe ideas on developer page...');
            loadRecipeIdeasFromFiles();
        }
        
        // Manual import function to get ideas from main page
        function importFromMainPage() {
            console.log('📥 Manually importing ideas from main page...');
            
            try {
                // Try to get ideas from main page localStorage
                const mainPageIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                console.log('📥 Found', mainPageIdeas.length, 'ideas on main page');
                
                if (mainPageIdeas.length > 0) {
                    // Save these ideas to the current project
                    if (window.projectManager && window.projectManager.getCurrentProject()) {
                        const projectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
                        localStorage.setItem(projectKey, JSON.stringify(mainPageIdeas));
                        console.log('💾 Saved ideas to project:', projectKey);
                        
                        // Reload the ideas display
                        loadRecipeIdeasFromFiles();
                        
                        alert(`Successfully imported ${mainPageIdeas.length} ideas from main page!`);
                    } else {
                        alert('No current project selected. Please select a project first.');
                    }
                } else {
                    alert('No ideas found on main page. Create some ideas first!');
                }
            } catch (error) {
                console.error('❌ Error importing ideas:', error);
                alert('Error importing ideas: ' + error.message);
            }
        }
        
        // Make functions globally available for debugging
        window.refreshRecipeIdeasOnDeveloperPage = refreshRecipeIdeasOnDeveloperPage;
        window.importFromMainPage = importFromMainPage;
        
        // Canvas status check function
        function checkCanvasStatus() {
            const status = {
                canvasElement: !!sketchCanvas,
                canvasContext: !!sketchCtx,
                canvasSize: sketchCanvas ? `${sketchCanvas.width}x${sketchCanvas.height}` : 'N/A',
                canvasStyle: sketchCanvas ? {
                    pointerEvents: sketchCanvas.style.pointerEvents,
                    cursor: sketchCanvas.style.cursor,
                    display: sketchCanvas.style.display,
                    visibility: sketchCanvas.style.visibility
                } : 'N/A',
                isDrawing: isDrawing,
                currentTool: currentSketchTool,
                currentColor: currentSketchColor,
                containerSize: sketchCanvas ? {
                    containerWidth: sketchCanvas.parentElement.clientWidth,
                    containerHeight: sketchCanvas.parentElement.clientHeight,
                    rectWidth: sketchCanvas.parentElement.getBoundingClientRect().width,
                    rectHeight: sketchCanvas.parentElement.getBoundingClientRect().height
                } : 'N/A'
            };
            
            console.log('🎨 Canvas Status:', status);
            
            if (!sketchCanvas) {
                alert('Canvas element not found. Please click "🎨 Init Canvas" button.');
            } else if (!sketchCtx) {
                alert('Canvas context not available. Please click "🎨 Init Canvas" button.');
            } else {
                alert(`Canvas is working!\n\nSize: ${status.canvasSize}\nTool: ${status.currentTool}\nColor: ${status.currentColor}\n\nTry clicking and dragging on the canvas to draw!`);
            }
            
            return status;
        }
        
        // Make canvas status check globally available
        window.checkCanvasStatus = checkCanvasStatus;
        
        // Force reinitialize canvas function
        function forceReinitializeCanvas() {
            console.log('🔄 Force reinitializing canvas...');
            
            // Clear any existing canvas
            if (sketchCanvas) {
                sketchCanvas.width = 0;
                sketchCanvas.height = 0;
            }
            
            // Reset variables
            sketchCanvas = null;
            sketchCtx = null;
            isDrawing = false;
            
            // Wait a moment then reinitialize
            setTimeout(() => {
                initializeSketchCanvas();
            }, 100);
        }
        
        // Make force reinitialize globally available
        window.forceReinitializeCanvas = forceReinitializeCanvas;
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('✅ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('✅ Authentication system initialized');
          } else {
            console.error('❌ UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('✅ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('✅ Page protection system initialized');
          } else {
            console.warn('⚠️ PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
</body>
</html>