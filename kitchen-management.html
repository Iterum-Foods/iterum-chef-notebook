<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Management - Iterum Culinary App</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9) 0%, #0b1120 55%, #111827 100%);
            min-height: 100vh;
            padding: 96px 0 48px;
            color: #0f172a;
        }

        .kitchen-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 28px;
        }

        .page-header {
            background: linear-gradient(135deg, #1e293b 0%, #1d4ed8 40%, #4338ca 100%);
            color: #f8fafc;
            padding: 44px 48px;
            border-radius: 28px;
            margin-bottom: 36px;
            box-shadow: 0 32px 70px rgba(37, 99, 235, 0.25);
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.55rem;
            font-weight: 800;
            margin: 0 0 12px;
        }

        .page-header p {
            font-size: 1.05rem;
            margin: 6px 0 0;
            color: rgba(248, 250, 252, 0.9);
        }

        .content-shell {
            background: #fff;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.18);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .tool-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 28px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 26px 45px rgba(59, 130, 246, 0.22);
            border-color: rgba(67, 56, 202, 0.55);
        }

        .tool-icon {
            font-size: 2.8rem;
            margin-bottom: 16px;
            color: #4338ca;
        }

        .tool-title {
            font-size: 1.45rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 12px;
        }

        .tool-desc {
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 22px;
        }

        .tool-action {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 12px 24px rgba(67, 56, 202, 0.32);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .tool-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 28px rgba(79, 70, 229, 0.4);
        }

        .output-area {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 22px 48px rgba(15, 23, 42, 0.12);
            margin-top: 28px;
            display: none;
        }

        .output-area.active {
            display: block;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #dce3f5;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .prep-component {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 4px solid #4338ca;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .priority-high {
            border-left-color: #ef4444;
        }

        .priority-medium {
            border-left-color: #f59e0b;
        }

        .priority-low {
            border-left-color: #10b981;
        }

        .quick-actions-card {
            margin-top: 36px;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.96), rgba(226, 232, 240, 0.9));
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 18px 36px rgba(148, 163, 184, 0.22);
        }
    </style>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
</head>
<body style="padding-top: 80px;">
    <div class="kitchen-container">
        <div class="page-header">
            <h1>üî™ Kitchen Management System</h1>
            <p>Professional tools for recipe books, build sheets, checklists & prep lists</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Logged in as: <span id="current-user-email">Loading...</span></p>
        </div>

        <div class="content-shell">
        <div class="tools-grid">
            <!-- Recipe Book PDF -->
            <div class="tool-card" onclick="showRecipeBookOptions()">
                <div class="tool-icon">üìï</div>
                <div class="tool-title">Recipe Book PDF</div>
                <div class="tool-desc">
                    Generate professional PDF recipe book with all your recipes, components, and plating instructions.
                </div>
                <button class="tool-action">üì• Generate PDF</button>
            </div>

            <!-- Build Sheets -->
            <div class="tool-card" onclick="showBuildSheets()">
                <div class="tool-icon">üìã</div>
                <div class="tool-title">Build Sheets</div>
                <div class="tool-desc">
                    Create detailed build sheets for each recipe with components, yields, and par levels.
                </div>
                <button class="tool-action">üìÑ View Build Sheets</button>
            </div>

            <!-- Pre-Service Checklist -->
            <div class="tool-card" onclick="showPreServiceChecklist()">
                <div class="tool-icon">‚úÖ</div>
                <div class="tool-title">Pre-Service Checklist</div>
                <div class="tool-desc">
                    Quality control checklist for equipment, ingredients, prep, and station readiness.
                </div>
                <button class="tool-action">‚úì Open Checklist</button>
            </div>

            <!-- Next Day Prep List -->
            <div class="tool-card" onclick="showPrepList()">
                <div class="tool-icon">üìù</div>
                <div class="tool-title">Next Day Prep List</div>
                <div class="tool-desc">
                    Generate prep list for tomorrow with priorities, shopping list, and task breakdown.
                </div>
                <button class="tool-action">üìÖ Generate Prep List</button>
            </div>

            <!-- FOH Information Sheet -->
            <div class="tool-card" onclick="showFOHSheet()">
                <div class="tool-icon">üõéÔ∏è</div>
                <div class="tool-title">FOH Information Sheet</div>
                <div class="tool-desc">
                    Brief servers on dish talking points, allergens, pairings, and daily highlights.
                </div>
                <button class="tool-action">üéôÔ∏è Prep FOH Briefing</button>
            </div>

            <!-- Version History -->
            <div class="tool-card" onclick="showVersionHistory()">
                <div class="tool-icon">üïê</div>
                <div class="tool-title">Recipe Versions</div>
                <div class="tool-desc">
                    Track recipe changes over time, compare versions, and restore previous versions.
                </div>
                <button class="tool-action">üìú View History</button>
            </div>

            <!-- Export All -->
            <div class="tool-card" onclick="exportAll()">
                <div class="tool-icon">üì¶</div>
                <div class="tool-title">Export All</div>
                <div class="tool-desc">
                    Download all kitchen documents (recipe book, build sheets, checklists) as ZIP file.
                </div>
                <button class="tool-action">üíæ Export Everything</button>
            </div>
        </div>

        <!-- Output Area -->
        <div id="output-area" class="output-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="output-title" style="font-size: 1.8rem; font-weight: 700;">Output</h2>
                <button onclick="closeOutput()" style="padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">‚úï Close</button>
            </div>
            <div id="output-content"></div>
        </div>

        <!-- Quick Actions -->
        <div class="card quick-actions-card" style="margin-top: 30px;">
            <div class="card-header-gradient">
                <h2 class="card-title">Quick Actions</h2>
            </div>
            <div style="padding: 20px;">
                <div class="button-group">
                    <button class="btn" onclick="location.href='index.html'">üè† Dashboard</button>
                    <button class="btn" onclick="location.href='recipe-library.html'">üìö Recipe Library</button>
                    <button class="btn" onclick="location.href='ingredient-highlights.html'">‚ú® Ingredient Highlights</button>
                    <button class="btn" onclick="location.href='server-info-sheet.html'">üìã Server Info</button>
                    <button class="btn" onclick="location.href='menu-builder.html'">üçΩÔ∏è Menu Builder</button>
                </div>
            </div>
        </div>
        </div> <!-- /.content-shell -->
    </div>

    <!-- Auth -->
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/state-persistence-manager.js"></script>
    <script src="assets/js/universal-recipe-manager.js"></script>
    <script src="assets/js/menu-prep-manager.js"></script>
    <script src="assets/js/menu-foh-manager.js"></script>
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <script src="assets/js/kitchen-management-system.js"></script>
    
    <script>
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for auth
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (!window.authManager || !window.authManager.isAuthenticated) {
                alert('Please sign in to access Kitchen Management');
                window.location.href = 'index.html';
                return;
            }

            const user = window.authManager.currentUser;
            document.getElementById('current-user-email').textContent = user.email;
            
            // Initialize kitchen system
            await window.kitchenManagementSystem.init(user.userId || user.id, user.email);
        });

        function showRecipeBookOptions() {
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = 'üìï Recipe Book PDF Generator';
            content.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">PDF Options</h3>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-components" checked>
                            Include recipe components and sub-recipes
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-photos">
                            Include recipe photos
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-nutrition" checked>
                            Include nutritional information
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="pdf-costs">
                            Include cost breakdown
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="pdf-format">
                            <option value="standard">Standard (Easy to read)</option>
                            <option value="compact">Compact (Save paper)</option>
                            <option value="full">Full Details (Everything)</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="generatePDF()" style="width: 100%;">
                        üì• Download Recipe Book PDF
                    </button>
                </div>
                
                <div id="pdf-status" style="margin-top: 15px; padding: 15px; background: #f1f5f9; border-radius: 8px; display: none;">
                    <p style="margin: 0;">Generating PDF...</p>
                </div>
            `;
            
            output.classList.add('active');
        }

        function showBuildSheets() {
            const recipes = window.kitchenManagementSystem.currentRecipes;
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = 'üìã Recipe Build Sheets';
            
            if (recipes.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 4rem;">üìã</div>
                        <h3 style="margin: 20px 0 10px;">No Recipes Found</h3>
                        <p>Create some recipes first to generate build sheets.</p>
                        <button class="btn" onclick="location.href='recipe-developer.html'" style="margin-top: 20px;">
                            üë®‚Äçüç≥ Create Recipe
                        </button>
                    </div>
                `;
                output.classList.add('active');
                return;
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #64748b; margin-bottom: 15px;">Select a recipe to view its build sheet:</p>
                    <select class="form-select" id="recipe-select" onchange="displayBuildSheet(this.value)">
                        <option value="">-- Select Recipe --</option>
                        ${recipes.map(r => `<option value="${r.id}">${r.title || r.name}</option>`).join('')}
                    </select>
                </div>
                <div id="build-sheet-content"></div>
            `;
            
            output.classList.add('active');
        }

        function displayBuildSheet(recipeId) {
            if (!recipeId) return;
            
            const buildSheet = window.kitchenManagementSystem.generateBuildSheet(recipeId);
            const content = document.getElementById('build-sheet-content');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">${buildSheet.recipeName}</h2>
                        <p class="card-subtitle">Build Sheet - Version ${buildSheet.version}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Overview -->
                        <div class="stats-row" style="margin-bottom: 25px;">
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.servings}</div>
                                <div class="stat-label">Servings</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.prepTime}m</div>
                                <div class="stat-label">Prep</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.cookTime}m</div>
                                <div class="stat-label">Cook</div>
                            </div>
                            <div class="stat-item-centered">
                                <div class="stat-value">${buildSheet.difficulty}</div>
                                <div class="stat-label">Difficulty</div>
                            </div>
                        </div>

                        <!-- Components -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">Components</h3>
                        ${buildSheet.components.map(comp => `
                            <div class="prep-component">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <h4 style="font-weight: 600; font-size: 1.1rem;">${comp.name}</h4>
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">
                                        ${comp.shelfLife}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #64748b;">
                                    <div><strong>Daily Par:</strong> ${comp.dailyPar}</div>
                                    <div><strong>Yield:</strong> ${comp.yield}</div>
                                    <div><strong>Portion:</strong> ${comp.portionSize}</div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <strong style="display: block; margin-bottom: 8px;">Ingredients:</strong>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        ${comp.ingredients.map(ing => `
                                            <li>${ing.name || ing.ingredientName} - ${ing.quantity} ${ing.unit}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                                
                                <div>
                                    <strong style="display: block; margin-bottom: 8px;">Instructions:</strong>
                                    <ol style="margin: 0; padding-left: 20px;">
                                        ${comp.instructions.map(inst => `<li>${inst}</li>`).join('')}
                                    </ol>
                                </div>
                            </div>
                        `).join('')}

                        <!-- Plating -->
                        ${buildSheet.plating.length > 0 ? `
                            <h3 style="font-size: 1.3rem; font-weight: 600; margin: 25px 0 15px;">Plating Instructions</h3>
                            <ol style="padding-left: 20px;">
                                ${buildSheet.plating.map(step => `<li style="margin-bottom: 8px;">${step}</li>`).join('')}
                            </ol>
                        ` : ''}

                        <!-- Quality Checks -->
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 25px 0 15px;">Quality Standards</h3>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            ${buildSheet.qualityChecks.map(check => `
                                <div style="margin-bottom: 8px;">‚òê ${check}</div>
                            `).join('')}
                        </div>

                        <!-- Actions -->
                        <div class="button-group" style="margin-top: 25px;">
                            <button class="btn" onclick="printBuildSheet('${recipeId}')">üñ®Ô∏è Print</button>
                            <button class="btn" onclick="downloadBuildSheet('${recipeId}')">üì• Download PDF</button>
                            <button class="btn" onclick="emailBuildSheet('${recipeId}')">üìß Email</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPreServiceChecklist() {
            const checklist = window.kitchenManagementSystem.generatePreServiceChecklist();
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = '‚úÖ Pre-Service Quality Checklist';
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">Pre-Service Checklist</h2>
                        <p class="card-subtitle">${checklist.date} | ${checklist.restaurant}</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        ${checklist.sections.map((section, sectionIndex) => `
                            <div style="margin-bottom: 30px;">
                                <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: #667eea;">
                                    ${section.name}
                                </h3>
                                ${section.items.map((item, itemIndex) => `
                                    <div class="checklist-item">
                                        <input 
                                            type="checkbox" 
                                            id="check-${sectionIndex}-${itemIndex}"
                                            onchange="updateChecklistProgress()"
                                        >
                                        <label for="check-${sectionIndex}-${itemIndex}" style="flex: 1; cursor: pointer;">
                                            ${item.task}
                                            ${item.shelfLife ? `<span style="color: #64748b; font-size: 0.85rem;"> (${item.shelfLife})</span>` : ''}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #0284c7;" id="checklist-progress">0%</div>
                                    <div style="color: #64748b;">Complete</div>
                                </div>
                                <button class="btn" onclick="saveChecklist()">üíæ Save Progress</button>
                            </div>
                        </div>
                        
                        <div class="button-group" style="margin-top: 20px;">
                            <button class="btn" onclick="printChecklist()">üñ®Ô∏è Print</button>
                            <button class="btn" onclick="downloadChecklistPDF()">üì• Download PDF</button>
                            <button class="btn" onclick="resetChecklist()">üîÑ Reset All</button>
                        </div>
                    </div>
                </div>
            `;
            
            output.classList.add('active');
            updateChecklistProgress();
        }

        function showPrepList() {
            const prepPlan = window.kitchenManagementSystem.generateNextDayPrepList();
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = 'üìù Next Day Prep Plan';
            
            const summarySection = prepPlan.menuSummary.length ? `
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header-gradient">
                        <h3 class="card-title">Menu Summary</h3>
                        <p class="card-subtitle">${prepPlan.menuSummary.length} menu items linked to recipes</p>
                    </div>
                    <div style="padding: 16px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                            <thead>
                                <tr style="text-align: left; background: #f1f5f9;">
                                    <th style="padding: 8px;">Dish</th>
                                    <th style="padding: 8px;">Station</th>
                                    <th style="padding: 8px;">Projected Covers</th>
                                    <th style="padding: 8px;">Status</th>
                                    <th style="padding: 8px;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${prepPlan.menuSummary.map(item => `
                                    <tr style="border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 8px; font-weight: 600;">${item.name}</td>
                                        <td style="padding: 8px;">${item.station || 'General'}</td>
                                        <td style="padding: 8px;">${item.covers || '‚Äî'}</td>
                                        <td style="padding: 8px;">${item.statusIcon || '‚ÑπÔ∏è'} ${item.statusLabel || item.recipeStatus || ''}</td>
                                        <td style="padding: 8px;">${item.notes || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '<p style="color: #64748b;">No menu items found. Build your menu to generate prep plans.</p>';

            const warningsSection = prepPlan.warnings.length ? `
                <div style="margin-bottom: 24px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                    <h4 style="font-weight: 600; color: #b91c1c; margin-bottom: 8px;">Warnings</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #b91c1c;">
                        ${prepPlan.warnings.map(warning => `<li>${warning.name || 'Item'}: ${warning.message}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            const formatQuantity = (value) => {
                if (value === null || value === undefined || Number.isNaN(value)) return '';
                const rounded = Math.round(value * 100) / 100;
                return Number.isInteger(rounded) ? rounded.toFixed(0) : rounded.toFixed(2);
            };

            const stationSections = Object.values(prepPlan.stations || {}).length ? Object.values(prepPlan.stations || {}).map(station => {
                const tasksHtml = station.tasks.map(task => {
                    const priorityClass = task.priority >= 4 ? 'high' : task.priority >= 3 ? 'medium' : 'low';
                    return `
                        <div class="prep-component priority-${priorityClass}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <h4 style="font-weight: 600; font-size: 1.05rem; margin-bottom: 4px;">${task.name}</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Recipe ID: ${task.recipeId || 'N/A'} | Covers: ${task.covers || '‚Äî'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: inline-block; padding: 4px 8px; background: rgba(37,99,235,0.1); color: #1d4ed8; border-radius: 12px; font-size: 0.8rem;">Priority ${task.priority || 1}</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px; color: #475569; font-size: 0.9rem;">
                                <strong>Ingredients:</strong>
                                <ul style="margin: 6px 0 0 20px;">
                                    ${task.ingredients.map(ing => `<li>${ing.scaledAmount !== null ? `${formatQuantity(ing.scaledAmount)} ` : ''}${ing.unit || ''} ${ing.name}${ing.notes ? ` (${ing.notes})` : ''}</li>`).join('')}
                                </ul>
                            </div>
                            ${task.instructions && task.instructions.length ? `
                                <details style="margin-top: 8px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Instructions</summary>
                                    <ol style="margin: 10px 0 0 20px;">
                                        ${task.instructions.map(inst => `<li style="margin-bottom: 4px;">${inst}</li>`).join('')}
                                    </ol>
                                </details>
                            ` : ''}
                            ${task.notes ? `<p style="margin-top: 10px; color: #0f172a;"><strong>Notes:</strong> ${task.notes}</p>` : ''}
                        </div>
                    `;
                }).join('');
                return `
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header-gradient">
                            <h3 class="card-title">${station.station}</h3>
                            <p class="card-subtitle">${station.totalCovers || 0} projected covers</p>
                        </div>
                    <div style="padding: 20px;">
                            ${tasksHtml || '<p style="color: #64748b;">No prep tasks for this station.</p>'}
                        </div>
                    </div>
                `;
            }).join('') : '<p style="color: #64748b;">No prep tasks generated. Ensure menu items have linked recipes and projected covers.</p>';

            const componentsSection = prepPlan.components.length ? prepPlan.components.map(comp => `
                            <div class="prep-component priority-${comp.priority >= 4 ? 'high' : comp.priority >= 3 ? 'medium' : 'low'}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="font-weight: 600; font-size: 1.1rem;">${comp.componentName}</h4>
                                        <p style="color: #64748b; font-size: 0.9rem; margin: 5px 0;">For: ${comp.recipeName}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: #667eea;">${comp.dailyPar}</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">${comp.shelfLife}</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 0.9rem;">Yield:</strong> ${comp.yield} | 
                                    <strong style="font-size: 0.9rem;">Portion:</strong> ${comp.portionSize}
                                </div>
                    ${comp.instructions && comp.instructions.length ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">View Instructions</summary>
                                    <ol style="margin: 10px 0 0 20px;">
                                        ${comp.instructions.map(inst => `<li style="margin-bottom: 5px;">${inst}</li>`).join('')}
                                    </ol>
                                </details>
                    ` : ''}
                            </div>
            `).join('') : '<p style="color: #64748b;">No components queued for prep.</p>';

            const shoppingCategories = {};
            prepPlan.shopping.forEach(item => {
                const category = item.category || 'General';
                if (!shoppingCategories[category]) shoppingCategories[category] = [];
                shoppingCategories[category].push(item);
            });

            const shoppingSection = Object.keys(shoppingCategories).length ? `
                        <div class="card" style="background: #f8fafc;">
                    <div style="padding: 20px;">
                        ${Object.keys(shoppingCategories).map(category => `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="font-weight: 600; color: #667eea; margin-bottom: 10px;">${category}</h4>
                                    <ul style="margin: 0; padding-left: 20px;">
                                    ${shoppingCategories[category].map(ing => `
                                        <li>${ing.name} - ${ing.quantity !== null ? `${formatQuantity(ing.quantity)} ` : ''}${ing.unit || ''}${ing.menuItems ? ` <span style="color:#64748b; font-size:0.85rem;">(${ing.menuItems.join(', ')})</span>` : ''}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                </div>
            ` : '<p style="color: #64748b;">No shopping items required.</p>';

            const notesSection = `<ul style="padding-left: 20px;">${prepPlan.notes.map(note => '<li style="margin-bottom: 8px;">' + note + '</li>').join('')}</ul>`;

            content.innerHTML = `
                <div class="card">
                    <div class="card-header-gradient">
                        <h2 class="card-title">Prep Plan for ${prepPlan.prepDate}</h2>
                        <p class="card-subtitle">${prepPlan.restaurant}</p>
                    </div>
                    <div style="padding: 20px;">
                        ${summarySection}
                        ${warningsSection}
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 25px 0 15px;">Station Tasks</h3>
                        ${stationSections}
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 30px 0 15px;">Components & Mise en Place</h3>
                        ${componentsSection}
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 30px 0 15px;">Shopping List</h3>
                        ${shoppingSection}
                        <h3 style="font-size: 1.3rem; font-weight: 600; margin: 30px 0 15px;">Prep Notes</h3>
                        ${notesSection}
                        <div class="button-group" style="margin-top: 25px;">
                            <button class="btn" onclick="printPrepList()">üñ®Ô∏è Print</button>
                            <button class="btn" onclick="downloadPrepListPDF()">üì• Download PDF</button>
                            <button class="btn" onclick="emailPrepList()">üìß Email to Team</button>
                        </div>
                    </div>
                </div>
            `;
            
            output.classList.add('active');
        }

        function showVersionHistory() {
            const recipes = window.kitchenManagementSystem.currentRecipes;
            
            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');
            
            title.textContent = 'üïê Recipe Version History';
            
            content.innerHTML = `
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">Select Recipe</h3>
                    <select class="form-select" id="version-recipe-select" onchange="displayVersionHistory(this.value)">
                        <option value="">-- Select Recipe --</option>
                        ${recipes.map(r => `<option value="${r.id}">${r.title || r.name}</option>`).join('')}
                    </select>
                </div>
                <div id="version-history-content" style="margin-top: 20px;"></div>
            `;
            
            output.classList.add('active');
        }

        function displayVersionHistory(recipeId) {
            if (!recipeId) return;
            
            const history = window.kitchenManagementSystem.getVersionHistory(recipeId);
            const recipe = window.kitchenManagementSystem.currentRecipes.find(r => r.id === recipeId);
            const content = document.getElementById('version-history-content');
            
            if (history.length === 0) {
                content.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem;">üìú</div>
                        <p style="color: #64748b; margin-top: 15px;">No version history yet for this recipe.</p>
                        <p style="color: #64748b; font-size: 0.9rem;">Versions will be saved automatically when you update the recipe.</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">
                        ${recipe.title || recipe.name} - ${history.length} Version(s)
                    </h3>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${history.reverse().map((version, index) => `
                            <div style="padding: 15px; background: ${index === 0 ? '#f0f9ff' : '#f8fafc'}; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${index === 0 ? '#0284c7' : '#cbd5e1'};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <div>
                                        <span style="font-weight: 600;">Version ${version.versionNumber}</span>
                                        ${index === 0 ? '<span style="background: #0284c7; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px;">CURRENT</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #64748b;">
                                        ${new Date(version.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">
                                    Modified by: ${version.modifiedBy}
                                </div>
                                <div style="font-size: 0.95rem;">
                                    Changes: ${version.changes}
                                </div>
                                <div class="button-group" style="margin-top: 10px;">
                                    <button class="btn" onclick="viewVersionDetail('${recipeId}', ${version.versionNumber})" style="font-size: 0.85rem; padding: 6px 12px;">üëÅÔ∏è View</button>
                                    ${index !== 0 ? `<button class="btn" onclick="restoreVersion('${recipeId}', ${version.versionNumber})" style="font-size: 0.85rem; padding: 6px 12px;">üîÑ Restore</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function updateChecklistProgress() {
            const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const total = checkboxes.length;
            const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            const progressEl = document.getElementById('checklist-progress');
            if (progressEl) {
                progressEl.textContent = `${percent}%`;
            }
        }

        function closeOutput() {
            document.getElementById('output-area').classList.remove('active');
        }

        async function generatePDF() {
            const statusEl = document.getElementById('pdf-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<p>üìï Generating PDF... Please wait...</p>';
            
            try {
                const options = {
                    includeComponents: document.getElementById('pdf-components').checked,
                    includePhotos: document.getElementById('pdf-photos').checked,
                    includeNutrition: document.getElementById('pdf-nutrition').checked,
                    includeCosts: document.getElementById('pdf-costs').checked,
                    format: document.getElementById('pdf-format').value
                };
                
                const pdfData = await window.kitchenManagementSystem.generateRecipeBookPDF(options);
                
                // Use jsPDF to create actual PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add cover page
                doc.setFontSize(28);
                doc.text(pdfData.coverPage.title, 20, 40);
                doc.setFontSize(14);
                doc.text(pdfData.coverPage.subtitle, 20, 55);
                doc.setFontSize(10);
                doc.text(`By: ${pdfData.coverPage.author}`, 20, 70);
                doc.text(pdfData.coverPage.date, 20, 80);
                
                // Add table of contents
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Table of Contents', 20, 20);
                doc.setFontSize(10);
                let y = 35;
                pdfData.tableOfContents.forEach((item, index) => {
                    doc.text(`${index + 1}. ${item.title}`, 25, y);
                    doc.text(`${item.category}`, 150, y);
                    y += 7;
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                });
                
                // Add recipes
                pdfData.recipes.forEach(recipe => {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text(recipe.title, 20, 20);
                    doc.setFontSize(10);
                    doc.text(`Category: ${recipe.category}`, 20, 30);
                    doc.text(`Servings: ${recipe.servings} | Prep: ${recipe.prepTime}m | Cook: ${recipe.cookTime}m`, 20, 37);
                    
                    // Add ingredients
                    y = 50;
                    doc.setFontSize(12);
                    doc.text('Ingredients:', 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    (recipe.ingredients || []).forEach(ing => {
                        const ingText = `‚Ä¢ ${ing.name || ing.ingredientName} - ${ing.quantity} ${ing.unit}`;
                        doc.text(ingText, 25, y);
                        y += 6;
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                    });
                    
                    // Add instructions
                    y += 5;
                    doc.setFontSize(12);
                    doc.text('Instructions:', 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    (recipe.instructions || []).forEach((inst, index) => {
                        const lines = doc.splitTextToSize(`${index + 1}. ${inst}`, 170);
                        lines.forEach(line => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(line, 25, y);
                            y += 6;
                        });
                    });
                });
                
                // Download
                const fileName = `${pdfData.coverPage.title.replace(/[^a-z0-9]/gi, '_')}_RecipeBook.pdf`;
                doc.save(fileName);
                
                statusEl.innerHTML = '<p style="color: #10b981;">‚úÖ PDF Generated Successfully!</p>';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                statusEl.innerHTML = '<p style="color: #ef4444;">‚ùå Error generating PDF: ' + error.message + '</p>';
            }
        }

        function printBuildSheet(recipeId) {
            window.print();
        }

        function downloadBuildSheet(recipeId) {
            alert('Build sheet PDF download will be implemented');
        }

        function emailBuildSheet(recipeId) {
            alert('Email functionality will be implemented');
        }

        function printChecklist() {
            window.print();
        }

        function downloadChecklistPDF() {
            alert('Checklist PDF download will be implemented');
        }

        function resetChecklist() {
            if (confirm('Reset all checkboxes?')) {
                document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                updateChecklistProgress();
            }
        }

        function saveChecklist() {
            const checkboxStates = {};
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach((cb, index) => {
                checkboxStates[cb.id] = cb.checked;
            });
            
            const saveKey = `checklist_${new Date().toISOString().split('T')[0]}`;
            localStorage.setItem(saveKey, JSON.stringify(checkboxStates));
            
            alert('‚úÖ Checklist progress saved!');
        }

        function printPrepList() {
            window.print();
        }

        function downloadPrepListPDF() {
            const prepPlan = window.kitchenManagementSystem.generateNextDayPrepList();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            const marginLeft = 48;
            let cursorY = 60;

            const formatText = (text) => (text || '').toString();
            const formatList = (list, separator = ', ') => Array.isArray(list) ? list.filter(Boolean).join(separator) : '';

            // Header
            doc.setFontSize(18);
            doc.text(`Next Day Prep Plan ‚Äî ${prepPlan.menuName || 'Menu'}`, marginLeft, cursorY);
            cursorY += 20;
            doc.setFontSize(11);
            doc.setTextColor('#475569');
            doc.text(`Restaurant: ${prepPlan.restaurant || 'Restaurant'}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Prep Date: ${prepPlan.prepDate}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Generated: ${new Date(prepPlan.generatedDate).toLocaleString()}`, marginLeft, cursorY);
            cursorY += 20;
            doc.setTextColor('#000000');

            // Warnings
            if (Array.isArray(prepPlan.warnings) && prepPlan.warnings.length) {
                doc.setFontSize(12);
                doc.setTextColor('#b91c1c');
                doc.text('Warnings', marginLeft, cursorY);
                cursorY += 12;
                doc.setFontSize(10);
                prepPlan.warnings.forEach((warning) => {
                    const warningText = `${warning.name ? `${warning.name}: ` : ''}${warning.message || warning.type || ''}`;
                    doc.text(`‚Ä¢ ${warningText}`, marginLeft, cursorY, { maxWidth: 520 });
                    cursorY += 12;
                });
                cursorY += 8;
                doc.setTextColor('#000000');
            }

            // Menu summary
            const menuRows = (prepPlan.menuSummary || []).map((item) => [
                formatText(item.name),
                formatText(item.station || 'General'),
                formatText(item.covers || '‚Äî'),
                formatText(`${item.statusIcon || ''} ${item.statusLabel || ''}`.trim()),
                formatText(item.notes)
            ]);

            if (menuRows.length) {
                doc.setFontSize(12);
                doc.text('Menu Summary', marginLeft, cursorY);
                cursorY += 10;
                doc.autoTable({
                    startY: cursorY,
                    head: [['Dish', 'Station', 'Covers', 'Status', 'Notes']],
                    body: menuRows,
                    styles: { fontSize: 9, cellPadding: 6 },
                    headStyles: { fillColor: [30, 64, 175], textColor: 255 },
                    columnStyles: { 0: { cellWidth: 140 }, 4: { cellWidth: 160 } }
                });
                cursorY = doc.lastAutoTable.finalY + 16;
            }

            // Station tasks
            const stations = Object.values(prepPlan.stations || {});
            stations.forEach((station, index) => {
                if (cursorY > 680 || index === 0) {
                    if (cursorY > 680) {
                        doc.addPage();
                        cursorY = 60;
                    }
                }

                doc.setFontSize(12);
                doc.text(`${station.station} Station ‚Äî ${station.totalCovers || 0} covers`, marginLeft, cursorY);
                cursorY += 12;

                const taskRows = (station.tasks || []).map((task) => [
                    formatText(task.name),
                    formatText(task.covers || '‚Äî'),
                    formatText(task.priority || '‚Äî'),
                    formatList((task.ingredients || []).map((ing) => `${ing.scaledAmount !== null && ing.scaledAmount !== undefined ? `${Math.round(ing.scaledAmount * 100) / 100} ` : ''}${ing.unit || ''} ${ing.name || ''}`)),
                    formatText(task.notes || '')
                ]);

                if (taskRows.length) {
                    doc.autoTable({
                        startY: cursorY,
                        head: [['Task', 'Covers', 'Priority', 'Ingredients', 'Notes']],
                        body: taskRows,
                        styles: { fontSize: 9, cellPadding: 6 },
                        headStyles: { fillColor: [22, 101, 52], textColor: 255 },
                        columnStyles: {
                            0: { cellWidth: 120 },
                            3: { cellWidth: 180 },
                            4: { cellWidth: 110 }
                        }
                    });
                    cursorY = doc.lastAutoTable.finalY + 16;
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor('#64748b');
                    doc.text('No prep tasks for this station.', marginLeft, cursorY);
                    doc.setTextColor('#000000');
                    cursorY += 18;
                }

                if (cursorY > 680 && index < stations.length - 1) {
                    doc.addPage();
                    cursorY = 60;
                }
            });

            // Components
            if (Array.isArray(prepPlan.components) && prepPlan.components.length) {
                if (cursorY > 620) {
                    doc.addPage();
                    cursorY = 60;
                }

                doc.setFontSize(12);
                doc.text('Components in Prep', marginLeft, cursorY);
                cursorY += 12;

                const componentRows = prepPlan.components.map((component) => [
                    formatText(component.componentName),
                    formatText(component.recipeName),
                    formatText(component.dailyPar),
                    formatText(component.shelfLife),
                    formatList(component.instructions, ' \u2022 ')
                ]);

                doc.autoTable({
                    startY: cursorY,
                    head: [['Component', 'Recipe', 'Par', 'Shelf Life', 'Notes']],
                    body: componentRows,
                    styles: { fontSize: 9, cellPadding: 6 },
                    headStyles: { fillColor: [78, 44, 131], textColor: 255 },
                    columnStyles: { 0: { cellWidth: 120 }, 4: { cellWidth: 180 } }
                });
                cursorY = doc.lastAutoTable.finalY + 16;
            }

            // Shopping list
            if (Array.isArray(prepPlan.shopping) && prepPlan.shopping.length) {
                if (cursorY > 620) {
                    doc.addPage();
                    cursorY = 60;
                }

                doc.setFontSize(12);
                doc.text('Shopping List', marginLeft, cursorY);
                cursorY += 12;

                const shoppingRows = prepPlan.shopping.map((item) => [
                    formatText(item.name),
                    formatText(item.quantity || '‚Äî'),
                    formatText(item.unit || ''),
                    formatText(item.category || 'General'),
                    formatText(item.notes || '')
                ]);

                doc.autoTable({
                    startY: cursorY,
                    head: [['Item', 'Quantity', 'Unit', 'Category', 'Notes']],
                    body: shoppingRows,
                    styles: { fontSize: 9, cellPadding: 6 },
                    headStyles: { fillColor: [14, 116, 144], textColor: 255 },
                    columnStyles: { 0: { cellWidth: 160 }, 4: { cellWidth: 160 } }
                });
                cursorY = doc.lastAutoTable.finalY + 16;
            }

            // Notes
            if (Array.isArray(prepPlan.notes) && prepPlan.notes.length) {
                if (cursorY > 640) {
                    doc.addPage();
                    cursorY = 60;
                }
                doc.setFontSize(12);
                doc.text('Notes & Reminders', marginLeft, cursorY);
                cursorY += 12;
                doc.setFontSize(10);
                prepPlan.notes.forEach((note) => {
                    doc.text(`‚Ä¢ ${note}`, marginLeft, cursorY, { maxWidth: 520 });
                    cursorY += 12;
                });
            }

            const fileName = `${(prepPlan.menuName || 'prep_plan').replace(/[^a-z0-9]/gi, '_')}_${prepPlan.prepDate || 'prep'}.pdf`;
            doc.save(fileName);
        }

        function emailPrepList() {
            alert('Email functionality will be implemented');
        }

        function printFOHSheet() {
            window.print();
        }

        function downloadFOHPDF() {
            const briefing = window.kitchenManagementSystem.generateFOHBriefing();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            const marginLeft = 48;
            let cursorY = 60;

            const cleanText = (text) => (text || '').toString();
            const bulletList = (items) => Array.isArray(items) ? items.filter(Boolean) : [];

            // Header
            doc.setFontSize(18);
            doc.text(`${briefing.menuName || 'Menu'} ‚Äî FOH Briefing`, marginLeft, cursorY);
            cursorY += 20;
            doc.setFontSize(11);
            doc.setTextColor('#475569');
            doc.text(`Restaurant: ${briefing.restaurant || 'Restaurant'}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Service Date: ${briefing.serviceDate}`, marginLeft, cursorY);
            cursorY += 14;
            doc.text(`Generated: ${new Date(briefing.generatedDate).toLocaleString()}`, marginLeft, cursorY);
            cursorY += 20;
            doc.setTextColor('#000000');

            // Warnings
            if (Array.isArray(briefing.warnings) && briefing.warnings.length) {
                doc.setFontSize(12);
                doc.setTextColor('#b91c1c');
                doc.text('Warnings / Follow-ups', marginLeft, cursorY);
                cursorY += 12;
                doc.setFontSize(10);
                briefing.warnings.forEach((warning) => {
                    const warningText = `${warning.name ? `${warning.name}: ` : ''}${warning.message || warning.type || ''}`;
                    doc.text(`‚Ä¢ ${warningText}`, marginLeft, cursorY, { maxWidth: 520 });
                    cursorY += 12;
                });
                cursorY += 8;
                doc.setTextColor('#000000');
            }

            // Highlights
            if (Array.isArray(briefing.highlights) && briefing.highlights.length) {
                doc.setFontSize(12);
                doc.text('Service Highlights', marginLeft, cursorY);
                cursorY += 12;
                briefing.highlights.forEach((highlight) => {
                    doc.setFontSize(11);
                    doc.setTextColor('#1d4ed8');
                    doc.text(`${highlight.name} ‚Äî ${highlight.reason}`, marginLeft, cursorY);
                    cursorY += 12;
                    doc.setFontSize(10);
                    doc.setTextColor('#0f172a');
                    bulletList(highlight.talkingPoints).forEach((point) => {
                        doc.text(`‚Ä¢ ${point}`, marginLeft + 12, cursorY, { maxWidth: 500 });
                        cursorY += 12;
                        if (cursorY > 700) {
                            doc.addPage();
                            cursorY = 60;
                        }
                    });
                    cursorY += 6;
                    if (cursorY > 700) {
                        doc.addPage();
                        cursorY = 60;
                    }
                });
                cursorY += 6;
            }

            // Course sections
            (briefing.courses || []).forEach((course) => {
                if (cursorY > 640) {
                    doc.addPage();
                    cursorY = 60;
                }

                doc.setFontSize(12);
                doc.text(course.category, marginLeft, cursorY);
                cursorY += 12;

                const courseRows = course.items.map((item) => [
                    cleanText(item.name),
                    cleanText(item.description),
                    bulletList(item.talkingPoints).join('\n'),
                    bulletList(item.allergens).join(', ') || '‚Äî',
                    bulletList(item.dietary).join(', ') || '‚Äî'
                ]);

                doc.autoTable({
                    startY: cursorY,
                    head: [['Dish', 'Description', 'Talking Points', 'Allergens', 'Dietary']],
                    body: courseRows,
                    styles: { fontSize: 9, cellPadding: 6, valign: 'top' },
                    headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                    columnStyles: {
                        0: { cellWidth: 120 },
                        1: { cellWidth: 150 },
                        2: { cellWidth: 150 },
                        3: { cellWidth: 60 },
                        4: { cellWidth: 60 }
                    }
                });
                cursorY = doc.lastAutoTable.finalY + 16;

                // Pairings & service notes
                course.items.forEach((item) => {
                    if ((item.pairings && item.pairings.length) || item.serviceNotes) {
                        if (cursorY > 700) {
                            doc.addPage();
                            cursorY = 60;
                        }
                        doc.setFontSize(10);
                        if (Array.isArray(item.pairings) && item.pairings.length) {
                            doc.setTextColor('#0f172a');
                            doc.text(`Pairings for ${item.name}:`, marginLeft, cursorY);
                            cursorY += 12;
                            item.pairings.forEach((pair) => {
                                doc.text(`‚Ä¢ ${pair}`, marginLeft + 12, cursorY, { maxWidth: 500 });
                                cursorY += 12;
                            });
                        }
                        if (item.serviceNotes) {
                            doc.setTextColor('#92400e');
                            doc.text(`Service Notes for ${item.name}: ${item.serviceNotes}`, marginLeft, cursorY, { maxWidth: 520 });
                            cursorY += 14;
                        }
                        doc.setTextColor('#000000');
                        cursorY += 6;
                    }
                });
            });

            // Allergen summary
            const allergenEntries = Object.entries(briefing.allergenSummary || {});
            if (allergenEntries.length) {
                if (cursorY > 620) {
                    doc.addPage();
                    cursorY = 60;
                }
                doc.setFontSize(12);
                doc.text('Allergen Overview', marginLeft, cursorY);
                cursorY += 10;
                doc.autoTable({
                    startY: cursorY,
                    head: [['Allergen', 'Count']],
                    body: allergenEntries.map(([allergen, count]) => [allergen, count]),
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [249, 115, 22], textColor: 255 },
                    columnStyles: { 0: { cellWidth: 200 } }
                });
                cursorY = doc.lastAutoTable.finalY + 16;
            }

            // Dietary summary
            const dietaryEntries = Object.entries(briefing.dietarySummary || {});
            if (dietaryEntries.length) {
                if (cursorY > 620) {
                    doc.addPage();
                    cursorY = 60;
                }
                doc.setFontSize(12);
                doc.text('Dietary Tags', marginLeft, cursorY);
                cursorY += 10;
                doc.autoTable({
                    startY: cursorY,
                    head: [['Dietary Tag', 'Count']],
                    body: dietaryEntries.map(([tag, count]) => [tag.toUpperCase(), count]),
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [16, 185, 129], textColor: 255 },
                    columnStyles: { 0: { cellWidth: 200 } }
                });
                cursorY = doc.lastAutoTable.finalY + 16;
            }

            // Notes
            if (Array.isArray(briefing.notes) && briefing.notes.length) {
                if (cursorY > 640) {
                    doc.addPage();
                    cursorY = 60;
                }
                doc.setFontSize(12);
                doc.text('Service Reminders', marginLeft, cursorY);
                cursorY += 12;
                doc.setFontSize(10);
                briefing.notes.forEach((note) => {
                    doc.text(`‚Ä¢ ${note}`, marginLeft, cursorY, { maxWidth: 520 });
                    cursorY += 12;
                });
            }

            const fileName = `${(briefing.menuName || 'foh_briefing').replace(/[^a-z0-9]/gi, '_')}_${briefing.serviceDate || 'briefing'}.pdf`;
            doc.save(fileName);
        }

        function emailFOHSheet() {
            alert('Email functionality will be implemented');
        }

        function viewVersionDetail(recipeId, versionNumber) {
            alert(`Viewing version ${versionNumber} details...`);
        }

        function restoreVersion(recipeId, versionNumber) {
            if (confirm(`Restore recipe to version ${versionNumber}?`)) {
                alert('Version restore will be implemented');
            }
        }

        async function exportAll() {
            alert('üì¶ Exporting all kitchen documents...\n\nThis will include:\n- Recipe Book PDF\n- All Build Sheets\n- Checklists\n- Prep Lists\n\nDownload will start shortly.');
            
            try {
                const docs = await window.kitchenManagementSystem.exportKitchenDocuments();
                console.log('Exported documents:', docs);
                
                // For now, download the recipe book PDF
                await generatePDF();
            } catch (error) {
                alert('Error exporting: ' + error.message);
            }
        }

        function showFOHSheet() {
            const briefing = window.kitchenManagementSystem.generateFOHBriefing();

            const output = document.getElementById('output-area');
            const title = document.getElementById('output-title');
            const content = document.getElementById('output-content');

            title.textContent = 'üõéÔ∏è FOH Service Briefing';

            const hasHighlights = Array.isArray(briefing.highlights) && briefing.highlights.length;
            const hasCourses = Array.isArray(briefing.courses) && briefing.courses.length;
            const hasWarnings = Array.isArray(briefing.warnings) && briefing.warnings.length;

            const formatBadgeList = (items, emptyText) => {
                if (!items || !items.length) return `<span style="color: #94a3b8;">${emptyText}</span>`;
                return items.map(item => `<span style="display: inline-block; margin: 4px 6px 0 0; padding: 4px 10px; background: rgba(59,130,246,0.15); color: #1d4ed8; border-radius: 999px; font-size: 0.82rem;">${item}</span>`).join('');
            };

            const highlightsSection = hasHighlights ? `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header-gradient">
                        <h3 class="card-title">Service Highlights</h3>
                        <p class="card-subtitle">Focus these points during pre-shift meeting.</p>
                    </div>
                    <div style="padding: 20px; display: grid; gap: 16px;">
                        ${briefing.highlights.map(highlight => `
                            <div style="padding: 16px; border: 1px solid #bfdbfe; border-radius: 12px; background: rgba(219,234,254,0.5);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; font-size: 1.1rem; color: #1d4ed8;">${highlight.name}</h4>
                                    <span style="padding: 4px 10px; background: #1d4ed8; color: #fff; border-radius: 999px; font-size: 0.78rem;">${highlight.reason}</span>
                                </div>
                                <div style="color: #334155; font-size: 0.95rem;">
                                    <ul style="margin: 0; padding-left: 18px;">
                                        ${highlight.talkingPoints.map(point => `<li style="margin-bottom: 6px;">${point}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            const courseSections = hasCourses ? briefing.courses.map(course => `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header-gradient">
                        <h3 class="card-title">${course.category}</h3>
                        <p class="card-subtitle">${course.items.length} featured item${course.items.length === 1 ? '' : 's'}</p>
                    </div>
                    <div style="padding: 20px; display: grid; gap: 18px;">
                        ${course.items.map(item => `
                            <div style="border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 4px; font-size: 1.1rem; font-weight: 600;">${item.name}</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.92rem;">${item.description}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #3b82f6; font-weight: 600; font-size: 0.85rem;">${item.station || 'General'}</div>
                                        ${item.status?.label ? `<div style="font-size: 0.8rem; color: #475569;">${item.status.icon || '‚ÑπÔ∏è'} ${item.status.label}</div>` : ''}
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <strong style="display: block; color: #0f172a; font-size: 0.85rem; margin-bottom: 6px;">Talking Points</strong>
                                    <ul style="margin: 0; padding-left: 18px; color: #1f2937; font-size: 0.92rem;">
                                        ${item.talkingPoints.map(point => `<li style="margin-bottom: 6px; line-height: 1.4;">${point}</li>`).join('')}
                                    </ul>
                                </div>
                                <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 12px;" class="foh-pill-row">
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.8rem; color: #0f172a; text-transform: uppercase; letter-spacing: 0.05em;">Allergens</div>
                                        ${formatBadgeList(item.allergens, 'Not specified')}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.8rem; color: #0f172a; text-transform: uppercase; letter-spacing: 0.05em;">Dietary</div>
                                        ${formatBadgeList(item.dietary, 'None noted')}
                                    </div>
                                </div>
                                ${item.pairings.length ? `
                                    <div style="margin-top: 12px;">
                                        <strong style="display: block; font-size: 0.85rem; color: #0f172a;">Pairings</strong>
                                        <ul style="margin: 6px 0 0 18px; color: #1f2937; font-size: 0.9rem;">
                                            ${item.pairings.map(pair => `<li>${pair}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${item.serviceNotes ? `<div style="margin-top: 14px; padding: 12px; background: rgba(250,204,21,0.12); border-radius: 8px; color: #92400e; font-size: 0.9rem;"><strong>Service Notes:</strong> ${item.serviceNotes}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') : '<p style="color: #64748b;">No menu items available. Create and link menu recipes to generate FOH briefings.</p>';

            const allergenSummary = Object.keys(briefing.allergenSummary || {}).length ? `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header-gradient">
                        <h3 class="card-title">Allergen Overview</h3>
                        <p class="card-subtitle">Count of dishes containing each allergen</p>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            ${Object.entries(briefing.allergenSummary).map(([allergen, count]) => `
                                <div style="flex: 1 1 200px; padding: 12px 16px; border: 1px solid #f59e0b; border-radius: 12px; background: rgba(253,230,138,0.4);">
                                    <div style="font-weight: 600; color: #b45309; text-transform: capitalize;">${allergen}</div>
                                    <div style="font-size: 0.9rem; color: #92400e;">${count} item${count === 1 ? '' : 's'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : '';

            const dietarySummary = Object.keys(briefing.dietarySummary || {}).length ? `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header-gradient">
                        <h3 class="card-title">Dietary Tags</h3>
                        <p class="card-subtitle">Quick reference for common guest requests</p>
                    </div>
                    <div style="padding: 20px; display: flex; flex-wrap: wrap; gap: 12px;">
                        ${Object.entries(briefing.dietarySummary).map(([tag, count]) => `
                            <div style="flex: 1 1 200px; padding: 12px 16px; border: 1px solid #34d399; border-radius: 12px; background: rgba(167,243,208,0.4);">
                                <div style="font-weight: 600; color: #047857; text-transform: uppercase; letter-spacing: 0.05em;">${tag}</div>
                                <div style="font-size: 0.9rem; color: #047857;">${count} item${count === 1 ? '' : 's'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            const warningsSection = hasWarnings ? `
                <div style="margin-bottom: 20px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px;">
                    <h4 style="margin: 0 0 8px; color: #b91c1c; font-weight: 600;">Warnings / Follow-ups</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #b91c1c;">
                        ${briefing.warnings.map(warning => `<li>${warning.name ? `${warning.name}: ` : ''}${warning.message || warning.type}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            const notesSection = briefing.notes && briefing.notes.length ? `
                <div style="margin-bottom: 20px; padding: 18px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                    <h4 style="margin: 0 0 10px; color: #0f172a; font-weight: 600;">Service Reminders</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #334155;">
                        ${briefing.notes.map(note => `<li style="margin-bottom: 6px;">${note}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 0.9rem; color: #64748b;">${briefing.restaurant}</div>
                        <h3 style="margin: 6px 0; font-size: 1.6rem;">${briefing.menuName} ‚Äî ${briefing.serviceDate}</h3>
                        <div style="font-size: 0.85rem; color: #94a3b8;">Generated ${new Date(briefing.generatedDate).toLocaleString()}</div>
                    </div>
                    <div class="button-group" style="gap: 12px;">
                        <button class="btn" onclick="printFOHSheet()">üñ®Ô∏è Print</button>
                        <button class="btn" onclick="downloadFOHPDF()">üì• Download PDF</button>
                        <button class="btn" onclick="emailFOHSheet()">‚úâÔ∏è Email</button>
                    </div>
                </div>
                ${warningsSection}
                ${highlightsSection || '<p style="color: #64748b;">No specific highlights flagged.</p>'}
                ${courseSections}
                ${allergenSummary}
                ${dietarySummary}
                ${notesSection}
            `;

            output.classList.add('active');
        }
    </script>
</body>
</html>

