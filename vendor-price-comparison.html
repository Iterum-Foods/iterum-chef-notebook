<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Price Comparison | Iterum R&D</title>
    
    <!-- Firebase & Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-header.css">
    
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; }
        .container { max-width: 1400px; margin: 0 auto; padding: 32px 20px; }
        
        .comparison-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        
        .price-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .price-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        .price-table td {
            padding: 16px 14px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .price-table tr:hover {
            background: #f8fafc;
        }
        
        .best-price {
            background: #dcfce7 !important;
            font-weight: 600;
        }
        
        .best-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #22c55e;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .savings-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #f59e0b;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-value { font-size: 28px; font-weight: 800; color: #667eea; margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .recommendation-card {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }
        
        .rec-savings { background: #dcfce7; border-color: #22c55e; }
        .rec-warning { background: #fef3c7; border-color: #f59e0b; }
        .rec-info { background: #dbeafe; border-color: #3b82f6; }
        
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <header class="iterum-header">
        <div class="header-container">
            <a href="index.html" class="header-logo">
                <div class="header-logo-icon">üçÉ</div>
                <div class="header-logo-text">
                    <div class="header-logo-title">Iterum R&D</div>
                    <div class="header-logo-subtitle">Price Comparison</div>
                </div>
            </a>
            <nav class="header-navigation">
                <a href="index.html" class="header-nav-item">üè† Dashboard</a>
                <a href="vendor-management.html" class="header-nav-item">üè™ Vendors</a>
                <a href="vendor-price-comparison.html" class="header-nav-item active">üí∞ Price Compare</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
            <div>
                <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">üí∞ Vendor Price Comparison</h1>
                <p style="color: #64748b;">Find the best deals and optimize your purchasing</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('single')">Single Item</button>
            <button class="tab-btn" onclick="switchTab('bulk')">Bulk Compare</button>
            <button class="tab-btn" onclick="switchTab('optimal')">Optimal Mix</button>
        </div>

        <!-- Single Item Comparison -->
        <div id="single-tab" class="tab-content active">
            <div class="comparison-card">
                <div style="display: flex; gap: 16px; align-items: end; margin-bottom: 24px;">
                    <div style="flex: 1;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #475569;">
                            Select Ingredient to Compare
                        </label>
                        <select id="ingredient-select" class="form-select" onchange="compareIngredient()">
                            <option value="">Choose an ingredient...</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="exportComparison()">üì• Export CSV</button>
                </div>

                <div id="comparison-results">
                    <div style="text-align: center; padding: 60px; color: #94a3b8;">
                        Select an ingredient above to compare vendor prices
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div id="recommendations-section" style="display: none;">
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">üí° Recommendations</h3>
                <div id="recommendations-list"></div>
            </div>
        </div>

        <!-- Bulk Comparison -->
        <div id="bulk-tab" class="tab-content">
            <div class="comparison-card">
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">Compare Shopping List</h3>
                <p style="color: #64748b; margin-bottom: 24px;">
                    Add multiple ingredients to see total savings potential
                </p>

                <div id="bulk-ingredient-list" style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px;">
                        <select class="form-select bulk-ingredient">
                            <option value="">Select ingredient...</option>
                        </select>
                        <input type="number" class="form-input bulk-quantity" placeholder="Quantity" min="0" step="0.1">
                        <select class="form-select bulk-unit">
                            <option value="lb">lb</option>
                            <option value="oz">oz</option>
                            <option value="kg">kg</option>
                            <option value="each">each</option>
                        </select>
                        <button class="btn btn-secondary" onclick="addBulkRow()">+</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="compareBulk()">Compare All</button>

                <div id="bulk-results" style="margin-top: 32px;"></div>
            </div>
        </div>

        <!-- Optimal Vendor Mix -->
        <div id="optimal-tab" class="tab-content">
            <div class="comparison-card">
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">Optimal Vendor Mix</h3>
                <p style="color: #64748b; margin-bottom: 24px;">
                    Get the best price by splitting orders across vendors
                </p>

                <div id="optimal-ingredient-list" style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px;">
                        <select class="form-select optimal-ingredient">
                            <option value="">Select ingredient...</option>
                        </select>
                        <input type="number" class="form-input optimal-quantity" placeholder="Quantity" min="0" step="0.1">
                        <select class="form-select optimal-unit">
                            <option value="lb">lb</option>
                            <option value="oz">oz</option>
                            <option value="kg">kg</option>
                            <option value="each">each</option>
                        </select>
                        <button class="btn btn-secondary" onclick="addOptimalRow()">+</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="calculateOptimal()">Calculate Optimal Mix</button>

                <div id="optimal-results" style="margin-top: 32px;"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/central-data-loader.js"></script>
    <script src="assets/js/vendor-ingredient-connector.js"></script>
    <script src="assets/js/vendor-price-comparator.js"></script>
    <script src="assets/js/auth_guard.js" defer></script>
    <script>
        let currentComparison = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadIngredientOptions();
        });

        function loadIngredientOptions() {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const connections = JSON.parse(localStorage.getItem('vendor_ingredient_connections') || '[]');
            
            // Only show ingredients that have vendor connections
            const ingredientsWithPrices = ingredients.filter(ing => 
                connections.some(conn => conn.ingredientId === ing.id)
            );

            const optionsHTML = '<option value="">Choose an ingredient...</option>' +
                ingredientsWithPrices.map(ing => 
                    `<option value="${ing.id}">${ing.name}</option>`
                ).join('');

            document.getElementById('ingredient-select').innerHTML = optionsHTML;
            document.querySelectorAll('.bulk-ingredient, .optimal-ingredient').forEach(select => {
                select.innerHTML = optionsHTML;
            });
        }

        function compareIngredient() {
            const ingredientId = document.getElementById('ingredient-select').value;
            if (!ingredientId) return;

            currentComparison = window.vendorPriceComparator.compareVendorsForIngredient(ingredientId);

            if (!currentComparison) {
                document.getElementById('comparison-results').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        No vendor prices found for this ingredient
                    </div>
                `;
                return;
            }

            displayComparison(currentComparison);
            displayRecommendations([currentComparison]);
        }

        function displayComparison(comparison) {
            const html = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-value">${comparison.totalVendors}</div>
                        <div class="stat-label">Vendors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #22c55e;">$${comparison.maxSavings.toFixed(2)}</div>
                        <div class="stat-label">Max Savings/lb</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f59e0b;">${comparison.savingsPercent}%</div>
                        <div class="stat-label">Potential Savings</div>
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; overflow: hidden;">
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Brand / Farm</th>
                                <th>Price</th>
                                <th>Price per lb</th>
                                <th>Product Code</th>
                                <th>Min Order</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${comparison.vendors.map((vendor, index) => `
                                <tr class="${index === 0 ? 'best-price' : ''}">
                                    <td>
                                        <strong>${vendor.vendorName}</strong>
                                        ${index === 0 ? '<span class="best-badge">BEST PRICE</span>' : ''}
                                    </td>
                                    <td>
                                        ${vendor.brandName ? `üè∑Ô∏è ${vendor.brandName}` : ''}
                                        ${vendor.farmName ? `üåæ ${vendor.farmName}` : ''}
                                        ${!vendor.brandName && !vendor.farmName ? '-' : ''}
                                    </td>
                                    <td><strong>$${vendor.price.toFixed(2)}</strong> / ${vendor.unit}</td>
                                    <td>$${vendor.pricePerLb.toFixed(2)} / lb</td>
                                    <td>${vendor.productCode || '-'}</td>
                                    <td>${vendor.minOrder || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('comparison-results').innerHTML = html;
        }

        function displayRecommendations(comparisons) {
            const recommendations = window.vendorPriceComparator.generateRecommendations(comparisons);
            
            if (recommendations.length === 0) {
                document.getElementById('recommendations-section').style.display = 'none';
                return;
            }

            const html = recommendations.map(rec => {
                const classes = rec.type === 'savings' ? 'rec-savings' : 
                               rec.type === 'warning' ? 'rec-warning' : 'rec-info';
                return `
                    <div class="recommendation-card ${classes}">
                        ${rec.message}
                    </div>
                `;
            }).join('');

            document.getElementById('recommendations-list').innerHTML = html;
            document.getElementById('recommendations-section').style.display = 'block';
        }

        function addBulkRow() {
            const container = document.getElementById('bulk-ingredient-list');
            const newRow = document.createElement('div');
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px;';
            newRow.innerHTML = `
                <select class="form-select bulk-ingredient">
                    ${document.querySelector('.bulk-ingredient').innerHTML}
                </select>
                <input type="number" class="form-input bulk-quantity" placeholder="Quantity" min="0" step="0.1">
                <select class="form-select bulk-unit">
                    <option value="lb">lb</option>
                    <option value="oz">oz</option>
                    <option value="kg">kg</option>
                    <option value="each">each</option>
                </select>
                <button class="btn btn-secondary" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(newRow);
        }

        function compareBulk() {
            const items = [];
            const rows = document.getElementById('bulk-ingredient-list').querySelectorAll('div[style*="grid"]');

            rows.forEach(row => {
                const ingredientId = row.querySelector('.bulk-ingredient').value;
                const quantity = parseFloat(row.querySelector('.bulk-quantity').value);
                const unit = row.querySelector('.bulk-unit').value;

                if (ingredientId && quantity) {
                    const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    
                    items.push({
                        ingredientId: ingredientId,
                        ingredientName: ingredient.name,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                alert('Please add at least one ingredient with quantity');
                return;
            }

            const result = window.vendorPriceComparator.compareShoppingList(items);

            const html = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-value">${result.itemCount}</div>
                        <div class="stat-label">Items Compared</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #22c55e;">$${result.totalSavings.toFixed(2)}</div>
                        <div class="stat-label">Total Savings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #667eea;">
                            ${result.items.length > 0 ? 
                                ((result.totalSavings / result.items.reduce((sum, i) => sum + i.worstCost, 0)) * 100).toFixed(1) 
                                : 0}%
                        </div>
                        <div class="stat-label">Avg Savings</div>
                    </div>
                </div>

                <table class="price-table">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Quantity</th>
                            <th>Best Vendor</th>
                            <th>Best Price</th>
                            <th>Worst Price</th>
                            <th>Savings</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.items.map(item => `
                            <tr>
                                <td><strong>${item.ingredientName}</strong></td>
                                <td>${item.quantity} ${item.unit}</td>
                                <td>${item.comparison.bestVendor.vendorName}</td>
                                <td class="best-price">$${item.bestCost.toFixed(2)}</td>
                                <td>$${item.worstCost.toFixed(2)}</td>
                                <td>
                                    <span class="savings-badge">$${item.savings.toFixed(2)}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('bulk-results').innerHTML = html;
        }

        function addOptimalRow() {
            const container = document.getElementById('optimal-ingredient-list');
            const newRow = document.createElement('div');
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px;';
            newRow.innerHTML = `
                <select class="form-select optimal-ingredient">
                    ${document.querySelector('.optimal-ingredient').innerHTML}
                </select>
                <input type="number" class="form-input optimal-quantity" placeholder="Quantity" min="0" step="0.1">
                <select class="form-select optimal-unit">
                    <option value="lb">lb</option>
                    <option value="oz">oz</option>
                    <option value="kg">kg</option>
                    <option value="each">each</option>
                </select>
                <button class="btn btn-secondary" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(newRow);
        }

        function calculateOptimal() {
            const items = [];
            const rows = document.getElementById('optimal-ingredient-list').querySelectorAll('div[style*="grid"]');

            rows.forEach(row => {
                const ingredientId = row.querySelector('.optimal-ingredient').value;
                const quantity = parseFloat(row.querySelector('.optimal-quantity').value);
                const unit = row.querySelector('.optimal-unit').value;

                if (ingredientId && quantity) {
                    const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    
                    items.push({
                        ingredientId: ingredientId,
                        ingredientName: ingredient.name,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                alert('Please add at least one ingredient with quantity');
                return;
            }

            const result = window.vendorPriceComparator.getOptimalVendorMix(items);

            const html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Optimal Total Cost</div>
                    <div style="font-size: 42px; font-weight: 800;">$${result.totalCost.toFixed(2)}</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 8px;">Split across ${result.vendorCount} vendors</div>
                </div>

                ${result.vendors.map(vendor => `
                    <div class="comparison-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 20px; font-weight: 700;">${vendor.vendorName}</h3>
                            <div style="font-size: 24px; font-weight: 800; color: #667eea;">
                                $${vendor.totalCost.toFixed(2)}
                            </div>
                        </div>

                        <table class="price-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Brand / Farm</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vendor.items.map(item => `
                                    <tr>
                                        <td><strong>${item.ingredientName}</strong></td>
                                        <td>
                                            ${item.brandName ? `üè∑Ô∏è ${item.brandName}` : '-'}
                                        </td>
                                        <td>${item.quantity} ${item.unit}</td>
                                        <td>$${item.price.toFixed(2)} / ${item.priceUnit}</td>
                                        <td><strong>$${item.cost.toFixed(2)}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `).join('')}
            `;

            document.getElementById('optimal-results').innerHTML = html;
        }

        function exportComparison() {
            if (!currentComparison) {
                alert('Please select an ingredient to compare first');
                return;
            }
            window.vendorPriceComparator.exportComparisonToCSV(currentComparison);
        }

        function switchTab(tabName) {
            // Remove active from all
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active to selected
            document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
    </script>
</body>
</html>

