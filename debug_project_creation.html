<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Creation Debug</title>
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <style>
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .debug-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: #ff4444; }
        .success { color: #00ff44; }
        .warning { color: #ffaa00; }
        .info { color: #0088ff; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <h1 class="heading-1 mb-8">üîç Project Creation Debug Tool</h1>
        
        <!-- Debug Controls -->
        <div class="debug-section">
            <h2 class="heading-2 mb-4">Debug Controls</h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="testUserSystem()" class="iterum-button iterum-button-primary">
                    üß™ Test User System
                </button>
                <button onclick="testProjectManager()" class="iterum-button iterum-button-primary">
                    üìÅ Test Project Manager
                </button>
                <button onclick="testProjectCreation()" class="iterum-button iterum-button-primary">
                    ‚ûï Test Project Creation
                </button>
                <button onclick="clearDebug()" class="iterum-button iterum-button-secondary">
                    üóëÔ∏è Clear Debug
                </button>
            </div>
        </div>

        <!-- System Status -->
        <div class="debug-section">
            <h2 class="heading-2 mb-4">System Status</h2>
            <div id="system-status" class="debug-output">
                Waiting for system initialization...
            </div>
        </div>

        <!-- Debug Output -->
        <div class="debug-section">
            <h2 class="heading-2 mb-4">Debug Output</h2>
            <div id="debug-output" class="debug-output">
                Debug output will appear here...
            </div>
        </div>

        <!-- Manual Project Creation -->
        <div class="debug-section">
            <h2 class="heading-2 mb-4">Manual Project Creation</h2>
            <form id="manual-project-form" class="space-y-4">
                <div class="form-group">
                    <label for="project-name" class="form-label">Project Name</label>
                    <input type="text" id="project-name" class="form-input" placeholder="Test Project" required>
                </div>
                <div class="form-group">
                    <label for="project-description" class="form-label">Description</label>
                    <textarea id="project-description" class="form-textarea" placeholder="Test project description"></textarea>
                </div>
                <button type="submit" class="iterum-button iterum-button-primary">
                    üöÄ Create Project Manually
                </button>
            </form>
        </div>
    </div>

    <!-- Essential Scripts -->
    <script src="assets/js/enhanced-user-system.js"></script>
    <!-- Project management now handled by new system -->
    <script src="assets/js/error_handler.js"></script>
    <script src="assets/js/startup-loading-config.js"></script>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput) {
                debugOutput.textContent = debugLog.join('\n');
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
            
            console.log(logEntry);
        }

        function clearDebug() {
            debugLog = [];
            document.getElementById('debug-output').textContent = 'Debug cleared...';
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            if (!statusDiv) return;

            const status = {
                userSystem: !!window.userSystem,
                projectManager: !!window.projectManager,
                currentUser: window.userSystem?.getCurrentUser(),
                projects: window.projectManager?.projects || [],
                currentProject: window.projectManager?.currentProject
            };

            let statusHtml = '';
            statusHtml += `User System: ${status.userSystem ? '‚úÖ' : '‚ùå'}\n`;
            statusHtml += `Project Manager: ${status.projectManager ? '‚úÖ' : '‚ùå'}\n`;
            statusHtml += `Current User: ${status.currentUser ? `${status.currentUser.name} (${status.currentUser.id})` : '‚ùå None'}\n`;
            statusHtml += `Projects Count: ${status.projects.length}\n`;
            statusHtml += `Current Project: ${status.currentProject ? status.currentProject.name : '‚ùå None'}\n`;

            statusDiv.textContent = statusHtml;
        }

        function testUserSystem() {
            log('üß™ Testing User System...', 'info');
            
            if (!window.userSystem) {
                log('‚ùå User System not found!', 'error');
                return;
            }

            try {
                const currentUser = window.userSystem.getCurrentUser();
                log(`‚úÖ Current User: ${currentUser ? currentUser.name : 'None'}`, 'success');
                
                const allUsers = window.userSystem.getAllUsers();
                log(`‚úÖ Total Users: ${allUsers.length}`, 'success');
                
                allUsers.forEach(user => {
                    log(`   - ${user.name} (${user.id})`, 'info');
                });
                
            } catch (error) {
                log(`‚ùå User System Error: ${error.message}`, 'error');
            }
            
            updateSystemStatus();
        }

        // Test project manager functionality
        function testProjectManager() {
            console.log('üß™ Testing Project Manager...');
            
            // Check if project manager is available
            if (!window.projectManager) {
                console.log('‚ùå Project manager not available');
                alert('Project manager not available. Please ensure the new project management system is loaded.');
                return;
            }
            
            console.log('‚úÖ Project manager is available');
            
            // Get project information
            const projects = window.projectManager.projects;
            console.log('üìö Projects:', projects);
            
            if (projects && projects.length > 0) {
                const currentProject = window.projectManager.currentProject;
                console.log('üìã Current project:', currentProject);
                
                // Display project info
                const projectInfo = projects.map(p => 
                    `${p.name} (${p.isMaster ? 'Master' : 'Project'})`
                ).join('\n');
                
                alert(`Found ${projects.length} projects:\n\n${projectInfo}`);
            } else {
                console.log('üìù No projects found');
                alert('No projects found. Please create a project first.');
            }
        }

        // Test project creation
        function testProjectCreation() {
            console.log('üß™ Testing Project Creation...');
            
            if (!window.projectManager) {
                alert('Project manager not available. Please ensure the new project management system is loaded.');
                return;
            }
            
            // Get project data from form
            const projectData = {
                name: document.getElementById('project-name')?.value || 'Test Project',
                description: document.getElementById('project-description')?.value || 'Test Description',
                type: document.getElementById('project-type')?.value || 'culinary'
            };
            
            console.log('üîç Creating project with data:', projectData);
            
            // Create project using new system
            try {
                const newProject = window.projectManager.createProject(projectData);
                console.log('‚úÖ Project created:', newProject);
                
                if (newProject) {
                    alert(`Project "${newProject.name}" created successfully!`);
                    
                    // Refresh project display
                    window.projectManager.updateProjectUI();
                } else {
                    alert('Failed to create project. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error creating project:', error);
                alert('Error creating project: ' + error.message);
            }
        }

        // Manual project creation form
        document.getElementById('manual-project-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('project-name').value;
            const description = document.getElementById('project-description').value;
            
            log(`üöÄ Manually creating project: ${name}`, 'info');
            
            if (!window.projectManager) {
                log('‚ùå Project Manager not available!', 'error');
                return;
            }

            try {
                const projectData = {
                    name: name,
                    description: description,
                    color_theme: '#3B82F6'
                };
                
                const newProject = window.projectManager.createNewProject(projectData);
                if (newProject) {
                    log(`‚úÖ Project created successfully: ${newProject.name} (${newProject.id})`, 'success');
                    updateSystemStatus();
                } else {
                    log('‚ùå Project creation returned null', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Manual Project Creation Error: ${error.message}`, 'error');
            }
        });

        // User system now initializes automatically
        console.log('üîç User system auto-initialization enabled');

        // Monitor system initialization
        let initCheckInterval = setInterval(() => {
            if (window.userSystem && window.projectManager) {
                log('üéâ System fully initialized!', 'success');
                clearInterval(initCheckInterval);
                updateSystemStatus();
                
                // Auto-test after initialization
                setTimeout(() => {
                    testUserSystem();
                    testProjectManager();
                }, 1000);
            }
        }, 100);

        // Update status every 2 seconds
        setInterval(updateSystemStatus, 2000);

        // Initial status
        log('üîç Project Creation Debug Tool Started', 'info');
        log('Waiting for system initialization...', 'info');
    </script>
</body>
</html>
