<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Integration Flow</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1f2e;
            color: #e5e7eb;
        }
        .test-section {
            background: #2d3748;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #4a7c2c;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .pass {
            background: #d1fae5;
            color: #065f46;
        }
        .fail {
            background: #fee2e2;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        button {
            background: #4a7c2c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover {
            background: #3d6a25;
        }
        pre {
            background: #1a1f2e;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç User Integration Flow Test</h1>
    <p>Testing all user data sources and integration points</p>

    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="location.reload()">üîÑ Reload Page</button>
    <button onclick="clearAndTest()">üóëÔ∏è Clear Storage & Test</button>

    <div id="test-results"></div>

    <!-- Load actual scripts for testing -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth_lite.js"></script>
    <script src="assets/js/header_user_sync.js"></script>
    <script src="assets/js/userDataManager.js"></script>
    
    <script>
        const results = [];

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.push({ message, type });
            return div;
        }

        async function runAllTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';

            // Test 1: Check localStorage
            const section1 = document.createElement('div');
            section1.className = 'test-section';
            section1.innerHTML = '<h2>1Ô∏è‚É£ LocalStorage Check</h2>';
            
            const sessionActive = localStorage.getItem('session_active');
            const currentUserStr = localStorage.getItem('current_user');
            
            section1.appendChild(log(
                `session_active: ${sessionActive}`,
                sessionActive === 'true' ? 'pass' : 'fail'
            ));
            
            section1.appendChild(log(
                `current_user exists: ${!!currentUserStr}`,
                currentUserStr ? 'pass' : 'fail'
            ));

            if (currentUserStr) {
                try {
                    const user = JSON.parse(currentUserStr);
                    section1.appendChild(log(`‚úÖ User data valid JSON`, 'pass'));
                    section1.appendChild(log(`   Name: ${user.name}`, 'info'));
                    section1.appendChild(log(`   Email: ${user.email}`, 'info'));
                    section1.appendChild(log(`   ID: ${user.id}`, 'info'));
                    section1.appendChild(log(`   Type: ${user.type}`, 'info'));
                } catch (e) {
                    section1.appendChild(log(`‚ùå User data invalid JSON`, 'fail'));
                }
            }
            
            container.appendChild(section1);

            // Test 2: Check window.currentUser
            const section2 = document.createElement('div');
            section2.className = 'test-section';
            section2.innerHTML = '<h2>2Ô∏è‚É£ window.currentUser (set by auth_guard)</h2>';
            
            section2.appendChild(log(
                `window.currentUser exists: ${!!window.currentUser}`,
                window.currentUser ? 'pass' : 'fail'
            ));
            
            if (window.currentUser) {
                section2.appendChild(log(`   Name: ${window.currentUser.name}`, 'info'));
                section2.appendChild(log(`   Email: ${window.currentUser.email}`, 'info'));
            }
            
            container.appendChild(section2);

            // Test 3: Check authLite
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const section3 = document.createElement('div');
            section3.className = 'test-section';
            section3.innerHTML = '<h2>3Ô∏è‚É£ AuthLite System</h2>';
            
            section3.appendChild(log(
                `window.authLite exists: ${!!window.authLite}`,
                window.authLite ? 'pass' : 'fail'
            ));
            
            if (window.authLite) {
                const isAuth = window.authLite.isAuthenticated();
                const user = window.authLite.getCurrentUser();
                
                section3.appendChild(log(`   isAuthenticated(): ${isAuth}`, isAuth ? 'pass' : 'fail'));
                section3.appendChild(log(`   getCurrentUser(): ${!!user}`, user ? 'pass' : 'fail'));
                
                if (user) {
                    section3.appendChild(log(`   User name: ${user.name}`, 'info'));
                }
            }
            
            container.appendChild(section3);

            // Test 4: Check headerUserSync
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const section4 = document.createElement('div');
            section4.className = 'test-section';
            section4.innerHTML = '<h2>4Ô∏è‚É£ Header User Sync</h2>';
            
            section4.appendChild(log(
                `window.headerUserSync exists: ${!!window.headerUserSync}`,
                window.headerUserSync ? 'pass' : 'fail'
            ));
            
            if (window.headerUserSync) {
                const user = window.headerUserSync.getCurrentUser();
                section4.appendChild(log(`   getCurrentUser(): ${!!user}`, user ? 'pass' : 'fail'));
                
                if (user) {
                    section4.appendChild(log(`   User name: ${user.name}`, 'info'));
                }
                
                // Check if header elements found
                const elements = window.headerUserSync.headerElements;
                section4.appendChild(log(`   Header elements found: ${Object.values(elements).filter(e => e).length}/5`, 'info'));
            }
            
            container.appendChild(section4);

            // Test 5: Check userDataManager
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const section5 = document.createElement('div');
            section5.className = 'test-section';
            section5.innerHTML = '<h2>5Ô∏è‚É£ User Data Manager</h2>';
            
            section5.appendChild(log(
                `window.userDataManager exists: ${!!window.userDataManager}`,
                window.userDataManager ? 'pass' : 'fail'
            ));
            
            if (window.userDataManager) {
                const isLoggedIn = window.userDataManager.isUserLoggedIn();
                const userId = window.userDataManager.getCurrentUserId();
                const userName = window.userDataManager.getCurrentUserName();
                
                section5.appendChild(log(`   isUserLoggedIn(): ${isLoggedIn}`, isLoggedIn ? 'pass' : 'fail'));
                section5.appendChild(log(`   getCurrentUserId(): ${userId}`, userId ? 'pass' : 'fail'));
                section5.appendChild(log(`   getCurrentUserName(): ${userName}`, 'info'));
            }
            
            container.appendChild(section5);

            // Test 6: Data Consistency Check
            const section6 = document.createElement('div');
            section6.className = 'test-section';
            section6.innerHTML = '<h2>6Ô∏è‚É£ Data Consistency Check</h2>';
            
            const sources = {
                localStorage: currentUserStr ? JSON.parse(currentUserStr) : null,
                windowUser: window.currentUser,
                authLite: window.authLite?.getCurrentUser(),
                headerSync: window.headerUserSync?.getCurrentUser(),
                userDataManager: window.userDataManager?.getCurrentUser()
            };
            
            const userIds = Object.entries(sources)
                .filter(([key, val]) => val)
                .map(([key, val]) => ({ source: key, id: val.id, name: val.name }));
            
            const allSameId = userIds.every(u => u.id === userIds[0]?.id);
            const allSameName = userIds.every(u => u.name === userIds[0]?.name);
            
            section6.appendChild(log(
                `All sources have same user ID: ${allSameId}`,
                allSameId ? 'pass' : 'fail'
            ));
            
            section6.appendChild(log(
                `All sources have same user name: ${allSameName}`,
                allSameName ? 'pass' : 'fail'
            ));
            
            userIds.forEach(u => {
                section6.appendChild(log(`   ${u.source}: ID=${u.id}, Name=${u.name}`, 'info'));
            });
            
            container.appendChild(section6);

            // Summary
            const summary = document.createElement('div');
            summary.className = 'test-section';
            summary.innerHTML = '<h2>üìä Summary</h2>';
            
            const passCount = results.filter(r => r.type === 'pass').length;
            const failCount = results.filter(r => r.type === 'fail').length;
            
            summary.innerHTML += `<pre>
Tests Passed: ${passCount}
Tests Failed: ${failCount}
Total Tests: ${passCount + failCount}
            
${failCount === 0 ? '‚úÖ ALL TESTS PASSED! User integration working correctly.' : '‚ö†Ô∏è Some tests failed. Check issues above.'}
</pre>`;
            
            container.appendChild(summary);
        }

        function clearAndTest() {
            if (confirm('This will clear all user data. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        // Auto-run on load
        setTimeout(runAllTests, 500);
    </script>
</body>
</html>

