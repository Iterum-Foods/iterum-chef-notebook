<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Builder | Iterum R&D Chef Notebook</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        body {
            background: repeating-linear-gradient(
                to bottom,
                #f6fbe7 0px,
                #f6fbe7 38px,
                #eafcd7 39px,
                #f6fbe7 40px
            ), url('data:image/svg+xml;utf8,<svg width="180" height="180" xmlns="http://www.w3.org/2000/svg"><g opacity="0.13"><path d="M60 140 Q90 80 120 140" stroke="%237bb661" stroke-width="2.5" fill="none"/><ellipse cx="90" cy="140" rx="22" ry="9" fill="%23b6e388" stroke="%237bb661" stroke-width="1.5"/><ellipse cx="80" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><ellipse cx="90" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><ellipse cx="100" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><path d="M90 140 Q95 120 110 110 Q125 100 140 120" stroke="%237bb661" stroke-width="1.2" fill="none"/><ellipse cx="140" cy="120" rx="4" ry="2.5" fill="%23b6e388" stroke="%237bb661" stroke-width="1"/></g></svg>');
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            position: relative;
        }
        .pea-bg-sketch {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 0;
            opacity: 0.11;
            pointer-events: none;
            width: 480px;
            max-width: 90vw;
            height: auto;
        }
        .notebook-card {
            background: #fffbe7;
            border-radius: 1.2rem;
            box-shadow: 0 2px 12px 0 rgba(44, 62, 80, 0.08);
            border: 1.5px solid #e2d8b8;
            margin-bottom: 2rem;
        }
        .notebook-heading {
            font-family: 'Shadows Into Light', cursive;
            font-size: 2.1rem;
            color: #2a365d;
            margin-bottom: 0.5rem;
        }
        .sticky-btn {
            background: linear-gradient(90deg, #f7c873 0%, #fffbe7 100%);
            color: #2a365d;
            border-radius: 9999px;
            font-weight: 700;
            box-shadow: 0 2px 8px 0 rgba(44, 62, 80, 0.08);
            transition: background 0.2s;
        }
        .sticky-btn:hover {
            background: linear-gradient(90deg, #fffbe7 0%, #f7c873 100%);
        }
        @media print {
            .no-print { display: none !important; }
            .print-section { display: block !important; }
        }
        .menu-builder-container {
            width: 95vw;
            max-width: 1400px;
            margin: 32px auto 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            box-shadow: 0 4px 32px 0 rgba(0,0,0,0.08);
            padding: 32px 36px 36px 36px;
            min-height: 80vh;
            transition: box-shadow 0.2s;
        }
        @media (max-width: 900px) {
            .menu-builder-container {
                width: 99vw;
                max-width: 100vw;
                padding: 12px 2vw;
            }
        }
        @media (max-width: 600px) {
            .menu-builder-container {
                padding: 4px 0.5vw;
                border-radius: 0;
            }
        }
        .menu-stepper, .menu-section, .menu-card, .menu-table {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- Enhanced Uniform Header -->
    <header class="bg-gradient-to-r from-white to-green-50 shadow-lg sticky top-0 z-40 border-b-2 border-green-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
        <!-- Logo and Brand -->
        <div class="flex items-center gap-3">
          <div class="relative">
            <img src="botanical-logo.svg" alt="Iterum Botanical Logo" class="h-10 w-10 transition-transform hover:scale-110">
            <div class="absolute -inset-1 bg-green-200 rounded-full opacity-0 hover:opacity-20 transition-opacity"></div>
          </div>
          <span class="font-bold text-xl tracking-tight text-gray-800 hover:text-green-700 transition-colors">
            Iterum R&D Chef Notebook
          </span>
        </div>
        
        <!-- Desktop Navigation -->
        <nav class="hidden lg:flex gap-1 text-gray-700 font-medium">
          <a href="index.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üè† Dashboard</span>
          </a>
          <a href="recipe-library.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üìö Recipe Library</span>
          </a>
          <a href="recipe-developer.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üß™ Recipe Developer</span>
          </a>
          <a href="recipe-upload.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">‚ö° Quick Upload</span>
          </a>
          <a href="menu-builder.html" class="nav-active hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üçΩÔ∏è Menu Builder</span>
          </a>
          <a href="ingredients.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">ü•¨ Ingredients</span>
          </a>
          <a href="equipment-management.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üîß Equipment</span>
          </a>
          <a href="vendor-management.html" class="hover:text-green-600 hover:bg-green-50 transition-all px-3 py-2 rounded-lg">
            <span class="flex items-center gap-1">üè™ Vendors</span>
          </a>
        </nav>
        
        <!-- User Info and Actions -->
        <div class="flex items-center gap-3">
          <span id="current-user" class="text-gray-600 text-sm font-medium bg-white px-3 py-1 rounded-full border"></span>
          <button id="login-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors shadow-sm hidden">
            Login
          </button>
          <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors hidden">
            Logout
          </button>
          <button id="switch-user-btn" onclick="window.switchUser()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm transition-colors shadow-sm">
            Switch User
          </button>
          <button id="nav-toggle" class="lg:hidden text-2xl text-gray-700 focus:outline-none hover:text-green-600 hover:bg-green-50 p-2 rounded-lg transition-colors">
            &#9776;
          </button>
        </div>
      </div>
      
      <!-- Mobile Navigation -->
      <nav id="mobile-nav" class="lg:hidden bg-white border-t border-gray-200 hidden flex-col gap-1 px-4 pb-4">
        <a href="index.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üè† Dashboard</span>
        </a>
        <a href="recipe-library.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üìö Recipe Library</span>
        </a>
        <a href="recipe-developer.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üß™ Recipe Developer</span>
        </a>
        <a href="recipe-upload.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">‚ö° Quick Upload</span>
        </a>
        <a href="menu-builder.html" class="nav-active block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üçΩÔ∏è Menu Builder</span>
        </a>
        <a href="ingredients.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">ü•¨ Ingredients</span>
        </a>
        <a href="equipment-management.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üîß Equipment</span>
        </a>
        <a href="vendor-management.html" class="block py-3 px-2 hover:text-green-600 hover:bg-green-50 rounded transition-colors">
          <span class="flex items-center gap-2">üè™ Vendors</span>
        </a>
      </nav>
    </header>

    <!-- Enhanced Mobile Navigation Toggle Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('nav-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        
        if (navToggle && mobileNav) {
          navToggle.addEventListener('click', function() {
            mobileNav.classList.toggle('hidden');
            
            // Add animation class
            if (!mobileNav.classList.contains('hidden')) {
              mobileNav.style.animation = 'slideDown 0.3s ease-out';
            }
          });
          
          // Close mobile nav when clicking outside
          document.addEventListener('click', function(event) {
            if (!navToggle.contains(event.target) && !mobileNav.contains(event.target)) {
              mobileNav.classList.add('hidden');
            }
          });
        }
      });
    </script>
    <main class="max-w-5xl mx-auto py-8 px-2 md:px-0">
        <div class="notebook-card p-6">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-8 mb-6">
                <div class="notebook-heading">Menu Builder</div>
                <div class="flex-1"></div>
                <div class="flex space-x-2">
                    <button class="sticky-btn px-4 py-2 no-print" onclick="window.print()">Print/Export PDF</button>
                </div>
            </div>
            <!-- Stepper Navigation -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="sticky-btn px-4 py-2" onclick="showSection('upload')">1. Upload Document</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('build')">2. Menu Build</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('staff')">3. Staff Sheet</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('plate')">4. Plate Build</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('recipes')">5. Recipe List</button>
            </div>
            <!-- Sections -->
            <section id="section-upload" class="menu-section">
                <h2 class="notebook-heading">1. Upload Menu Document</h2>
                
                <!-- Project/Restaurant Selection -->
                <div class="mb-6">
                    <div class="notebook-card p-4 bg-blue-50 border-blue-200">
                        <h3 class="text-lg font-semibold mb-3 text-blue-800">üè¢ Project & Restaurant Selection</h3>
                        <p class="text-sm text-blue-600 mb-4">Choose or create a project to organize your menu development</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Restaurant Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Restaurant/Brand</label>
                                <div class="flex gap-2">
                                    <select id="restaurant-select" class="notebook-input flex-1" onchange="handleRestaurantChange()">
                                        <option value="">Select Restaurant...</option>
                                        <option value="new">+ Add New Restaurant</option>
                                    </select>
                                    <button class="sticky-btn px-3 py-1 text-sm" onclick="showRestaurantModal()" title="Manage Restaurants">‚öôÔ∏è</button>
                                </div>
                                <input type="text" id="new-restaurant-input" class="notebook-input mt-2 hidden" placeholder="Enter restaurant name" onblur="saveNewRestaurant()">
                            </div>
                            
                            <!-- Project Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                <div class="flex gap-2">
                                    <select id="project-select" class="notebook-input flex-1" onchange="handleProjectChange()">
                                        <option value="">Select Project...</option>
                                        <option value="new">+ Create New Project</option>
                                    </select>
                                    <button class="sticky-btn px-3 py-1 text-sm" onclick="showProjectModal()" title="Manage Projects">‚öôÔ∏è</button>
                                </div>
                                <input type="text" id="new-project-input" class="notebook-input mt-2 hidden" placeholder="Enter project name (e.g., Summer 2024 Menu)" onblur="saveNewProject()">
                            </div>
                        </div>
                        
                        <!-- Selected Project Info -->
                        <div id="project-info" class="mt-4 p-3 bg-white rounded border hidden">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-gray-800" id="current-project-display">No project selected</span>
                                    <div class="text-sm text-gray-600" id="project-details"></div>
                                </div>
                                <div class="text-sm text-gray-500" id="project-date"></div>
                            </div>
                        </div>
                        
                        <!-- Continue Button -->
                        <div class="mt-4 text-center">
                            <button id="continue-to-upload" class="sticky-btn px-6 py-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="continueToUpload()" disabled>
                                ‚úÖ Continue to Menu Upload
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Menu Upload Section (Initially Hidden) -->
                <div id="upload-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Document Upload -->
                    <div class="notebook-card p-4">
                        <h3 class="text-lg font-semibold mb-3">üìÑ Document Upload</h3>
                        <p class="text-sm text-gray-600 mb-3">Upload PDF or Word (.docx) menu files</p>
                        <input type="file" accept="application/pdf,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="mb-4 w-full" id="menu-document-upload">
                        <button class="sticky-btn px-4 py-2 mb-2" onclick="extractMenuDocument()">üìñ Extract Text</button>
                        <div id="document-extract-result" class="mt-2 text-sm text-gray-700 p-3 bg-gray-50 rounded border min-h-[100px] hidden"></div>
                        <div class="text-xs text-gray-500 mt-2">
                            <p>‚Ä¢ Supports PDF and Word (.docx) files</p>
                            <p>‚Ä¢ Legacy .doc files not supported</p>
                            <p>‚Ä¢ Text will be extracted automatically</p>
                        </div>
                    </div>
                    
                    <!-- Paste Menu Text -->
                    <div class="notebook-card p-4">
                        <h3 class="text-lg font-semibold mb-3">üìã Paste Menu Text</h3>
                        <p class="text-sm text-gray-600 mb-3">Paste your menu text from any source (Word, website, etc.)</p>
                        <button class="sticky-btn px-4 py-2 mb-3" onclick="showPasteMenuModal()">üìã Paste Menu Text</button>
                        <div class="text-xs text-gray-500">
                            <p>‚Ä¢ Copy menu text from any source</p>
                            <p>‚Ä¢ Paste into the text area</p>
                            <p>‚Ä¢ Auto-detect menu sections</p>
                            <p>‚Ä¢ Generate structured menu</p>
                        </div>
                    </div>
                    </div> <!-- End upload-content -->
                </div>
            </section>
            <section id="section-build" class="menu-section hidden">
                <h2 class="notebook-heading">2. Menu Build</h2>
                <div class="mb-4 p-3 bg-blue-50 rounded border-blue-200" id="project-context" style="display: none;">
                    <div class="text-sm text-blue-800">
                        <strong>Project:</strong> <span id="build-project-name"></span> | 
                        <strong>Restaurant:</strong> <span id="build-restaurant-name"></span>
                    </div>
                </div>
                <input type="text" class="notebook-input mb-2" placeholder="Menu Name" id="menu-title">
                <textarea class="notebook-textarea mb-2" placeholder="Menu Description"></textarea>
                <!-- Menu sections and items will be dynamically added here -->
                <div id="menu-sections"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="addMenuSection()">+ Add Section</button>
            </section>
            <section id="section-staff" class="menu-section hidden">
                <h2 class="notebook-heading">3. Staff Sheet</h2>
                <div class="mb-2 text-gray-700">Export a staff version with staff notes, modifiers, substitutions, and allergy info.</div>
                <div id="staff-sheet"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
            <section id="section-plate" class="menu-section hidden">
                <h2 class="notebook-heading">4. Plate Build Sheet</h2>
                <div class="mb-2 text-gray-700">For each menu item, list all components, quantities, and descriptions for the kitchen.</div>
                <div id="plate-build-list">
                    <table class="w-full border border-gray-300 rounded-lg mb-4">
                        <thead>
                            <tr class="bg-yellow-100">
                                <th class="p-2 border-b">Component/Prep Item</th>
                                <th class="p-2 border-b">Quantity</th>
                                <th class="p-2 border-b">Description/Notes</th>
                                <th class="p-2 border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plate-build-body">
                            <!-- Plate build rows will be dynamically added here -->
                        </tbody>
                    </table>
                    <button class="sticky-btn px-4 py-2" onclick="addPlateBuildRow()">+ Add Component</button>
                </div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
            <section id="section-recipes" class="menu-section hidden">
                <h2 class="notebook-heading">5. Recipe List</h2>
                <div class="mb-2 text-gray-700">All recipes needed for this menu. Add new or link to existing.</div>
                <div id="recipe-list"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
        </div>
    </main>
    <!-- Modern Dark Loading Overlay -->
    <div id="loading-overlay" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f0f23 100%);display:flex;align-items:center;justify-content:center;transition:opacity 0.7s;backdrop-filter:blur(10px);">
      <div style="display:flex;flex-direction:column;align-items:center;gap:2rem;">
        <div style="width:80px;height:80px;border:3px solid rgba(255,255,255,0.1);border-top:3px solid #64ffda;border-radius:50%;animation:spin 1.2s cubic-bezier(0.68,-0.55,0.265,1.55) infinite;position:relative;">
          <div style="display:flex;gap:8px;margin-top:1rem;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);">
            <div style="width:8px;height:8px;border-radius:50%;background:linear-gradient(45deg,#64ffda,#ff6b6b);animation:pulse 1.5s ease-in-out infinite;"></div>
            <div style="width:8px;height:8px;border-radius:50%;background:linear-gradient(45deg,#64ffda,#ff6b6b);animation:pulse 1.5s ease-in-out infinite;animation-delay:0.2s;"></div>
            <div style="width:8px;height:8px;border-radius:50%;background:linear-gradient(45deg,#64ffda,#ff6b6b);animation:pulse 1.5s ease-in-out infinite;animation-delay:0.4s;"></div>
          </div>
        </div>
        <div style="font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;color:#e2e8f0;font-size:1.1rem;font-weight:500;text-align:center;letter-spacing:0.05em;margin-top:1rem;opacity:0.9;">Menu Builder</div>
        <div style="font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;color:#64ffda;font-size:0.9rem;font-weight:400;text-align:center;margin-top:0.5rem;opacity:0.7;">Loading your menu workspace...</div>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white text-center">
          <div class="text-3xl mb-2">üë®‚Äçüç≥</div>
          <h2 class="text-2xl font-bold">Welcome to Iterum</h2>
          <p class="text-blue-100">Your Culinary Research & Development Notebook</p>
        </div>
        <!-- Login Form -->
        <div id="login-form-container" class="p-6">
          <form id="login-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="login-email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Enter your email">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <div class="relative">
                <input type="password" id="login-password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12" placeholder="Enter your password">
                <button type="button" id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">üëÅÔ∏è</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="flex items-center">
                <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-600">Remember me</span>
              </label>
              <button type="button" id="forgot-password-btn" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</button>
            </div>
            <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
            <button type="submit" id="login-submit-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all">
              <span id="login-btn-text">Sign In</span>
              <div id="login-spinner" class="hidden inline-block ml-2">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              </div>
            </button>
          </form>
          <div class="mt-6 text-center">
            <p class="text-gray-600">Don't have an account?</p>
            <button type="button" id="show-signup-btn" class="text-blue-600 hover:text-blue-800 font-semibold">Create Account</button>
          </div>
          <div class="mt-6 pt-6 border-t border-gray-200">
            <button type="button" id="continue-offline-btn" class="w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-200 transition-all">üöÄ Continue Offline (Local Profile)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Paste Menu Modal -->
    <div id="paste-menu-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">üìã Paste Menu Text</h3>
                <button id="close-paste-menu-modal" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Menu Text</label>
                    <textarea id="paste-menu-text" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                              placeholder="Paste your menu text here...

Example:
STARTERS
Bruschetta - Toasted bread with tomatoes, basil, and garlic
Caprese Salad - Fresh mozzarella, tomatoes, and basil

MAIN COURSES
Grilled Salmon - Atlantic salmon with seasonal vegetables
Beef Tenderloin - 8oz tenderloin with mashed potatoes

DESSERTS
Tiramisu - Classic Italian dessert
Chocolate Lava Cake - Warm chocolate cake with vanilla ice cream"></textarea>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">üí° Tips for best results:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ <strong>Section Headers:</strong> Use ALL CAPS or Title Case (STARTERS, Main Courses, etc.)</li>
                        <li>‚Ä¢ <strong>Dish Format:</strong> "Dish Name - Description" or "Dish Name: Description"</li>
                        <li>‚Ä¢ <strong>Prices:</strong> Include with $, ‚Ç¨, ¬£ symbols or "dollars/euros"</li>
                        <li>‚Ä¢ <strong>Separate Lines:</strong> Put each dish on its own line for best parsing</li>
                        <li>‚Ä¢ <strong>Flexible Format:</strong> Works with most menu formats automatically</li>
                    </ul>
                </div>
                
                <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2">‚úÖ Supported Formats:</h4>
                    <div class="text-sm text-green-700 space-y-1">
                        <p><strong>Section Detection:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>‚Ä¢ STARTERS, APPETIZERS, MAIN COURSES</li>
                            <li>‚Ä¢ Starters, Appetizers, Main Courses</li>
                            <li>‚Ä¢ 1. Starters, 2. Main Courses</li>
                            <li>‚Ä¢ Chef's Specials, Daily Specials</li>
                        </ul>
                        <p class="mt-2"><strong>Price Detection:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>‚Ä¢ $12, $12.99, 12$, 12.99$</li>
                            <li>‚Ä¢ ‚Ç¨12, ‚Ç¨12.99, 12‚Ç¨, 12.99‚Ç¨</li>
                            <li>‚Ä¢ ¬£12, ¬£12.99, 12¬£, 12.99¬£</li>
                            <li>‚Ä¢ 12 dollars, 12.99 euros</li>
                        </ul>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="preview-menu-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-semibold">
                        üëÅÔ∏è Preview Extraction
                    </button>
                    <button id="extract-menu-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold" style="display: none;">
                        üöÄ Generate Menu Structure
                    </button>
                    <button id="cancel-paste-menu" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg">
                        Cancel
                    </button>
                </div>
                
                <!-- Preview Section -->
                <div id="preview-section" class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-800">üìã Preview of Extracted Menu:</h4>
                        <button id="try-again-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            üîÑ Try Again
                        </button>
                    </div>
                    <div id="preview-content" class="text-sm text-gray-700 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

        <script src="unified_auth_system.js"></script>
    <script src="auto_save_system.js"></script>
    <script src="auto_save_config.js"></script>
    <script src="debug_auth_buttons.js"></script>
    <script src="standardize-login-modals.js"></script>
    <script>
        // Section navigation
        function showSection(section) {
            document.querySelectorAll('.menu-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');
        }

        // Paste Menu Modal Functions
        function showPasteMenuModal() {
            const modal = document.getElementById('paste-menu-modal');
            modal.classList.remove('hidden');
            document.getElementById('paste-menu-text').focus();
        }

        function hidePasteMenuModal() {
            const modal = document.getElementById('paste-menu-modal');
            modal.classList.add('hidden');
            document.getElementById('paste-menu-text').value = '';
            
            // Reset preview
            const previewSection = document.getElementById('preview-section');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            
            if (previewSection) previewSection.style.display = 'none';
            if (extractBtn) extractBtn.style.display = 'none';
            if (previewBtn) previewBtn.style.display = 'block';
        }

        // Enhanced menu text parsing with improved intelligence
        function parseMenuText(text) {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
            const sections = [];
            let currentSection = null;
            
            // Enhanced section keywords with variations
            const sectionKeywords = [
                // Starters & Appetizers
                'starters', 'appetizers', 'appetiser', 'appetisers', 'first course', 'first courses',
                'hors d\'oeuvres', 'hors d\'oeuvre', 'small plates', 'tapas', 'canap√©s', 'canapes',
                
                // Main Courses
                'main course', 'main courses', 'mains', 'entr√©es', 'entrees', 'entr√©e', 'entree',
                'main dishes', 'main dish', 'primary dishes', 'primary course',
                
                // Desserts & Sweets
                'desserts', 'dessert', 'sweets', 'sweet', 'pastries', 'pastry', 'cakes', 'cake',
                'ice cream', 'gelato', 'sorbet', 'pudding', 'puddings',
                
                // Beverages
                'beverages', 'beverage', 'drinks', 'drink', 'cocktails', 'cocktail', 'wine', 'wines',
                'beer', 'beers', 'spirits', 'spirit', 'coffee', 'tea', 'juice', 'juices',
                
                // Other Categories
                'soup', 'soups', 'salad', 'salads', 'sides', 'side dishes', 'side dish',
                'breakfast', 'lunch', 'dinner', 'brunch', 'specials', 'daily specials',
                'chef\'s specials', 'chef specials', 'seasonal', 'seasonal dishes',
                'vegetarian', 'vegan', 'gluten free', 'dairy free', 'allergen free'
            ];
            
            // Enhanced section detection patterns
            const sectionPatterns = [
                /^[A-Z\s&]+$/, // ALL CAPS sections
                /^[A-Z][a-z\s&]+$/, // Title Case sections
                /^[A-Z][a-z\s&]+:$/, // Title Case with colon
                /^[A-Z\s&]+:$/, // ALL CAPS with colon
                /^\d+\.\s*[A-Z][a-z\s&]+$/, // Numbered sections
                /^[A-Z][a-z\s&]+\s*[-‚Äì‚Äî]\s*[A-Z][a-z\s&]+$/ // Sections with separators
            ];
            
            lines.forEach((line, index) => {
                const lowerLine = line.toLowerCase();
                
                // Check if this line is a section header
                const isSectionHeader = sectionKeywords.some(keyword => 
                    lowerLine.includes(keyword) || 
                    lowerLine === keyword ||
                    lowerLine.startsWith(keyword + ' ') ||
                    lowerLine.endsWith(' ' + keyword)
                ) || sectionPatterns.some(pattern => pattern.test(line));
                
                // Additional section detection logic
                const isLikelySection = 
                    line.length > 2 && line.length < 60 && // Reasonable length
                    !line.includes('$') && !line.includes('‚Ç¨') && !line.includes('¬£') && // No currency
                    !/\d+\.\d+/.test(line) && // No decimal prices
                    !line.includes('oz') && !line.includes('g') && !line.includes('ml') && // No measurements
                    (line.match(/[A-Z]/g) || []).length > (line.match(/[a-z]/g) || []).length * 0.3; // Mostly caps
                
                if (isSectionHeader || isLikelySection) {
                    // Clean up section name
                    let sectionName = line.replace(/^[\d\.\s]+/, '').replace(/[:\.\s]+$/, '');
                    
                    // If it's a numbered section, extract just the name
                    if (/^\d+\./.test(line)) {
                        sectionName = line.replace(/^\d+\.\s*/, '');
                    }
                    
                    currentSection = { 
                        name: sectionName, 
                        items: [] 
                    };
                    sections.push(currentSection);
                } else if (currentSection && line.length > 0) {
                    // Parse menu item with enhanced logic
                    const item = parseMenuItem(line);
                    if (item.name && item.name.length > 0) {
                        currentSection.items.push(item);
                    }
                } else if (!currentSection && line.length > 0) {
                    // If no section detected yet, create a default section
                    if (!sections.length) {
                        currentSection = { name: 'Menu Items', items: [] };
                        sections.push(currentSection);
                    }
                    const item = parseMenuItem(line);
                    if (item.name && item.name.length > 0) {
                        currentSection.items.push(item);
                    }
                }
            });
            
            // Post-process sections to clean up and merge similar ones
            return postProcessSections(sections);
        }

        function parseMenuItem(line) {
            // Enhanced price extraction patterns
            const pricePatterns = [
                /\$(\d+\.?\d*)/, // $12, $12.99
                /(\d+\.?\d*)\s*\$/, // 12$, 12.99$
                /‚Ç¨(\d+\.?\d*)/, // ‚Ç¨12, ‚Ç¨12.99
                /(\d+\.?\d*)\s*‚Ç¨/, // 12‚Ç¨, 12.99‚Ç¨
                /¬£(\d+\.?\d*)/, // ¬£12, ¬£12.99
                /(\d+\.?\d*)\s*¬£/, // 12¬£, 12.99¬£
                /(\d+\.?\d*)\s*(?:dollars?|euros?|pounds?)/i, // 12 dollars, 12.99 euros
                /(\d+\.?\d*)\s*(?:USD|EUR|GBP)/i // 12 USD, 12.99 EUR
            ];
            
            let price = '';
            let description = line;
            
            // Find and extract price
            for (const pattern of pricePatterns) {
                const match = line.match(pattern);
                if (match) {
                    price = match[1] || match[0];
                    description = line.replace(match[0], '').trim();
                    break;
                }
            }
            
            // Enhanced item parsing with multiple separators
            const separators = [
                /[-‚Äì‚Äî]\s*/, // Dash, en-dash, em-dash
                /\s*[-‚Äì‚Äî]\s*/, // Dash with spaces
                /\s*:\s*/, // Colon
                /\s*‚Äì\s*/, // En dash
                /\s*‚Äî\s*/, // Em dash
                /\s*\.\s*/, // Period
                /\s*,\s*/, // Comma
                /\s*\|\s*/, // Pipe
                /\s*\/\s*/ // Forward slash
            ];
            
            let name = description;
            let itemDescription = '';
            
            // Try to split on separators
            for (const separator of separators) {
                const parts = description.split(separator);
                if (parts.length > 1 && parts[0].trim().length > 0) {
                    name = parts[0].trim();
                    itemDescription = parts.slice(1).join(' - ').trim();
                    break;
                }
            }
            
            // Clean up name and description
            name = name.replace(/^[\d\.\s]+/, '').trim(); // Remove leading numbers/dots
            itemDescription = itemDescription.replace(/^[\d\.\s]+/, '').trim();
            
            // If no description found, check if the whole line is just a name
            if (!itemDescription && name.length > 0) {
                // Check if the line looks like a complete item name
                if (name.length < 100 && !name.includes('$') && !name.includes('‚Ç¨') && !name.includes('¬£')) {
                    // This might be a standalone item name
                } else {
                    // This might be a description, not a name
                    itemDescription = name;
                    name = '';
                }
            }
            
            return {
                name: name || 'Untitled Item',
                description: itemDescription,
                price: price
            };
        }

        function postProcessSections(sections) {
            // Merge similar sections
            const mergedSections = [];
            const sectionMap = new Map();
            
            sections.forEach(section => {
                const key = section.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (sectionMap.has(key)) {
                    // Merge with existing section
                    sectionMap.get(key).items.push(...section.items);
                } else {
                    sectionMap.set(key, { ...section });
                    mergedSections.push(sectionMap.get(key));
                }
            });
            
            // Clean up section names
            mergedSections.forEach(section => {
                // Remove common prefixes/suffixes
                section.name = section.name
                    .replace(/^(menu|our|the)\s+/i, '')
                    .replace(/\s+(menu|section|items?)$/i, '')
                    .trim();
                
                // Capitalize properly
                section.name = section.name.replace(/\b\w/g, l => l.toUpperCase());
            });
            
            // Remove empty sections
            return mergedSections.filter(section => section.items.length > 0);
        }

        // Plate Build logic
        function addPlateBuildRow() {
            const tbody = document.getElementById('plate-build-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Component/Prep Item"></td>
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Quantity"></td>
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Description/Notes"></td>
                <td class="p-2 border-b"><button onclick="this.closest('tr').remove()" class="sticky-btn px-2 py-1">Remove</button></td>
            `;
            tbody.appendChild(row);
        }

        // Add first row by default
        if(document.getElementById('plate-build-body')) addPlateBuildRow();

        // Document extraction (PDF and Word)
        function extractMenuDocument() {
            const fileInput = document.getElementById('menu-document-upload');
            const result = document.getElementById('document-extract-result');
            
            // Clear previous results and show container
            result.innerHTML = '';
            result.classList.remove('hidden');
            
            if (!fileInput.files || !fileInput.files[0]) {
                result.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Please select a PDF or Word document first.</span>';
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            
            // Validate file type
            if (!fileName.endsWith('.pdf') && !fileName.endsWith('.docx')) {
                result.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Only PDF and Word (.docx) files are supported. Legacy .doc files are not supported.</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading state
            const fileType = fileName.endsWith('.pdf') ? 'PDF' : 'Word';
            result.innerHTML = `
                <div class="flex items-center space-x-2 text-blue-600">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>üì§ Uploading ${fileType} document...</span>
                </div>
                <div class="mt-2 text-sm text-gray-500">Extracting text from ${file.name}</div>
            `;
            
            fetch('http://localhost:8000/api/menu/upload-document', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.text) {
                    // Store extracted text globally for later use
                    window.lastExtractedText = data.text;
                    const fileTypeIcon = data.file_type === 'pdf' ? 'üìÑ' : 'üìù';
                    result.innerHTML = `
                        <div class="mb-3">
                            <div class="flex items-center space-x-2 text-green-600 mb-2">
                                <span class="text-lg">${fileTypeIcon}</span>
                                <span class="font-medium">‚úÖ Successfully extracted text from ${data.filename}</span>
                            </div>
                            <div class="text-sm text-gray-600">File type: ${data.file_type.toUpperCase()}</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-sm font-mono max-h-60 overflow-y-auto" id="extracted-text-display">
                            ${data.text.replace(/\n/g, '<br>')}
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button class="sticky-btn px-3 py-1 text-sm" onclick="startTextAnnotation('${data.text.replace(/'/g, "\\'")}')">
                                ‚úèÔ∏è Select Menu Sections
                            </button>
                            <button class="sticky-btn px-3 py-1 text-sm" onclick="copyExtractedText('${data.text.replace(/'/g, "\\'")}')">
                                üìã Copy Text
                            </button>
                            <button class="sticky-btn px-3 py-1 text-sm" onclick="autoParseMenu('${data.text.replace(/'/g, "\\'")}')">
                                ü§ñ Auto-Parse Menu
                            </button>
                        </div>
                    `;
                } else if (data.detail) {
                    result.innerHTML = `<span class="text-red-600">‚ùå Error: ${data.detail}</span>`;
                } else {
                    result.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è No text found in document. The file might be scanned images.</span>';
                }
            })
            .catch(err => {
                console.error('Upload error:', err);
                let errorMessage = 'Network error';
                if (err.message) {
                    if (err.message.includes('HTTP 501')) {
                        errorMessage = 'Backend server not responding correctly. Please check if the server is running.';
                    } else if (err.message.includes('Failed to fetch')) {
                        errorMessage = 'Cannot connect to backend server. Please ensure it\'s running on port 8000.';
                    } else {
                        errorMessage = err.message;
                    }
                }
                result.innerHTML = `<span class="text-red-600">‚ùå Upload failed: ${errorMessage}</span>`;
            });
        }
        
        // Helper function to copy extracted text
        function copyExtractedText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('üìã Text copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text:', err);
                alert('‚ùå Failed to copy text. Please select and copy manually.');
            });
        }
        
        // Interactive text annotation system
        function startTextAnnotation(text) {
            const result = document.getElementById('document-extract-result');
            
            result.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">üìù Select Menu Sections</h3>
                    <p class="text-sm text-gray-600 mb-4">Highlight text and click buttons to categorize menu items. Each section has a unique color scheme for easy identification.</p>
                    
                    <!-- Color Legend -->
                    <div class="mb-4 p-4 bg-white border rounded-lg shadow-sm">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            üé® Color Legend
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(99, 102, 241), rgb(139, 92, 246));"></div>
                                <span class="font-medium">üèÜ Title</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(16, 185, 129), rgb(34, 197, 94));"></div>
                                <span class="font-medium">üìÇ Category</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(245, 158, 11), rgb(251, 191, 36));"></div>
                                <span class="font-medium">üçΩÔ∏è Dish</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(244, 63, 94), rgb(251, 113, 133));"></div>
                                <span class="font-medium">üí∞ Price</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(139, 92, 246), rgb(167, 139, 250));"></div>
                                <span class="font-medium">üìù Description</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border shadow-sm" style="background: linear-gradient(135deg, rgb(100, 116, 139), rgb(148, 163, 184));"></div>
                                <span class="font-medium">‚ùå Ignore</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Multi-Color Category Selection Buttons -->
                <div class="mb-4" id="category-buttons">
                    <div class="flex flex-wrap gap-3 mb-3">
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('title')" data-category="title"
                                style="background: linear-gradient(135deg, rgb(99, 102, 241), rgb(139, 92, 246)); color: white; border: 2px solid rgb(99, 102, 241);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">üèÜ</span>
                                <span>Menu Title</span>
                            </span>
                        </button>
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('category')" data-category="category"
                                style="background: linear-gradient(135deg, rgb(16, 185, 129), rgb(34, 197, 94)); color: white; border: 2px solid rgb(16, 185, 129);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">üìÇ</span>
                                <span>Category</span>
                            </span>
                        </button>
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('dish')" data-category="dish"
                                style="background: linear-gradient(135deg, rgb(245, 158, 11), rgb(251, 191, 36)); color: white; border: 2px solid rgb(245, 158, 11);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">üçΩÔ∏è</span>
                                <span>Dish Name</span>
                            </span>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('price')" data-category="price"
                                style="background: linear-gradient(135deg, rgb(244, 63, 94), rgb(251, 113, 133)); color: white; border: 2px solid rgb(244, 63, 94);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">üí∞</span>
                                <span>Price</span>
                            </span>
                        </button>
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('description')" data-category="description"
                                style="background: linear-gradient(135deg, rgb(139, 92, 246), rgb(167, 139, 250)); color: white; border: 2px solid rgb(139, 92, 246);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">üìù</span>
                                <span>Description</span>
                            </span>
                        </button>
                        <button class="category-btn relative px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-sm" 
                                onclick="setActiveCategory('ignore')" data-category="ignore"
                                style="background: linear-gradient(135deg, rgb(100, 116, 139), rgb(148, 163, 184)); color: white; border: 2px solid rgb(100, 116, 139);">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">‚ùå</span>
                                <span>Ignore</span>
                            </span>
                        </button>
                    </div>
                </div>
                
                <!-- Selected Category Display -->
                <div class="mb-4 p-2 bg-gray-50 rounded">
                    <span class="text-sm text-gray-600">Active selection type: </span>
                    <span id="active-category-display" class="font-medium text-blue-600">Click a category button above</span>
                </div>
                
                <!-- Interactive Text Display -->
                <div class="bg-white p-4 rounded border text-sm max-h-96 overflow-y-auto mb-4" id="selectable-text">
                    <div class="mb-2 text-xs text-gray-500 border-b pb-2">
                        üí° <strong>Tips:</strong> Click lines to categorize them. Hold Ctrl/Cmd to select multiple lines. Right-click to deselect.
                    </div>
                    ${text.split('\n').map((line, index) => {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) return `<div class="text-line-empty p-1" data-line="${index}"><br></div>`;
                        
                        return `<div class="text-line cursor-pointer hover:bg-gray-100 p-2 rounded border-l-2 border-transparent transition-all duration-200" 
                                data-line="${index}" 
                                data-text="${trimmedLine.replace(/"/g, '&quot;')}"
                                onclick="selectLine(${index}, this, event)"
                                oncontextmenu="deselectLine(${index}, this, event)"
                                title="Click to categorize as: ${window.activeCategory || 'Select category first'}"
                                >${trimmedLine}</div>`;
                    }).join('')}
                </div>
                
                <!-- Enhanced Multi-Color Selection Tools -->
                <div class="mb-4 p-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border shadow-inner">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        üõ†Ô∏è Smart Selection Tools
                    </h4>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button class="smart-tool-btn text-xs px-3 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 shadow-sm" 
                                onclick="selectByPattern('title')"
                                style="background: linear-gradient(135deg, rgb(99, 102, 241), rgb(139, 92, 246)); color: white;">
                            <span class="flex items-center gap-1">
                                <span>üéØ</span>
                                <span>Smart Titles</span>
                            </span>
                        </button>
                        <button class="smart-tool-btn text-xs px-3 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 shadow-sm" 
                                onclick="selectByPattern('category')"
                                style="background: linear-gradient(135deg, rgb(16, 185, 129), rgb(34, 197, 94)); color: white;">
                            <span class="flex items-center gap-1">
                                <span>üéØ</span>
                                <span>Smart Categories</span>
                            </span>
                        </button>
                        <button class="smart-tool-btn text-xs px-3 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 shadow-sm" 
                                onclick="selectByPattern('price')"
                                style="background: linear-gradient(135deg, rgb(244, 63, 94), rgb(251, 113, 133)); color: white;">
                            <span class="flex items-center gap-1">
                                <span>üéØ</span>
                                <span>Find Prices</span>
                            </span>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button class="smart-tool-btn text-xs px-3 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 shadow-sm" 
                                onclick="clearAllSelections()"
                                style="background: linear-gradient(135deg, rgb(239, 68, 68), rgb(248, 113, 113)); color: white;">
                            <span class="flex items-center gap-1">
                                <span>üóëÔ∏è</span>
                                <span>Clear All</span>
                            </span>
                        </button>
                        <button class="smart-tool-btn text-xs px-3 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 shadow-sm" 
                                onclick="undoLastSelection()"
                                style="background: linear-gradient(135deg, rgb(107, 114, 128), rgb(156, 163, 175)); color: white;">
                            <span class="flex items-center gap-1">
                                <span>‚Ü∂</span>
                                <span>Undo Last</span>
                            </span>
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 bg-white/60 px-3 py-2 rounded border">
                        üí° <strong>Smart Tools:</strong> Use pattern detection above or click lines manually. 
                        <span id="selection-stats" class="font-semibold text-gray-800"></span>
                    </div>
                </div>
                
                <!-- Progress and Actions -->
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        <span id="selection-count">0 items categorized</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="sticky-btn px-4 py-2" onclick="previewMenuStructure()">
                            üëÄ Preview Menu
                        </button>
                        <button class="sticky-btn px-4 py-2" onclick="buildMenuFromSelections()" id="build-menu-btn" disabled>
                            üèóÔ∏è Build Menu
                        </button>
                    </div>
                </div>
            `;
            
            // Initialize selection system
            window.selectedItems = {};
            window.activeCategory = null;
            window.selectionHistory = [];
            window.multiSelectMode = false;
            
            updateSelectionCount();
            updateSelectionStats();
        }
        
        // Auto-parse menu with smart detection
        function autoParseMenu(text) {
            const result = document.getElementById('document-extract-result');
            
            result.innerHTML = `
                <div class="mb-4">
                    <div class="flex items-center space-x-2 text-blue-600 mb-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        <span>ü§ñ Auto-parsing menu structure...</span>
                    </div>
                </div>
            `;
            
            // Simulate processing delay
            setTimeout(() => {
                const parsedMenu = parseMenuText(text);
                displayParsedMenu(parsedMenu);
            }, 1500);
        }
        
        // Smart menu text parsing
        function parseMenuText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const menuStructure = {
                title: '',
                categories: []
            };
            
            let currentCategory = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Detect menu title (usually first significant line)
                if (!menuStructure.title && line.length > 5 && line.length < 50 && !line.includes('$') && !line.includes('‚Ç¨') && !line.includes('¬£')) {
                    menuStructure.title = line;
                    continue;
                }
                
                // Detect categories (lines that don't have prices and aren't too long)
                const hasPrice = /[\$‚Ç¨¬£]\s*\d+|\d+[\$‚Ç¨¬£]|\d+\.\d{2}|\d+,\d{2}/.test(line);
                const isShort = line.length < 30;
                const isAllCaps = line === line.toUpperCase() && line.length > 3;
                
                if ((isAllCaps || (isShort && !hasPrice)) && !line.includes('.') && !line.includes(',')) {
                    // This looks like a category
                    currentCategory = {
                        name: line,
                        items: []
                    };
                    menuStructure.categories.push(currentCategory);
                    continue;
                }
                
                // Detect menu items (lines with potential prices or descriptions)
                if (currentCategory && line.length > 3) {
                    const priceMatch = line.match(/([\$‚Ç¨¬£]\s*\d+(?:\.\d{2})?|\d+(?:\.\d{2})?\s*[\$‚Ç¨¬£])/);
                    
                    if (priceMatch) {
                        // Line contains a price
                        const price = priceMatch[1];
                        const dishName = line.replace(priceMatch[0], '').trim();
                        currentCategory.items.push({
                            name: dishName,
                            price: price,
                            description: ''
                        });
                    } else if (line.length > 10) {
                        // Might be a description or dish without price
                        const lastItem = currentCategory.items[currentCategory.items.length - 1];
                        if (lastItem && !lastItem.description) {
                            lastItem.description = line;
                        } else {
                            currentCategory.items.push({
                                name: line,
                                price: '',
                                description: ''
                            });
                        }
                    }
                }
            }
            
            return menuStructure;
        }
        
        // Display parsed menu for review
        function displayParsedMenu(menuStructure) {
            const result = document.getElementById('document-extract-result');
            
            result.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ü§ñ Auto-Parsed Menu Structure</h3>
                    <p class="text-sm text-gray-600 mb-4">Review the automatically detected menu structure. You can edit items before building the menu.</p>
                </div>
                
                <div class="bg-white p-4 rounded border mb-4 max-h-96 overflow-y-auto">
                    <div class="mb-4">
                        <h4 class="font-semibold text-blue-600">Menu Title:</h4>
                        <p class="ml-4">${menuStructure.title || 'No title detected'}</p>
                    </div>
                    
                    ${menuStructure.categories.map(category => `
                        <div class="mb-4 border-l-4 border-green-400 pl-4">
                            <h4 class="font-semibold text-green-600">${category.name}</h4>
                            ${category.items.map(item => `
                                <div class="ml-4 mb-2 p-2 bg-gray-50 rounded">
                                    <div class="font-medium">${item.name}</div>
                                    ${item.price ? `<div class="text-red-600 font-semibold">${item.price}</div>` : ''}
                                    ${item.description ? `<div class="text-sm text-gray-600">${item.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
                
                <div class="flex gap-2">
                    <button class="sticky-btn px-4 py-2" onclick="buildMenuFromParsed(${JSON.stringify(menuStructure).replace(/"/g, '&quot;')})">
                        ‚úÖ Use This Structure
                    </button>
                    <button class="sticky-btn px-4 py-2" onclick="startTextAnnotation('${window.lastExtractedText}')">
                        ‚úèÔ∏è Manual Selection Instead
                    </button>
                </div>
            `;
        }
        
        // Supporting functions for text annotation system
        function setActiveCategory(category) {
            window.activeCategory = category;
            
            // Update button styling with enhanced multi-color feedback
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                btn.style.animation = '';
            });
            
            const activeBtn = document.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.style.transform = 'scale(1.08)';
                activeBtn.style.boxShadow = '0 8px 16px rgba(0,0,0,0.3), 0 0 0 3px rgba(255,255,255,0.6)';
                
                // Add pulsing glow animation
                const colorScheme = getCategoryColorRGB(category);
                activeBtn.style.animation = 'none';
                setTimeout(() => {
                    activeBtn.style.animation = 'pulse 2s infinite';
                }, 10);
            }
            
            // Update display with enhanced styling
            const display = document.getElementById('active-category-display');
            if (display) {
                const categoryNames = {
                    'title': 'üèÜ Menu Title',
                    'category': 'üìÇ Category',
                    'dish': 'üçΩÔ∏è Dish Name',
                    'price': 'üí∞ Price', 
                    'description': 'üìù Description',
                    'ignore': '‚ùå Ignore'
                };
                
                const colorScheme = getCategoryColorRGB(category);
                display.innerHTML = `
                    <span class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300" 
                          style="background: ${colorScheme.accent}; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                        ${categoryNames[category] || category}
                        <span class="animate-bounce">‚ú®</span>
                    </span>
                `;
            }
            
            // Update tooltips for all text lines
            updateTooltips();
        }
        
        function selectLine(lineIndex, element, event) {
            if (!window.activeCategory) {
                showTooltip(element, 'Please select a category first!', 'warning');
                return;
            }
            
            // Handle multi-select with Ctrl/Cmd
            window.multiSelectMode = event && (event.ctrlKey || event.metaKey);
            
            const lineText = element.getAttribute('data-text') || element.textContent.trim();
            if (!lineText) return;
            
            // Store selection in history for undo
            window.selectionHistory.push({
                action: 'select',
                category: window.activeCategory,
                lineIndex: lineIndex,
                text: lineText,
                timestamp: Date.now()
            });
            
            // Initialize category if needed
            if (!window.selectedItems[window.activeCategory]) {
                window.selectedItems[window.activeCategory] = [];
            }
            
            // Check if line already categorized
            const existingCategory = Object.keys(window.selectedItems).find(cat => 
                window.selectedItems[cat].some(item => item.lineIndex === lineIndex)
            );
            
            if (existingCategory && existingCategory !== window.activeCategory) {
                // Remove from previous category
                window.selectedItems[existingCategory] = window.selectedItems[existingCategory]
                    .filter(item => item.lineIndex !== lineIndex);
                
                showTooltip(element, `Moved from ${existingCategory} to ${window.activeCategory}`, 'info');
            } else if (existingCategory === window.activeCategory) {
                // Already in this category, show feedback
                showTooltip(element, `Already categorized as ${window.activeCategory}`, 'info');
                return;
            } else {
                showTooltip(element, `Categorized as ${window.activeCategory}`, 'success');
            }
            
            // Add to current category
            if (!window.selectedItems[window.activeCategory].some(item => item.lineIndex === lineIndex)) {
                window.selectedItems[window.activeCategory].push({
                    lineIndex: lineIndex,
                    text: lineText,
                    element: element
                });
            }
            
            // Update visual styling and stats
            updateLineStyling();
            updateSelectionCount();
            updateSelectionStats();
            
            // Auto-advance category for quick selection (optional)
            if (!window.multiSelectMode && window.activeCategory) {
                setTimeout(() => updateTooltips(), 100);
            }
        }
        
        function deselectLine(lineIndex, element, event) {
            event.preventDefault(); // Prevent context menu
            
            // Find which category this line belongs to
            const category = Object.keys(window.selectedItems).find(cat => 
                window.selectedItems[cat].some(item => item.lineIndex === lineIndex)
            );
            
            if (category) {
                // Store in history for undo
                const item = window.selectedItems[category].find(item => item.lineIndex === lineIndex);
                if (item) {
                    window.selectionHistory.push({
                        action: 'deselect',
                        category: category,
                        lineIndex: lineIndex,
                        text: item.text,
                        timestamp: Date.now()
                    });
                }
                
                // Remove from category
                window.selectedItems[category] = window.selectedItems[category]
                    .filter(item => item.lineIndex !== lineIndex);
                
                showTooltip(element, `Removed from ${category}`, 'info');
                
                // Update visual styling and stats
                updateLineStyling();
                updateSelectionCount();
                updateSelectionStats();
            } else {
                showTooltip(element, 'Not categorized', 'warning');
            }
        }
        
        function selectByPattern(type) {
            if (!window.activeCategory) {
                alert('Please select a category first!');
                return;
            }
            
            const lines = document.querySelectorAll('.text-line');
            let selected = 0;
            
            lines.forEach((element, index) => {
                const text = element.getAttribute('data-text') || element.textContent.trim();
                if (!text) return;
                
                let shouldSelect = false;
                
                switch (type) {
                    case 'title':
                        // Look for likely titles: short, no prices, capitalized
                        shouldSelect = text.length < 50 && 
                                     !hasPrice(text) && 
                                     (text === text.toUpperCase() || isCapitalized(text)) &&
                                     !text.includes('...');
                        break;
                        
                    case 'category':
                        // Look for likely categories: short, all caps or title case, no prices
                        shouldSelect = text.length < 30 && 
                                     !hasPrice(text) && 
                                     (text === text.toUpperCase() || isCapitalized(text)) &&
                                     !text.includes('.') &&
                                     text.split(' ').length <= 3;
                        break;
                        
                    case 'price':
                        // Look for lines with prices
                        shouldSelect = hasPrice(text);
                        break;
                }
                
                if (shouldSelect) {
                    const lineIndex = parseInt(element.getAttribute('data-line'));
                    selectLine(lineIndex, element, { ctrlKey: true }); // Simulate multi-select
                    selected++;
                }
            });
            
            showNotification(`Selected ${selected} lines as ${window.activeCategory}`, 'success');
        }
        
        function clearAllSelections() {
            if (Object.keys(window.selectedItems).length === 0) {
                showNotification('No selections to clear', 'info');
                return;
            }
            
            // Store in history for undo
            window.selectionHistory.push({
                action: 'clear_all',
                items: JSON.parse(JSON.stringify(window.selectedItems)),
                timestamp: Date.now()
            });
            
            window.selectedItems = {};
            updateLineStyling();
            updateSelectionCount();
            updateSelectionStats();
            
            showNotification('All selections cleared', 'info');
        }
        
        function undoLastSelection() {
            if (window.selectionHistory.length === 0) {
                showNotification('Nothing to undo', 'warning');
                return;
            }
            
            const lastAction = window.selectionHistory.pop();
            
            switch (lastAction.action) {
                case 'select':
                    // Remove the selection
                    if (window.selectedItems[lastAction.category]) {
                        window.selectedItems[lastAction.category] = window.selectedItems[lastAction.category]
                            .filter(item => item.lineIndex !== lastAction.lineIndex);
                    }
                    showNotification(`Undid selection of "${lastAction.text}"`, 'info');
                    break;
                    
                case 'deselect':
                    // Re-add the selection
                    if (!window.selectedItems[lastAction.category]) {
                        window.selectedItems[lastAction.category] = [];
                    }
                    const element = document.querySelector(`[data-line="${lastAction.lineIndex}"]`);
                    if (element) {
                        window.selectedItems[lastAction.category].push({
                            lineIndex: lastAction.lineIndex,
                            text: lastAction.text,
                            element: element
                        });
                    }
                    showNotification(`Undid deselection of "${lastAction.text}"`, 'info');
                    break;
                    
                case 'clear_all':
                    // Restore all selections
                    window.selectedItems = lastAction.items;
                    showNotification('Undid clear all selections', 'info');
                    break;
            }
            
            updateLineStyling();
            updateSelectionCount();
            updateSelectionStats();
        }
        
        function updateLineStyling() {
            // Reset all lines to default styling and remove badges
            document.querySelectorAll('.text-line').forEach(line => {
                line.className = 'text-line cursor-pointer hover:bg-gray-100 p-2 rounded border-l-2 border-transparent transition-all duration-300';
                line.style.background = '';
                line.style.borderLeft = '';
                line.style.color = '';
                line.style.transform = '';
                line.style.boxShadow = '';
                
                // Remove existing badges
                const existingBadge = line.querySelector('.category-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            });
            
            // Apply enhanced multi-color styling
            Object.keys(window.selectedItems).forEach(category => {
                const colorScheme = getCategoryColorRGB(category);
                window.selectedItems[category].forEach(item => {
                    if (item.element) {
                        // Apply rich color styling with gradients
                        item.element.className = 'text-line cursor-pointer p-3 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg';
                        item.element.style.background = colorScheme.bg;
                        item.element.style.borderLeft = `4px solid ${colorScheme.border}`;
                        item.element.style.color = colorScheme.text;
                        item.element.style.transform = 'translateX(6px)';
                        item.element.style.boxShadow = `0 2px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.5)`;
                        
                        // Add enhanced category badge with gradient
                        const badge = document.createElement('span');
                        badge.className = 'category-badge inline-flex items-center gap-1 px-3 py-1 text-xs rounded-full ml-3 font-semibold transition-all duration-300';
                        badge.style.background = colorScheme.accent;
                        badge.style.color = 'white';
                        badge.style.boxShadow = `0 2px 4px rgba(0,0,0,0.2)`;
                        badge.style.transform = 'scale(0.95)';
                        
                        // Add category icon and text
                        const categoryIcons = {
                            'title': 'üèÜ',
                            'category': 'üìÇ',
                            'dish': 'üçΩÔ∏è',
                            'price': 'üí∞',
                            'description': 'üìù',
                            'ignore': '‚ùå'
                        };
                        
                        badge.innerHTML = `
                            <span class="text-sm">${categoryIcons[category] || 'üìã'}</span>
                            <span>${category.toUpperCase()}</span>
                        `;
                        
                        item.element.appendChild(badge);
                        
                        // Add subtle animation on hover
                        item.element.addEventListener('mouseenter', function() {
                            this.style.transform = 'translateX(8px) scale(1.02)';
                            badge.style.transform = 'scale(1)';
                        });
                        
                        item.element.addEventListener('mouseleave', function() {
                            this.style.transform = 'translateX(6px)';
                            badge.style.transform = 'scale(0.95)';
                        });
                    }
                });
            });
        }
        
        function updateSelectionStats() {
            const stats = document.getElementById('selection-stats');
            if (!stats) return;
            
            const categories = Object.keys(window.selectedItems);
            if (categories.length === 0) {
                stats.textContent = '';
                return;
            }
            
            const breakdown = categories.map(cat => 
                `${cat}: ${window.selectedItems[cat].length}`
            ).join(', ');
            
            stats.textContent = `(${breakdown})`;
        }
        
        function showTooltip(element, message, type = 'info') {
            // Remove existing tooltips
            document.querySelectorAll('.selection-tooltip').forEach(t => t.remove());
            
            const tooltip = document.createElement('div');
            tooltip.className = `selection-tooltip absolute z-50 px-2 py-1 text-xs rounded shadow-lg pointer-events-none`;
            
            switch (type) {
                case 'success':
                    tooltip.className += ' bg-green-600 text-white';
                    break;
                case 'warning':
                    tooltip.className += ' bg-yellow-600 text-white';
                    break;
                case 'error':
                    tooltip.className += ' bg-red-600 text-white';
                    break;
                default:
                    tooltip.className += ' bg-blue-600 text-white';
            }
            
            tooltip.textContent = message;
            
            // Position relative to element
            const rect = element.getBoundingClientRect();
            tooltip.style.top = (rect.top - 30) + 'px';
            tooltip.style.left = rect.left + 'px';
            
            document.body.appendChild(tooltip);
            
            // Auto-remove after 2 seconds
            setTimeout(() => tooltip.remove(), 2000);
        }
        
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.selection-notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `selection-notification fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300`;
            
            switch (type) {
                case 'success':
                    notification.className += ' bg-green-600 text-white';
                    break;
                case 'warning':
                    notification.className += ' bg-yellow-600 text-white';
                    break;
                case 'error':
                    notification.className += ' bg-red-600 text-white';
                    break;
                default:
                    notification.className += ' bg-blue-600 text-white';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Slide in animation
            setTimeout(() => notification.style.transform = 'translateX(0)', 10);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function hasPrice(text) {
            // Look for various price patterns
            const pricePatterns = [
                /\$\d+(?:\.\d{2})?/,     // $10, $10.50
                /\d+(?:\.\d{2})?\s*\$/,  // 10$, 10.50 $
                /‚Ç¨\d+(?:\.\d{2})?/,      // ‚Ç¨10, ‚Ç¨10.50
                /¬£\d+(?:\.\d{2})?/,      // ¬£10, ¬£10.50
                /\d+(?:\.\d{2})?(?:\s*‚Ç¨|\s*¬£)/,  // 10 ‚Ç¨, 10.50 ¬£
                /\d+,\d{2}/,             // 10,50 (European format)
                /\d+\.\d{2}(?!\d)/       // 10.50 (standalone decimal)
            ];
            
            return pricePatterns.some(pattern => pattern.test(text));
        }
        
        function isCapitalized(text) {
            // Check if text is title case or properly capitalized
            const words = text.split(' ');
            return words.every(word => {
                if (word.length === 0) return true;
                return word[0] === word[0].toUpperCase();
            });
        }
        
        function updateTooltips() {
            // Update tooltip titles for all text lines
            document.querySelectorAll('.text-line').forEach(element => {
                if (window.activeCategory) {
                    element.title = `Click to categorize as: ${window.activeCategory}`;
                } else {
                    element.title = 'Select a category first';
                }
            });
        }
        
        function getCategoryColor(category) {
            const colors = {
                'title': 'indigo',      // Deep purple-blue for titles
                'category': 'emerald',   // Rich green for categories  
                'dish': 'amber',        // Warm orange-yellow for dishes
                'price': 'rose',        // Pink-red for prices
                'description': 'violet', // Purple for descriptions
                'ignore': 'slate'       // Gray for ignored items
            };
            return colors[category] || 'slate';
        }
        
        function getCategoryColorRGB(category) {
            const colorRGB = {
                'title': { 
                    bg: 'rgb(238, 242, 255)', 
                    border: 'rgb(99, 102, 241)', 
                    text: 'rgb(67, 56, 202)',
                    accent: 'linear-gradient(135deg, rgb(99, 102, 241), rgb(139, 92, 246))'
                },
                'category': { 
                    bg: 'rgb(236, 253, 245)', 
                    border: 'rgb(16, 185, 129)', 
                    text: 'rgb(5, 150, 105)',
                    accent: 'linear-gradient(135deg, rgb(16, 185, 129), rgb(34, 197, 94))'
                },
                'dish': { 
                    bg: 'rgb(255, 251, 235)', 
                    border: 'rgb(245, 158, 11)', 
                    text: 'rgb(217, 119, 6)',
                    accent: 'linear-gradient(135deg, rgb(245, 158, 11), rgb(251, 191, 36))'
                },
                'price': { 
                    bg: 'rgb(255, 241, 242)', 
                    border: 'rgb(244, 63, 94)', 
                    text: 'rgb(225, 29, 72)',
                    accent: 'linear-gradient(135deg, rgb(244, 63, 94), rgb(251, 113, 133))'
                },
                'description': { 
                    bg: 'rgb(245, 243, 255)', 
                    border: 'rgb(139, 92, 246)', 
                    text: 'rgb(124, 58, 237)',
                    accent: 'linear-gradient(135deg, rgb(139, 92, 246), rgb(167, 139, 250))'
                },
                'ignore': { 
                    bg: 'rgb(248, 250, 252)', 
                    border: 'rgb(100, 116, 139)', 
                    text: 'rgb(71, 85, 105)',
                    accent: 'linear-gradient(135deg, rgb(100, 116, 139), rgb(148, 163, 184))'
                }
            };
            return colorRGB[category] || colorRGB['ignore'];
        }
        
        function updateSelectionCount() {
            const totalSelections = Object.values(window.selectedItems || {})
                .reduce((sum, items) => sum + items.length, 0);
            
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `${totalSelections} items categorized`;
            }
            
            // Enable/disable build button
            const buildBtn = document.getElementById('build-menu-btn');
            if (buildBtn) {
                buildBtn.disabled = totalSelections === 0;
                buildBtn.className = totalSelections > 0 
                    ? 'sticky-btn px-4 py-2' 
                    : 'sticky-btn px-4 py-2 opacity-50 cursor-not-allowed';
            }
        }
        
        function previewMenuStructure() {
            if (!window.selectedItems || Object.keys(window.selectedItems).length === 0) {
                showNotification('No items selected yet. Please categorize some text first.', 'warning');
                return;
            }
            
            // Calculate structure stats
            const totalSelections = Object.values(window.selectedItems).reduce((sum, items) => sum + items.length, 0);
            const hasTitle = window.selectedItems.title && window.selectedItems.title.length > 0;
            const hasCategories = window.selectedItems.category && window.selectedItems.category.length > 0;
            const hasDishes = window.selectedItems.dish && window.selectedItems.dish.length > 0;
            const hasPrices = window.selectedItems.price && window.selectedItems.price.length > 0;
            
            const preview = document.createElement('div');
            preview.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            preview.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl max-h-[80vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">üëÄ Menu Structure Preview</h3>
                        <div class="text-sm text-gray-600">
                            ${totalSelections} items categorized
                        </div>
                    </div>
                    
                    <!-- Structure Quality Assessment -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2">üìä Structure Assessment</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="flex items-center">
                                <span class="${hasTitle ? 'text-green-600' : 'text-gray-400'}">${hasTitle ? '‚úÖ' : '‚ö™'}</span>
                                <span class="ml-2">Menu Title</span>
                            </div>
                            <div class="flex items-center">
                                <span class="${hasCategories ? 'text-green-600' : 'text-yellow-600'}">${hasCategories ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                <span class="ml-2">Categories</span>
                            </div>
                            <div class="flex items-center">
                                <span class="${hasDishes ? 'text-green-600' : 'text-red-600'}">${hasDishes ? '‚úÖ' : '‚ùå'}</span>
                                <span class="ml-2">Dish Names</span>
                            </div>
                            <div class="flex items-center">
                                <span class="${hasPrices ? 'text-green-600' : 'text-gray-400'}">${hasPrices ? '‚úÖ' : '‚ö™'}</span>
                                <span class="ml-2">Prices</span>
                            </div>
                        </div>
                        ${!hasDishes ? '<div class="mt-2 text-sm text-red-600">‚ö†Ô∏è No dish names selected - menu will be incomplete</div>' : ''}
                    </div>
                    
                    <!-- Categorized Content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${Object.keys(window.selectedItems).map(category => `
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-${getCategoryColor(category)}-600 capitalize mb-3 flex items-center">
                                    <span class="w-3 h-3 bg-${getCategoryColor(category)}-400 rounded-full mr-2"></span>
                                    ${category} (${window.selectedItems[category].length})
                                </h4>
                                <div class="max-h-40 overflow-y-auto">
                                    ${window.selectedItems[category].map((item, index) => 
                                        `<div class="mb-2 p-2 bg-${getCategoryColor(category)}-50 rounded text-sm border-l-2 border-${getCategoryColor(category)}-300">
                                            <span class="text-gray-500 text-xs">${index + 1}.</span> ${item.text}
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Actions -->
                    <div class="mt-6 flex justify-between items-center pt-4 border-t">
                        <div class="text-sm text-gray-600">
                            ${hasDishes ? 'Ready to build menu structure' : 'Please select some dish names before building'}
                        </div>
                        <div class="flex gap-2">
                            <button class="px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-50" onclick="this.closest('.fixed').remove()">
                                Close Preview
                            </button>
                            <button class="sticky-btn px-4 py-2 ${!hasDishes ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    onclick="this.closest('.fixed').remove(); ${hasDishes ? 'buildMenuFromSelections()' : ''}"
                                    ${!hasDishes ? 'disabled' : ''}>
                                üèóÔ∏è Build Menu Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(preview);
            
            // Add click outside to close
            preview.addEventListener('click', (e) => {
                if (e.target === preview) {
                    preview.remove();
                }
            });
        }
        
        function buildMenuFromSelections() {
            if (!window.selectedItems || Object.keys(window.selectedItems).length === 0) {
                alert('No items selected. Please categorize some text first.');
                return;
            }
            
            // Convert selections to menu structure
            populateMenuBuilder(window.selectedItems);
            
            // Show project context in build section
            if (window.currentProject) {
                const projectContext = document.getElementById('project-context');
                const buildProjectName = document.getElementById('build-project-name');
                const buildRestaurantName = document.getElementById('build-restaurant-name');
                
                if (projectContext && buildProjectName && buildRestaurantName) {
                    buildProjectName.textContent = window.currentProject.name;
                    buildRestaurantName.textContent = window.currentProject.restaurant;
                    projectContext.style.display = 'block';
                }
            }
            
            // Hide the upload section and show success
            const result = document.getElementById('document-extract-result');
            result.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-green-600 text-4xl mb-4">‚úÖ</div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Menu Built Successfully!</h3>
                    <p class="text-gray-600 mb-4">Your selections have been converted into menu sections below. You can now edit, add items, or print your menu.</p>
                    <button class="sticky-btn px-4 py-2" onclick="location.reload()">
                        üìÑ Upload Another Menu
                    </button>
                </div>
            `;
            
            // Scroll to menu sections
            const menuSections = document.getElementById('menu-sections');
            if (menuSections) {
                menuSections.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function buildMenuFromParsed(menuStructure) {
            // Convert parsed structure to menu builder format
            const convertedSelections = {
                title: menuStructure.title ? [{ text: menuStructure.title }] : [],
                category: [],
                dish: [],
                price: [],
                description: []
            };
            
            menuStructure.categories.forEach(category => {
                convertedSelections.category.push({ text: category.name });
                
                category.items.forEach(item => {
                    if (item.name) convertedSelections.dish.push({ text: item.name });
                    if (item.price) convertedSelections.price.push({ text: item.price });
                    if (item.description) convertedSelections.description.push({ text: item.description });
                });
            });
            
            populateMenuBuilder(convertedSelections);
            
            // Show project context in build section
            if (window.currentProject) {
                const projectContext = document.getElementById('project-context');
                const buildProjectName = document.getElementById('build-project-name');
                const buildRestaurantName = document.getElementById('build-restaurant-name');
                
                if (projectContext && buildProjectName && buildRestaurantName) {
                    buildProjectName.textContent = window.currentProject.name;
                    buildRestaurantName.textContent = window.currentProject.restaurant;
                    projectContext.style.display = 'block';
                }
            }
            
            // Show success message
            const result = document.getElementById('document-extract-result');
            result.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-green-600 text-4xl mb-4">ü§ñ‚úÖ</div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Auto-Parse Complete!</h3>
                    <p class="text-gray-600 mb-4">Menu structure automatically detected and built. You can now edit sections and items below.</p>
                    <button class="sticky-btn px-4 py-2" onclick="location.reload()">
                        üìÑ Upload Another Menu
                    </button>
                </div>
            `;
            
            // Scroll to menu sections
            const menuSections = document.getElementById('menu-sections');
            if (menuSections) {
                menuSections.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function populateMenuBuilder(selections) {
            // Clear existing menu sections
            const container = document.getElementById('menu-sections');
            container.innerHTML = '';
            
            // Add menu title if available
            if (selections.title && selections.title.length > 0) {
                const titleInput = document.getElementById('menu-title');
                if (titleInput) {
                    titleInput.value = selections.title[0].text;
                }
            }
            
            // Group dishes by categories
            const categories = selections.category || [];
            const dishes = selections.dish || [];
            const prices = selections.price || [];
            const descriptions = selections.description || [];
            
            if (categories.length === 0 && dishes.length > 0) {
                // No categories detected, create a default section
                addMenuSectionWithItems('Menu Items', dishes, prices, descriptions);
            } else {
                // Create sections based on detected categories
                categories.forEach((category, index) => {
                    const categoryName = category.text;
                    // For now, distribute dishes evenly across categories
                    // In a more sophisticated version, we'd match dishes to categories contextually
                    const dishesPerCategory = Math.ceil(dishes.length / categories.length);
                    const startIndex = index * dishesPerCategory;
                    const endIndex = startIndex + dishesPerCategory;
                    
                    const categoryDishes = dishes.slice(startIndex, endIndex);
                    const categoryPrices = prices.slice(startIndex, endIndex);
                    const categoryDescriptions = descriptions.slice(startIndex, endIndex);
                    
                    addMenuSectionWithItems(categoryName, categoryDishes, categoryPrices, categoryDescriptions);
                });
            }
        }
        
        // Legacy PDF extraction function (for backward compatibility)
        function extractPDF() {
            // Redirect to the new function
            extractMenuDocument();
        }

        // Menu section and item management
        function addMenuSection() {
            const container = document.getElementById('menu-sections');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'notebook-card p-4 mb-4';
            sectionDiv.innerHTML = `
                <input type="text" class="notebook-input mb-2 w-full" placeholder="Section Name (e.g., Starters)">
                <div class="menu-items"></div>
                <button class="sticky-btn px-3 py-1" onclick="addMenuItem(this)">+ Add Menu Item</button>
            `;
            container.appendChild(sectionDiv);
        }

        function addMenuItem(btn) {
            const itemsDiv = btn.parentElement.querySelector('.menu-items');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex flex-col md:flex-row md:items-center gap-2 mb-2';
            itemDiv.innerHTML = `
                <input type="text" class="notebook-input flex-1" placeholder="Item Name">
                <input type="text" class="notebook-input flex-1" placeholder="Description">
                <input type="text" class="notebook-input w-24" placeholder="Price (optional)">
                <input type="text" class="notebook-input flex-1" placeholder="Staff Description">
                <input type="text" class="notebook-input flex-1" placeholder="Allergies">
                <input type="text" class="notebook-input flex-1" placeholder="Modifiers/Substitutions">
                <button class="sticky-btn px-2 py-1" onclick="this.parentElement.remove()">Remove</button>
            `;
            itemsDiv.appendChild(itemDiv);
        }

        function addMenuSectionWithItems(sectionName, dishes, prices, descriptions) {
            const container = document.getElementById('menu-sections');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'notebook-card p-4 mb-4';
            
            // Create section with pre-filled name
            sectionDiv.innerHTML = `
                <input type="text" class="notebook-input mb-2 w-full" placeholder="Section Name (e.g., Starters)" value="${sectionName}">
                <div class="menu-items"></div>
                <button class="sticky-btn px-3 py-1" onclick="addMenuItem(this)">+ Add Menu Item</button>
            `;
            
            container.appendChild(sectionDiv);
            
            // Add items to the section
            const itemsDiv = sectionDiv.querySelector('.menu-items');
            const maxItems = Math.max(dishes.length, prices.length, descriptions.length);
            
            for (let i = 0; i < maxItems; i++) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex flex-col md:flex-row md:items-center gap-2 mb-2';
                
                const dishName = dishes[i]?.text || '';
                const price = prices[i]?.text || '';
                const description = descriptions[i]?.text || '';
                
                itemDiv.innerHTML = `
                    <input type="text" class="notebook-input flex-1" placeholder="Item Name" value="${dishName}">
                    <input type="text" class="notebook-input flex-1" placeholder="Description" value="${description}">
                    <input type="text" class="notebook-input w-24" placeholder="Price (optional)" value="${price}">
                    <input type="text" class="notebook-input flex-1" placeholder="Staff Description">
                    <input type="text" class="notebook-input flex-1" placeholder="Allergies">
                    <input type="text" class="notebook-input flex-1" placeholder="Modifiers/Substitutions">
                    <button class="sticky-btn px-2 py-1" onclick="this.parentElement.remove()">Remove</button>
                `;
                
                itemsDiv.appendChild(itemDiv);
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('current-user');
            if (!userInfo) return;
            const username = localStorage.getItem('username');
            userInfo.textContent = username ? username : 'Guest';
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfo();
            
            // Set up paste menu modal event listeners
            const closeModalBtn = document.getElementById('close-paste-menu-modal');
            const cancelBtn = document.getElementById('cancel-paste-menu');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            const tryAgainBtn = document.getElementById('try-again-btn');
            
            if (closeModalBtn) closeModalBtn.addEventListener('click', hidePasteMenuModal);
            if (cancelBtn) cancelBtn.addEventListener('click', hidePasteMenuModal);
            
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function() {
                    const previewSection = document.getElementById('preview-section');
                    const extractBtn = document.getElementById('extract-menu-btn');
                    const previewBtn = document.getElementById('preview-menu-btn');
                    
                    if (previewSection) previewSection.style.display = 'none';
                    if (extractBtn) extractBtn.style.display = 'none';
                    if (previewBtn) previewBtn.style.display = 'block';
                });
            }
            
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    const text = document.getElementById('paste-menu-text').value;
                    if (!text.trim()) {
                        alert('Please paste some menu text first.');
                        return;
                    }
                    
                    const sections = parseMenuText(text);
                    showPreview(sections);
                });
            }
            
            if (extractBtn) {
                extractBtn.addEventListener('click', function() {
                    const text = document.getElementById('paste-menu-text').value;
                    if (!text.trim()) {
                        alert('Please paste some menu text first.');
                        return;
                    }
                    
                    const sections = parseMenuText(text);
                    populateMenuSections(sections);
                    hidePasteMenuModal();
                    
                    // Switch to the build section
                    showSection('build');
                });
            }
        });

        function showPreview(sections) {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            
            if (!previewSection || !previewContent) return;
            
            let previewHTML = '';
            
            if (sections.length === 0) {
                previewHTML = '<p class="text-red-600">‚ùå No menu sections detected. Please check your text format.</p>';
            } else {
                sections.forEach((section, index) => {
                    previewHTML += `<div class="mb-4 p-3 bg-white border border-gray-300 rounded">`;
                    previewHTML += `<h5 class="font-semibold text-blue-600 mb-2">üìã ${section.name}</h5>`;
                    
                    if (section.items.length === 0) {
                        previewHTML += '<p class="text-gray-500 italic">No items detected in this section</p>';
                    } else {
                        previewHTML += '<ul class="space-y-1">';
                        section.items.forEach(item => {
                            previewHTML += '<li class="text-sm">';
                            previewHTML += `<span class="font-medium">${item.name}</span>`;
                            if (item.description) {
                                previewHTML += `<span class="text-gray-600"> - ${item.description}</span>`;
                            }
                            if (item.price) {
                                previewHTML += `<span class="text-green-600 font-medium"> (${item.price})</span>`;
                            }
                            previewHTML += '</li>';
                        });
                        previewHTML += '</ul>';
                    }
                    previewHTML += '</div>';
                });
                
                previewHTML += `<p class="text-sm text-gray-600 mt-3">‚úÖ Found ${sections.length} section(s) with ${sections.reduce((total, s) => total + s.items.length, 0)} total items</p>`;
            }
            
            previewContent.innerHTML = previewHTML;
            previewSection.style.display = 'block';
            extractBtn.style.display = 'block';
            previewBtn.style.display = 'none';
        }

        function populateMenuSections(sections) {
            const menuSections = document.getElementById('menu-sections');
            if (!menuSections) return;
            
            menuSections.innerHTML = '';
            
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'notebook-card p-4 mb-4';
                sectionDiv.innerHTML = `
                    <input type="text" class="notebook-input mb-2 w-full" placeholder="Section Name (e.g., Starters)" value="${section.name}">
                    <div class="menu-items"></div>
                    <button class="sticky-btn px-3 py-1" onclick="addMenuItem(this)">+ Add Menu Item</button>
                `;
                
                const itemsDiv = sectionDiv.querySelector('.menu-items');
                section.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex flex-col md:flex-row md:items-center gap-2 mb-2';
                    itemDiv.innerHTML = `
                        <input type="text" class="notebook-input flex-1" placeholder="Item Name" value="${item.name}">
                        <input type="text" class="notebook-input flex-1" placeholder="Description" value="${item.description}">
                        <input type="text" class="notebook-input w-24" placeholder="Price (optional)" value="${item.price}">
                        <input type="text" class="notebook-input flex-1" placeholder="Staff Description">
                        <input type="text" class="notebook-input flex-1" placeholder="Allergies">
                        <input type="text" class="notebook-input flex-1" placeholder="Modifiers/Substitutions">
                        <button class="sticky-btn px-2 py-1" onclick="this.parentElement.remove()">Remove</button>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
                
                menuSections.appendChild(sectionDiv);
            });
        }

        // Project and Restaurant Management
        function initializeProjectSelection() {
            console.log('Initializing project selection...');
            loadSavedRestaurants();
            loadSavedProjects();
            
            // Initial button state check
            setTimeout(() => {
                console.log('Running initial checkContinueButton after initialization');
                checkContinueButton();
            }, 200);
        }
        
        function loadSavedRestaurants() {
            const restaurants = JSON.parse(localStorage.getItem('iterum_restaurants') || '[]');
            const select = document.getElementById('restaurant-select');
            if (!select) return;
            
            // Store original options
            const defaultOptions = ['<option value="">Select Restaurant...</option>', '<option value="new">+ Add New Restaurant</option>'];
            
            // Clear and rebuild
            select.innerHTML = defaultOptions.join('');
            
            // Add saved restaurants
            restaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                select.appendChild(option);
            });
        }
        
        function loadSavedProjects() {
            const projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            const select = document.getElementById('project-select');
            if (!select) return;
            
            // Store original options  
            const defaultOptions = ['<option value="">Select Project...</option>', '<option value="new">+ Create New Project</option>'];
            
            // Clear and rebuild
            select.innerHTML = defaultOptions.join('');
            
            // Add saved projects
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.restaurant})`;
                select.appendChild(option);
            });
        }
        
        function handleRestaurantChange() {
            const select = document.getElementById('restaurant-select');
            const newInput = document.getElementById('new-restaurant-input');
            
            if (select.value === 'new') {
                newInput.classList.remove('hidden');
                newInput.focus();
            } else {
                newInput.classList.add('hidden');
                updateProjectOptions();
                checkContinueButton();
            }
        }
        
        function handleProjectChange() {
            const select = document.getElementById('project-select');
            const newInput = document.getElementById('new-project-input');
            
            if (select.value === 'new') {
                newInput.classList.remove('hidden');
                newInput.focus();
            } else {
                newInput.classList.add('hidden');
                if (select.value) {
                    showProjectInfo();
                }
                checkContinueButton();
            }
        }
        
        function saveNewRestaurant() {
            const input = document.getElementById('new-restaurant-input');
            const select = document.getElementById('restaurant-select');
            const restaurantName = input.value.trim();
            
            if (!restaurantName) {
                select.value = '';
                input.classList.add('hidden');
                return;
            }
            
            const restaurants = JSON.parse(localStorage.getItem('iterum_restaurants') || '[]');
            const newRestaurant = {
                id: 'restaurant_' + Date.now(),
                name: restaurantName,
                createdAt: new Date().toISOString()
            };
            
            restaurants.push(newRestaurant);
            localStorage.setItem('iterum_restaurants', JSON.stringify(restaurants));
            
            loadSavedRestaurants();
            select.value = newRestaurant.id;
            
            input.value = '';
            input.classList.add('hidden');
            
            updateProjectOptions();
            
            // Force check after a brief delay to ensure DOM is updated
            setTimeout(() => {
                checkContinueButton();
            }, 100);
            
            if (window.showNotification) {
                showNotification(`Restaurant "${restaurantName}" added successfully!`, 'success');
            }
        }
        
        function saveNewProject() {
            const input = document.getElementById('new-project-input');
            const select = document.getElementById('project-select');
            const restaurantSelect = document.getElementById('restaurant-select');
            const projectName = input.value.trim();
            
            if (!projectName) {
                select.value = '';
                input.classList.add('hidden');
                return;
            }
            
            if (!restaurantSelect.value) {
                if (window.showNotification) {
                    showNotification('Please select a restaurant first!', 'warning');
                } else {
                    alert('Please select a restaurant first!');
                }
                input.classList.add('hidden');
                select.value = '';
                return;
            }
            
            const restaurants = JSON.parse(localStorage.getItem('iterum_restaurants') || '[]');
            const restaurant = restaurants.find(r => r.id === restaurantSelect.value);
            const restaurantName = restaurant ? restaurant.name : 'Unknown';
            
            const projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            const newProject = {
                id: 'project_' + Date.now(),
                name: projectName,
                restaurant: restaurantName,
                restaurantId: restaurantSelect.value,
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            projects.push(newProject);
            localStorage.setItem('iterum_projects', JSON.stringify(projects));
            
            loadSavedProjects();
            select.value = newProject.id;
            
            input.value = '';
            input.classList.add('hidden');
            
            showProjectInfo();
            
            // Force check after a brief delay to ensure DOM is updated
            setTimeout(() => {
                checkContinueButton();
            }, 100);
            
            if (window.showNotification) {
                showNotification(`Project "${projectName}" created successfully!`, 'success');
            }
        }
        
        function updateProjectOptions() {
            const restaurantSelect = document.getElementById('restaurant-select');
            const projectSelect = document.getElementById('project-select');
            
            if (!restaurantSelect.value) return;
            
            const projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            const restaurantProjects = projects.filter(p => p.restaurantId === restaurantSelect.value);
            
            projectSelect.innerHTML = `
                <option value="">Select Project...</option>
                <option value="new">+ Create New Project</option>
            `;
            
            restaurantProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });
        }
        
        function showProjectInfo() {
            const projectSelect = document.getElementById('project-select');
            const projectInfo = document.getElementById('project-info');
            const projectDisplay = document.getElementById('current-project-display');
            const projectDetails = document.getElementById('project-details');
            const projectDate = document.getElementById('project-date');
            
            if (!projectSelect.value) {
                projectInfo.classList.add('hidden');
                return;
            }
            
            const projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            const project = projects.find(p => p.id === projectSelect.value);
            
            if (project) {
                projectDisplay.textContent = project.name;
                projectDetails.textContent = `Restaurant: ${project.restaurant}`;
                projectDate.textContent = `Created: ${new Date(project.createdAt).toLocaleDateString()}`;
                projectInfo.classList.remove('hidden');
                
                window.currentProject = project;
            }
        }
        
        function checkContinueButton() {
            const restaurantSelect = document.getElementById('restaurant-select');
            const projectSelect = document.getElementById('project-select');
            const continueBtn = document.getElementById('continue-to-upload');
            
            // Add null checks
            if (!restaurantSelect || !projectSelect || !continueBtn) {
                console.log('checkContinueButton: Missing elements', {
                    restaurantSelect: !!restaurantSelect,
                    projectSelect: !!projectSelect,
                    continueBtn: !!continueBtn
                });
                return;
            }
            
            const hasRestaurant = restaurantSelect.value && restaurantSelect.value !== 'new';
            const hasProject = projectSelect.value && projectSelect.value !== 'new';
            
            console.log('checkContinueButton:', {
                hasRestaurant,
                hasProject,
                restaurantValue: restaurantSelect.value,
                projectValue: projectSelect.value
            });
            
            continueBtn.disabled = !(hasRestaurant && hasProject);
            
            // Update button appearance
            if (hasRestaurant && hasProject) {
                continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.add('hover:scale-105');
            } else {
                continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
                continueBtn.classList.remove('hover:scale-105');
            }
        }
        
        function continueToUpload() {
            console.log('continueToUpload() called');
            
            const uploadContent = document.getElementById('upload-content');
            const continueBtn = document.getElementById('continue-to-upload');
            
            console.log('Elements found:', {
                uploadContent: !!uploadContent,
                continueBtn: !!continueBtn
            });
            
            if (!uploadContent) {
                console.error('upload-content element not found!');
                alert('Error: Upload content section not found. Please refresh the page.');
                return;
            }
            
            if (!continueBtn) {
                console.error('continue-to-upload button not found!');
                return;
            }
            
            // Show the upload content
            uploadContent.classList.remove('hidden');
            console.log('Removed hidden class from upload-content');
            
            // Update button
            continueBtn.textContent = '‚úÖ Project Selected';
            continueBtn.disabled = true;
            
            // Scroll to upload section
            setTimeout(() => {
                uploadContent.scrollIntoView({ behavior: 'smooth' });
                console.log('Scrolled to upload content');
            }, 100);
            
            // Show notification
            if (window.showNotification) {
                showNotification('Project selected! You can now upload your menu.', 'success');
            } else {
                console.log('Success: Project selected! You can now upload your menu.');
            }
        }
        
        function showRestaurantModal() {
            const restaurants = JSON.parse(localStorage.getItem('iterum_restaurants') || '[]');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4">üè¢ Manage Restaurants</h3>
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Saved Restaurants (${restaurants.length})</h4>
                        <div class="max-h-40 overflow-y-auto">
                            ${restaurants.length === 0 ? 
                                '<p class="text-gray-500 text-sm">No restaurants saved yet.</p>' :
                                restaurants.map(restaurant => `
                                    <div class="flex justify-between items-center p-2 border rounded mb-2">
                                        <div>
                                            <span class="font-medium">${restaurant.name}</span>
                                            <div class="text-xs text-gray-500">Created: ${new Date(restaurant.createdAt).toLocaleDateString()}</div>
                                        </div>
                                        <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteRestaurant('${restaurant.id}'); this.closest('.fixed').remove();">Delete</button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-50" onclick="this.closest('.fixed').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        function showProjectModal() {
            const projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
                    <h3 class="text-lg font-semibold mb-4">üìÅ Manage Projects</h3>
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Saved Projects (${projects.length})</h4>
                        <div class="max-h-60 overflow-y-auto">
                            ${projects.length === 0 ? 
                                '<p class="text-gray-500 text-sm">No projects saved yet.</p>' :
                                projects.map(project => `
                                    <div class="flex justify-between items-center p-3 border rounded mb-2">
                                        <div>
                                            <span class="font-medium">${project.name}</span>
                                            <div class="text-sm text-gray-600">${project.restaurant}</div>
                                            <div class="text-xs text-gray-500">Created: ${new Date(project.createdAt).toLocaleDateString()}</div>
                                        </div>
                                        <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteProject('${project.id}'); this.closest('.fixed').remove();">Delete</button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-50" onclick="this.closest('.fixed').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        function deleteRestaurant(restaurantId) {
            if (!confirm('Are you sure you want to delete this restaurant? This will also delete all associated projects.')) {
                return;
            }
            
            let restaurants = JSON.parse(localStorage.getItem('iterum_restaurants') || '[]');
            restaurants = restaurants.filter(r => r.id !== restaurantId);
            localStorage.setItem('iterum_restaurants', JSON.stringify(restaurants));
            
            let projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            projects = projects.filter(p => p.restaurantId !== restaurantId);
            localStorage.setItem('iterum_projects', JSON.stringify(projects));
            
            loadSavedRestaurants();
            loadSavedProjects();
            
            if (window.showNotification) {
                showNotification('Restaurant and associated projects deleted.', 'info');
            }
        }
        
        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) {
                return;
            }
            
            let projects = JSON.parse(localStorage.getItem('iterum_projects') || '[]');
            projects = projects.filter(p => p.id !== projectId);
            localStorage.setItem('iterum_projects', JSON.stringify(projects));
            
            loadSavedProjects();
            
            if (window.showNotification) {
                showNotification('Project deleted.', 'info');
            }
        }

        // Test function to debug button state
        function testContinueButton() {
            console.log('=== Testing Continue Button ===');
            const restaurantSelect = document.getElementById('restaurant-select');
            const projectSelect = document.getElementById('project-select');
            const continueBtn = document.getElementById('continue-to-upload');
            
            console.log('Elements found:', {
                restaurantSelect: !!restaurantSelect,
                projectSelect: !!projectSelect,
                continueBtn: !!continueBtn
            });
            
            if (restaurantSelect) {
                console.log('Restaurant options:', Array.from(restaurantSelect.options).map(opt => ({ value: opt.value, text: opt.text })));
                console.log('Selected restaurant:', restaurantSelect.value);
            }
            
            if (projectSelect) {
                console.log('Project options:', Array.from(projectSelect.options).map(opt => ({ value: opt.value, text: opt.text })));
                console.log('Selected project:', projectSelect.value);
            }
            
            if (continueBtn) {
                console.log('Button state:', {
                    disabled: continueBtn.disabled,
                    text: continueBtn.textContent,
                    classes: continueBtn.className
                });
            }
            
            // Force a check
            checkContinueButton();
        }
        
        // Make test function globally available
        window.testContinueButton = testContinueButton;

        // Initialize project selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfo();
            initializeProjectSelection();
            
            // Initial button state check
            setTimeout(() => {
                checkContinueButton();
            }, 500);
        });
    </script>
    <script src="userDataManager.js"></script>
    
    <!-- Modern Dark Loading Styles -->
    <style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1.2); }
    }

    /* Enhanced Multi-Color Parsing Animation Styles */
    @keyframes colorPulse {
        0%, 100% { 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: scale(1.02);
        }
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    @keyframes bounceIn {
        0% { 
            opacity: 0; 
            transform: scale(0.3) translateY(-20px); 
        }
        50% { 
            opacity: 0.8; 
            transform: scale(1.05) translateY(-5px); 
        }
        70% { 
            opacity: 1; 
            transform: scale(0.95) translateY(0); 
        }
        100% { 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
    }

    /* Category Button Hover Effects */
    .category-btn:hover {
        animation: colorPulse 1.5s infinite;
    }

    .smart-tool-btn:hover {
        background-size: 200% 200% !important;
        animation: shimmer 2s infinite linear;
    }

    /* Selected Line Animation */
    .text-line.selected {
        animation: bounceIn 0.6s ease-out;
    }

    /* Color Legend Hover Effects */
    .color-legend-item:hover .color-swatch {
        transform: scale(1.2) rotate(5deg);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Enhanced Header Animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Header Logo Hover Glow */
    header .relative:hover .absolute {
        animation: pulse 2s infinite;
    }

    /* Navigation Active State */
    nav a[class*="bg-green-100"] {
        position: relative;
        overflow: hidden;
    }

    nav a[class*="bg-green-100"]::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }

    nav a[class*="bg-green-100"]:hover::before {
        left: 100%;
    }

    /* Navigation Active State - Current Page Highlighting */
    .nav-active {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important;
        color: #15803d !important;
        font-weight: 600 !important;
        border: 1px solid #86efac !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        position: relative;
        overflow: hidden;
    }

    .nav-active::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }

    .nav-active:hover::before {
        left: 100%;
    }

    #loading-overlay.fade-out {
        opacity: 0;
        pointer-events: none;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        #loading-overlay div[style*="width:80px"] {
            width: 60px !important;
            height: 60px !important;
        }
        #loading-overlay div[style*="font-size:1.1rem"] {
            font-size: 1rem !important;
        }
        #loading-overlay div[style*="font-size:0.9rem"] {
            font-size: 0.8rem !important;
        }
    }
    </style>
    
    <svg class="pea-bg-sketch" viewBox="0 0 120 180" fill="none" style="">
      <path d="M60 160 Q60 120 60 80" stroke="#7bb661" stroke-width="3" fill="none" stroke-linecap="round"/>
      <ellipse cx="60" cy="80" rx="22" ry="9" fill="#b6e388" stroke="#7bb661" stroke-width="2"/>
      <ellipse cx="52" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="60" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="68" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q40 110 50 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="48" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q80 110 70 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="72" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
    </svg>
</body>
</html> 