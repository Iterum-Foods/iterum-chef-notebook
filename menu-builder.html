<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Builder | Iterum R&D Chef Notebook</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        body {
            background: repeating-linear-gradient(
                to bottom,
                #f6fbe7 0px,
                #f6fbe7 38px,
                #eafcd7 39px,
                #f6fbe7 40px
            ), url('data:image/svg+xml;utf8,<svg width="180" height="180" xmlns="http://www.w3.org/2000/svg"><g opacity="0.13"><path d="M60 140 Q90 80 120 140" stroke="%237bb661" stroke-width="2.5" fill="none"/><ellipse cx="90" cy="140" rx="22" ry="9" fill="%23b6e388" stroke="%237bb661" stroke-width="1.5"/><ellipse cx="80" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><ellipse cx="90" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><ellipse cx="100" cy="140" rx="4" ry="4" fill="%23eafcd7" stroke="%237bb661" stroke-width="1"/><path d="M90 140 Q95 120 110 110 Q125 100 140 120" stroke="%237bb661" stroke-width="1.2" fill="none"/><ellipse cx="140" cy="120" rx="4" ry="2.5" fill="%23b6e388" stroke="%237bb661" stroke-width="1"/></g></svg>');
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            position: relative;
        }
        .pea-bg-sketch {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 0;
            opacity: 0.11;
            pointer-events: none;
            width: 480px;
            max-width: 90vw;
            height: auto;
        }
        .notebook-card {
            background: #fffbe7;
            border-radius: 1.2rem;
            box-shadow: 0 2px 12px 0 rgba(44, 62, 80, 0.08);
            border: 1.5px solid #e2d8b8;
            margin-bottom: 2rem;
        }
        .notebook-heading {
            font-family: 'Shadows Into Light', cursive;
            font-size: 2.1rem;
            color: #2a365d;
            margin-bottom: 0.5rem;
        }
        .sticky-btn {
            background: linear-gradient(90deg, #f7c873 0%, #fffbe7 100%);
            color: #2a365d;
            border-radius: 9999px;
            font-weight: 700;
            box-shadow: 0 2px 8px 0 rgba(44, 62, 80, 0.08);
            transition: background 0.2s;
        }
        .sticky-btn:hover {
            background: linear-gradient(90deg, #fffbe7 0%, #f7c873 100%);
        }
        @media print {
            .no-print { display: none !important; }
            .print-section { display: block !important; }
        }
        .menu-builder-container {
            width: 95vw;
            max-width: 1400px;
            margin: 32px auto 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            box-shadow: 0 4px 32px 0 rgba(0,0,0,0.08);
            padding: 32px 36px 36px 36px;
            min-height: 80vh;
            transition: box-shadow 0.2s;
        }
        @media (max-width: 900px) {
            .menu-builder-container {
                width: 99vw;
                max-width: 100vw;
                padding: 12px 2vw;
            }
        }
        @media (max-width: 600px) {
            .menu-builder-container {
                padding: 4px 0.5vw;
                border-radius: 0;
            }
        }
        .menu-stepper, .menu-section, .menu-card, .menu-table {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
    <div class="flex items-center gap-2">
      <img src="iterum.ico" alt="Iterum Logo" class="h-8 w-8">
      <span class="font-bold text-xl tracking-tight">Iterum R&D Chef Notebook</span>
    </div>
    <nav class="hidden md:flex gap-6 text-gray-700 font-medium">
      <a href="index.html" class="hover:text-green-600">Dashboard</a>
      <a href="recipe-library.html" class="hover:text-green-600">Recipe Library</a>
      <a href="recipe-upload.html" class="hover:text-green-600">Recipe Uploader</a>
      <a href="menu-builder.html" class="hover:text-green-600">Menu Builder</a>
      <a href="ingredients.html" class="hover:text-green-600">Ingredients</a>
      <a href="equipment-management.html" class="hover:text-green-600">Equipment</a>
      <a href="vendor-management.html" class="hover:text-green-600">Vendors</a>
    </nav>
    <div class="flex items-center gap-4">
      <span id="current-user" class="text-gray-600 text-sm"></span>
      <button id="login-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded hidden">Login</button>
      <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded hidden">Logout</button>
      <button id="nav-toggle" class="md:hidden text-2xl text-gray-700 focus:outline-none">&#9776;</button>
    </div>
  </div>
  <nav id="mobile-nav" class="md:hidden bg-white border-t border-gray-200 hidden flex-col gap-2 px-4 pb-4">
    <a href="index.html" class="block py-2 hover:text-green-600">Dashboard</a>
    <a href="recipe-library.html" class="block py-2 hover:text-green-600">Recipe Library</a>
    <a href="recipe-upload.html" class="block py-2 hover:text-green-600">Recipe Uploader</a>
    <a href="menu-builder.html" class="block py-2 hover:text-green-600">Menu Builder</a>
    <a href="ingredients.html" class="block py-2 hover:text-green-600">Ingredients</a>
    <a href="equipment-management.html" class="block py-2 hover:text-green-600">Equipment</a>
    <a href="vendor-management.html" class="block py-2 hover:text-green-600">Vendors</a>
  </nav>
</header>
    <main class="max-w-5xl mx-auto py-8 px-2 md:px-0">
        <div class="notebook-card p-6">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-8 mb-6">
                <div class="notebook-heading">Menu Builder</div>
                <div class="flex-1"></div>
                <div class="flex space-x-2">
                    <button class="sticky-btn px-4 py-2 no-print" onclick="window.print()">Print/Export PDF</button>
                </div>
            </div>
            <!-- Stepper Navigation -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="sticky-btn px-4 py-2" onclick="showSection('upload')">1. Upload PDF</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('build')">2. Menu Build</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('staff')">3. Staff Sheet</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('plate')">4. Plate Build</button>
                <button class="sticky-btn px-4 py-2" onclick="showSection('recipes')">5. Recipe List</button>
            </div>
            <!-- Sections -->
            <section id="section-upload" class="menu-section">
                <h2 class="notebook-heading">1. Upload PDF Menu</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- PDF Upload -->
                    <div class="notebook-card p-4">
                        <h3 class="text-lg font-semibold mb-3">📄 PDF Upload</h3>
                        <input type="file" accept="application/pdf" class="mb-4 w-full" id="pdf-upload">
                        <button class="sticky-btn px-4 py-2 mb-2" onclick="extractPDF()">Extract Text (OCR)</button>
                        <div id="pdf-extract-result" class="mt-2 text-sm text-gray-700"></div>
                    </div>
                    
                    <!-- Paste Menu Text -->
                    <div class="notebook-card p-4">
                        <h3 class="text-lg font-semibold mb-3">📋 Paste Menu Text</h3>
                        <p class="text-sm text-gray-600 mb-3">Paste your menu text from any source (Word, website, etc.)</p>
                        <button class="sticky-btn px-4 py-2 mb-3" onclick="showPasteMenuModal()">📋 Paste Menu Text</button>
                        <div class="text-xs text-gray-500">
                            <p>• Copy menu text from any source</p>
                            <p>• Paste into the text area</p>
                            <p>• Auto-detect menu sections</p>
                            <p>• Generate structured menu</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="section-build" class="menu-section hidden">
                <h2 class="notebook-heading">2. Menu Build</h2>
                <input type="text" class="notebook-input mb-2" placeholder="Menu Name">
                <textarea class="notebook-textarea mb-2" placeholder="Menu Description"></textarea>
                <!-- Menu sections and items will be dynamically added here -->
                <div id="menu-sections"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="addMenuSection()">+ Add Section</button>
            </section>
            <section id="section-staff" class="menu-section hidden">
                <h2 class="notebook-heading">3. Staff Sheet</h2>
                <div class="mb-2 text-gray-700">Export a staff version with staff notes, modifiers, substitutions, and allergy info.</div>
                <div id="staff-sheet"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
            <section id="section-plate" class="menu-section hidden">
                <h2 class="notebook-heading">4. Plate Build Sheet</h2>
                <div class="mb-2 text-gray-700">For each menu item, list all components, quantities, and descriptions for the kitchen.</div>
                <div id="plate-build-list">
                    <table class="w-full border border-gray-300 rounded-lg mb-4">
                        <thead>
                            <tr class="bg-yellow-100">
                                <th class="p-2 border-b">Component/Prep Item</th>
                                <th class="p-2 border-b">Quantity</th>
                                <th class="p-2 border-b">Description/Notes</th>
                                <th class="p-2 border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plate-build-body">
                            <!-- Plate build rows will be dynamically added here -->
                        </tbody>
                    </table>
                    <button class="sticky-btn px-4 py-2" onclick="addPlateBuildRow()">+ Add Component</button>
                </div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
            <section id="section-recipes" class="menu-section hidden">
                <h2 class="notebook-heading">5. Recipe List</h2>
                <div class="mb-2 text-gray-700">All recipes needed for this menu. Add new or link to existing.</div>
                <div id="recipe-list"></div>
                <button class="sticky-btn px-4 py-2 mt-2" onclick="window.print()">Print/Export PDF</button>
            </section>
        </div>
    </main>
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(120deg,#eafcd7 0%,#b6e388 100%);display:flex;align-items:center;justify-content:center;transition:opacity 0.7s;">
      <div style="display:flex;flex-direction:column;align-items:center;">
        <svg class="pea-plant-anim" viewBox="0 0 120 180" fill="none">
          <path id="stem" d="M60 160 Q60 120 60 80" stroke="#7bb661" stroke-width="3" fill="none" stroke-linecap="round"/>
          <ellipse id="pod" cx="60" cy="80" rx="22" ry="9" fill="#b6e388" stroke="#7bb661" stroke-width="2" opacity="0"/>
          <ellipse id="pea1" cx="52" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1" opacity="0"/>
          <ellipse id="pea2" cx="60" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1" opacity="0"/>
          <ellipse id="pea3" cx="68" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1" opacity="0"/>
          <path id="leafL" d="M60 120 Q40 110 50 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round" opacity="0"/>
          <ellipse id="leafL2" cx="48" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1" opacity="0"/>
          <path id="leafR" d="M60 120 Q80 110 70 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round" opacity="0"/>
          <ellipse id="leafR2" cx="72" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1" opacity="0"/>
        </svg>
        <div class="loading-text" style="font-family:'Shadows Into Light',cursive;color:#3a5a40;font-size:1.3rem;margin-top:1.2rem;text-align:center;letter-spacing:0.03em;">Loading Iterum R&D Chef Notebook…</div>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white text-center">
          <div class="text-3xl mb-2">👨‍🍳</div>
          <h2 class="text-2xl font-bold">Welcome to Iterum</h2>
          <p class="text-blue-100">Your Culinary Research & Development Notebook</p>
        </div>
        <!-- Login Form -->
        <div id="login-form-container" class="p-6">
          <form id="login-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="login-email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Enter your email">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <div class="relative">
                <input type="password" id="login-password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12" placeholder="Enter your password">
                <button type="button" id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">👁️</button>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="flex items-center">
                <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-600">Remember me</span>
              </label>
              <button type="button" id="forgot-password-btn" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</button>
            </div>
            <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
            <button type="submit" id="login-submit-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all">
              <span id="login-btn-text">Sign In</span>
              <div id="login-spinner" class="hidden inline-block ml-2">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              </div>
            </button>
          </form>
          <div class="mt-6 text-center">
            <p class="text-gray-600">Don't have an account?</p>
            <button type="button" id="show-signup-btn" class="text-blue-600 hover:text-blue-800 font-semibold">Create Account</button>
          </div>
          <div class="mt-6 pt-6 border-t border-gray-200">
            <button type="button" id="continue-offline-btn" class="w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-200 transition-all">🚀 Continue Offline (Local Profile)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Paste Menu Modal -->
    <div id="paste-menu-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">📋 Paste Menu Text</h3>
                <button id="close-paste-menu-modal" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Menu Text</label>
                    <textarea id="paste-menu-text" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                              placeholder="Paste your menu text here...

Example:
STARTERS
Bruschetta - Toasted bread with tomatoes, basil, and garlic
Caprese Salad - Fresh mozzarella, tomatoes, and basil

MAIN COURSES
Grilled Salmon - Atlantic salmon with seasonal vegetables
Beef Tenderloin - 8oz tenderloin with mashed potatoes

DESSERTS
Tiramisu - Classic Italian dessert
Chocolate Lava Cake - Warm chocolate cake with vanilla ice cream"></textarea>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">💡 Tips for best results:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• <strong>Section Headers:</strong> Use ALL CAPS or Title Case (STARTERS, Main Courses, etc.)</li>
                        <li>• <strong>Dish Format:</strong> "Dish Name - Description" or "Dish Name: Description"</li>
                        <li>• <strong>Prices:</strong> Include with $, €, £ symbols or "dollars/euros"</li>
                        <li>• <strong>Separate Lines:</strong> Put each dish on its own line for best parsing</li>
                        <li>• <strong>Flexible Format:</strong> Works with most menu formats automatically</li>
                    </ul>
                </div>
                
                <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2">✅ Supported Formats:</h4>
                    <div class="text-sm text-green-700 space-y-1">
                        <p><strong>Section Detection:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>• STARTERS, APPETIZERS, MAIN COURSES</li>
                            <li>• Starters, Appetizers, Main Courses</li>
                            <li>• 1. Starters, 2. Main Courses</li>
                            <li>• Chef's Specials, Daily Specials</li>
                        </ul>
                        <p class="mt-2"><strong>Price Detection:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>• $12, $12.99, 12$, 12.99$</li>
                            <li>• €12, €12.99, 12€, 12.99€</li>
                            <li>• £12, £12.99, 12£, 12.99£</li>
                            <li>• 12 dollars, 12.99 euros</li>
                        </ul>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button id="preview-menu-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-semibold">
                        👁️ Preview Extraction
                    </button>
                    <button id="extract-menu-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold" style="display: none;">
                        🚀 Generate Menu Structure
                    </button>
                    <button id="cancel-paste-menu" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg">
                        Cancel
                    </button>
                </div>
                
                <!-- Preview Section -->
                <div id="preview-section" class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-800">📋 Preview of Extracted Menu:</h4>
                        <button id="try-again-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            🔄 Try Again
                        </button>
                    </div>
                    <div id="preview-content" class="text-sm text-gray-700 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="unified_auth_system.js"></script>
<script src="debug_auth_buttons.js"></script>
    <script src="standardize-login-modals.js"></script>
    <script>
        // Section navigation
        function showSection(section) {
            document.querySelectorAll('.menu-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');
        }

        // Paste Menu Modal Functions
        function showPasteMenuModal() {
            const modal = document.getElementById('paste-menu-modal');
            modal.classList.remove('hidden');
            document.getElementById('paste-menu-text').focus();
        }

        function hidePasteMenuModal() {
            const modal = document.getElementById('paste-menu-modal');
            modal.classList.add('hidden');
            document.getElementById('paste-menu-text').value = '';
            
            // Reset preview
            const previewSection = document.getElementById('preview-section');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            
            if (previewSection) previewSection.style.display = 'none';
            if (extractBtn) extractBtn.style.display = 'none';
            if (previewBtn) previewBtn.style.display = 'block';
        }

        // Enhanced menu text parsing with improved intelligence
        function parseMenuText(text) {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
            const sections = [];
            let currentSection = null;
            
            // Enhanced section keywords with variations
            const sectionKeywords = [
                // Starters & Appetizers
                'starters', 'appetizers', 'appetiser', 'appetisers', 'first course', 'first courses',
                'hors d\'oeuvres', 'hors d\'oeuvre', 'small plates', 'tapas', 'canapés', 'canapes',
                
                // Main Courses
                'main course', 'main courses', 'mains', 'entrées', 'entrees', 'entrée', 'entree',
                'main dishes', 'main dish', 'primary dishes', 'primary course',
                
                // Desserts & Sweets
                'desserts', 'dessert', 'sweets', 'sweet', 'pastries', 'pastry', 'cakes', 'cake',
                'ice cream', 'gelato', 'sorbet', 'pudding', 'puddings',
                
                // Beverages
                'beverages', 'beverage', 'drinks', 'drink', 'cocktails', 'cocktail', 'wine', 'wines',
                'beer', 'beers', 'spirits', 'spirit', 'coffee', 'tea', 'juice', 'juices',
                
                // Other Categories
                'soup', 'soups', 'salad', 'salads', 'sides', 'side dishes', 'side dish',
                'breakfast', 'lunch', 'dinner', 'brunch', 'specials', 'daily specials',
                'chef\'s specials', 'chef specials', 'seasonal', 'seasonal dishes',
                'vegetarian', 'vegan', 'gluten free', 'dairy free', 'allergen free'
            ];
            
            // Enhanced section detection patterns
            const sectionPatterns = [
                /^[A-Z\s&]+$/, // ALL CAPS sections
                /^[A-Z][a-z\s&]+$/, // Title Case sections
                /^[A-Z][a-z\s&]+:$/, // Title Case with colon
                /^[A-Z\s&]+:$/, // ALL CAPS with colon
                /^\d+\.\s*[A-Z][a-z\s&]+$/, // Numbered sections
                /^[A-Z][a-z\s&]+\s*[-–—]\s*[A-Z][a-z\s&]+$/ // Sections with separators
            ];
            
            lines.forEach((line, index) => {
                const lowerLine = line.toLowerCase();
                
                // Check if this line is a section header
                const isSectionHeader = sectionKeywords.some(keyword => 
                    lowerLine.includes(keyword) || 
                    lowerLine === keyword ||
                    lowerLine.startsWith(keyword + ' ') ||
                    lowerLine.endsWith(' ' + keyword)
                ) || sectionPatterns.some(pattern => pattern.test(line));
                
                // Additional section detection logic
                const isLikelySection = 
                    line.length > 2 && line.length < 60 && // Reasonable length
                    !line.includes('$') && !line.includes('€') && !line.includes('£') && // No currency
                    !/\d+\.\d+/.test(line) && // No decimal prices
                    !line.includes('oz') && !line.includes('g') && !line.includes('ml') && // No measurements
                    (line.match(/[A-Z]/g) || []).length > (line.match(/[a-z]/g) || []).length * 0.3; // Mostly caps
                
                if (isSectionHeader || isLikelySection) {
                    // Clean up section name
                    let sectionName = line.replace(/^[\d\.\s]+/, '').replace(/[:\.\s]+$/, '');
                    
                    // If it's a numbered section, extract just the name
                    if (/^\d+\./.test(line)) {
                        sectionName = line.replace(/^\d+\.\s*/, '');
                    }
                    
                    currentSection = { 
                        name: sectionName, 
                        items: [] 
                    };
                    sections.push(currentSection);
                } else if (currentSection && line.length > 0) {
                    // Parse menu item with enhanced logic
                    const item = parseMenuItem(line);
                    if (item.name && item.name.length > 0) {
                        currentSection.items.push(item);
                    }
                } else if (!currentSection && line.length > 0) {
                    // If no section detected yet, create a default section
                    if (!sections.length) {
                        currentSection = { name: 'Menu Items', items: [] };
                        sections.push(currentSection);
                    }
                    const item = parseMenuItem(line);
                    if (item.name && item.name.length > 0) {
                        currentSection.items.push(item);
                    }
                }
            });
            
            // Post-process sections to clean up and merge similar ones
            return postProcessSections(sections);
        }

        function parseMenuItem(line) {
            // Enhanced price extraction patterns
            const pricePatterns = [
                /\$(\d+\.?\d*)/, // $12, $12.99
                /(\d+\.?\d*)\s*\$/, // 12$, 12.99$
                /€(\d+\.?\d*)/, // €12, €12.99
                /(\d+\.?\d*)\s*€/, // 12€, 12.99€
                /£(\d+\.?\d*)/, // £12, £12.99
                /(\d+\.?\d*)\s*£/, // 12£, 12.99£
                /(\d+\.?\d*)\s*(?:dollars?|euros?|pounds?)/i, // 12 dollars, 12.99 euros
                /(\d+\.?\d*)\s*(?:USD|EUR|GBP)/i // 12 USD, 12.99 EUR
            ];
            
            let price = '';
            let description = line;
            
            // Find and extract price
            for (const pattern of pricePatterns) {
                const match = line.match(pattern);
                if (match) {
                    price = match[1] || match[0];
                    description = line.replace(match[0], '').trim();
                    break;
                }
            }
            
            // Enhanced item parsing with multiple separators
            const separators = [
                /[-–—]\s*/, // Dash, en-dash, em-dash
                /\s*[-–—]\s*/, // Dash with spaces
                /\s*:\s*/, // Colon
                /\s*–\s*/, // En dash
                /\s*—\s*/, // Em dash
                /\s*\.\s*/, // Period
                /\s*,\s*/, // Comma
                /\s*\|\s*/, // Pipe
                /\s*\/\s*/ // Forward slash
            ];
            
            let name = description;
            let itemDescription = '';
            
            // Try to split on separators
            for (const separator of separators) {
                const parts = description.split(separator);
                if (parts.length > 1 && parts[0].trim().length > 0) {
                    name = parts[0].trim();
                    itemDescription = parts.slice(1).join(' - ').trim();
                    break;
                }
            }
            
            // Clean up name and description
            name = name.replace(/^[\d\.\s]+/, '').trim(); // Remove leading numbers/dots
            itemDescription = itemDescription.replace(/^[\d\.\s]+/, '').trim();
            
            // If no description found, check if the whole line is just a name
            if (!itemDescription && name.length > 0) {
                // Check if the line looks like a complete item name
                if (name.length < 100 && !name.includes('$') && !name.includes('€') && !name.includes('£')) {
                    // This might be a standalone item name
                } else {
                    // This might be a description, not a name
                    itemDescription = name;
                    name = '';
                }
            }
            
            return {
                name: name || 'Untitled Item',
                description: itemDescription,
                price: price
            };
        }

        function postProcessSections(sections) {
            // Merge similar sections
            const mergedSections = [];
            const sectionMap = new Map();
            
            sections.forEach(section => {
                const key = section.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (sectionMap.has(key)) {
                    // Merge with existing section
                    sectionMap.get(key).items.push(...section.items);
                } else {
                    sectionMap.set(key, { ...section });
                    mergedSections.push(sectionMap.get(key));
                }
            });
            
            // Clean up section names
            mergedSections.forEach(section => {
                // Remove common prefixes/suffixes
                section.name = section.name
                    .replace(/^(menu|our|the)\s+/i, '')
                    .replace(/\s+(menu|section|items?)$/i, '')
                    .trim();
                
                // Capitalize properly
                section.name = section.name.replace(/\b\w/g, l => l.toUpperCase());
            });
            
            // Remove empty sections
            return mergedSections.filter(section => section.items.length > 0);
        }

        // Plate Build logic
        function addPlateBuildRow() {
            const tbody = document.getElementById('plate-build-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Component/Prep Item"></td>
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Quantity"></td>
                <td class="p-2 border-b"><input type="text" class="notebook-input w-full" placeholder="Description/Notes"></td>
                <td class="p-2 border-b"><button onclick="this.closest('tr').remove()" class="sticky-btn px-2 py-1">Remove</button></td>
            `;
            tbody.appendChild(row);
        }

        // Add first row by default
        if(document.getElementById('plate-build-body')) addPlateBuildRow();

        // PDF extraction
        function extractPDF() {
            const fileInput = document.getElementById('pdf-upload');
            const result = document.getElementById('pdf-extract-result');
            result.textContent = '';
            if (!fileInput.files || !fileInput.files[0]) {
                result.textContent = 'Please select a PDF file first.';
                return;
            }
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            result.textContent = 'Uploading and extracting text...';
            fetch('/api/menu/upload-pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.text) {
                    result.textContent = data.text;
                } else if (data.detail) {
                    result.textContent = 'Error: ' + data.detail;
                } else {
                    result.textContent = 'Unknown error.';
                }
            })
            .catch(err => {
                result.textContent = 'Upload failed: ' + err;
            });
        }

        // Menu section and item management
        function addMenuSection() {
            const container = document.getElementById('menu-sections');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'notebook-card p-4 mb-4';
            sectionDiv.innerHTML = `
                <input type="text" class="notebook-input mb-2 w-full" placeholder="Section Name (e.g., Starters)">
                <div class="menu-items"></div>
                <button class="sticky-btn px-3 py-1" onclick="addMenuItem(this)">+ Add Menu Item</button>
            `;
            container.appendChild(sectionDiv);
        }

        function addMenuItem(btn) {
            const itemsDiv = btn.parentElement.querySelector('.menu-items');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex flex-col md:flex-row md:items-center gap-2 mb-2';
            itemDiv.innerHTML = `
                <input type="text" class="notebook-input flex-1" placeholder="Item Name">
                <input type="text" class="notebook-input flex-1" placeholder="Description">
                <input type="text" class="notebook-input w-24" placeholder="Price (optional)">
                <input type="text" class="notebook-input flex-1" placeholder="Staff Description">
                <input type="text" class="notebook-input flex-1" placeholder="Allergies">
                <input type="text" class="notebook-input flex-1" placeholder="Modifiers/Substitutions">
                <button class="sticky-btn px-2 py-1" onclick="this.parentElement.remove()">Remove</button>
            `;
            itemsDiv.appendChild(itemDiv);
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('current-user');
            if (!userInfo) return;
            const username = localStorage.getItem('username');
            userInfo.textContent = username ? username : 'Guest';
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfo();
            
            // Set up paste menu modal event listeners
            const closeModalBtn = document.getElementById('close-paste-menu-modal');
            const cancelBtn = document.getElementById('cancel-paste-menu');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            const tryAgainBtn = document.getElementById('try-again-btn');
            
            if (closeModalBtn) closeModalBtn.addEventListener('click', hidePasteMenuModal);
            if (cancelBtn) cancelBtn.addEventListener('click', hidePasteMenuModal);
            
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function() {
                    const previewSection = document.getElementById('preview-section');
                    const extractBtn = document.getElementById('extract-menu-btn');
                    const previewBtn = document.getElementById('preview-menu-btn');
                    
                    if (previewSection) previewSection.style.display = 'none';
                    if (extractBtn) extractBtn.style.display = 'none';
                    if (previewBtn) previewBtn.style.display = 'block';
                });
            }
            
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    const text = document.getElementById('paste-menu-text').value;
                    if (!text.trim()) {
                        alert('Please paste some menu text first.');
                        return;
                    }
                    
                    const sections = parseMenuText(text);
                    showPreview(sections);
                });
            }
            
            if (extractBtn) {
                extractBtn.addEventListener('click', function() {
                    const text = document.getElementById('paste-menu-text').value;
                    if (!text.trim()) {
                        alert('Please paste some menu text first.');
                        return;
                    }
                    
                    const sections = parseMenuText(text);
                    populateMenuSections(sections);
                    hidePasteMenuModal();
                    
                    // Switch to the build section
                    showSection('build');
                });
            }
        });

        function showPreview(sections) {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            const extractBtn = document.getElementById('extract-menu-btn');
            const previewBtn = document.getElementById('preview-menu-btn');
            
            if (!previewSection || !previewContent) return;
            
            let previewHTML = '';
            
            if (sections.length === 0) {
                previewHTML = '<p class="text-red-600">❌ No menu sections detected. Please check your text format.</p>';
            } else {
                sections.forEach((section, index) => {
                    previewHTML += `<div class="mb-4 p-3 bg-white border border-gray-300 rounded">`;
                    previewHTML += `<h5 class="font-semibold text-blue-600 mb-2">📋 ${section.name}</h5>`;
                    
                    if (section.items.length === 0) {
                        previewHTML += '<p class="text-gray-500 italic">No items detected in this section</p>';
                    } else {
                        previewHTML += '<ul class="space-y-1">';
                        section.items.forEach(item => {
                            previewHTML += '<li class="text-sm">';
                            previewHTML += `<span class="font-medium">${item.name}</span>`;
                            if (item.description) {
                                previewHTML += `<span class="text-gray-600"> - ${item.description}</span>`;
                            }
                            if (item.price) {
                                previewHTML += `<span class="text-green-600 font-medium"> (${item.price})</span>`;
                            }
                            previewHTML += '</li>';
                        });
                        previewHTML += '</ul>';
                    }
                    previewHTML += '</div>';
                });
                
                previewHTML += `<p class="text-sm text-gray-600 mt-3">✅ Found ${sections.length} section(s) with ${sections.reduce((total, s) => total + s.items.length, 0)} total items</p>`;
            }
            
            previewContent.innerHTML = previewHTML;
            previewSection.style.display = 'block';
            extractBtn.style.display = 'block';
            previewBtn.style.display = 'none';
        }

        function populateMenuSections(sections) {
            const menuSections = document.getElementById('menu-sections');
            if (!menuSections) return;
            
            menuSections.innerHTML = '';
            
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'notebook-card p-4 mb-4';
                sectionDiv.innerHTML = `
                    <input type="text" class="notebook-input mb-2 w-full" placeholder="Section Name (e.g., Starters)" value="${section.name}">
                    <div class="menu-items"></div>
                    <button class="sticky-btn px-3 py-1" onclick="addMenuItem(this)">+ Add Menu Item</button>
                `;
                
                const itemsDiv = sectionDiv.querySelector('.menu-items');
                section.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex flex-col md:flex-row md:items-center gap-2 mb-2';
                    itemDiv.innerHTML = `
                        <input type="text" class="notebook-input flex-1" placeholder="Item Name" value="${item.name}">
                        <input type="text" class="notebook-input flex-1" placeholder="Description" value="${item.description}">
                        <input type="text" class="notebook-input w-24" placeholder="Price (optional)" value="${item.price}">
                        <input type="text" class="notebook-input flex-1" placeholder="Staff Description">
                        <input type="text" class="notebook-input flex-1" placeholder="Allergies">
                        <input type="text" class="notebook-input flex-1" placeholder="Modifiers/Substitutions">
                        <button class="sticky-btn px-2 py-1" onclick="this.parentElement.remove()">Remove</button>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
                
                menuSections.appendChild(sectionDiv);
            });
        }
    </script>
    <script src="userDataManager.js"></script>
    <svg class="pea-bg-sketch" viewBox="0 0 120 180" fill="none" style="">
      <path d="M60 160 Q60 120 60 80" stroke="#7bb661" stroke-width="3" fill="none" stroke-linecap="round"/>
      <ellipse cx="60" cy="80" rx="22" ry="9" fill="#b6e388" stroke="#7bb661" stroke-width="2"/>
      <ellipse cx="52" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="60" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="68" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q40 110 50 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="48" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q80 110 70 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="72" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
    </svg>
</body>
</html> 