{% extends "base.html" %}

{% block title %}Scrape Recipes from Web - Enhanced Recipe Manager{% endblock %}
{% block page_title %}Scrape Recipes from Websites{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 1rem;">
            <div class="card-body p-4">
                <h4 class="mb-4">
                    <i class="bi bi-globe me-2 text-success"></i>
                    Scrape Recipes from Websites
                </h4>
                <p class="text-muted mb-4">
                    Extract recipes from recipe websites and automatically import them into your library. 
                    Supports Schema.org Recipe markup, microdata, and common HTML patterns.
                </p>
                
                <div class="alert alert-info mb-4">
                    <h6><i class="bi bi-info-circle me-2"></i>Supported Formats:</h6>
                    <ul class="mb-0">
                        <li>Schema.org JSON-LD Recipe markup (most reliable)</li>
                        <li>Schema.org microdata</li>
                        <li>Common HTML recipe patterns</li>
                        <li>Works with most major recipe websites</li>
                    </ul>
                </div>
                
                <!-- Single URL Input -->
                <div class="mb-4">
                    <label for="recipeUrl" class="form-label">
                        <strong>Recipe URL</strong>
                    </label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="recipeUrl" 
                               placeholder="https://example.com/recipe/pasta-carbonara" 
                               required>
                        <button type="button" class="btn btn-success" id="scrapeSingleBtn">
                            <i class="bi bi-download me-2"></i>
                            Scrape Recipe
                        </button>
                    </div>
                </div>
                
                <!-- Multiple URLs Input -->
                <div class="mb-4">
                    <label for="recipeUrls" class="form-label">
                        <strong>Multiple URLs (one per line)</strong>
                    </label>
                    <textarea class="form-control" id="recipeUrls" rows="5" 
                              placeholder="https://example.com/recipe1&#10;https://example.com/recipe2&#10;https://example.com/recipe3"></textarea>
                    <button type="button" class="btn btn-success mt-2 w-100" id="scrapeMultipleBtn">
                        <i class="bi bi-download me-2"></i>
                        Scrape All Recipes
                    </button>
                </div>
                
                <div id="scrapeProgress" class="mt-4" style="display: none;">
                    <div class="alert alert-info d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <strong>Scraping recipe...</strong>
                            <div class="small" id="scrapeStatus">Processing...</div>
                        </div>
                    </div>
                </div>
                
                <div id="scrapeResults" class="mt-4" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Examples -->
        <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
            <div class="card-body p-4">
                <h5 class="mb-3">
                    <i class="bi bi-lightbulb me-2"></i>
                    Example Recipe Sites
                </h5>
                <p class="text-muted small mb-2">These sites typically work well:</p>
                <ul class="small mb-0">
                    <li>AllRecipes.com</li>
                    <li>FoodNetwork.com</li>
                    <li>BBC Good Food</li>
                    <li>Sites with Schema.org Recipe markup</li>
                    <li>Most modern recipe blogs</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 1rem;">
            <div class="card-body p-4">
                <h5 class="mb-3">How It Works</h5>
                <ol class="small">
                    <li class="mb-2">Enter a recipe URL or multiple URLs</li>
                    <li class="mb-2">The scraper extracts recipe data</li>
                    <li class="mb-2">Recipe is saved to your library</li>
                    <li class="mb-2">You can then convert to Iterum format</li>
                </ol>
            </div>
        </div>
        
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 1rem;">
            <div class="card-body p-4">
                <h5 class="mb-3">What Gets Extracted</h5>
                <ul class="small mb-0">
                    <li>Recipe title</li>
                    <li>Ingredients list</li>
                    <li>Instructions/method</li>
                    <li>Prep and cook times</li>
                    <li>Servings/yield</li>
                    <li>Cuisine type (if available)</li>
                    <li>Recipe description</li>
                </ul>
            </div>
        </div>
        
        <div class="card border-0 shadow-sm" style="border-radius: 1rem; border-left: 4px solid #10B981;">
            <div class="card-body p-4">
                <h6 class="mb-2">
                    <i class="bi bi-check-circle me-2 text-success"></i>
                    Tips
                </h6>
                <ul class="small mb-0">
                    <li>Use the direct recipe page URL</li>
                    <li>Some sites may require JavaScript (not supported)</li>
                    <li>Check scraped recipes for accuracy</li>
                    <li>Convert to Iterum format after scraping</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('scrapeSingleBtn').addEventListener('click', function() {
    const url = document.getElementById('recipeUrl').value.trim();
    
    if (!url) {
        alert('Please enter a recipe URL');
        return;
    }
    
    scrapeRecipe(url);
});

document.getElementById('scrapeMultipleBtn').addEventListener('click', function() {
    const urlsText = document.getElementById('recipeUrls').value.trim();
    
    if (!urlsText) {
        alert('Please enter at least one recipe URL');
        return;
    }
    
    const urls = urlsText.split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'));
    
    if (urls.length === 0) {
        alert('Please enter at least one valid URL');
        return;
    }
    
    scrapeMultipleRecipes(urls);
});

function scrapeRecipe(url) {
    const progressDiv = document.getElementById('scrapeProgress');
    const resultsDiv = document.getElementById('scrapeResults');
    const statusDiv = document.getElementById('scrapeStatus');
    
    progressDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    statusDiv.textContent = `Scraping ${url}...`;
    
    fetch('/api/scrape', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';
        resultsDiv.style.display = 'block';
        
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle me-2"></i>Recipe Scraped Successfully!</h5>
                    <p class="mb-2"><strong>Title:</strong> ${data.recipe.title}</p>
                    <p class="mb-2"><strong>Cuisine:</strong> ${data.recipe.cuisine || 'Not detected'}</p>
                    <p class="mb-2"><strong>Category:</strong> ${data.recipe.category || 'Not detected'}</p>
                    <div class="mt-3">
                        <a href="/recipe/${data.recipe.id}" class="btn btn-primary me-2">
                            <i class="bi bi-eye me-2"></i>View Recipe
                        </a>
                        <a href="/recipes" class="btn btn-outline-primary">
                            <i class="bi bi-list me-2"></i>Browse All Recipes
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('recipeUrl').value = '';
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Scraping Failed</h5>
                    <p>${data.error || 'Could not extract recipe from URL'}</p>
                    <p class="small text-muted mt-2">Make sure the URL is a direct link to a recipe page.</p>
                </div>
            `;
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Error</h5>
                <p>${error.message}</p>
            </div>
        `;
    });
}

function scrapeMultipleRecipes(urls) {
    const progressDiv = document.getElementById('scrapeProgress');
    const resultsDiv = document.getElementById('scrapeResults');
    const statusDiv = document.getElementById('scrapeStatus');
    
    progressDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    statusDiv.textContent = `Scraping ${urls.length} recipes...`;
    
    fetch('/api/scrape', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ urls: urls })
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';
        resultsDiv.style.display = 'block';
        
        if (data.success) {
            const results = data.results;
            const successCount = results.success.length;
            const failCount = results.failed.length;
            
            let html = `
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle me-2"></i>Scraping Complete</h5>
                    <p class="mb-2"><strong>Successfully scraped:</strong> ${successCount}</p>
                    <p class="mb-0"><strong>Failed:</strong> ${failCount}</p>
                </div>
            `;
            
            if (successCount > 0) {
                html += '<h6 class="mt-3">Successfully Scraped:</h6><ul class="list-group mb-3">';
                results.success.forEach(item => {
                    html += `
                        <li class="list-group-item">
                            <strong>${item.title}</strong><br>
                            <small class="text-muted">${item.url}</small>
                            <a href="/recipe/${item.id}" class="btn btn-sm btn-outline-primary float-end">View</a>
                        </li>
                    `;
                });
                html += '</ul>';
            }
            
            if (failCount > 0) {
                html += '<h6 class="mt-3">Failed:</h6><ul class="list-group">';
                results.failed.forEach(item => {
                    html += `
                        <li class="list-group-item">
                            <small>${item.url}</small><br>
                            <span class="text-danger small">${item.reason}</span>
                        </li>
                    `;
                });
                html += '</ul>';
            }
            
            html += `
                <div class="mt-3">
                    <a href="/recipes" class="btn btn-primary">
                        <i class="bi bi-list me-2"></i>Browse All Recipes
                    </a>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            document.getElementById('recipeUrls').value = '';
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Error</h5>
                    <p>${data.error || 'Could not scrape recipes'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Error</h5>
                <p>${error.message}</p>
            </div>
        `;
    });
}
</script>
{% endblock %}

