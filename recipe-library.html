<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Library - Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-header.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    
    <!-- Load Enhanced User Management System -->
    <!-- Enhanced User Management now handled by Firebase Auth -->
    
    <!-- Project management now handled by new system -->
    <script src="assets/js/error_handler.js"></script>
    <script src="assets/js/project-management-system.js"></script>
    
    <style>
        /* Recipe Library Specific Styles */
        .recipe-filters {
            background: white;
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--spacing-6);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }
        
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }
        
        .recipe-card {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .recipe-card-header {
            background: linear-gradient(135deg, var(--iterum-primary), var(--iterum-secondary));
            color: white;
            padding: var(--spacing-4);
        }
        
        .recipe-card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-2);
        }
        
        .recipe-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }
        
        .recipe-card-body {
            padding: var(--spacing-4);
        }
        
        .recipe-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--iterum-primary);
        }
        
        .info-label {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }
        
        .recipe-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .recipe-description {
            color: var(--gray-600);
            margin-bottom: var(--spacing-4);
            line-height: var(--line-height-relaxed);
        }
        
        .recipe-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }
        
        .recipe-tag {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }
        
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .recipe-grid {
                grid-template-columns: 1fr;
            }
            
            .recipe-info {
                grid-template-columns: 1fr;
            }
            
            .recipe-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Uniform Centered Header -->
    <header class="iterum-header">
        <div class="header-container">
            <!-- Logo Section -->
            <a href="index.html" class="header-logo">
                <div class="header-logo-icon">
                    <span>üçÉ</span>
                </div>
                <div class="header-logo-text">
                    <div class="header-logo-title">Iterum R&D</div>
                    <div class="header-logo-subtitle">Chef Notebook</div>
                </div>
            </a>

            <!-- Center Navigation -->
            <nav class="header-navigation">
                <a href="index.html" class="header-nav-item" data-page="index">
                    <span class="nav-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="recipe-library.html" class="header-nav-item active" data-page="recipe-library">
                    <span class="nav-icon">üìö</span>
                    <span>Library</span>
                </a>
                <a href="recipe-developer.html" class="header-nav-item" data-page="recipe-developer">
                    <span class="nav-icon">üß™</span>
                    <span>Developer</span>
                </a>
                <a href="recipe-upload.html" class="header-nav-item" data-page="recipe-upload">
                    <span class="nav-icon">‚ö°</span>
                    <span>Upload</span>
                </a>
                <a href="menu-builder.html" class="header-nav-item" data-page="menu-builder">
                    <span class="nav-icon">üçΩÔ∏è</span>
                    <span>Menu</span>
                </a>
                <a href="ingredients.html" class="header-nav-item" data-page="ingredients">
                    <span class="nav-icon">ü•¨</span>
                    <span>Ingredients</span>
                </a>
                <a href="equipment-management.html" class="header-nav-item" data-page="equipment-management">
                    <span class="nav-icon">üîß</span>
                    <span>Equipment</span>
                </a>
                <a href="vendor-management.html" class="header-nav-item" data-page="vendor-management">
                    <span class="nav-icon">üè™</span>
                    <span>Vendors</span>
                </a>
            </nav>

            <!-- Right Side - User Section -->
            <div class="header-user-section">
                <!-- Project Selector -->
                <div class="header-project-selector-container">
                    <div class="project-selector-display" onclick="window.showProjectSelectionDropdown()">
                        <div class="project-selector-current">
                            <span class="project-selector-icon">üìã</span>
                            <span class="project-selector-name" data-project-name>Master Project</span>
                            <svg class="project-selector-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <div class="project-status-display">
                            <span class="project-status-label">Current:</span>
                            <span class="project-status-value" data-project-name>Master Project</span>
                        </div>
                    </div>
                </div>

                <!-- User Info Tab -->
                <div class="header-user-tab" onclick="toggleUserDropdown()">
                    <div class="header-user-avatar" id="user-avatar">
                        <span id="user-avatar-initial">üë§</span>
                    </div>
                    <div class="header-user-info">
                        <div class="header-user-name" id="current-user">Guest User</div>
                        <div class="header-user-role">Chef</div>
                    </div>
                    <svg class="header-user-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>

                <!-- User Dropdown Menu -->
                <div class="header-user-dropdown" id="user-dropdown">
                    <div class="header-user-dropdown-header">
                        <div class="header-user-dropdown-title" id="dropdown-user-name">Guest User</div>
                        <div class="header-user-dropdown-subtitle" id="dropdown-user-role">Chef</div>
                    </div>
                    
                    <div class="header-user-dropdown-menu">
                        <div class="header-user-dropdown-item" onclick="window.switchUser()">
                            <span>üîÑ</span>
                            <span>Switch User</span>
                        </div>
                        <div class="header-user-dropdown-item" onclick="userSystem.showUserModal('create')">
                            <span>‚ûï</span>
                            <span>Create New User</span>
                        </div>
                    </div>
                    
                    <div class="header-user-dropdown-divider"></div>
                    
                    <div class="header-user-dropdown-menu">
                        <div class="header-user-dropdown-item" onclick="userSystem.showSettings()">
                            <span>‚öôÔ∏è</span>
                            <span>Settings</span>
                        </div>
                        <div class="header-user-dropdown-item danger" onclick="userSystem.logout()">
                            <span>üö™</span>
                            <span>Sign Out</span>
                        </div>
                    </div>
                    
                    <div class="header-user-dropdown-footer">
                        <div class="header-user-dropdown-footer-text">Iterum R&D v1.0</div>
                    </div>
                </div>

                <!-- Mobile Navigation Toggle -->
                <button class="header-mobile-toggle" onclick="toggleMobileNav()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <nav id="mobile-nav" class="header-mobile-nav">
            <!-- Project Selector for Mobile -->
            <div style="margin-bottom: 1rem;">
                <select id="mobile-project-selector" class="header-project-selector" style="width: 100%;">
                    <option value="">Select Project...</option>
                </select>
            </div>

            <!-- Mobile Navigation Items -->
            <a href="index.html" class="header-mobile-nav-item" data-page="index">
                <span class="nav-icon">üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="recipe-library.html" class="header-mobile-nav-item active" data-page="recipe-library">
                <span class="nav-icon">üìö</span>
                <span>Library</span>
            </a>
            <a href="recipe-developer.html" class="header-mobile-nav-item" data-page="recipe-developer">
                <span class="nav-icon">üß™</span>
                <span>Developer</span>
            </a>
            <a href="recipe-upload.html" class="header-mobile-nav-item" data-page="recipe-upload">
                <span class="nav-icon">‚ö°</span>
                <span>Upload</span>
            </a>
            <a href="menu-builder.html" class="header-mobile-nav-item" data-page="menu-builder">
                <span class="nav-icon">üçΩÔ∏è</span>
                <span>Menu</span>
            </a>
            <a href="ingredients.html" class="header-mobile-nav-item" data-page="ingredients">
                <span class="nav-icon">ü•¨</span>
                <span>Ingredients</span>
            </a>
            <a href="equipment-management.html" class="header-mobile-nav-item" data-page="equipment-management">
                <span class="nav-icon">üîß</span>
                <span>Equipment</span>
            </a>
            <a href="vendor-management.html" class="header-mobile-nav-item" data-page="vendor-management">
                <span class="nav-icon">üè™</span>
                <span>Vendors</span>
            </a>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="heading-1">Recipe Library</h1>
                <p class="body-large">Browse, search, and manage your complete recipe collection with advanced filtering and organization tools.</p>
            </div>

            <!-- Recipe Filters -->
            <div class="recipe-filters">
                <h2 class="heading-2">Search & Filter Recipes</h2>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="search-query" class="form-label">Search</label>
                        <input type="text" id="search-query" class="form-input" placeholder="Search recipes...">
                    </div>
                    <div class="form-group">
                        <label for="filter-category" class="form-label">Category</label>
                        <select id="filter-category" class="form-select">
                            <option value="">All Categories</option>
                            <option value="appetizer">Appetizer</option>
                            <option value="main-course">Main Course</option>
                            <option value="dessert">Dessert</option>
                            <option value="beverage">Beverage</option>
                            <option value="sauce">Sauce</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-cuisine" class="form-label">Cuisine</label>
                        <select id="filter-cuisine" class="form-select">
                            <option value="">All Cuisines</option>
                            <option value="italian">Italian</option>
                            <option value="french">French</option>
                            <option value="asian">Asian</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="american">American</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-difficulty" class="form-label">Difficulty</label>
                        <select id="filter-difficulty" class="form-select">
                            <option value="">All Levels</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="form-group">
                        <label for="filter-time" class="form-label">Prep Time</label>
                        <select id="filter-time" class="form-select">
                            <option value="">Any Time</option>
                            <option value="quick">Quick (< 30 min)</option>
                            <option value="medium">Medium (30-60 min)</option>
                            <option value="long">Long (> 60 min)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-servings" class="form-label">Servings</label>
                        <select id="filter-servings" class="form-select">
                            <option value="">Any</option>
                            <option value="1-2">1-2 people</option>
                            <option value="3-4">3-4 people</option>
                            <option value="5-6">5-6 people</option>
                            <option value="7+">7+ people</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-by" class="form-label">Sort By</label>
                        <select id="sort-by" class="form-select">
                            <option value="name">Name</option>
                            <option value="date-added">Date Added</option>
                            <option value="difficulty">Difficulty</option>
                            <option value="prep-time">Prep Time</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="searchRecipes()">üîç Search</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                    <button class="btn btn-secondary" onclick="exportRecipes()">üì§ Export</button>
                </div>
            </div>

            <!-- Recipes Grid -->
            <div id="recipes-container">
                <div class="recipe-grid" id="recipes-grid">
                    <!-- Recipes will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Essential Scripts -->
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing Recipe Library Page');
            
            // Wait for authentication system to be ready
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Ensure unified auth system is initialized and user state is maintained
            if (window.unifiedAuth) {
                console.log('üîê Unified auth system found, checking user state...');
                
                // Check if there's a current user session
                const currentUser = localStorage.getItem('current_user');
                const sessionActive = localStorage.getItem('session_active');
                
                if (currentUser && sessionActive === 'true') {
                    try {
                        const user = JSON.parse(currentUser);
                        console.log('‚úÖ User session found:', user.name);
                        
                        // Update the header display with current user
                        updateHeaderUserDisplay(user);
                        
                        // Ensure unified auth system has the current user
                        window.unifiedAuth.currentUser = user;
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error parsing current user:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è No active user session found');
                }
            } else {
                console.warn('‚ö†Ô∏è Unified auth system not available');
            }
            
            // Initialize header user synchronization
            if (window.HeaderUserSync) {
                try {
                    const headerSync = new window.HeaderUserSync();
                    headerSync.initialize();
                    console.log('‚úÖ Header user synchronization initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Header user sync initialization failed:', error);
                }
            }
            
            console.log('‚úÖ Recipe Library Page initialized');
        });

        // Wait for app to be ready
        document.addEventListener('iterumAppReady', function() {
            initializeRecipeLibrary();
            updateUserInfo();
            initializeProjectSelector();
        });

        // Wait for loading screen to be hidden
        document.addEventListener('loadingScreenHidden', function() {
            initializeRecipeLibrary();
            updateUserInfo();
            initializeProjectSelector();
        });

        function initializeRecipeLibrary() {
            console.log('üìö Initializing Recipe Library');
            loadRecipes();
            setupEventListeners();
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
            }
        }

        function initializeProjectSelector() {
            if (window.projectManager) {
                window.projectManager.loadUserProjects();
            }
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('search-query').addEventListener('input', function() {
                searchRecipes();
            });

            // Filter changes
            document.getElementById('filter-category').addEventListener('change', searchRecipes);
            document.getElementById('filter-cuisine').addEventListener('change', searchRecipes);
            document.getElementById('filter-difficulty').addEventListener('change', searchRecipes);
            document.getElementById('filter-time').addEventListener('change', searchRecipes);
            document.getElementById('filter-servings').addEventListener('change', searchRecipes);
            document.getElementById('sort-by').addEventListener('change', searchRecipes);
        }

        function loadRecipes() {
            // Load recipes from localStorage or API
            const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
            displayRecipes(recipes);
        }

        function displayRecipes(recipes) {
            const grid = document.getElementById('recipes-grid');
            grid.innerHTML = '';

            if (recipes.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500">No recipes found. Start by adding some recipes!</p>';
                return;
            }

            recipes.forEach(recipe => {
                const card = createRecipeCard(recipe);
                grid.appendChild(card);
            });
        }

        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.innerHTML = `
                <div class="recipe-card-header">
                    <div class="recipe-card-title">${recipe.name || 'Untitled Recipe'}</div>
                    <div class="recipe-card-meta">
                        <span>${recipe.category || 'Uncategorized'}</span>
                        <span>${recipe.difficulty || 'Medium'}</span>
                    </div>
                </div>
                <div class="recipe-card-body">
                    <div class="recipe-description">${recipe.description || 'No description available.'}</div>
                    
                    <div class="recipe-tags">
                        ${(recipe.tags || []).map(tag => `<span class="recipe-tag">${tag}</span>`).join('')}
                    </div>
                    
                    <div class="recipe-info">
                        <div class="info-item">
                            <div class="info-value">${recipe.prepTime || '0'}</div>
                            <div class="info-label">Prep Time</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value">${recipe.servings || '0'}</div>
                            <div class="info-label">Servings</div>
                        </div>
                    </div>
                    
                    <div class="recipe-actions">
                        <button class="btn btn-primary" onclick="viewRecipe('${recipe.id}')">üëÅÔ∏è View</button>
                        <button class="btn btn-secondary" onclick="editRecipe('${recipe.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-secondary" onclick="duplicateRecipe('${recipe.id}')">üìã Copy</button>
                        <button class="btn btn-secondary danger" onclick="deleteRecipe('${recipe.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            return card;
        }

        function searchRecipes() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const cuisine = document.getElementById('filter-cuisine').value;
            const difficulty = document.getElementById('filter-difficulty').value;
            const time = document.getElementById('filter-time').value;
            const servings = document.getElementById('filter-servings').value;
            const sortBy = document.getElementById('sort-by').value;

            let recipes = JSON.parse(localStorage.getItem('recipes') || '[]');

            // Filter
            recipes = recipes.filter(recipe => {
                const matchesQuery = !query || recipe.name.toLowerCase().includes(query) || 
                                   (recipe.description && recipe.description.toLowerCase().includes(query));
                const matchesCategory = !category || recipe.category === category;
                const matchesCuisine = !cuisine || recipe.cuisine === cuisine;
                const matchesDifficulty = !difficulty || recipe.difficulty === difficulty;
                const matchesTime = !time || recipe.prepTime === time;
                const matchesServings = !servings || recipe.servings === servings;
                
                return matchesQuery && matchesCategory && matchesCuisine && 
                       matchesDifficulty && matchesTime && matchesServings;
            });

            // Sort
            recipes.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    case 'date-added': return new Date(b.dateAdded || 0) - new Date(a.dateAdded || 0);
                    case 'difficulty': return (a.difficulty || '').localeCompare(b.difficulty || '');
                    case 'prep-time': return (a.prepTime || 0) - (b.prepTime || 0);
                    case 'rating': return (b.rating || 0) - (a.rating || 0);
                    default: return 0;
                }
            });

            displayRecipes(recipes);
        }

        function resetFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-cuisine').value = '';
            document.getElementById('filter-difficulty').value = '';
            document.getElementById('filter-time').value = '';
            document.getElementById('filter-servings').value = '';
            document.getElementById('sort-by').value = 'name';
            searchRecipes();
        }

        function exportRecipes() {
            console.log('üì§ Exporting recipes...');
            // Implement export logic
        }

        function viewRecipe(id) {
            console.log('üëÅÔ∏è Viewing recipe:', id);
            // Implement view logic
        }

        function editRecipe(id) {
            console.log('‚úèÔ∏è Editing recipe:', id);
            // Implement edit logic
        }

        function duplicateRecipe(id) {
            console.log('üìã Duplicating recipe:', id);
            // Implement duplicate logic
        }

        function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                const filtered = recipes.filter(r => r.id !== id);
                localStorage.setItem('recipes', JSON.stringify(filtered));
                loadRecipes();
                console.log('üóëÔ∏è Recipe deleted:', id);
            }
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Function to update header user display
        function updateHeaderUserDisplay(user) {
            if (!user) return;
            
            // Update user avatar initial
            const avatarInitial = document.getElementById('user-avatar-initial');
            if (avatarInitial) {
                avatarInitial.textContent = user.name.charAt(0).toUpperCase();
            }
            
            // Update current user name
            const currentUserName = document.getElementById('current-user');
            if (currentUserName) {
                currentUserName.textContent = user.name;
            }
            
            // Update dropdown user name
            const dropdownUserName = document.getElementById('dropdown-user-name');
            if (dropdownUserName) {
                dropdownUserName.textContent = user.name;
            }
            
            // Update dropdown user role
            const dropdownUserRole = document.getElementById('dropdown-user-role');
            if (dropdownUserRole) {
                dropdownUserRole.textContent = user.role || 'Chef';
            }
            
            console.log('‚úÖ Header user display updated for:', user.name);
        }

        // Listen for user authentication events to keep header synchronized
        document.addEventListener('userLoggedIn', function(event) {
            console.log('üîê User logged in event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });

        document.addEventListener('userSwitched', function(event) {
            console.log('üîÑ User switched event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });

        document.addEventListener('userLoggedOut', function(event) {
            console.log('üö™ User logged out event received on recipe library page');
            // Reset header to guest state
            updateHeaderUserDisplay({
                name: 'Guest User',
                role: 'Guest'
            });
        });

        document.addEventListener('iterumUserDataLoaded', function(event) {
            console.log('üì• User data loaded event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('‚úÖ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('‚úÖ Authentication system initialized');
          } else {
            console.error('‚ùå UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('‚úÖ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('‚úÖ Page protection system initialized');
          } else {
            console.warn('‚ö†Ô∏è PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
    
    <!-- Load Profile Editor -->
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- Load Email Verification Banner -->
    <script src="assets/js/email-verification-banner.js"></script>
    
    <!-- Load Project UI Manager -->
    <script defer src="assets/js/project-ui-manager.js"></script>
</body>
</html>