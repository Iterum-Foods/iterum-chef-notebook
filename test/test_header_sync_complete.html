<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Header Sync Test - Iterum R&D Chef Notebook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Uniform Centered Header -->
    <header class="iterum-header">
        <div class="header-container">
            <!-- Logo Section -->
            <a href="index.html" class="header-logo">
                <div class="header-logo-icon">
                    <span>üçÉ</span>
                </div>
                <div class="header-logo-text">
                    <div class="header-logo-title">Iterum R&D</div>
                    <div class="header-logo-subtitle">Chef Notebook</div>
                </div>
            </a>

            <!-- Center Navigation -->
            <nav class="header-navigation">
                <a href="index.html" class="header-nav-item" data-page="index">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="test_header_sync_complete.html" class="header-nav-item active" data-page="test">
                    <span class="nav-icon">üß™</span>
                    <span class="nav-text">Test Page</span>
                </a>
            </nav>

            <!-- Right Side - User Section -->
            <div class="header-user-section">
                <!-- Project Selector -->
                <select id="header-project-selector" class="header-project-selector">
                    <option value="">Select Project...</option>
                </select>

                <!-- User Info Tab -->
                <div class="header-user-tab" onclick="toggleUserDropdown()">
                    <div class="header-user-avatar" id="user-avatar">
                        <span id="user-avatar-initial">üë§</span>
                    </div>
                    <div class="header-user-info">
                        <div class="header-user-name" id="current-user">Guest User</div>
                        <div class="header-user-role">Chef</div>
                    </div>
                    <svg class="header-user-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>

                <!-- User Dropdown Menu -->
                <div class="header-user-dropdown" id="user-dropdown">
                    <div class="header-user-dropdown-header">
                        <div class="header-user-dropdown-title" id="dropdown-user-name">Guest User</div>
                        <div class="header-user-dropdown-subtitle" id="dropdown-user-role">Chef</div>
                    </div>
                    
                    <div class="header-user-dropdown-menu">
                        <div class="header-user-dropdown-item" onclick="testCreateUser()">
                            <span>üë§</span>
                            <span>Create Test User</span>
                        </div>
                        <div class="header-user-dropdown-item" onclick="testSwitchUser()">
                            <span>üîÑ</span>
                            <span>Switch Test User</span>
                        </div>
                        <div class="header-user-dropdown-item" onclick="testLogout()">
                            <span>üö™</span>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Header Synchronization Test</h1>
            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Instructions</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-700">
                    <li>Open this page in one tab</li>
                    <li>Open the main page (index.html) in another tab</li>
                    <li>Create or login as a user on the main page</li>
                    <li>Come back to this tab - the header should automatically show the user</li>
                    <li>Use the dropdown menu to test different user states</li>
                </ol>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Current Status</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="font-medium">Header Sync Status:</span>
                        <span id="sync-status" class="ml-2 px-2 py-1 bg-gray-100 rounded text-sm">Checking...</span>
                    </div>
                    <div>
                        <span class="font-medium">User System Status:</span>
                        <span id="user-system-status" class="ml-2 px-2 py-1 bg-gray-100 rounded text-sm">Checking...</span>
                    </div>
                    <div>
                        <span class="font-medium">Current User:</span>
                        <span id="current-user-status" class="ml-2 px-2 py-1 bg-gray-100 rounded text-sm">Checking...</span>
                    </div>
                    <div>
                        <span class="font-medium">Authentication:</span>
                        <span id="auth-status" class="ml-2 px-2 py-1 bg-gray-100 rounded text-sm">Checking...</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Actions</h2>
                <div class="flex flex-wrap gap-4">
                    <button onclick="testCreateUser()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Create Test User
                    </button>
                    <button onclick="testSwitchUser()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Switch Test User
                    </button>
                    <button onclick="testLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Logout
                    </button>
                    <button onclick="refreshStatus()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Refresh Status
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Console Log</h2>
                <div id="console-log" class="bg-gray-100 p-4 rounded-lg font-mono text-sm h-32 overflow-y-auto">
                    <div class="text-gray-500">Console output will appear here...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Load Unified Authentication System -->
    <script src="assets/js/unified_auth_system.js"></script>
    
    <!-- Load Header User Synchronization -->
    <script src="assets/js/header_user_sync.js"></script>
    
    <!-- Load Header Sync Loader (ensures sync on all pages) -->
    <script src="assets/js/header_sync_loader.js"></script>
    
    <!-- Load Enhanced User Management System -->
    <script src="assets/js/enhanced-user-system.js"></script>
    
    <script>
        // Console logging function
        function log(message) {
            const consoleLog = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.innerHTML += `<div class="text-gray-700">[${timestamp}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(message);
        }

        // Status update function
        function updateStatus() {
            // Header sync status
            const syncStatus = document.getElementById('sync-status');
            if (window.headerUserSync) {
                syncStatus.textContent = '‚úÖ Active';
                syncStatus.className = 'ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-sm';
            } else {
                syncStatus.textContent = '‚ùå Not Found';
                syncStatus.className = 'ml-2 px-2 py-1 bg-red-100 text-red-800 rounded text-sm';
            }

            // User system status
            const userSystemStatus = document.getElementById('user-system-status');
            if (window.userSystem) {
                userSystemStatus.textContent = '‚úÖ Available';
                userSystemStatus.className = 'ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-sm';
            } else {
                userSystemStatus.textContent = '‚ùå Not Found';
                userSystemStatus.className = 'ml-2 px-2 py-1 bg-red-100 text-red-800 rounded text-sm';
            }

            // Current user status
            const currentUserStatus = document.getElementById('current-user-status');
            if (window.userSystem && window.userSystem.currentUser) {
                currentUserStatus.textContent = window.userSystem.currentUser.name;
                currentUserStatus.className = 'ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm';
            } else {
                currentUserStatus.textContent = 'Guest';
                currentUserStatus.className = 'ml-2 px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm';
            }

            // Authentication status
            const authStatus = document.getElementById('auth-status');
            const currentUser = localStorage.getItem('current_user');
            const sessionActive = localStorage.getItem('session_active');
            if (currentUser && sessionActive === 'true') {
                authStatus.textContent = '‚úÖ Authenticated';
                authStatus.className = 'ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-sm';
            } else {
                authStatus.textContent = '‚ùå Not Authenticated';
                authStatus.className = 'ml-2 px-2 py-1 bg-red-100 text-red-800 rounded text-sm';
            }
        }

        // Test functions
        function testCreateUser() {
            log('üß™ Creating test user...');
            if (window.userSystem) {
                const testUser = {
                    id: 'test-user-' + Date.now(),
                    name: 'Test User ' + Math.floor(Math.random() * 1000),
                    email: 'test@example.com',
                    role: 'Chef',
                    photoURL: null
                };
                
                // Add user to system
                window.userSystem.users.push(testUser);
                window.userSystem.currentUser = testUser;
                
                // Update localStorage
                localStorage.setItem('current_user', JSON.stringify(testUser));
                localStorage.setItem('session_active', 'true');
                
                // Update UI
                window.userSystem.updateUI();
                
                // Trigger header sync
                if (window.headerUserSync) {
                    window.headerUserSync.syncUserDisplay();
                }
                
                log('‚úÖ Test user created: ' + testUser.name);
                updateStatus();
            } else {
                log('‚ùå User system not available');
            }
        }

        function testSwitchUser() {
            log('üîÑ Switching test user...');
            if (window.userSystem && window.userSystem.users.length > 1) {
                const currentIndex = window.userSystem.users.findIndex(u => u.id === window.userSystem.currentUser?.id);
                const nextIndex = (currentIndex + 1) % window.userSystem.users.length;
                const newUser = window.userSystem.users[nextIndex];
                
                window.userSystem.currentUser = newUser;
                localStorage.setItem('current_user', JSON.stringify(newUser));
                
                // Update UI
                window.userSystem.updateUI();
                
                // Trigger header sync
                if (window.headerUserSync) {
                    window.headerUserSync.syncUserDisplay();
                }
                
                log('‚úÖ Switched to user: ' + newUser.name);
                updateStatus();
            } else {
                log('‚ùå Not enough users to switch');
            }
        }

        function testLogout() {
            log('üö™ Logging out...');
            localStorage.removeItem('current_user');
            localStorage.removeItem('session_active');
            
            if (window.userSystem) {
                window.userSystem.currentUser = null;
                window.userSystem.updateUI();
            }
            
            // Trigger header sync
            if (window.headerUserSync) {
                window.headerUserSync.syncUserDisplay();
            }
            
            log('‚úÖ Logged out successfully');
            updateStatus();
        }

        function refreshStatus() {
            log('üîÑ Refreshing status...');
            updateStatus();
            log('‚úÖ Status refreshed');
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Header Sync Test Page initialized');
            
            // Wait for systems to load
            setTimeout(() => {
                updateStatus();
                log('‚úÖ Initial status check complete');
            }, 1000);
            
            // Update status every 5 seconds
            setInterval(updateStatus, 5000);
        });

        // Listen for authentication events
        document.addEventListener('userLoggedIn', (event) => {
            log('üîê User logged in event received');
            setTimeout(updateStatus, 100);
        });

        document.addEventListener('userLoggedOut', (event) => {
            log('üîê User logged out event received');
            setTimeout(updateStatus, 100);
        });

        document.addEventListener('userSwitched', (event) => {
            log('üîê User switched event received');
            setTimeout(updateStatus, 100);
        });

        document.addEventListener('iterumUserDataLoaded', (event) => {
            log('üîê User data loaded event received');
            setTimeout(updateStatus, 100);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && !userTab.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
