<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Recipe Upload - Iterum App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success { background: #28a745; }
        .test-button.warning { background: #ffc107; color: #212529; }
        .test-button.danger { background: #dc3545; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .upload-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        .recipe-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-top: 15px;
        }
        .recipe-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .meta-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .meta-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
        }
        .meta-value {
            color: #212529;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Recipe Upload System</h1>
        <p>This page tests the complete recipe upload functionality including PDF processing, storage, and integration.</p>
        
        <div class="test-section">
            <h3>üì§ Recipe Upload Test</h3>
            <form class="upload-form" id="test-upload-form">
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="test-project-select">
                        <option value="master">Master Project</option>
                        <option value="test_project_1">Test Project 1</option>
                        <option value="test_project_2">Test Project 2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipe Name</label>
                    <input type="text" class="form-input" id="test-recipe-name" placeholder="Enter recipe name" value="Test Recipe">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="test-recipe-description" placeholder="Enter recipe description">A test recipe for testing the upload system</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">PDF File</label>
                    <input type="file" class="form-input" id="test-pdf-file" accept=".pdf">
                    <small style="color: #6c757d;">Select a PDF file to test upload (max 10MB)</small>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn success">üì§ Upload Recipe</button>
                    <button type="button" class="btn warning" onclick="testWithSampleData()">üß™ Test with Sample Data</button>
                    <button type="button" class="btn danger" onclick="clearTestForm()">üóëÔ∏è Clear Form</button>
                </div>
            </form>
            
            <!-- Progress Bar -->
            <div id="test-progress" style="display: none;">
                <h4>Upload Progress</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="test-progress-fill"></div>
                </div>
                <div id="test-progress-text">Preparing upload...</div>
            </div>
            
            <!-- Recipe Preview -->
            <div id="test-recipe-preview" class="recipe-preview" style="display: none;">
                <h4>üìã Recipe Preview</h4>
                <div class="recipe-meta" id="test-recipe-meta">
                    <!-- Recipe metadata will be displayed here -->
                </div>
                <div id="test-recipe-content">
                    <!-- Recipe content will be displayed here -->
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç System Tests</h3>
            <button class="test-button" onclick="testStorageSystem()">Test Storage System</button>
            <button class="test-button" onclick="testUserSystem()">Test User System</button>
            <button class="test-button" onclick="testProjectSystem()">Test Project System</button>
            <button class="test-button" onclick="testPDFProcessing()">Test PDF Processing</button>
            <button class="test-button" onclick="testRecipeParsing()">Test Recipe Parsing</button>
            <button class="test-button success" onclick="showStorageControl()">Show Storage Control</button>
            <button class="test-button warning" onclick="createTestRecipe()">Create Test Recipe</button>
            <button class="test-button danger" onclick="clearTestData()">Clear Test Data</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç System Status</h3>
            <div id="system-status"></div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="../assets/js/userControlledStorage.js"></script>
    <script src="../assets/js/enhanced-user-system.js"></script>
    <script src="../assets/js/project-management-system.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(message);
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            if (!statusDiv) return;

            let status = '<h4>System Components Status</h4>';
            
            // Check storage system
            if (window.userControlledStorage) {
                status += '<p>‚úÖ User-Controlled Storage: Active</p>';
                const stats = window.userControlledStorage.getStorageStats();
                if (stats) {
                    status += `<p>üìä Storage: ${stats.fileCount} files, ${stats.totalSizeMB} MB</p>`;
                }
            } else {
                status += '<p>‚ùå User-Controlled Storage: Not Available</p>';
            }
            
            // Check user system
            if (window.userSystem) {
                status += '<p>‚úÖ User System: Active</p>';
                const currentUser = window.userSystem.getCurrentUser();
                if (currentUser) {
                    status += `<p>üë§ Current User: ${currentUser.name}</p>`;
                } else {
                    status += '<p>‚ö†Ô∏è No user logged in</p>';
                }
            } else {
                status += '<p>‚ùå User System: Not Available</p>';
            }
            
            // Check project system
            if (window.projectManager) {
                status += '<p>‚úÖ Project Manager: Active</p>';
                if (window.projectManager.currentProject) {
                    status += `<p>üìã Current Project: ${window.projectManager.currentProject.name}</p>`;
                } else {
                    status += '<p>‚ö†Ô∏è No project selected</p>';
                }
            } else {
                status += '<p>‚ùå Project Manager: Not Available</p>';
            }
            
            statusDiv.innerHTML = status;
        }

        // Test storage system
        function testStorageSystem() {
            try {
                log('üß™ Testing storage system...', 'info');
                
                if (!window.userControlledStorage) {
                    log('‚ùå Storage system not available', 'error');
                    return;
                }

                const system = window.userControlledStorage;
                log(`‚úÖ Storage system loaded: ${system.constructor.name}`, 'success');
                
                // Test user setting
                const testUser = { id: 'test_user', name: 'Test Chef' };
                system.setCurrentUser(testUser);
                log(`‚úÖ Test user set: ${testUser.name}`, 'success');
                
                // Test file operations
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                const success = system.saveUserFile('test_user/test_file.json', testData);
                if (success) {
                    log('‚úÖ Test file saved successfully', 'success');
                } else {
                    log('‚ùå Test file save failed', 'error');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Storage system test failed: ${error.message}`, 'error');
            }
        }

        // Test user system
        function testUserSystem() {
            try {
                log('üß™ Testing user system...', 'info');
                
                if (!window.userSystem) {
                    log('‚ùå User system not available', 'error');
                    return;
                }

                const system = window.userSystem;
                log(`‚úÖ User system loaded: ${system.constructor.name}`, 'success');
                
                const currentUser = system.getCurrentUser();
                if (currentUser) {
                    log(`‚úÖ Current user: ${currentUser.name}`, 'success');
                } else {
                    log('‚ö†Ô∏è No current user', 'info');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå User system test failed: ${error.message}`, 'error');
            }
        }

        // Test project system
        function testProjectSystem() {
            try {
                log('üß™ Testing project system...', 'info');
                
                if (!window.projectManager) {
                    log('‚ùå Project manager not available', 'error');
                    return;
                }

                const system = window.projectManager;
                log(`‚úÖ Project manager loaded: ${system.constructor.name}`, 'success');
                
                if (system.currentProject) {
                    log(`‚úÖ Current project: ${system.currentProject.name}`, 'success');
                } else {
                    log('‚ö†Ô∏è No current project', 'info');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Project system test failed: ${error.message}`, 'error');
            }
        }

        // Test PDF processing
        function testPDFProcessing() {
            try {
                log('üß™ Testing PDF processing...', 'info');
                
                // Create a simple test PDF content
                const testContent = 'Test PDF content for processing';
                const testFile = new File([testContent], 'test.pdf', { type: 'application/pdf' });
                
                log('‚úÖ Test PDF file created', 'success');
                log(`üìÑ File size: ${testFile.size} bytes`, 'info');
                
                // Test PDF.js
                if (typeof pdfjsLib !== 'undefined') {
                    log('‚úÖ PDF.js library loaded', 'success');
                } else {
                    log('‚ùå PDF.js library not available', 'error');
                }
                
            } catch (error) {
                log(`‚ùå PDF processing test failed: ${error.message}`, 'error');
            }
        }

        // Test recipe parsing
        function testRecipeParsing() {
            try {
                log('üß™ Testing recipe parsing...', 'info');
                
                const sampleText = `
Ingredients:
- 2 cups flour
- 1 cup sugar
- 3 eggs

Instructions:
1. Mix flour and sugar
2. Add eggs
3. Bake at 350¬∞F for 30 minutes

Prep Time: 15 minutes
Cook Time: 30 minutes
Servings: 12
                `;
                
                // Test parsing logic
                const lines = sampleText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const ingredients = lines.filter(line => line.includes('-') && !line.includes('Instructions'));
                const instructions = lines.filter(line => line.match(/^\d+\./));
                
                log(`‚úÖ Parsed ${ingredients.length} ingredients`, 'success');
                log(`‚úÖ Parsed ${instructions.length} instructions`, 'success');
                
            } catch (error) {
                log(`‚ùå Recipe parsing test failed: ${error.message}`, 'error');
            }
        }

        // Create test recipe
        function createTestRecipe() {
            try {
                log('üß™ Creating test recipe...', 'info');
                
                const testRecipe = {
                    id: 'test_recipe_' + Date.now(),
                    name: 'Test Recipe ' + new Date().toLocaleTimeString(),
                    description: 'A test recipe created for testing purposes',
                    projectId: 'master',
                    sourceFile: 'test_creation.pdf',
                    uploadedAt: new Date().toISOString(),
                    rawText: 'This is a test recipe with sample content for testing the system.',
                    status: 'test',
                    type: 'test_creation',
                    userId: 'test_user',
                    userName: 'Test Chef',
                    complexity: 'easy',
                    estimatedPrepTime: 15,
                    tags: ['test', 'sample', 'demo']
                };
                
                // Save to storage
                if (window.userControlledStorage) {
                    const success = window.userControlledStorage.saveUserFile('test_user/test_recipes.json', [testRecipe]);
                    if (success) {
                        log('‚úÖ Test recipe saved to storage', 'success');
                    } else {
                        log('‚ùå Failed to save test recipe', 'error');
                    }
                }
                
                // Display recipe preview
                displayRecipePreview(testRecipe);
                
            } catch (error) {
                log(`‚ùå Test recipe creation failed: ${error.message}`, 'error');
            }
        }

        // Display recipe preview
        function displayRecipePreview(recipe) {
            const previewDiv = document.getElementById('test-recipe-preview');
            const metaDiv = document.getElementById('test-recipe-meta');
            const contentDiv = document.getElementById('test-recipe-content');
            
            if (previewDiv && metaDiv && contentDiv) {
                metaDiv.innerHTML = `
                    <div class="meta-item">
                        <div class="meta-label">Name</div>
                        <div class="meta-value">${recipe.name}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Complexity</div>
                        <div class="meta-value">${recipe.complexity}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Prep Time</div>
                        <div class="meta-value">${recipe.estimatedPrepTime} minutes</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Status</div>
                        <div class="meta-value">${recipe.status}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Tags</div>
                        <div class="meta-value">${recipe.tags.join(', ')}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Created</div>
                        <div class="meta-value">${new Date(recipe.createdAt).toLocaleString()}</div>
                    </div>
                `;
                
                contentDiv.innerHTML = `
                    <h5>Description</h5>
                    <p>${recipe.description}</p>
                    <h5>Raw Text</h5>
                    <p style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">${recipe.rawText}</p>
                `;
                
                previewDiv.style.display = 'block';
            }
        }

        // Test with sample data
        function testWithSampleData() {
            log('üß™ Testing with sample data...', 'info');
            
            // Fill form with sample data
            document.getElementById('test-recipe-name').value = 'Sample Recipe';
            document.getElementById('test-recipe-description').value = 'This is a sample recipe for testing the upload system. It includes various ingredients and cooking instructions.';
            document.getElementById('test-project-select').value = 'test_project_1';
            
            log('‚úÖ Form filled with sample data', 'success');
        }

        // Clear test form
        function clearTestForm() {
            document.getElementById('test-upload-form').reset();
            document.getElementById('test-recipe-preview').style.display = 'none';
            log('üßπ Test form cleared', 'info');
        }

        // Clear test data
        function clearTestData() {
            try {
                log('üßπ Clearing test data...', 'info');
                
                // Clear test-related localStorage items
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('test_') || key.includes('user_file_test_user')) {
                        localStorage.removeItem(key);
                        log(`üóëÔ∏è Removed: ${key}`, 'info');
                    }
                });
                
                log('‚úÖ Test data cleared', 'success');
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Test data clearing failed: ${error.message}`, 'error');
            }
        }

        // Handle form submission
        document.getElementById('test-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            log('üì§ Test upload form submitted', 'info');
            
            const formData = new FormData(e.target);
            const projectId = formData.get('test-project-select') || document.getElementById('test-project-select').value;
            const recipeName = formData.get('test-recipe-name') || document.getElementById('test-recipe-name').value;
            const description = formData.get('test-recipe-description') || document.getElementById('test-recipe-description').value;
            const pdfFile = document.getElementById('test-pdf-file').files[0];
            
            if (!pdfFile) {
                log('‚ùå No PDF file selected', 'error');
                return;
            }
            
            log(`üìÑ Processing PDF: ${pdfFile.name} (${pdfFile.size} bytes)`, 'info');
            
            // Show progress
            const progressDiv = document.getElementById('test-progress');
            const progressFill = document.getElementById('test-progress-fill');
            const progressText = document.getElementById('test-progress-text');
            
            if (progressDiv) {
                progressDiv.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = 'Starting PDF processing...';
            }
            
            // Simulate PDF processing
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                if (progressFill) progressFill.style.width = progress + '%';
                if (progressText) progressText.textContent = `Processing... ${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    if (progressText) progressText.textContent = 'Processing complete!';
                    
                    // Create test recipe
                    const testRecipe = {
                        id: 'upload_test_' + Date.now(),
                        name: recipeName,
                        description: description,
                        projectId: projectId,
                        sourceFile: pdfFile.name,
                        uploadedAt: new Date().toISOString(),
                        rawText: 'Sample extracted text from PDF for testing purposes.',
                        status: 'uploaded',
                        type: 'pdf_upload',
                        userId: 'test_user',
                        userName: 'Test Chef',
                        complexity: 'medium',
                        estimatedPrepTime: 45,
                        tags: ['uploaded', 'test', 'pdf']
                    };
                    
                    // Save to storage
                    if (window.userControlledStorage) {
                        window.userControlledStorage.saveUserFile('test_user/uploaded_recipes.json', [testRecipe]);
                    }
                    
                    // Display preview
                    displayRecipePreview(testRecipe);
                    
                    log('‚úÖ Test upload completed successfully', 'success');
                    
                    // Hide progress after delay
                    setTimeout(() => {
                        if (progressDiv) progressDiv.style.display = 'none';
                    }, 2000);
                }
            }, 200);
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Test page loaded', 'info');
            
            // Wait for systems to initialize
            setTimeout(() => {
                updateSystemStatus();
                log('‚è≥ Systems initialized, status updated', 'info');
            }, 1000);
            
            // Update status periodically
            setInterval(updateSystemStatus, 10000);
        });
    </script>
</body>
</html>
