<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Ingredient Database | Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
    <link rel="stylesheet" href="assets/css/ui-polish.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    
    <!-- Load Enhanced User Management System -->
    <!-- Enhanced User Management now handled by Firebase Auth -->
    <script src="assets/js/project-management-system.js"></script>
    <!-- Project management now handled by new system -->
    <script src="assets/js/error_handler.js"></script>
    
    <!-- Base Ingredients Loader -->
    <script src="assets/js/base-ingredients-loader.js"></script>
    <script defer src="assets/js/import-service.js"></script>
    
    <!-- State Persistence -->
    <script src="assets/js/state-persistence-manager.js"></script>
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
    <style>
        .catalog-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .catalog-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .catalog-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 14px;
            border: 1px dashed rgba(99, 102, 241, 0.32);
            background: rgba(99, 102, 241, 0.06);
        }

        .catalog-card h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .catalog-card p {
            margin: 6px 0;
            font-size: 0.85rem;
            color: #475569;
        }

        .catalog-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
            color: #475569;
        }

        .catalog-meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.05);
            color: #1f2937;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" style="padding-top: 80px;">
    <!-- Header injected by unified-nav-header.js -->

    <!-- Main Content -->
    <main style="padding: 20px;">
        <div class="container">
            <div class="page-header">
                <h1 class="heading-1">Master Ingredient Database</h1>
                <p class="body-large">Comprehensive ingredient management with nutritional data, suppliers, and cost tracking.</p>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
                <button onclick="window.baseIngredientsLoader.showImportModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span>üì¶</span>
                    <span>Import Base Database (100+ Ingredients)</span>
                </button>
                <button onclick="window.location.href='bulk-ingredient-import.html'" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <span>üì•</span>
                    <span>Bulk Import Ingredients</span>
                </button>
                <button onclick="window.importService?.openIngredientCSVImport()" class="btn btn-secondary">
                    <span>üìÑ</span>
                    <span>Import Ingredient CSV</span>
                </button>
                <button onclick="window.importService?.openIngredientURLImport()" class="btn btn-secondary">
                    <span>üîó</span>
                    <span>Bulk URL Import</span>
                </button>
                <button onclick="window.location.href='price-list-upload.html'" class="btn btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <span>üí∞</span>
                    <span>Upload Price List</span>
                </button>
            </div>

            <!-- Add New Ingredient Section -->
            <div class="card mb-6">
                <div class="catalog-section">
                    <h3>üìö Quick Add from Catalogs</h3>
                    <p style="color: #475569; font-size: 0.9rem; margin-bottom: 12px;">
                        Import curated ingredient packs to jump-start your pantry. Review items before they enter your database.
                    </p>
                    <div id="ingredient-catalog-list" class="catalog-list"></div>
                </div>
            </div>

            <div class="card mb-6">
                <h2 class="heading-2">Add Single Ingredient</h2>
                <form id="add-ingredient-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-name" class="form-label">Ingredient Name</label>
                            <input type="text" id="ingredient-name" class="form-input" placeholder="e.g., Organic Kale" required>
                        </div>
                        <div class="form-group">
                            <label for="ingredient-category" class="form-label">Category</label>
                            <select id="ingredient-category" class="form-select" required>
                                <option value="">Select category</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="proteins">Proteins</option>
                                <option value="grains">Grains</option>
                                <option value="dairy">Dairy</option>
                                <option value="spices">Spices & Herbs</option>
                                <option value="oils">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-unit" class="form-label">Base Unit</label>
                            <select id="ingredient-unit" class="form-select" required>
                                <option value="g">Grams (g)</option>
                                <option value="kg">Kilograms (kg)</option>
                                <option value="ml">Milliliters (ml)</option>
                                <option value="l">Liters (l)</option>
                                <option value="piece">Piece</option>
                                <option value="bunch">Bunch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ingredient-cost" class="form-label">Cost per Unit</label>
                            <input type="number" id="ingredient-cost" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-supplier" class="form-label">Primary Supplier</label>
                            <input type="text" id="ingredient-supplier" class="form-input" placeholder="Supplier name">
                        </div>
                        <div class="form-group">
                            <label for="ingredient-url" class="form-label">URL Import</label>
                            <div class="flex gap-2">
                                <input type="url" id="ingredient-url" class="form-input" placeholder="Paste ingredient URL">
                                <button type="button" class="btn btn-secondary" onclick="previewURLImport()">Preview</button>
                            </div>
                        </div>
                    </div>

                <div id="ingredient-import-preview" style="display: none; margin-top: 18px; border: 1px dashed #cbd5e1; border-radius: 14px; padding: 18px; background: #f8fafc;">
                    <div class="flex items-center gap-3 text-sm text-slate-500">
                        <span>üîé</span>
                        <span>Paste a supplier or product link above and choose Preview to auto-fill ingredient details.</span>
                    </div>
                </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">‚ûï Add Ingredient</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Search and Filter Section -->
            <div class="card mb-6">
                <h2 class="heading-2">Search Ingredients</h2>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="search-query" class="form-label">Search</label>
                        <input type="text" id="search-query" class="form-input" placeholder="Search ingredients...">
                    </div>
                    <div class="form-group">
                        <label for="filter-category" class="form-label">Category</label>
                        <select id="filter-category" class="form-select">
                            <option value="">All Categories</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="fruits">Fruits</option>
                            <option value="proteins">Proteins</option>
                            <option value="grains">Grains</option>
                            <option value="dairy">Dairy</option>
                            <option value="spices">Spices & Herbs</option>
                            <option value="oils">Oils & Fats</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-supplier" class="form-label">Supplier</label>
                        <select id="filter-supplier" class="form-select">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-by" class="form-label">Sort By</label>
                        <select id="sort-by" class="form-select">
                            <option value="name">Name</option>
                            <option value="category">Category</option>
                            <option value="cost">Cost</option>
                            <option value="date-added">Date Added</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="searchIngredients()">üîç Search</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>

            <!-- Ingredients Grid -->
            <div id="ingredients-container">
                <div class="grid-3-col" id="ingredients-grid">
                    <!-- Ingredients will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Essential Scripts -->
    <script>
        // Main initialization - Single entry point
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM Loaded - Initializing Ingredients Page');
            
            // Setup event listeners first
            setupEventListeners();
            
            // Wait a moment for auth to be ready
            await waitForAuth();
            
            // Load ingredients
            await loadIngredientsDatabase();
            renderIngredientCatalogList();
            
            console.log('‚úÖ Ingredients Page Ready');
        });

        let pendingIngredientImport = null;
        let ingredientCatalogManifest = null;
        const ingredientCatalogCache = {};

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        async function waitForAuth() {
            console.log('‚è≥ Waiting for auth...');
            let attempts = 0;
            while (attempts < 30 && !window.authManager?.currentUser) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            console.log('‚úÖ Auth ready');
        }

        async function loadIngredientsDatabase() {
            console.log('ü•¨ Loading Ingredients Database...');
            
            // Check if ingredients already exist in localStorage
            const storedIngredients = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
            
            if (storedIngredients && storedIngredients !== '[]') {
                // Load from cache immediately
                try {
                    const cached = JSON.parse(storedIngredients);
                    console.log(`üì¶ Found ${cached.length} cached ingredients`);
                    displayIngredients(cached);
                    updateStats(cached);
                    return;
                } catch (e) {
                    console.error('‚ùå Error parsing cached ingredients:', e);
                }
            }
            
            // Show loading and fetch from database
            console.log('üì• Fetching ingredients from database...');
            showLoadingState();
            await directImportAndDisplay();
        }
        
        function showLoadingState() {
            const grid = document.getElementById('ingredients-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: #0f172a;">Loading Ingredients...</h2>
                        <p style="color: #64748b; margin-bottom: 15px;">Please wait while we import the ingredient database.</p>
                        <div class="loading-spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #5a67d8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                `;
            }
        }
        
        async function directImportAndDisplay() {
            console.log('üöÄ Fetching ingredients database from file...');
            
            try {
                // Direct fetch with absolute path
                const response = await fetch('data/base-ingredients-database.json');
                
                console.log('üì° Fetch response:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Database file not found (${response.status})`);
                }
                
                const database = await response.json();
                
                if (!database || !database.ingredients) {
                    throw new Error('Invalid database format');
                }
                
                const ingredients = database.ingredients;
                console.log(`‚úÖ Loaded ${ingredients.length} ingredients from database`);
                
                // Save to localStorage (both keys for compatibility)
                localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
                localStorage.setItem('ingredients', JSON.stringify(ingredients));
                
                console.log(`üíæ Saved ${ingredients.length} ingredients to localStorage`);
                
                // Display immediately
                console.log(`üé® Displaying ${ingredients.length} ingredients...`);
                displayIngredients(ingredients);
                updateStats(ingredients);
                
                console.log(`‚úÖ SUCCESS: ${ingredients.length} ingredients displayed!`);
                
            } catch (error) {
                console.error('‚ùå Error loading ingredients:', error);
                
                // Try to load from localStorage as fallback
                const stored = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
                if (stored && stored !== '[]') {
                    try {
                        const ingredients = JSON.parse(stored);
                        console.log(`üì¶ Fallback: Loaded ${ingredients.length} ingredients from cache`);
                        displayIngredients(ingredients);
                        updateStats(ingredients);
                    } catch (parseError) {
                        console.error('‚ùå Error parsing cached ingredients:', parseError);
                        showErrorState(error);
                    }
                } else {
                    showErrorState(error);
                }
            }
        }
        
        function showErrorState(error) {
            const grid = document.getElementById('ingredients-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ùå</div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: #dc2626;">Error Loading Ingredients</h2>
                        <p style="color: #64748b; margin-bottom: 15px;">Could not load ingredient database.</p>
                        <p style="color: #64748b; margin-bottom: 25px; font-family: monospace; background: #fee2e2; padding: 12px; border-radius: 8px;">Error: ${error.message}</p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="location.reload()">üîÑ Reload Page</button>
                            <button class="btn btn-secondary" onclick="directImportAndDisplay()">üì• Try Import Again</button>
                            <button class="btn btn-secondary" onclick="window.open('https://console.firebase.google.com/project/iterum-culinary-app', '_blank')">üîß Check Firebase</button>
                        </div>
                    </div>
                `;
            }
        }

        // Check and auto-import ingredients on first load
        function checkAndAutoImportIngredients() {
            const ingredientsDb = localStorage.getItem('ingredients_database');
            const ingredients = localStorage.getItem('ingredients');
            
            // If both are empty or null, trigger auto-import
            if ((!ingredientsDb || ingredientsDb === '[]') && (!ingredients || ingredients === '[]')) {
                console.log('üì¶ No ingredients found, triggering auto-import...');
                
                // Show loading message
                const grid = document.getElementById('ingredients-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Loading Ingredients Database...</div>
                            <div style="color: #64748b;">Importing professional culinary ingredients</div>
                        </div>
                    `;
                }
                
                // Auto-import after a brief delay to let scripts load
                setTimeout(() => {
                    autoImportBaseIngredients();
                }, 500);
            }
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
            }
        }

        function initializeProjectSelector() {
            if (window.projectManager) {
                window.projectManager.loadUserProjects();
            }
        }

        function setupEventListeners() {
            // Form submission
            document.getElementById('add-ingredient-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addIngredient();
            });

            // Search input
            document.getElementById('search-query').addEventListener('input', function() {
                searchIngredients();
            });

            // Filter changes
            document.getElementById('filter-category').addEventListener('change', searchIngredients);
            document.getElementById('filter-supplier').addEventListener('change', searchIngredients);
            document.getElementById('sort-by').addEventListener('change', searchIngredients);
        }

        function loadIngredients() {
            // Load ingredients from localStorage
            let ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            
            // Fallback to old key if database is empty
            if (ingredients.length === 0) {
                ingredients = JSON.parse(localStorage.getItem('ingredients') || '[]');
            }
            
            console.log(`üìä Displaying ${ingredients.length} ingredients`);
            
            displayIngredients(ingredients);
            updateStats(ingredients);
        }
        window.refreshIngredientsView = loadIngredients;
        
        function updateStats(ingredients) {
            // Update stats at top of page
            const totalEl = document.querySelector('.stat-value');
            if (totalEl) {
                totalEl.textContent = ingredients.length;
            }
        }

        function displayIngredients(ingredients) {
            const grid = document.getElementById('ingredients-grid');
            
            if (!grid) {
                console.error('‚ùå Ingredients grid not found');
                return;
            }
            
            grid.innerHTML = '';

            if (!ingredients || ingredients.length === 0) {
                // Check if we're still loading
                const isLoading = !localStorage.getItem('ingredients_database') && !localStorage.getItem('ingredients');
                
                if (isLoading) {
                    grid.innerHTML = `
                        <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">Loading Ingredients...</h2>
                            <p style="color: #64748b; margin-bottom: 15px;">Please wait while we import the ingredient database.</p>
                            <div class="loading-spinner" style="margin: 20px auto;"></div>
                        </div>
                    `;
                } else {
                    grid.innerHTML = `
                        <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">ü•¨</div>
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">No Ingredients Found</h2>
                            <p style="color: #64748b; margin-bottom: 25px;">The ingredient database appears to be empty.</p>
                            <button class="btn" onclick="directImportAndDisplay()">üîÑ Reload Database</button>
                        </div>
                    `;
                }
                return;
            }

            console.log(`‚úÖ Displaying ${ingredients.length} ingredients`);

            ingredients.forEach(ingredient => {
                const card = createIngredientCard(ingredient);
                grid.appendChild(card);
            });
        }

        function createIngredientCard(ingredient) {
            const card = document.createElement('div');
            card.className = 'card card-hover';
            card.innerHTML = `
                <div class="card-header-gradient">
                    <div class="card-title">${ingredient.name}</div>
                    <div class="card-subtitle">${ingredient.category}</div>
                </div>
                <div class="card-body">
                    <div class="stats-row mb-4">
                        <div class="stat-item-centered">
                            <div class="stat-value text-primary">$${(ingredient.cost || 0).toFixed(2)}</div>
                            <div class="stat-label">Cost</div>
                        </div>
                        <div class="stat-item-centered">
                            <div class="stat-value text-primary">${ingredient.unit || 'g'}</div>
                            <div class="stat-label">Unit</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-sm btn-secondary" onclick="editIngredient('${ingredient.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="viewIngredient('${ingredient.id}')">üëÅÔ∏è View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteIngredient('${ingredient.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            return card;
        }

        function addIngredient() {
            const formData = new FormData(document.getElementById('add-ingredient-form'));
            const ingredient = {
                id: 'ing_' + Date.now(),
                name: document.getElementById('ingredient-name').value,
                category: document.getElementById('ingredient-category').value,
                unit: document.getElementById('ingredient-unit').value,
                cost: parseFloat(document.getElementById('ingredient-cost').value) || 0,
                supplier: document.getElementById('ingredient-supplier').value,
                dateAdded: new Date().toISOString(),
                costCurrency: 'USD'
            };

            // Validate required fields
            if (!ingredient.name || !ingredient.category) {
                alert('Please fill in ingredient name and category');
                return;
            }

            const importUrl = document.getElementById('ingredient-url').value.trim();
            if (pendingIngredientImport && (!pendingIngredientImport.url || pendingIngredientImport.url === importUrl)) {
                const meta = pendingIngredientImport;
                ingredient.source_url = meta.url;
                ingredient.source_host = meta.site;
                ingredient.description = meta.description || '';
                ingredient.image = meta.image || '';
                ingredient.tags = meta.tags || [];
                ingredient.costCurrency = meta.costCurrency || 'USD';
                if (meta.cost && !formData.get('ingredient-cost')) {
                    ingredient.cost = parseFloat(meta.cost) || ingredient.cost;
                }
                if (meta.supplier && !ingredient.supplier) {
                    ingredient.supplier = meta.supplier;
                }
                if (meta.unit && ingredient.unit === '') {
                    ingredient.unit = meta.unit;
                }
                if (meta.nutritionalInfo) {
                    ingredient.nutritional_info = meta.nutritionalInfo;
                }
            }

            // Load from primary database
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            ingredients.push(ingredient);
            
            // Save to BOTH storage keys for compatibility
            localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
            localStorage.setItem('ingredients', JSON.stringify(ingredients));

            // Refresh display
            loadIngredients();
            clearForm();
            pendingIngredientImport = null;
            renderImportPreview('reset');
            
            console.log('‚úÖ Ingredient added:', ingredient);
            alert(`‚úÖ Ingredient "${ingredient.name}" added successfully!`);
        }

        function clearForm() {
            document.getElementById('add-ingredient-form').reset();
            pendingIngredientImport = null;
            renderImportPreview('reset');
        }

        function autoImportBaseIngredients() {
            console.log('üöÄ Auto-importing base ingredients...');
            
            if (window.baseIngredientsLoader) {
                // Check if base database exists
                window.baseIngredientsLoader.loadBaseDatabase().then(database => {
                    if (database && database.ingredients && database.ingredients.length > 0) {
                        console.log(`üì¶ Found ${database.ingredients.length} base ingredients, importing...`);
                        
                        // Import without confirmation
                        window.baseIngredientsLoader.importToLocalStorage(false).then(result => {
                            if (result.success) {
                                console.log(`‚úÖ Auto-imported ${result.total} ingredients!`);
                                loadIngredients(); // Reload display
                            }
                        });
                    } else {
                        console.log('‚ö†Ô∏è No base ingredients database found');
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Base ingredients loader not available');
            }
        }

        function searchIngredients() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const supplier = document.getElementById('filter-supplier').value;
            const sortBy = document.getElementById('sort-by').value;

            let ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');

            // Filter
            ingredients = ingredients.filter(ingredient => {
                const matchesQuery = !query || ingredient.name.toLowerCase().includes(query);
                const matchesCategory = !category || ingredient.category === category;
                const matchesSupplier = !supplier || ingredient.supplier === supplier;
                return matchesQuery && matchesCategory && matchesSupplier;
            });

            // Sort
            ingredients.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'category': return a.category.localeCompare(b.category);
                    case 'cost': return a.cost - b.cost;
                    case 'date-added': return new Date(b.dateAdded) - new Date(a.dateAdded);
                    default: return 0;
                }
            });

            displayIngredients(ingredients);
        }

        function resetFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-supplier').value = '';
            document.getElementById('sort-by').value = 'name';
            searchIngredients();
        }

        function previewURLImport() {
            const urlInput = document.getElementById('ingredient-url');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a URL to import from');
                return;
            }
            
            if (!isValidUrl(url)) {
                alert('Please enter a valid URL (including https://)');
                return;
            }

            console.log('üîó Previewing ingredient import from:', url);
            renderImportPreview('loading');

            fetchIngredientMetadata(url)
                .then((metadata) => {
                    pendingIngredientImport = metadata;
                    applyMetadataToForm(metadata);
                    renderImportPreview('success', metadata);
                    showToast('‚úÖ Ingredient info imported from URL!', 'success');
                })
                .catch((error) => {
                    console.error('‚ùå Ingredient URL import failed:', error);
                    pendingIngredientImport = null;
                    renderImportPreview('error', error.message || 'Could not extract ingredient information. Please fill fields manually.');
                    showToast('‚ö†Ô∏è Could not import details from that link. Please fill manually.', 'warning');
                });
        }

        function isValidUrl(url) {
            try {
                const parsed = new URL(url);
                return parsed.protocol === 'https:' || parsed.protocol === 'http:';
            } catch (_) {
                return false;
            }
        }

        function renderImportPreview(state, data) {
            const preview = document.getElementById('ingredient-import-preview');
            if (!preview) return;

            switch (state) {
                case 'loading':
                    preview.style.display = 'block';
                    preview.innerHTML = `
                        <div style="display: flex; gap: 12px; align-items: center; color: #334155;">
                            <div class="loading-spinner" style="width: 28px; height: 28px; border: 3px solid #cbd5e1; border-top-color: #5a67d8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <div>
                                <div style="font-weight: 600;">Scraping ingredient details‚Ä¶</div>
                                <div style="font-size: 0.85rem; color: #64748b;">We‚Äôre parsing product metadata, nutrition, and pricing clues.</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'error':
                    preview.style.display = 'block';
                    preview.innerHTML = `
                        <div style="display: flex; gap: 12px; align-items: flex-start; color: #b91c1c;">
                            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                            <div>
                                <div style="font-weight: 600;">Import unavailable</div>
                                <div style="font-size: 0.85rem; color: #64748b;">${escapeHtml(data || 'We couldn‚Äôt read that page. Try another link or fill the form manually.')}</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'success':
                    preview.style.display = 'block';
                    preview.innerHTML = `
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <span style="font-size: 1.4rem;">üìù</span>
                                <div>
                                    <div style="font-weight: 600; color: #0f172a;">${escapeHtml(data.name || 'Unnamed ingredient')}</div>
                                    ${data.description ? `<div style="font-size: 0.85rem; color: #475569; margin-top: 4px;">${escapeHtml(data.description)}</div>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${data.category ? `<span style="background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">${escapeHtml(data.category)}</span>` : ''}
                                ${data.supplier ? `<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">Vendor: ${escapeHtml(data.supplier)}</span>` : ''}
                                ${data.cost ? `<span style="background: #dcfce7; color: #047857; padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">Cost: ${escapeHtml(data.costCurrency || 'USD')} ${escapeHtml(data.cost.toString())}</span>` : ''}
                                ${data.unit ? `<span style="background: #ede9fe; color: #5b21b6; padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">Unit: ${escapeHtml(data.unit)}</span>` : ''}
                            </div>
                            ${data.nutritionalInfo ? `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                    ${data.nutritionalInfo.calories ? `<div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                                        <div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em;">Calories</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #111827;">${escapeHtml(data.nutritionalInfo.calories.toString())}</div>
                                    </div>` : ''}
                                    ${data.nutritionalInfo.protein ? `<div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                                        <div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em;">Protein</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #111827;">${escapeHtml(data.nutritionalInfo.protein.toString())} g</div>
                                    </div>` : ''}
                                    ${data.nutritionalInfo.fat ? `<div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                                        <div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em;">Fat</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #111827;">${escapeHtml(data.nutritionalInfo.fat.toString())} g</div>
                                    </div>` : ''}
                                    ${data.nutritionalInfo.carbohydrates ? `<div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                                        <div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em;">Carbs</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #111827;">${escapeHtml(data.nutritionalInfo.carbohydrates.toString())} g</div>
                                    </div>` : ''}
                                </div>
                            ` : ''}
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75rem; color: #64748b;">
                                <span>Source:</span>
                                <a href="${escapeHtml(data.url)}" target="_blank" rel="noopener" style="color: #2563eb; font-weight: 600;">${escapeHtml(data.site || data.url)}</a>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    preview.style.display = 'none';
                    preview.innerHTML = `
                        <div class="flex items-center gap-3 text-sm text-slate-500">
                            <span>üîé</span>
                            <span>Paste a supplier or product link above and choose Preview to auto-fill ingredient details.</span>
                        </div>
                    `;
            }
        }

        async function loadIngredientCatalogManifest() {
            if (ingredientCatalogManifest) return ingredientCatalogManifest;
            try {
                const response = await fetch('data/catalogs/ingredients-manifest.json');
                if (!response.ok) throw new Error('Manifest not found');
                ingredientCatalogManifest = await response.json();
                return ingredientCatalogManifest;
            } catch (error) {
                console.error('Failed to load ingredient catalog manifest:', error);
                return { packs: [] };
            }
        }

        async function fetchIngredientCatalogPack(packId) {
            if (ingredientCatalogCache[packId]) return ingredientCatalogCache[packId];
            const manifest = await loadIngredientCatalogManifest();
            const packMeta = manifest.packs.find(pack => pack.id === packId);
            if (!packMeta) {
                console.warn('Catalog pack not found:', packId);
                return null;
            }
            try {
                const response = await fetch(`data/catalogs/${packMeta.file}`);
                if (!response.ok) throw new Error(`Pack file missing: ${packMeta.file}`);
                const pack = await response.json();
                ingredientCatalogCache[packId] = { meta: packMeta, data: pack };
                return ingredientCatalogCache[packId];
            } catch (error) {
                console.error('Failed to load catalog pack:', error);
                return null;
            }
        }

        async function renderIngredientCatalogList() {
            const container = document.getElementById('ingredient-catalog-list');
            if (!container) return;

            const manifest = await loadIngredientCatalogManifest();
            if (!manifest.packs.length) {
                container.innerHTML = `<div style="color:#64748b;">No ingredient catalogs available yet.</div>`;
                return;
            }

            const cards = await Promise.all(manifest.packs.map(async pack => {
                const packBundle = await fetchIngredientCatalogPack(pack.id);
                const itemCount = packBundle?.data?.items?.length || 0;
                return `
                    <div class="catalog-card">
                        <div>
                            <h4>${pack.name}</h4>
                            <p>${pack.description}</p>
                            <div class="catalog-meta">
                                <span>üì¶ ${itemCount} items</span>
                                ${pack.tags?.map(tag => `<span>#${tag}</span>`).join('') || ''}
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="openIngredientCatalogModal('${pack.id}')">
                            Review Pack
                        </button>
                    </div>
                `;
            }));

            container.innerHTML = cards.join('');
        }

        function addIngredientFromCatalog(item, packMeta) {
            const current = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const duplicate = current.some(existing => existing.name.toLowerCase() === item.name.toLowerCase());
            if (duplicate) {
                console.log('Skipping duplicate ingredient:', item.name);
                return false;
            }

            const now = new Date().toISOString();
            const generatedId = `ing_catalog_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`;

            const ingredient = {
                id: generatedId,
                name: item.name,
                category: item.category || 'other',
                unit: item.defaultUnit || item.unit || 'g',
                cost: typeof item.cost === 'number' ? item.cost : 0,
                costPer: item.costPer || item.unit || item.defaultUnit || 'unit',
                supplier: item.supplier || '',
                storage: item.storage || 'dry',
                shelfLifeDays: item.shelfLifeDays || null,
                dateAdded: now,
                costCurrency: item.costCurrency || 'USD',
                catalogSource: packMeta?.id || 'catalog',
                catalogName: packMeta?.name || '',
                status: 'Active'
            };

            current.push(ingredient);
            localStorage.setItem('ingredients_database', JSON.stringify(current));
            localStorage.setItem('ingredients', JSON.stringify(current));
            return true;
        }

        async function openIngredientCatalogModal(packId) {
            const packBundle = await fetchIngredientCatalogPack(packId);
            if (!packBundle) {
                alert('Could not load catalog pack.');
                return;
            }

            const { meta, data } = packBundle;
            const items = data.items || [];
            if (!items.length) {
                alert('No items found in this catalog pack.');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'ingredient-catalog-modal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.55);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; width: min(700px, 92vw); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white;">
                        <h2 style="margin: 0; font-size: 1.2rem; font-weight: 600;">Import from ${meta.name}</h2>
                    </div>
                    <div style="padding: 20px 24px; flex: 1; overflow-y: auto;">
                        <p style="color: #475569; font-size: 0.9rem; margin-bottom: 16px;">
                            Select the ingredients you wish to add. You can edit costing and details after import.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${items.map((item, index) => `
                                <label style="display:flex; gap:12px; padding:12px; border:1px solid #e2e8f0; border-radius:12px;">
                                    <input type="checkbox" class="ingredient-catalog-checkbox" data-pack="${packId}" data-index="${index}" checked>
                                    <div>
                                        <div style="font-weight:600; color:#1f2937;">${item.name}</div>
                                        <div style="font-size:0.85rem; color:#475569; margin-top:4px;">
                                            ${item.category || 'Uncategorized'}${item.unit ? ' ‚Ä¢ Unit: ' + (item.defaultUnit || item.unit) : ''}
                                        </div>
                                        <div style="font-size:0.8rem; color:#64748b; margin-top:6px;">
                                            ${typeof item.cost === 'number' ? `Cost: $${item.cost.toFixed(2)} / ${item.costPer || item.unit || 'unit'}` : 'Cost: ‚Äî'}
                                            ${item.supplier ? ` ‚Ä¢ Supplier: ${item.supplier}` : ''}
                                        </div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
                        <button class="btn btn-secondary" onclick="closeIngredientCatalogModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmIngredientCatalogImport('${packId}')">Import Selected</button>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeIngredientCatalogModal();
                }
            });

            document.body.appendChild(modal);
        }

        function closeIngredientCatalogModal() {
            document.getElementById('ingredient-catalog-modal')?.remove();
        }

        async function confirmIngredientCatalogImport(packId) {
            const modal = document.getElementById('ingredient-catalog-modal');
            if (!modal) return;
            const checkboxes = modal.querySelectorAll('.ingredient-catalog-checkbox:checked');
            if (!checkboxes.length) {
                alert('Select at least one ingredient to import.');
                return;
            }

            const packBundle = await fetchIngredientCatalogPack(packId);
            if (!packBundle) {
                alert('Failed to load catalog data.');
                return;
            }

            const { meta, data } = packBundle;
            const imported = [];
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index, 10);
                const item = data.items[index];
                if (!item) return;
                const success = addIngredientFromCatalog(item, meta);
                if (success) imported.push(item.name);
            });

            closeIngredientCatalogModal();
            if (imported.length) {
                loadIngredients();
                alert(`‚úÖ Imported ${imported.length} catalog ingredient(s).`);
            } else {
                alert('No new ingredients were imported (duplicates may have been skipped).');
            }
        }

        async function fetchIngredientMetadata(url) {
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);

            if (!response.ok) {
                throw new Error(`Request failed (${response.status})`);
            }

            const payload = await response.json();
            if (!payload.contents) {
                throw new Error('No page contents returned from proxy');
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(payload.contents, 'text/html');

            const metadata = {
                url,
                site: new URL(url).hostname.replace('www.', ''),
                name: '',
                description: '',
                category: '',
                supplier: '',
                cost: null,
                costCurrency: 'USD',
                unit: '',
                nutritionalInfo: null,
                image: '',
                tags: []
            };

            // Title / name
            const titleTag = doc.querySelector('title');
            if (titleTag) {
                metadata.name = titleTag.textContent.trim().split('|')[0].split('-')[0].trim();
            }

            const ogTitle = doc.querySelector('meta[property="og:title"]');
            if (ogTitle && !metadata.name) {
                metadata.name = ogTitle.content.trim();
            }

            // Description
            const descriptionTag = doc.querySelector('meta[name="description"]') || doc.querySelector('meta[property="og:description"]');
            if (descriptionTag) {
                metadata.description = descriptionTag.content.trim();
            }

            const ogImage = doc.querySelector('meta[property="og:image"]');
            if (ogImage) {
                metadata.image = ogImage.content.trim();
            }

            const keywordsTag = doc.querySelector('meta[name="keywords"]');
            if (keywordsTag) {
                metadata.tags = keywordsTag.content.split(',').map(k => k.trim()).filter(Boolean);
            }

            // Look for price meta
            const priceMeta = doc.querySelector('meta[property="product:price:amount"]');
            const priceCurrencyMeta = doc.querySelector('meta[property="product:price:currency"]');
            if (priceMeta) {
                const priceValue = parseFloat(priceMeta.content);
                if (!Number.isNaN(priceValue)) {
                    metadata.cost = priceValue;
                }
            }
            if (priceCurrencyMeta) {
                metadata.costCurrency = priceCurrencyMeta.content || metadata.costCurrency;
            }

            // JSON-LD parsing
            const scripts = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
            scripts.forEach(script => {
                try {
                    const json = JSON.parse(script.textContent.trim());
                    const items = Array.isArray(json) ? json : [json];
                    items.forEach(item => {
                        if (!item || typeof item !== 'object') return;
                        const type = Array.isArray(item['@type']) ? item['@type'].join(',').toLowerCase() : String(item['@type'] || '').toLowerCase();

                        if (type.includes('product') || type.includes('menuitem')) {
                            metadata.name = item.name || metadata.name;
                            metadata.description = item.description || metadata.description;
                            metadata.category = item.category || metadata.category;
                            if (item.brand) {
                                metadata.supplier = typeof item.brand === 'string' ? item.brand : item.brand.name || metadata.supplier;
                            }
                            if (item.keywords && !metadata.tags.length) {
                                metadata.tags = Array.isArray(item.keywords) ? item.keywords : String(item.keywords).split(',').map(k => k.trim());
                            }
                            if (item.offers) {
                                const offers = Array.isArray(item.offers) ? item.offers[0] : item.offers;
                                if (offers.price && !metadata.cost) {
                                    const priceValue = parseFloat(offers.price);
                                    if (!Number.isNaN(priceValue)) metadata.cost = priceValue;
                                }
                                if (offers.priceCurrency) metadata.costCurrency = offers.priceCurrency;
                                if (offers.priceSpecification?.unitText) metadata.unit = offers.priceSpecification.unitText;
                            }
                        }

                        if (type.includes('recipe')) {
                            metadata.name = item.name || metadata.name;
                            metadata.description = item.description || metadata.description;
                            metadata.category = item.recipeCategory || metadata.category;
                            if (item.author && typeof item.author === 'object') {
                                metadata.supplier = item.author.name || metadata.supplier;
                            }
                            if (item.keywords && !metadata.tags.length) {
                                metadata.tags = Array.isArray(item.keywords) ? item.keywords : String(item.keywords).split(',').map(k => k.trim());
                            }
                            if (item.nutrition) {
                                metadata.nutritionalInfo = {
                                    calories: parseNutritionValue(item.nutrition.calories),
                                    fat: parseNutritionValue(item.nutrition.fatContent),
                                    protein: parseNutritionValue(item.nutrition.proteinContent),
                                    carbohydrates: parseNutritionValue(item.nutrition.carbohydrateContent)
                                };
                            }
                            if (item.aggregateRating && item.aggregateRating.ratingValue) {
                                metadata.tags.push(`Rating: ${item.aggregateRating.ratingValue}`);
                            }
                        }

                        if (item.nutrition && !metadata.nutritionalInfo) {
                            metadata.nutritionalInfo = {
                                calories: parseNutritionValue(item.nutrition.calories),
                                fat: parseNutritionValue(item.nutrition.fatContent),
                                protein: parseNutritionValue(item.nutrition.proteinContent),
                                carbohydrates: parseNutritionValue(item.nutrition.carbohydrateContent)
                            };
                        }
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to parse JSON-LD', error);
                }
            });

            if (!metadata.name) {
                metadata.name = metadata.site.split('.')[0].replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }

            // Fallback for supplier
            if (!metadata.supplier && metadata.site) {
                metadata.supplier = metadata.site.split('.')[0].charAt(0).toUpperCase() + metadata.site.split('.')[0].slice(1);
            }

            return metadata;
        }

        function parseNutritionValue(value) {
            if (!value) return null;
            if (typeof value === 'number') return value;
            const numeric = parseFloat(String(value).replace(/[^0-9.]+/g, ''));
            if (Number.isNaN(numeric)) return null;
            return numeric;
        }

        function applyMetadataToForm(metadata) {
            const highlight = (element) => {
                if (!element) return;
                element.classList.add('import-highlight');
                element.style.background = '#ecfdf5';
                setTimeout(() => {
                    element.style.background = '';
                    element.classList.remove('import-highlight');
                }, 2000);
            };

            const nameField = document.getElementById('ingredient-name');
            if (metadata.name && nameField && !nameField.value) {
                nameField.value = metadata.name;
                highlight(nameField);
            }

            const supplierField = document.getElementById('ingredient-supplier');
            if (metadata.supplier && supplierField) {
                supplierField.value = metadata.supplier;
                highlight(supplierField);
            }

            const costField = document.getElementById('ingredient-cost');
            if (metadata.cost && costField) {
                costField.value = metadata.cost;
                highlight(costField);
            }

            const unitSelect = document.getElementById('ingredient-unit');
            if (metadata.unit && unitSelect) {
                const normalized = metadata.unit.toLowerCase();
                let matchingOption = Array.from(unitSelect.options).find(opt => opt.value === normalized || opt.text.toLowerCase() === normalized);
                if (!matchingOption && normalized.length <= 6) {
                    matchingOption = new Option(metadata.unit, normalized, false, true);
                    unitSelect.add(matchingOption);
                }
                if (matchingOption) {
                    unitSelect.value = matchingOption.value;
                    highlight(unitSelect);
                }
            }

            const categorySelect = document.getElementById('ingredient-category');
            if (metadata.category && categorySelect) {
                const normalizedCategory = metadata.category.toLowerCase();
                const matchingOption = Array.from(categorySelect.options).find(opt => opt.value === normalizedCategory);
                if (matchingOption) {
                    categorySelect.value = matchingOption.value;
                } else {
                    categorySelect.value = 'other';
                }
                highlight(categorySelect);
            }
        }

        function viewIngredient(id) {
            console.log('üëÅÔ∏è Viewing ingredient:', id);
            
            // Get ingredient
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            const ingredient = ingredients.find(i => i.id === id);
            
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            // Build nutritional info
            const nutritionHTML = ingredient.nutritional_info ? `
                <div style="padding: 25px; background: #f8fafc; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üìä</span> Nutritional Information (per 100g)
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        ${ingredient.nutritional_info.calories ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #5a67d8;">${ingredient.nutritional_info.calories}</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Calories</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.protein ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${ingredient.nutritional_info.protein}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Protein</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.fat ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${ingredient.nutritional_info.fat}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Fat</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.carbohydrates ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${ingredient.nutritional_info.carbohydrates}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Carbs</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '';
            
            // Build vendor info
            const vendorHTML = ingredient.preferred_vendor || ingredient.vendor_info ? `
                <div style="padding: 25px; background: white; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üè™</span> Vendor Information
                    </h3>
                    <div style="padding: 15px; background: #dbeafe; border-radius: 12px;">
                        <div style="font-weight: 700; color: #1e40af; margin-bottom: 8px;">${ingredient.preferred_vendor || 'No vendor specified'}</div>
                        ${ingredient.vendor_info ? `<div style="color: #1e40af; font-size: 0.9rem;">${ingredient.vendor_info}</div>` : ''}
                    </div>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 90px rgba(0,0,0,0.5);">
                    
                    <!-- Header -->
                    <div style="padding: 30px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.5rem; cursor: pointer; color: white;">
                            ‚úï
                        </button>
                        <h2 style="font-size: 2rem; font-weight: 700; margin: 0 0 12px 0;">ü•¨ ${ingredient.name}</h2>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <span style="background: rgba(255,255,255,0.25); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                ${ingredient.category}
                            </span>
                            ${ingredient.avg_price_per_lb ? `
                                <span style="background: rgba(255,255,255,0.25); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                    $${ingredient.avg_price_per_lb}/lb
                                </span>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Content -->
                    <div style="overflow-y: auto; flex: 1;">
                        
                        <!-- Basic Info -->
                        <div style="padding: 25px; background: white; border-bottom: 2px solid #f1f5f9;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                ${ingredient.default_unit ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Default Unit</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.default_unit}</div>
                                    </div>
                                ` : ''}
                                ${ingredient.storage ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Storage</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.storage}</div>
                                    </div>
                                ` : ''}
                                ${ingredient.shelf_life_days ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Shelf Life</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.shelf_life_days} days</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Nutritional Info -->
                        ${nutritionHTML}

                        <!-- Vendor -->
                        ${vendorHTML}

                        <!-- Allergens & Dietary -->
                        ${ingredient.allergens && ingredient.allergens.length > 0 ? `
                            <div style="padding: 20px 25px; background: #fef3c7; border-bottom: 2px solid #fbbf24;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #92400e; margin: 0 0 15px 0;">‚ö†Ô∏è Allergens</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.allergens.map(a => `
                                        <span style="background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${a}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${ingredient.dietary && ingredient.dietary.length > 0 ? `
                            <div style="padding: 20px 25px; background: #dcfce7; border-bottom: 2px solid #10b981;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #15803d; margin: 0 0 15px 0;">üå± Dietary</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.dietary.map(d => `
                                        <span style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${d}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Substitutes -->
                        ${ingredient.substitutes && ingredient.substitutes.length > 0 ? `
                            <div style="padding: 25px; background: #f8fafc;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0 0 15px 0;">üîÑ Substitutes</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.substitutes.map(s => `
                                        <span style="background: #e0e7ff; color: #3730a3; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${s}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 25px; background: white; border-top: 2px solid #e5e7eb; display: flex; gap: 12px;">
                        <button onclick="editIngredient('${ingredient.id}'); this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 14px 28px; background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        function editIngredient(id) {
            console.log('‚úèÔ∏è Editing ingredient:', id);
            
            // Get ingredient
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            const ingredient = ingredients.find(i => i.id === id);
            const index = ingredients.findIndex(i => i.id === id);
            
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }
            
            // Close any open modals
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 90px rgba(0,0,0,0.5);">
                    
                    <!-- Header -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">
                        <h2 style="font-size: 1.8rem; font-weight: 700; margin: 0;">‚úèÔ∏è Edit Ingredient</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">${ingredient.name}</p>
                    </div>

                    <!-- Form -->
                    <div style="overflow-y: auto; flex: 1; padding: 25px;">
                        
                        <!-- Name -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Ingredient Name</label>
                            <input type="text" id="edit-ing-name" value="${ingredient.name}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; color: #0f172a; font-weight: 600;">
                        </div>

                        <!-- Category & Unit -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Category</label>
                                <input type="text" id="edit-ing-category" value="${ingredient.category}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Default Unit</label>
                                <select id="edit-ing-unit" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                    <option value="lb" ${ingredient.default_unit === 'lb' ? 'selected' : ''}>lb</option>
                                    <option value="kg" ${ingredient.default_unit === 'kg' ? 'selected' : ''}>kg</option>
                                    <option value="oz" ${ingredient.default_unit === 'oz' ? 'selected' : ''}>oz</option>
                                    <option value="g" ${ingredient.default_unit === 'g' ? 'selected' : ''}>g</option>
                                    <option value="ea" ${ingredient.default_unit === 'ea' ? 'selected' : ''}>each</option>
                                    <option value="gal" ${ingredient.default_unit === 'gal' ? 'selected' : ''}>gal</option>
                                    <option value="qt" ${ingredient.default_unit === 'qt' ? 'selected' : ''}>qt</option>
                                </select>
                            </div>
                        </div>

                        <!-- Price & Storage -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Price per lb</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2rem; font-weight: 700;">$</span>
                                    <input type="number" id="edit-ing-price" value="${ingredient.avg_price_per_lb || ''}" step="0.01" min="0" style="flex: 1; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Storage</label>
                                <select id="edit-ing-storage" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                    <option value="refrigerated" ${ingredient.storage === 'refrigerated' ? 'selected' : ''}>Refrigerated</option>
                                    <option value="frozen" ${ingredient.storage === 'frozen' ? 'selected' : ''}>Frozen</option>
                                    <option value="dry" ${ingredient.storage === 'dry' ? 'selected' : ''}>Dry/Pantry</option>
                                    <option value="room_temp" ${ingredient.storage === 'room_temp' ? 'selected' : ''}>Room Temp</option>
                                </select>
                            </div>
                        </div>

                        <!-- Shelf Life & Vendor -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Shelf Life (days)</label>
                                <input type="number" id="edit-ing-shelf-life" value="${ingredient.shelf_life_days || ''}" min="1" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Preferred Vendor</label>
                                <input type="text" id="edit-ing-vendor" value="${ingredient.preferred_vendor || ''}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 25px; background: white; border-top: 2px solid #e5e7eb; display: flex; gap: 12px;">
                        <button onclick="saveIngredientEdit(${index})" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            üíæ Save Changes
                        </button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 14px 28px; background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        function saveIngredientEdit(index) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            
            if (!ingredients[index]) {
                alert('Ingredient not found');
                return;
            }

            // Get form values
            const name = document.getElementById('edit-ing-name').value.trim();
            const category = document.getElementById('edit-ing-category').value.trim();
            const unit = document.getElementById('edit-ing-unit').value;
            const price = parseFloat(document.getElementById('edit-ing-price').value) || 0;
            const storage = document.getElementById('edit-ing-storage').value;
            const shelfLife = parseInt(document.getElementById('edit-ing-shelf-life').value) || null;
            const vendor = document.getElementById('edit-ing-vendor').value.trim();

            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }

            // Update ingredient
            ingredients[index] = {
                ...ingredients[index],
                name,
                category,
                default_unit: unit,
                avg_price_per_lb: price,
                storage,
                shelf_life_days: shelfLife,
                preferred_vendor: vendor,
                lastModified: new Date().toISOString()
            };

            // Save to both keys
            localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
            localStorage.setItem('ingredients', JSON.stringify(ingredients));

            // Close modal
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());

            // Refresh display
            displayIngredients(ingredients);
            updateStats(ingredients);

            showToast('‚úÖ Ingredient updated!');
        }

        function showToast(message, type = 'success') {
            const colors = {
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444',
                info: '#3b82f6'
            };
            const background = colors[type] || colors.success;

            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${background};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 999999;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 2000);
        }

        function deleteIngredient(id) {
            if (confirm('Are you sure you want to delete this ingredient?')) {
                const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
                const filtered = ingredients.filter(i => i.id !== id);
                
                // Save to BOTH storage keys for compatibility
                localStorage.setItem('ingredients_database', JSON.stringify(filtered));
                localStorage.setItem('ingredients', JSON.stringify(filtered));
                
                loadIngredients();
                console.log('üóëÔ∏è Ingredient deleted:', id);
            }
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('‚úÖ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('‚úÖ Authentication system initialized');
          } else {
            console.error('‚ùå UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('‚úÖ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('‚úÖ Page protection system initialized');
          } else {
            console.warn('‚ö†Ô∏è PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
    
    <!-- Load Profile Editor -->
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- Load Email Verification Banner -->
    <script src="assets/js/email-verification-banner.js"></script>
    
    <!-- Load Base Ingredients Loader -->
    <script src="assets/js/base-ingredients-loader.js"></script>
    
    <!-- Load Vendor-Ingredient Connector -->
    <script src="assets/js/vendor-ingredient-connector.js"></script>
    
    <!-- Project UI Manager -->
    <script defer src="assets/js/project-ui-manager.js"></script>
    
    <!-- Central Data Loader -->
    <script src="assets/js/central-data-loader.js"></script>
    
    <!-- State Persistence Manager - Ensures user and project persist across pages -->
    <script src="assets/js/state-persistence-manager.js"></script>
    
    <!-- Secure Storage Manager - Fast & Secure IndexedDB storage -->
    <script src="assets/js/secure-storage-manager.js"></script>
    
    <!-- UI Polish Systems -->
    <script src="assets/js/toast-notifications.js"></script>
    <script src="assets/js/loading-states.js"></script>
    <script src="assets/js/empty-states.js"></script>
</body>
</html>