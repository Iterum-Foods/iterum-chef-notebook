<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Developer - Iterum R&D Chef Notebook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'culinary-green': '#059669',
                        'culinary-dark': '#064e3b'
                    }
                }
            }
        }
    </script>
    <script>
        // Integration with calendar system
        function trackRecipeDevelopment(action, details = '') {
            const activity = {
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                action: action,
                description: details,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            let activities = JSON.parse(localStorage.getItem('iterum_recipe_development') || '[]');
            activities.push(activity);
            localStorage.setItem('iterum_recipe_development', JSON.stringify(activities));
            
            // Add to calendar manager if available
            if (window.calendarManager) {
                window.calendarManager.addRecipeChange(action, 'Recipe Development', details);
            }
        }
    </script>
    <style>
        body {
            background: repeating-linear-gradient(
                to bottom,
                #f6fbe7 0px,
                #f6fbe7 38px,
                #eafcd7 39px,
                #f6fbe7 40px
            );
            position: relative;
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            padding-left: 0;
        }
        .pea-bg-sketch {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 0;
            opacity: 0.11;
            pointer-events: none;
            width: 480px;
            max-width: 90vw;
            height: auto;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 56px;
            width: 2px;
            height: 100vh;
            background: repeating-linear-gradient(
                to bottom,
                #e57373 0px,
                #e57373 16px,
                transparent 16px,
                transparent 32px
            );
            z-index: 0;
            pointer-events: none;
        }
        .notebook-heading {
            font-family: 'Shadows Into Light', cursive;
            font-size: 2.5rem;
            color: #b8860b;
            letter-spacing: 1.5px;
            text-shadow: 0 2px 8px #fffbe7, 0 1px 0 #e2d8b8;
        }
        .notebook-card {
            background: #fffbe7;
            border: 1.5px solid #e2d8b8;
            border-radius: 22px 22px 18px 18px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.09), 0 1.5px 0 #e2d8b8;
            margin-bottom: 2.5rem;
            position: relative;
            padding-top: 2.5rem;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .notebook-card::before {
            content: '';
            position: absolute;
            left: -18px;
            top: 18px;
            width: 12px;
            height: 80%;
            background: repeating-linear-gradient(
                to bottom,
                #e57373 0px,
                #e57373 8px,
                transparent 8px,
                transparent 24px
            );
            border-radius: 8px;
            opacity: 0.18;
            z-index: 1;
        }
        .sticky-btn {
            background: linear-gradient(135deg, #fff176 80%, #ffe082 100%);
            color: #795548;
            border: 1.5px solid #ffe082;
            border-radius: 16px;
            box-shadow: 0 2px 8px 0 rgba(255, 235, 59, 0.15);
            font-weight: 600;
            transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
            padding: 0.5rem 1.5rem;
        }
        .sticky-btn:hover {
            transform: translateY(-2px) scale(1.04) rotate(-2deg);
            box-shadow: 0 6px 18px 0 rgba(255, 235, 59, 0.25);
            background: linear-gradient(135deg, #ffe082 80%, #fff176 100%);
        }
        .notebook-textarea, .notebook-input {
            border-radius: 10px;
            border: 1.5px solid #e2d8b8;
            background: #fffbe7;
            padding: 0.5rem;
            width: 100%;
            font-size: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        .notebook-textarea:focus, .notebook-input:focus {
            border-color: #b8860b;
            box-shadow: 0 0 0 2px #ffe082;
            outline: none;
        }
        button, .notebook-input, .notebook-textarea {
            transition: box-shadow 0.2s, border 0.2s, background 0.2s, color 0.2s;
        }
        button {
            border-radius: 999px;
            font-weight: 600;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
        }
        button:active {
            transform: scale(0.97);
        }
        .notebook-card:hover {
            box-shadow: 0 12px 36px 0 rgba(0,0,0,0.13), 0 2px 0 #e2d8b8;
            transform: translateY(-2px) scale(1.01);
        }
        /* Tape/Sticky Note effect for highlights */
        .tape {
            position: absolute;
            top: -18px;
            left: 32px;
            width: 60px;
            height: 24px;
            background: repeating-linear-gradient(135deg, #ffe082 0px, #fffde7 8px, #ffe082 16px);
            border-radius: 8px 8px 4px 4px;
            box-shadow: 0 2px 8px 0 rgba(255, 235, 59, 0.15);
            z-index: 2;
            opacity: 0.85;
        }
        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            background: #fdf6e3;
        }
        ::-webkit-scrollbar-thumb {
            background: #e2d8b8;
            border-radius: 8px;
        }
        /* Responsive tweaks */
        @media (max-width: 768px) {
            .notebook-card {
                padding: 1.2rem 0.7rem 1.2rem 0.7rem;
            }
            .notebook-heading {
                font-size: 1.5rem;
            }
        }
        .step-active {
            background: linear-gradient(135deg, #059669, #064e3b);
            color: white;
        }
        .step-completed {
            background: #10b981;
            color: white;
        }
        .draft-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .max-w-7xl, .max-w-4xl, .max-w-3xl {
            max-width: 1400px !important;
            width: 95vw !important;
        }
        .mx-auto {
            margin-left: auto !important;
            margin-right: auto !important;
        }
        @media (max-width: 900px) {
            .max-w-7xl, .max-w-4xl, .max-w-3xl {
                width: 99vw !important;
                max-width: 100vw !important;
            }
        }
        @media (max-width: 600px) {
            .max-w-7xl, .max-w-4xl, .max-w-3xl {
                padding: 4px 0.5vw;
                border-radius: 0;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-overlay:not(.hidden) .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header style="background: linear-gradient(90deg, #eafcd7 0%, #b6e388 100%); border-bottom: 2px solid #7bb661; min-height: 48px;">
      <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; padding: 0.3rem 1.5rem;">
        <div style="display: flex; align-items: center;">
          <svg width="48" height="48" viewBox="0 0 64 64" fill="none" style="vertical-align: middle;"><ellipse cx="32" cy="44" rx="18" ry="8" fill="#b6e388" stroke="#7bb661" stroke-width="2"/><ellipse cx="24" cy="44" rx="2.5" ry="2.5" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/><ellipse cx="32" cy="44" rx="2.5" ry="2.5" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/><ellipse cx="40" cy="44" rx="2.5" ry="2.5" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/><path d="M18 44 Q32 20 46 44" stroke="#7bb661" stroke-width="2.5" fill="none"/><path d="M32 20 Q36 10 50 18" stroke="#7bb661" stroke-width="1.2" fill="none"/><path d="M32 20 Q28 10 14 18" stroke="#7bb661" stroke-width="1.2" fill="none"/><ellipse cx="50" cy="18" rx="4" ry="2" fill="#b6e388" stroke="#7bb661" stroke-width="1"/><ellipse cx="14" cy="18" rx="4" ry="2" fill="#b6e388" stroke="#7bb661" stroke-width="1"/></svg>
          <span style="font-family: 'Shadows Into Light', cursive; font-size: 2rem; color: #4a7c2c; margin-left: 0.5rem;">Iterum R&D Chef Notebook</span>
        </div>
        <nav style="display: flex; gap: 1.2rem; font-weight: 600; flex-wrap: wrap;">
          <a href="index.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Home</a>
          <a href="menu-builder.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Menu Builder</a>
          <a href="recipe-developer.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Recipe Developer</a>
          <a href="recipe-upload.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Recipe Upload</a>
          <a href="recipe-review.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Recipe Review</a>
          <a href="ingredients.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Ingredients</a>
          <a href="inventory.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Inventory</a>
          <a href="equipment-management.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Equipment</a>
          <a href="vendor-management.html" style="color: #4a7c2c; text-decoration: none; padding: 0.5rem 0.8rem; border-radius: 8px; transition: background-color 0.2s;">Vendors</a>
        </nav>
        <span id="user-info" style="margin-left: 1rem; padding: 0.2rem 0.8rem; border-radius: 999px; background: #eafcd7; color: #4a7c2c; font-weight: bold;">Guest</span>
      </div>
    </header>

    <!-- Recipe Name Section - Always Visible -->
    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-b border-orange-200 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex-1 mr-4">
                    <label class="block text-orange-800 text-sm font-bold mb-2">Recipe Name</label>
                    <input type="text" id="header-recipe-name" placeholder="Enter your recipe name..." 
                           class="w-full text-2xl font-bold bg-white border-2 border-orange-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200"
                           onchange="syncRecipeName('header')"
                           oninput="syncRecipeName('header')">
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-sm text-orange-700 font-medium">Development Stage</div>
                        <div id="current-stage" class="text-lg font-bold text-orange-800">Initial Concept</div>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-orange-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <div class="bg-orange-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: 16.67%"></div>
                </div>
                <div class="flex justify-between text-xs text-orange-600 mt-1">
                    <span>Concept</span>
                    <span>Vision</span>
                    <span>Ingredients</span>
                    <span>Method</span>
                    <span>Testing</span>
                    <span>Final</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex gap-8">
            <!-- Sketch Section (Left Side) -->
            <div class="w-1/2">
                <div class="bg-white rounded-lg shadow-xl p-6 sticky top-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Recipe Sketch</h2>
                        <div class="flex gap-2">
                            <button onclick="clearSketch()" class="text-gray-500 hover:text-gray-700 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </button>
                            <button onclick="downloadSketch()" class="text-gray-500 hover:text-gray-700 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sketch Canvas -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-4" style="height: 900px;">
                        <canvas id="sketch-canvas" class="w-full h-full cursor-crosshair"></canvas>
                        <div id="sketch-placeholder" class="flex flex-col items-center justify-center h-full text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" />
                            </svg>
                            <p class="text-sm">Click to start sketching</p>
                            <p class="text-xs mt-1">Draw your recipe concept</p>
                        </div>
                    </div>
                    
                    <!-- Sketch Tools -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="setTool('pen')" id="tool-pen" class="flex-1 bg-green-600 text-white py-2 px-3 rounded text-sm font-medium">Pen</button>
                        <button onclick="setTool('text')" id="tool-text" class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded text-sm font-medium">Text</button>
                        <button onclick="setTool('shape')" id="tool-shape" class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded text-sm font-medium">Shape</button>
                        <button onclick="setTool('label')" id="tool-label" class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded text-sm font-medium">Label</button>
                    </div>
                    
                    <!-- Ingredient Selection for Labels -->
                    <div id="ingredient-selector" class="mb-4 hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Select Ingredient to Label</label>
                        <select id="ingredient-dropdown" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                            <option value="">Choose an ingredient...</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            Click on the sketch to place ingredient labels
                        </div>
                    </div>
                    
                    <!-- Color Palette -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="setColor('#000000')" class="w-6 h-6 bg-black rounded border-2 border-gray-300"></button>
                        <button onclick="setColor('#dc2626')" class="w-6 h-6 bg-red-600 rounded border-2 border-gray-300"></button>
                        <button onclick="setColor('#059669')" class="w-6 h-6 bg-green-600 rounded border-2 border-gray-300"></button>
                        <button onclick="setColor('#2563eb')" class="w-6 h-6 bg-blue-600 rounded border-2 border-gray-300"></button>
                        <button onclick="setColor('#7c3aed')" class="w-6 h-6 bg-purple-600 rounded border-2 border-gray-300"></button>
                        <button onclick="setColor('#f59e0b')" class="w-6 h-6 bg-yellow-500 rounded border-2 border-gray-300"></button>
                    </div>
                    
                    <!-- Sketch Notes -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Sketch Notes</label>
                        <textarea id="sketch-notes" rows="3" placeholder="Add notes about your sketch, plating ideas, or visual concepts..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                    </div>
                </div>
            </div>

            <!-- Main Recipe Development Area (Right Side) -->
            <div class="flex-1">
                <!-- Progress Steps -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Recipe Development Progress</h2>
                        <span class="text-sm text-gray-500" id="progress-text">Step 1 of 6</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex-1 flex justify-between">
                            <button onclick="goToStep(1)" class="step-button step-active flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="1">
                                <div class="w-8 h-8 rounded-full bg-white text-green-600 font-bold flex items-center justify-center mb-2">1</div>
                                <span class="text-xs font-medium">Concept</span>
                            </button>
                            <button onclick="goToStep(2)" class="step-button flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="2">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 font-bold flex items-center justify-center mb-2">2</div>
                                <span class="text-xs font-medium">Vision</span>
                            </button>
                            <button onclick="goToStep(3)" class="step-button flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="3">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 font-bold flex items-center justify-center mb-2">3</div>
                                <span class="text-xs font-medium">Ingredients</span>
                            </button>
                            <button onclick="goToStep(4)" class="step-button flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="4">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 font-bold flex items-center justify-center mb-2">4</div>
                                <span class="text-xs font-medium">Method</span>
                            </button>
                            <button onclick="goToStep(5)" class="step-button flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="5">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 font-bold flex items-center justify-center mb-2">5</div>
                                <span class="text-xs font-medium">Testing</span>
                            </button>
                            <button onclick="goToStep(6)" class="step-button flex flex-col items-center p-3 rounded-lg transition duration-300" data-step="6">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 font-bold flex items-center justify-center mb-2">6</div>
                                <span class="text-xs font-medium">Final</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step Content -->
                <div id="step-content" class="bg-white rounded-lg shadow-xl p-8">
                    <!-- Step 1: Recipe Concept -->
                    <div id="step-1" class="step-panel">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Recipe Title & Initial Concept</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Recipe Name</label>
                                <input type="text" id="recipe-name" placeholder="e.g., Caramelized Onion & Gruy√®re Soup" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300" 
                                onchange="syncRecipeName('step')" 
                                oninput="syncRecipeName('step')">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Core Concept</label>
                                <input type="text" id="recipe-concept" placeholder="e.g., Modern take on classic French onion soup" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Initial Ideas & Vision</label>
                                <textarea id="initial-ideas" rows="4" placeholder="Describe your initial vision for this recipe... What inspired you? What are you trying to achieve? What makes this special?" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Recipe Notes & Key Points</label>
                                <textarea id="recipe-notes" rows="5" placeholder="Jot down key notes, techniques to explore, flavor combinations, presentation ideas, or any important considerations..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Recipe Main Image</label>
                                <p class="text-sm text-gray-600 mb-3">Upload a beautiful hero image that showcases your finished recipe</p>
                                <div id="recipe-primary-image-upload"></div>
                            </div>
                            
                            <!-- Recipe URL Import Section -->
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold text-blue-800 mb-1">üîó Import Recipe from URL</h4>
                                        <p class="text-sm text-blue-700">Paste a recipe URL to automatically fill in the details</p>
                                    </div>
                                    <button onclick="openRecipeUrlImportModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                                        Import from URL
                                    </button>
                                </div>
                                <div class="text-xs text-blue-600">
                                    ‚úì Supports AllRecipes, Food Network, Bon App√©tit, Serious Eats, Epicurious, and many more
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div class="flex items-start gap-3">
                                    <div class="text-green-600 text-lg">‚úèÔ∏è</div>
                                    <div>
                                        <h4 class="font-semibold text-green-800 mb-1">Sketch Your Concept</h4>
                                        <p class="text-sm text-green-700">Use the sketch area on the left to visualize your recipe. Draw the plating, components, cooking techniques, or any visual ideas that help capture your vision.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Recipe Type</label>
                                <select id="recipe-type" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300" required>
                                    <option value="">Select recipe type...</option>
                                    <option value="Prep">Prep Recipe</option>
                                    <option value="Dish">Dish</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Vision & Planning -->
                    <div id="step-2" class="step-panel hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Recipe Vision & Planning</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Detailed Description</label>
                                <textarea id="recipe-description" rows="3" placeholder="Brief description of the dish, its unique features, and what makes it special..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Inspiration Sources</label>
                                <textarea id="inspiration-sources" rows="4" placeholder="List your inspiration sources: cookbooks, restaurants, chefs, cultural influences, etc." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Flavor Profile</label>
                                <textarea id="flavor-profile" rows="3" placeholder="Describe the intended flavor profile: sweet, savory, spicy, umami, etc." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Texture & Presentation</label>
                                <textarea id="texture-presentation" rows="3" placeholder="Describe the intended texture, mouthfeel, and visual presentation..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Target Audience</label>
                                <input type="text" id="target-audience" placeholder="e.g., Fine dining, home cooks, vegetarian" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Dietary Considerations</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="dietary-vegetarian" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Vegetarian</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="dietary-vegan" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Vegan</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="dietary-gluten-free" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Gluten-Free</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="dietary-dairy-free" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        <span class="ml-2 text-sm">Dairy-Free</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Difficulty Level</label>
                                <select id="difficulty-level" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                    <option value="Beginner">Beginner</option>
                                    <option value="Intermediate">Intermediate</option>
                                    <option value="Advanced">Advanced</option>
                                    <option value="Professional">Professional</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Estimated Time</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-1">Prep Time</label>
                                        <input type="number" id="prep-time" placeholder="30" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                    </div>
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-1">Cook Time</label>
                                        <input type="number" id="cook-time" placeholder="45" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Ingredients -->
                    <div id="step-3" class="step-panel hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Ingredients & Quantities</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Servings</label>
                                <input type="number" id="servings" placeholder="4" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Ingredients</label>
                                <div id="ingredients-list" class="space-y-3">
                                    <!-- Ingredients will be added here -->
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <button onclick="addIngredientRow()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-full transition duration-300">
                                        + Add Ingredient
                                    </button>
                                    <button onclick="addNewIngredient()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-full transition duration-300">
                                        + New Ingredient
                                    </button>
                                    <button onclick="addNewPrepRecipe()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-full transition duration-300">
                                        + New Prep Recipe
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Special Equipment</label>
                                <textarea id="special-equipment" rows="3" placeholder="List any special equipment, tools, or appliances needed..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Method -->
                    <div id="step-4" class="step-panel hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Cooking Method & Instructions</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Cooking Instructions</label>
                                <div id="instructions-list" class="space-y-3">
                                    <!-- Instructions will be added here -->
                                </div>
                                <button onclick="addInstructionRow()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-full transition duration-300">
                                    + Add Step
                                </button>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Cooking Tips</label>
                                <textarea id="cooking-tips" rows="3" placeholder="Important tips, tricks, and things to watch out for..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Temperature & Timing Notes</label>
                                <textarea id="temp-timing-notes" rows="3" placeholder="Specific temperature requirements, timing windows, and critical moments..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Testing -->
                    <div id="step-5" class="step-panel hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Testing & Refinement</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Test Results</label>
                                <textarea id="test-results" rows="4" placeholder="Document your testing results, what worked, what didn't, and observations..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Adjustments Made</label>
                                <textarea id="adjustments-made" rows="4" placeholder="List any adjustments you made during testing and why..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Quality Assessment</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-1">Taste</label>
                                        <select id="taste-rating" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                            <option value="1">1 - Poor</option>
                                            <option value="2">2 - Fair</option>
                                            <option value="3">3 - Good</option>
                                            <option value="4">4 - Very Good</option>
                                            <option value="5">5 - Excellent</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-1">Texture</label>
                                        <select id="texture-rating" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                            <option value="1">1 - Poor</option>
                                            <option value="2">2 - Fair</option>
                                            <option value="3">3 - Good</option>
                                            <option value="4">4 - Very Good</option>
                                            <option value="5">5 - Excellent</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-600 text-sm mb-1">Presentation</label>
                                        <select id="presentation-rating" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                            <option value="1">1 - Poor</option>
                                            <option value="2">2 - Fair</option>
                                            <option value="3">3 - Good</option>
                                            <option value="4">4 - Very Good</option>
                                            <option value="5">5 - Excellent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Issues & Solutions</label>
                                <textarea id="issues-solutions" rows="4" placeholder="Document any issues encountered and how they were resolved..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Final -->
                    <div id="step-6" class="step-panel hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Final Recipe & Notes</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Final Recipe Notes</label>
                                <textarea id="final-notes" rows="4" placeholder="Final thoughts, serving suggestions, and any last-minute adjustments..." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Tags & Categories</label>
                                <input type="text" id="recipe-tags" placeholder="e.g., soup, French, comfort food, winter" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Recipe Status</label>
                                <select id="recipe-status" class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300">
                                    <option value="Draft">Draft</option>
                                    <option value="Testing">Testing</option>
                                    <option value="Refined">Refined</option>
                                    <option value="Final">Final</option>
                                    <option value="Archived">Archived</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Next Steps</label>
                                <textarea id="next-steps" rows="3" placeholder="What are the next steps for this recipe? Further testing, menu integration, etc." class="shadow-sm border rounded-lg py-2 px-3 w-full focus:outline-none focus:ring-2 focus:ring-green-300"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8">
                    <button onclick="previousStep()" id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-full transition duration-300" disabled>
                        Previous
                    </button>
                    <button onclick="nextStep()" id="next-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-full transition duration-300">
                        Next
                    </button>
                </div>
            </div>

            <!-- Sidebar - Drafts -->
            <div class="w-48">
                <div class="bg-white rounded-lg shadow-xl p-4 sticky top-8">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base font-semibold text-gray-800">Drafts</h3>
                        <button onclick="toggleDraftView()" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                            <span id="draft-toggle-text">Show All</span>
                        </button>
                    </div>
                    
                    <div id="drafts-container" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Drafts will be loaded here -->
                    </div>
                    
                    <div class="mt-3 pt-3 border-t">
                        <button onclick="createNewDraft()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-full transition duration-300 text-sm">
                            + New Draft
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '594179299035-u1or64qms81kqdp3rcpceu3e0kujedgc.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        function initGoogleAPI() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    clientId: CLIENT_ID,
                    scope: SCOPES
                }).then(() => {
                    const authInstance = gapi.auth2.getAuthInstance();
                    updateSigninStatus(authInstance.isSignedIn.get());
                    document.getElementById('google-signin-btn').onclick = () => {
                        authInstance.signIn();
                    };
                    authInstance.isSignedIn.listen(updateSigninStatus);
                });
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                document.getElementById('google-user-info').textContent =
                    'Signed in as: ' + user.getBasicProfile().getEmail();
            } else {
                document.getElementById('google-user-info').textContent = '';
            }
        }

        window.addEventListener('load', function() {
            initGoogleAPI();
        });

        function uploadPDFToDrive(pdfBlob, fileName) {
            const accessToken = gapi.auth.getToken().access_token;
            const metadata = {
                name: fileName,
                mimeType: 'application/pdf'
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', pdfBlob);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            }).then((res) => res.json())
                .then((val) => {
                    alert('PDF uploaded to your Google Drive!');
                    console.log('Drive upload result:', val);
                });
        }

        // Data structures
        let currentStep = 1;
        let totalSteps = 6;
        let currentDraft = null;
        let allDrafts = [];
        let showAllDrafts = false;

        // Local storage keys
        const STORAGE_KEYS = {
            DRAFTS: 'iterum_recipe_drafts',
            CURRENT_DRAFT: 'iterum_current_draft'
        };

        // Local storage functions
        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromLocalStorage(key, defaultValue = []) {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultValue;
        }

        // Initialize app
        function initializeApp() {
            allDrafts = loadFromLocalStorage(STORAGE_KEYS.DRAFTS, []);
            currentDraft = loadFromLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, null);
            
            if (!currentDraft) {
                createNewDraft();
            }
            
            renderDrafts();
            updateProgress();
            loadRecipeName();
        }

        // Recipe name synchronization
        function syncRecipeName(sourceField) {
            const headerNameField = document.getElementById('header-recipe-name');
            const stepNameField = document.getElementById('recipe-name');
            
            if (headerNameField && stepNameField) {
                // Determine which field was changed and sync to the other
                let newRecipeName = '';
                if (sourceField === 'step' || document.activeElement === stepNameField) {
                    // User changed the step field, sync to header
                    newRecipeName = stepNameField.value;
                    headerNameField.value = newRecipeName;
                } else {
                    // User changed the header field (or default), sync to step
                    newRecipeName = headerNameField.value;
                    stepNameField.value = newRecipeName;
                }
                
                // Update current draft if exists
                if (currentDraft) {
                    const recipeName = newRecipeName || 'Untitled Recipe';
                    
                    // Update both the draft name and the recipe data
                    currentDraft.name = recipeName;
                    currentDraft.data.recipe_name = recipeName;
                    currentDraft.updated_at = new Date().toISOString();
                    
                    // Find and update the corresponding draft in allDrafts array
                    const draftIndex = allDrafts.findIndex(draft => draft.id === currentDraft.id);
                    if (draftIndex !== -1) {
                        allDrafts[draftIndex].name = recipeName;
                        allDrafts[draftIndex].data.recipe_name = recipeName;
                        allDrafts[draftIndex].updated_at = new Date().toISOString();
                    }
                    
                    // Save updated data
                    saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
                    saveToLocalStorage(STORAGE_KEYS.DRAFTS, allDrafts);
                    
                    // Update the draft list display
                    renderDrafts();
                }
                
                // Track the name change
                if (newRecipeName) {
                    trackRecipeDevelopment('Recipe Name Updated', newRecipeName);
                }
            }
        }

        // Load recipe name into header
        function loadRecipeName() {
            const headerNameField = document.getElementById('header-recipe-name');
            const stepNameField = document.getElementById('recipe-name');
            
            if (currentDraft && headerNameField) {
                headerNameField.value = currentDraft.name === 'New Recipe Draft' ? '' : currentDraft.name;
                if (stepNameField) {
                    stepNameField.value = headerNameField.value;
                }
            }
        }

        // Update progress bar and stage indicator
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const stageIndicator = document.getElementById('current-stage');
            
            if (progressBar) {
                const percentage = (currentStep / totalSteps) * 100;
                progressBar.style.width = percentage + '%';
            }
            
            if (stageIndicator) {
                const stages = ['Initial Concept', 'Vision & Planning', 'Ingredients', 'Method', 'Testing', 'Final Recipe'];
                stageIndicator.textContent = stages[currentStep - 1] || 'Unknown';
            }
        }

        // Step navigation
        function goToStep(step) {
            if (step < 1 || step > totalSteps) return;
            
            // Hide current step
            document.querySelector(`#step-${currentStep}`).classList.add('hidden');
            
            // Show new step
            document.querySelector(`#step-${step}`).classList.remove('hidden');
            
            // Update step buttons
            document.querySelectorAll('.step-button').forEach(btn => {
                btn.classList.remove('step-active', 'step-completed');
                const btnStep = parseInt(btn.dataset.step);
                if (btnStep < step) {
                    btn.classList.add('step-completed');
                } else if (btnStep === step) {
                    btn.classList.add('step-active');
                }
            });
            
            currentStep = step;
            updateProgress();
            updateProgressBar();
            updateNavigationButtons();
            
            // Track step progression
            const stepNames = ['Concept', 'Vision', 'Ingredients', 'Method', 'Testing', 'Final'];
            trackRecipeDevelopment('Step Progress', `Moved to ${stepNames[step-1]} step`);
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                goToStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        function updateProgress() {
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn) {
                prevBtn.disabled = currentStep === 1;
            }
            
            if (nextBtn) {
                nextBtn.textContent = currentStep === totalSteps ? 'Finish' : 'Next';
            }
        }

        // Draft management
        function createNewDraft() {
            const newDraft = {
                id: Date.now(),
                name: 'New Recipe Draft',
                step: 1,
                data: {
                    recipe_type: 'Dish',
                    recipe_concept: '',
                    inspiration_sources: '',
                    research_notes: '',
                    target_audience: '',
                    dietary_considerations: {
                        vegetarian: false,
                        vegan: false,
                        gluten_free: false,
                        dairy_free: false
                    },
                    recipe_name: '',
                    recipe_description: '',
                    flavor_profile: '',
                    texture_presentation: '',
                    difficulty_level: 'Intermediate',
                    prep_time: '',
                    cook_time: '',
                    servings: '',
                    ingredients: [],
                    special_equipment: '',
                    instructions: [],
                    cooking_tips: '',
                    temp_timing_notes: '',
                    test_results: '',
                    adjustments_made: '',
                    taste_rating: '3',
                    texture_rating: '3',
                    presentation_rating: '3',
                    issues_solutions: '',
                    final_notes: '',
                    recipe_tags: '',
                    recipe_status: 'Draft',
                    next_steps: ''
                },
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            currentDraft = newDraft;
            allDrafts.unshift(newDraft);
            
            saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
            saveToLocalStorage(STORAGE_KEYS.DRAFTS, allDrafts);
            
            renderDrafts();
            loadDraftData();
        }

        function loadDraft(draftId) {
            const draft = allDrafts.find(d => d.id === draftId);
            if (draft) {
                currentDraft = draft;
                saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
                loadDraftData();
                goToStep(draft.step);
            }
        }

        function loadDraftData() {
            if (!currentDraft) return;
            
            // Load all form data from currentDraft.data
            Object.keys(currentDraft.data).forEach(key => {
                const element = document.getElementById(key.replace(/_/g, '-'));
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = currentDraft.data[key];
                    } else {
                        element.value = currentDraft.data[key];
                    }
                }
            });
            
            // Load ingredients and instructions
            renderIngredientsList();
            renderInstructionsList();
        }

        function saveDraft() {
            if (!currentDraft) return;
            
            // Save all form data to currentDraft.data
            currentDraft.data = {
                recipe_type: document.getElementById('recipe-type')?.value || 'Dish',
                recipe_concept: document.getElementById('recipe-concept')?.value || '',
                inspiration_sources: document.getElementById('inspiration-sources')?.value || '',
                research_notes: document.getElementById('research-notes')?.value || '',
                target_audience: document.getElementById('target-audience')?.value || '',
                dietary_considerations: {
                    vegetarian: document.getElementById('dietary-vegetarian')?.checked || false,
                    vegan: document.getElementById('dietary-vegan')?.checked || false,
                    gluten_free: document.getElementById('dietary-gluten-free')?.checked || false,
                    dairy_free: document.getElementById('dietary-dairy-free')?.checked || false
                },
                recipe_name: document.getElementById('recipe-name')?.value || '',
                recipe_description: document.getElementById('recipe-description')?.value || '',
                flavor_profile: document.getElementById('flavor-profile')?.value || '',
                texture_presentation: document.getElementById('texture-presentation')?.value || '',
                difficulty_level: document.getElementById('difficulty-level')?.value || 'Intermediate',
                prep_time: document.getElementById('prep-time')?.value || '',
                cook_time: document.getElementById('cook-time')?.value || '',
                servings: document.getElementById('servings')?.value || '',
                ingredients: getIngredientsData(),
                special_equipment: document.getElementById('special-equipment')?.value || '',
                instructions: getInstructionsData(),
                cooking_tips: document.getElementById('cooking-tips')?.value || '',
                temp_timing_notes: document.getElementById('temp-timing-notes')?.value || '',
                test_results: document.getElementById('test-results')?.value || '',
                adjustments_made: document.getElementById('adjustments-made')?.value || '',
                taste_rating: document.getElementById('taste-rating')?.value || '3',
                texture_rating: document.getElementById('texture-rating')?.value || '3',
                presentation_rating: document.getElementById('presentation-rating')?.value || '3',
                issues_solutions: document.getElementById('issues-solutions')?.value || '',
                final_notes: document.getElementById('final-notes')?.value || '',
                recipe_tags: document.getElementById('recipe-tags')?.value || '',
                recipe_status: document.getElementById('recipe-status')?.value || 'Draft',
                next_steps: document.getElementById('next-steps')?.value || ''
            };
            
            currentDraft.step = currentStep;
            currentDraft.updated_at = new Date().toISOString();
            
            // Update draft in allDrafts
            const index = allDrafts.findIndex(d => d.id === currentDraft.id);
            if (index !== -1) {
                allDrafts[index] = currentDraft;
            }
            
            saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
            saveToLocalStorage(STORAGE_KEYS.DRAFTS, allDrafts);
            
            // Track recipe development activity
            trackRecipeDevelopment('Draft Saved', `Saved draft: ${currentDraft.data.recipe_name || 'Untitled Recipe'}`);
            
            renderDrafts();
            alert('Draft saved successfully!');
        }

        function renderDrafts() {
            const container = document.getElementById('drafts-container');
            if (!container) return;
            
            const draftsToShow = showAllDrafts ? allDrafts : allDrafts.slice(0, 5);
            
            if (draftsToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-xs text-center">No drafts yet</p>';
                return;
            }
            
            container.innerHTML = draftsToShow.map(draft => `
                <div class="draft-card bg-gray-50 rounded-lg p-2 cursor-pointer transition duration-300 ${currentDraft?.id === draft.id ? 'ring-2 ring-blue-500' : ''}" onclick="loadDraft(${draft.id})">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium text-gray-800 text-xs truncate flex-1">${draft.name}</h4>
                        <span class="text-xs text-gray-500 ml-1">${draft.step}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-1 truncate">${draft.data.recipe_name || 'Untitled'}</div>
                    <div class="text-xs text-gray-400">${new Date(draft.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function toggleDraftView() {
            showAllDrafts = !showAllDrafts;
            const toggleText = document.getElementById('draft-toggle-text');
            if (toggleText) {
                toggleText.textContent = showAllDrafts ? 'Show Recent' : 'Show All';
            }
            renderDrafts();
        }

        // Load all available ingredients and prep recipes
        function loadAllIngredients() {
            const ingredients = loadFromLocalStorage('iterum_ingredients', []);
            const recipes = loadFromLocalStorage('iterum_recipes', []);
            const prepRecipes = recipes.filter(r => r.type === 'Prep').map(r => ({
                id: 'prep-' + r.id,
                name: r.name,
                unit: r.unit || 'each',
                category: 'Prep Recipe',
                isPrep: true
            }));
            
            return [...ingredients, ...prepRecipes];
        }

        // Ingredients management
        function addIngredientRow() {
            const container = document.getElementById('ingredients-list');
            const ingredientId = Date.now();
            const allIngredients = loadAllIngredients();
            
            const ingredientOptions = allIngredients.map(ing => 
                `<option value="${ing.name}" data-unit="${ing.unit}" data-is-prep="${ing.isPrep || false}">${ing.isPrep ? 'üßë‚Äçüç≥ ' : ''}${ing.name} (${ing.unit})</option>`
            ).join('');
            
            const ingredientHtml = `
                <div class="ingredient-row flex gap-3 items-center" data-id="${ingredientId}">
                    <select class="ingredient-select flex-1 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" onchange="updateIngredientUnit(${ingredientId})">
                        <option value="">Select ingredient...</option>
                        ${ingredientOptions}
                    </select>
                    <input type="text" placeholder="Amount" class="ingredient-amount w-20 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300">
                    <input type="text" placeholder="Unit" class="ingredient-unit w-24 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" readonly>
                    <button onclick="removeIngredientRow(${ingredientId})" class="text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', ingredientHtml);
        }

        function updateIngredientUnit(ingredientId) {
            const row = document.querySelector(`[data-id="${ingredientId}"]`);
            const select = row.querySelector('.ingredient-select');
            const unitInput = row.querySelector('.ingredient-unit');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                unitInput.value = selectedOption.dataset.unit;
            } else {
                unitInput.value = '';
            }
        }

        function addNewIngredient() {
            const name = prompt('Enter new ingredient name:');
            if (!name) return;
            
            const unit = prompt('Enter unit (e.g., grams, ml, each):');
            if (!unit) return;
            
            const category = prompt('Enter category (e.g., Produce, Dairy, Pantry):');
            if (!category) return;
            
            const newIngredient = {
                id: Date.now(),
                name: name.trim(),
                unit: unit.trim(),
                category: category.trim(),
                notes: '',
                created_at: new Date().toISOString()
            };
            
            // Add to ingredients storage
            const ingredients = loadFromLocalStorage('iterum_ingredients', []);
            ingredients.push(newIngredient);
            saveToLocalStorage('iterum_ingredients', ingredients);
            
            // Refresh ingredient row
            addIngredientRow();
            
            alert(`New ingredient "${name}" added successfully!`);
        }

        function addNewPrepRecipe() {
            // Save current draft
            saveDraft();
            
            // Create a new draft for the prep recipe
            const newDraft = {
                id: Date.now(),
                name: 'New Prep Recipe',
                step: 1,
                data: {
                    recipe_type: 'Prep',
                    recipe_concept: '',
                    inspiration_sources: '',
                    research_notes: '',
                    target_audience: '',
                    dietary_considerations: {
                        vegetarian: false,
                        vegan: false,
                        gluten_free: false,
                        dairy_free: false
                    },
                    recipe_name: '',
                    recipe_description: '',
                    flavor_profile: '',
                    texture_presentation: '',
                    difficulty_level: 'Intermediate',
                    prep_time: '',
                    cook_time: '',
                    servings: '',
                    ingredients: [],
                    special_equipment: '',
                    instructions: [],
                    cooking_tips: '',
                    temp_timing_notes: '',
                    test_results: '',
                    adjustments_made: '',
                    taste_rating: '3',
                    texture_rating: '3',
                    presentation_rating: '3',
                    issues_solutions: '',
                    final_notes: '',
                    recipe_tags: '',
                    recipe_status: 'Draft',
                    next_steps: ''
                },
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // Add to drafts
            allDrafts.unshift(newDraft);
            saveToLocalStorage(STORAGE_KEYS.DRAFTS, allDrafts);
            
            // Switch to new draft
            currentDraft = newDraft;
            saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
            
            // Go to recipe developer with new draft
            window.location.href = 'recipe-developer.html';
        }

        function removeIngredientRow(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            if (row) {
                row.remove();
            }
        }

        function getIngredientsData() {
            const ingredients = [];
            document.querySelectorAll('.ingredient-row').forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const amount = row.querySelector('.ingredient-amount').value;
                const unit = row.querySelector('.ingredient-unit').value;
                
                if (select.value && amount) {
                    ingredients.push({ 
                        name: select.value, 
                        amount: amount, 
                        unit: unit,
                        isPrep: select.options[select.selectedIndex].dataset.isPrep === 'true'
                    });
                }
            });
            return ingredients;
        }

        function renderIngredientsList() {
            const container = document.getElementById('ingredients-list');
            if (!container || !currentDraft) return;
            
            container.innerHTML = '';
            const allIngredients = loadAllIngredients();
            
            currentDraft.data.ingredients.forEach(ingredient => {
                const ingredientId = Date.now() + Math.random();
                const ingredientOptions = allIngredients.map(ing => 
                    `<option value="${ing.name}" data-unit="${ing.unit}" data-is-prep="${ing.isPrep || false}" ${ing.name === ingredient.name ? 'selected' : ''}>${ing.isPrep ? 'üßë‚Äçüç≥ ' : ''}${ing.name} (${ing.unit})</option>`
                ).join('');
                
                const ingredientHtml = `
                    <div class="ingredient-row flex gap-3 items-center" data-id="${ingredientId}">
                        <select class="ingredient-select flex-1 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" onchange="updateIngredientUnit(${ingredientId})">
                            <option value="">Select ingredient...</option>
                            ${ingredientOptions}
                        </select>
                        <input type="text" value="${ingredient.amount}" placeholder="Amount" class="ingredient-amount w-20 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <input type="text" value="${ingredient.unit}" placeholder="Unit" class="ingredient-unit w-24 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" readonly>
                        <button onclick="removeIngredientRow(${ingredientId})" class="text-red-600 hover:text-red-800">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', ingredientHtml);
            });
        }

        // Instructions management
        function addInstructionRow() {
            const container = document.getElementById('instructions-list');
            const instructionId = Date.now();
            
            const instructionHtml = `
                <div class="instruction-row flex gap-3 items-start" data-id="${instructionId}">
                    <span class="instruction-number bg-gray-200 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-sm font-medium mt-2"></span>
                    <textarea placeholder="Instruction step..." class="instruction-text flex-1 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" rows="2"></textarea>
                    <button onclick="removeInstructionRow(${instructionId})" class="text-red-600 hover:text-red-800 mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', instructionHtml);
            updateInstructionNumbers();
        }

        function removeInstructionRow(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            if (row) {
                row.remove();
                updateInstructionNumbers();
            }
        }

        function updateInstructionNumbers() {
            document.querySelectorAll('.instruction-number').forEach((number, index) => {
                number.textContent = index + 1;
            });
        }

        function getInstructionsData() {
            const instructions = [];
            document.querySelectorAll('.instruction-row').forEach(row => {
                const text = row.querySelector('.instruction-text').value;
                if (text.trim()) {
                    instructions.push(text.trim());
                }
            });
            return instructions;
        }

        function renderInstructionsList() {
            const container = document.getElementById('instructions-list');
            if (!container || !currentDraft) return;
            
            container.innerHTML = '';
            currentDraft.data.instructions.forEach((instruction, index) => {
                const instructionId = Date.now() + Math.random();
                const instructionHtml = `
                    <div class="instruction-row flex gap-3 items-start" data-id="${instructionId}">
                        <span class="instruction-number bg-gray-200 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-sm font-medium mt-2">${index + 1}</span>
                        <textarea class="instruction-text flex-1 shadow-sm border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-green-300" rows="2">${instruction}</textarea>
                        <button onclick="removeInstructionRow(${instructionId})" class="text-red-600 hover:text-red-800 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', instructionHtml);
            });
        }

        function finalizeRecipe() {
            saveDraft();
            
            // Ask if user wants to export PDF
            const exportPDF = confirm('Recipe finalized! Would you like to export it as a PDF?');
            
            // Create final recipe object
            const finalRecipe = {
                id: Date.now(),
                name: currentDraft.data.recipe_name || 'Untitled Recipe',
                description: currentDraft.data.recipe_description,
                type: currentDraft.data.recipe_type || 'Dish',
                instructions: currentDraft.data.instructions.join('\n\n'),
                tags: currentDraft.data.recipe_tags,
                ingredients: currentDraft.data.ingredients,
                servings: currentDraft.data.servings,
                prep_time: currentDraft.data.prep_time,
                cook_time: currentDraft.data.cook_time,
                difficulty_level: currentDraft.data.difficulty_level,
                status: 'Final',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // Save to main recipes storage
            const existingRecipes = loadFromLocalStorage('iterum_recipes', []);
            existingRecipes.push(finalRecipe);
            saveToLocalStorage('iterum_recipes', existingRecipes);
            
            // Track recipe development activity
            trackRecipeDevelopment('Recipe Finalized', `Finalized recipe: ${finalRecipe.name}`);
            
            // Remove draft
            allDrafts = allDrafts.filter(d => d.id !== currentDraft.id);
            saveToLocalStorage(STORAGE_KEYS.DRAFTS, allDrafts);
            
            if (exportPDF) {
                // Export PDF before redirecting
                setTimeout(() => {
                    exportToPDF();
                    alert('Recipe finalized and PDF exported!');
                    window.location.href = 'index.html';
                }, 500);
            } else {
                alert('Recipe finalized and saved to your recipe collection!');
                window.location.href = 'index.html';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeSketchCanvas();
            
            // Add recipe name synchronization event listeners
            const headerNameField = document.getElementById('header-recipe-name');
            const stepNameField = document.getElementById('recipe-name');
            
            // Sync from step field to header field
            if (stepNameField) {
                stepNameField.addEventListener('input', function() {
                    if (headerNameField) {
                        headerNameField.value = this.value;
                        syncRecipeName();
                    }
                });
                
                stepNameField.addEventListener('change', function() {
                    if (headerNameField) {
                        headerNameField.value = this.value;
                        syncRecipeName();
                    }
                });
            }
            
            // Initial sync on page load
            setTimeout(() => {
                loadRecipeName();
                updateProgressBar();
            }, 100);
        });

        // Sketch Canvas Functionality
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let lastX = 0;
        let lastY = 0;
        let ingredients = [];
        let ingredientLabels = [];

        function initializeSketchCanvas() {
            canvas = document.getElementById('sketch-canvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // Set initial styles
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Load ingredients for labeling
            loadIngredientsForLabeling();
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('click', handleCanvasClick);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Hide placeholder when drawing starts
            canvas.addEventListener('mousedown', hidePlaceholder);
            canvas.addEventListener('touchstart', hidePlaceholder);
        }

        function hidePlaceholder() {
            const placeholder = document.getElementById('sketch-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function setTool(tool) {
            currentTool = tool;
            
            // Update button styles
            document.querySelectorAll('[id^="tool-"]').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(`tool-${tool}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`tool-${tool}`).classList.add('bg-green-600', 'text-white');
            
            // Show/hide ingredient selector
            const ingredientSelector = document.getElementById('ingredient-selector');
            if (tool === 'label') {
                ingredientSelector.classList.remove('hidden');
            } else {
                ingredientSelector.classList.add('hidden');
            }
            
            // Update cursor
            if (tool === 'pen') {
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'text') {
                canvas.style.cursor = 'text';
            } else if (tool === 'shape') {
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'label') {
                canvas.style.cursor = 'pointer';
            }
        }

        function setColor(color) {
            currentColor = color;
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
        }

        function clearSketch() {
            if (confirm('Are you sure you want to clear the sketch?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ingredientLabels = [];
                const placeholder = document.getElementById('sketch-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            }
        }

        function downloadSketch() {
            const link = document.createElement('a');
            link.download = `recipe-sketch-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Save sketch data with draft
        function saveSketchData() {
            if (currentDraft && canvas) {
                currentDraft.data.sketch_data = canvas.toDataURL();
                currentDraft.data.sketch_notes = document.getElementById('sketch-notes').value;
                currentDraft.data.ingredient_labels = ingredientLabels;
                saveToLocalStorage(STORAGE_KEYS.CURRENT_DRAFT, currentDraft);
            }
        }

        // Load sketch data from draft
        function loadSketchData() {
            if (currentDraft && currentDraft.data.sketch_data && canvas) {
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    // Redraw ingredient labels
                    if (currentDraft.data.ingredient_labels) {
                        ingredientLabels = currentDraft.data.ingredient_labels;
                        redrawAllLabels();
                    }
                    
                    hidePlaceholder();
                };
                img.src = currentDraft.data.sketch_data;
            }
            
            if (currentDraft && currentDraft.data.sketch_notes) {
                document.getElementById('sketch-notes').value = currentDraft.data.sketch_notes;
            }
        }

        // Override saveDraft to include sketch data
        const originalSaveDraft = saveDraft;
        saveDraft = function() {
            saveSketchData();
            originalSaveDraft();
        };

        // Override loadDraftData to include sketch data
        const originalLoadDraftData = loadDraftData;
        loadDraftData = function() {
            originalLoadDraftData();
            loadSketchData();
        };

        // PDF Export Functionality
        function exportToPDF() {
            if (!currentDraft) {
                alert('No recipe data to export. Please save your draft first.');
                return;
            }

            // Create new PDF document
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up fonts and styles
            doc.setFont('helvetica');
            doc.setFontSize(20);
            
            // Recipe title
            const recipeName = currentDraft.data.recipe_name || 'Untitled Recipe';
            doc.text(recipeName, 20, 30);
            
            // Recipe type and difficulty
            doc.setFontSize(12);
            const recipeType = currentDraft.data.recipe_type || 'Dish';
            const difficulty = currentDraft.data.difficulty_level || 'Intermediate';
            doc.text(`Type: ${recipeType} | Difficulty: ${difficulty}`, 20, 45);
            
            // Description
            if (currentDraft.data.recipe_description) {
                doc.setFontSize(11);
                const description = currentDraft.data.recipe_description;
                const splitDesc = doc.splitTextToSize(description, 170);
                doc.text('Description:', 20, 60);
                doc.setFontSize(10);
                doc.text(splitDesc, 20, 70);
            }
            
            // Timing information
            let yPos = 90;
            if (currentDraft.data.prep_time || currentDraft.data.cook_time) {
                doc.setFontSize(11);
                doc.text('Timing:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                if (currentDraft.data.prep_time) {
                    doc.text(`Prep Time: ${currentDraft.data.prep_time} minutes`, 20, yPos);
                    yPos += 7;
                }
                if (currentDraft.data.cook_time) {
                    doc.text(`Cook Time: ${currentDraft.data.cook_time} minutes`, 20, yPos);
                    yPos += 7;
                }
                if (currentDraft.data.servings) {
                    doc.text(`Servings: ${currentDraft.data.servings}`, 20, yPos);
                    yPos += 7;
                }
            }
            
            // Ingredients
            if (currentDraft.data.ingredients && currentDraft.data.ingredients.length > 0) {
                yPos += 10;
                doc.setFontSize(12);
                doc.text('Ingredients:', 20, yPos);
                yPos += 10;
                
                const ingredientsTable = currentDraft.data.ingredients.map(ing => [
                    ing.name,
                    ing.amount,
                    ing.unit
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Ingredient', 'Amount', 'Unit']],
                    body: ingredientsTable,
                    theme: 'grid',
                    headStyles: { fillColor: [5, 150, 105] },
                    styles: { fontSize: 9 }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // Special Equipment
            if (currentDraft.data.special_equipment) {
                doc.setFontSize(11);
                doc.text('Special Equipment:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                const equipment = currentDraft.data.special_equipment;
                const splitEquipment = doc.splitTextToSize(equipment, 170);
                doc.text(splitEquipment, 20, yPos);
                yPos += splitEquipment.length * 5 + 10;
            }
            
            // Instructions
            if (currentDraft.data.instructions && currentDraft.data.instructions.length > 0) {
                doc.setFontSize(12);
                doc.text('Instructions:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                
                currentDraft.data.instructions.forEach((instruction, index) => {
                    const stepText = `${index + 1}. ${instruction}`;
                    const splitStep = doc.splitTextToSize(stepText, 170);
                    
                    // Check if we need a new page
                    if (yPos + splitStep.length * 5 > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(splitStep, 20, yPos);
                    yPos += splitStep.length * 5 + 5;
                });
            }
            
            // Cooking Tips
            if (currentDraft.data.cooking_tips) {
                yPos += 10;
                doc.setFontSize(11);
                doc.text('Cooking Tips:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                const tips = currentDraft.data.cooking_tips;
                const splitTips = doc.splitTextToSize(tips, 170);
                doc.text(splitTips, 20, yPos);
                yPos += splitTips.length * 5 + 10;
            }
            
            // Test Results (if available)
            if (currentDraft.data.test_results) {
                yPos += 10;
                doc.setFontSize(11);
                doc.text('Test Results:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                const results = currentDraft.data.test_results;
                const splitResults = doc.splitTextToSize(results, 170);
                doc.text(splitResults, 20, yPos);
                yPos += splitResults.length * 5 + 10;
            }
            
            // Final Notes
            if (currentDraft.data.final_notes) {
                yPos += 10;
                doc.setFontSize(11);
                doc.text('Final Notes:', 20, yPos);
                yPos += 10;
                doc.setFontSize(10);
                const notes = currentDraft.data.final_notes;
                const splitNotes = doc.splitTextToSize(notes, 170);
                doc.text(splitNotes, 20, yPos);
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 20, 290);
                doc.text(`Generated on ${new Date().toLocaleDateString()}`, 120, 290);
            }
            
            // Save as Blob
            const pdfBlob = doc.output('blob');
            const fileName = (currentDraft.data.recipe_name || 'Recipe') + '.pdf';

            // Upload to Google Drive if signed in
            if (gapi.auth2 && gapi.auth2.getAuthInstance && gapi.auth2.getAuthInstance().isSignedIn.get()) {
                uploadPDFToDrive(pdfBlob, fileName);
            } else {
                alert('Not signed in to Google. PDF will be downloaded locally.');
            }

            // Always trigger local download as fallback
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        function loadIngredientsForLabeling() {
            // Load ingredients from localStorage
            const storedIngredients = localStorage.getItem('iterum_ingredients');
            if (storedIngredients) {
                try {
                    ingredients = JSON.parse(storedIngredients);
                    populateIngredientDropdown();
                } catch (e) {
                    console.error('Error loading ingredients:', e);
                }
            }
        }

        function populateIngredientDropdown() {
            const dropdown = document.getElementById('ingredient-dropdown');
            if (!dropdown) return;
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">Choose an ingredient...</option>';
            
            // Add ingredients to dropdown
            ingredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.name;
                option.textContent = ingredient.name;
                dropdown.appendChild(option);
            });
        }

        function handleCanvasClick(e) {
            if (currentTool === 'label') {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if clicking on an existing label to remove it
                const clickedLabel = findLabelAtPosition(x, y);
                if (clickedLabel) {
                    removeIngredientLabel(clickedLabel);
                    return;
                }
                
                const selectedIngredient = document.getElementById('ingredient-dropdown').value;
                if (selectedIngredient) {
                    addIngredientLabel(x, y, selectedIngredient);
                } else {
                    alert('Please select an ingredient first');
                }
            }
        }

        function findLabelAtPosition(x, y) {
            return ingredientLabels.find(label => {
                const padding = 8;
                const fontSize = 12;
                ctx.font = `${fontSize}px Arial`;
                const textWidth = ctx.measureText(label.ingredient).width;
                const boxWidth = textWidth + padding * 2;
                const boxHeight = fontSize + padding * 2;
                
                return x >= label.x && x <= label.x + boxWidth &&
                       y >= label.y - boxHeight && y <= label.y;
            });
        }

        function removeIngredientLabel(label) {
            if (confirm(`Remove label for "${label.ingredient}"?`)) {
                ingredientLabels = ingredientLabels.filter(l => l.id !== label.id);
                redrawCanvas();
                saveSketchData();
            }
        }

        function redrawCanvas() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Redraw all labels
            redrawAllLabels();
        }

        function addIngredientLabel(x, y, ingredientName) {
            const label = {
                x: x,
                y: y,
                ingredient: ingredientName,
                id: Date.now() + Math.random()
            };
            
            ingredientLabels.push(label);
            drawIngredientLabel(label);
            saveSketchData();
        }

        function drawIngredientLabel(label) {
            const padding = 8;
            const fontSize = 12;
            
            ctx.font = `${fontSize}px Arial`;
            ctx.fillStyle = '#ffffff';
            ctx.strokeStyle = '#059669';
            ctx.lineWidth = 2;
            
            const textWidth = ctx.measureText(label.ingredient).width;
            const boxWidth = textWidth + padding * 2;
            const boxHeight = fontSize + padding * 2;
            
            // Draw background box
            ctx.fillStyle = '#059669';
            ctx.fillRect(label.x, label.y - boxHeight, boxWidth, boxHeight);
            
            // Draw border
            ctx.strokeRect(label.x, label.y - boxHeight, boxWidth, boxHeight);
            
            // Draw text
            ctx.fillStyle = '#ffffff';
            ctx.fillText(label.ingredient, label.x + padding, label.y - padding);
            
            // Draw connecting line
            ctx.strokeStyle = '#059669';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(label.x + boxWidth / 2, label.y);
            ctx.lineTo(label.x + boxWidth / 2, label.y + 20);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function redrawAllLabels() {
            ingredientLabels.forEach(label => {
                drawIngredientLabel(label);
            });
        }

        (function(){
            const langSel = document.getElementById('language-selector');
            if (!langSel) return;
            const storedLang = localStorage.getItem('iterum_lang') || 'en';
            langSel.value = storedLang;
            langSel.addEventListener('change', function() {
                localStorage.setItem('iterum_lang', langSel.value);
                translatePage(langSel.value);
            });
            if (storedLang !== 'en') translatePage(storedLang);

            function translatePage(targetLang) {
                if (targetLang === 'en') return location.reload();
                const elements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, label, button, a, p, span, th, td, li');
                elements.forEach(el => {
                    if (!el.dataset.origText) el.dataset.origText = el.innerText;
                });
                const texts = Array.from(elements).map(el => el.dataset.origText);
                fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(texts.join('|||'))}&langpair=en|${targetLang}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.responseData) return;
                        const translated = data.responseData.translatedText.split('|||');
                        elements.forEach((el, i) => {
                            if (translated[i]) el.innerText = translated[i];
                        });
                    });
            }
        })();

        // Helper to get current user ID
        function getCurrentUserId() {
            const user = JSON.parse(localStorage.getItem('current_user') || '{}');
            return user && user.id ? user.id : null;
        }
    </script>
    <script src="userDataManager.js"></script>
    <script src="imageUploadManager.js"></script>
    <script>
        // Initialize image upload functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize primary image upload for recipes
            const primaryImageContainer = document.getElementById('recipe-primary-image-upload');
            if (primaryImageContainer) {
                window.imageUploadManager.createUploadInterface(primaryImageContainer, {
                    multiple: false,
                    placeholder: 'Upload your main recipe image here'
                });
            }
            
            // Add upload handler for primary image
            if (primaryImageContainer) {
                const uploadContainer = primaryImageContainer.querySelector('.image-upload-container');
                if (uploadContainer) {
                    // Add upload button functionality
                    const uploadBtn = document.createElement('button');
                    uploadBtn.textContent = 'Upload Image';
                    uploadBtn.className = 'mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors';
                    uploadBtn.onclick = async () => {
                        if (uploadContainer.pendingFiles && uploadContainer.pendingFiles.length > 0) {
                            const file = uploadContainer.pendingFiles[0];
                            const recipeName = document.getElementById('recipe-name').value;
                            
                            if (!recipeName) {
                                alert('Please enter a recipe name first');
                                return;
                            }
                            
                            try {
                                const progressCallback = (percent) => {
                                    window.imageUploadManager.showProgress(uploadContainer, percent);
                                };
                                
                                // For development, we'll simulate upload
                                // In production, this would use the actual recipe ID
                                console.log('Would upload primary image for recipe:', recipeName);
                                const messagesContainer = uploadContainer.querySelector('.upload-messages');
                                window.imageUploadManager.showMessage(messagesContainer, 'Image uploaded successfully!', 'success');
                                
                                // Track the upload activity
                                trackRecipeDevelopment('Image Upload', `Uploaded primary image for ${recipeName}`);
                                
                            } catch (error) {
                                const messagesContainer = uploadContainer.querySelector('.upload-messages');
                                window.imageUploadManager.showMessage(messagesContainer, `Upload failed: ${error.message}`, 'error');
                            }
                        } else {
                            alert('Please select an image first');
                        }
                    };
                    uploadContainer.appendChild(uploadBtn);
                }
            }
        });

        // Recipe URL Import Functions
        let currentParsedRecipe = null;

        function openRecipeUrlImportModal() {
            document.getElementById('recipe-url-import-modal').classList.remove('hidden');
            document.getElementById('recipe-url-input').focus();
            loadRecentRecipeUrls();
        }

        function closeRecipeUrlImportModal() {
            document.getElementById('recipe-url-import-modal').classList.add('hidden');
            clearRecipeUrlResults();
        }

        async function parseRecipeUrl() {
            const urlInput = document.getElementById('recipe-url-input');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a recipe URL');
                return;
            }

            // Show loading state
            document.getElementById('recipe-url-loading').classList.remove('hidden');
            document.getElementById('recipe-url-error').classList.add('hidden');
            document.getElementById('recipe-url-results').classList.add('hidden');
            document.getElementById('parse-recipe-btn').disabled = true;
            document.getElementById('parse-recipe-btn').textContent = 'Parsing...';

            try {
                const response = await fetch('/api/integrations/recipe/parse-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const result = await response.json();

                if (result.success && result.recipe) {
                    currentParsedRecipe = result.recipe;
                    displayParsedRecipe(result.recipe);
                    saveRecentRecipeUrl(url, result.recipe.source);
                } else {
                    showRecipeUrlError(result.detail || 'Failed to parse recipe from URL');
                }
            } catch (error) {
                console.error('Recipe URL parsing error:', error);
                showRecipeUrlError('Network error: ' + error.message);
            } finally {
                document.getElementById('recipe-url-loading').classList.add('hidden');
                document.getElementById('parse-recipe-btn').disabled = false;
                document.getElementById('parse-recipe-btn').textContent = 'Parse Recipe';
            }
        }

        function displayParsedRecipe(recipe) {
            // Populate recipe details
            document.getElementById('parsed-recipe-name').textContent = recipe.name || 'Untitled Recipe';
            document.getElementById('parsed-recipe-source').textContent = recipe.source || 'Unknown Source';
            document.getElementById('parsed-recipe-description').textContent = recipe.description || 'No description available';
            document.getElementById('parsed-recipe-prep-time').textContent = recipe.prep_time || 'N/A';
            document.getElementById('parsed-recipe-cook-time').textContent = recipe.cook_time || 'N/A';
            document.getElementById('parsed-recipe-total-time').textContent = recipe.total_time || 'N/A';
            document.getElementById('parsed-recipe-servings').textContent = recipe.servings || 'N/A';

            // Populate ingredients
            const ingredientsContainer = document.getElementById('parsed-recipe-ingredients');
            const ingredientsCount = document.getElementById('parsed-ingredients-count');
            ingredientsContainer.innerHTML = '';
            
            if (recipe.ingredients && recipe.ingredients.length > 0) {
                ingredientsCount.textContent = recipe.ingredients.length;
                recipe.ingredients.forEach((ingredient, index) => {
                    const div = document.createElement('div');
                    div.className = 'text-sm text-gray-800 mb-1';
                    div.textContent = `${index + 1}. ${ingredient}`;
                    ingredientsContainer.appendChild(div);
                });
            } else {
                ingredientsCount.textContent = '0';
                ingredientsContainer.innerHTML = '<div class="text-sm text-gray-500 italic">No ingredients found</div>';
            }

            // Populate instructions
            const instructionsContainer = document.getElementById('parsed-recipe-instructions');
            const instructionsCount = document.getElementById('parsed-instructions-count');
            instructionsContainer.innerHTML = '';
            
            if (recipe.instructions && recipe.instructions.length > 0) {
                instructionsCount.textContent = recipe.instructions.length;
                recipe.instructions.forEach((instruction, index) => {
                    const div = document.createElement('div');
                    div.className = 'text-sm text-gray-800 mb-2 pb-2 border-b border-gray-200 last:border-b-0';
                    div.textContent = `${index + 1}. ${instruction}`;
                    instructionsContainer.appendChild(div);
                });
            } else {
                instructionsCount.textContent = '0';
                instructionsContainer.innerHTML = '<div class="text-sm text-gray-500 italic">No instructions found</div>';
            }

            document.getElementById('recipe-url-results').classList.remove('hidden');
        }

        function showRecipeUrlError(message) {
            document.getElementById('recipe-url-error-message').textContent = message;
            document.getElementById('recipe-url-error').classList.remove('hidden');
        }

        function clearRecipeUrlResults() {
            document.getElementById('recipe-url-results').classList.add('hidden');
            document.getElementById('recipe-url-error').classList.add('hidden');
            document.getElementById('recipe-url-loading').classList.add('hidden');
            document.getElementById('recipe-url-input').value = '';
            currentParsedRecipe = null;
        }

        function importParsedRecipe() {
            if (!currentParsedRecipe) return;

            // Fill in the recipe form with parsed data
            fillRecipeForm(currentParsedRecipe);
            
            // Close the modal
            closeRecipeUrlImportModal();
            
            // Show success message
            alert('Recipe imported successfully! Review and edit the details as needed.');
            
            // Track the import activity
            trackRecipeDevelopment('Recipe Import', `Imported recipe from ${currentParsedRecipe.source}: ${currentParsedRecipe.name}`);
        }

        function editParsedRecipe() {
            if (!currentParsedRecipe) return;

            // Fill in the recipe form with parsed data
            fillRecipeForm(currentParsedRecipe);
            
            // Keep the modal open for editing
            alert('Recipe data has been pre-filled. You can edit it in the modal and then import when ready.');
        }

        function fillRecipeForm(recipe) {
            // Fill basic recipe information
            const recipeNameInput = document.getElementById('recipe-name');
            const headerRecipeNameInput = document.getElementById('header-recipe-name');
            const conceptInput = document.getElementById('recipe-concept');
            const initialIdeasTextarea = document.getElementById('initial-ideas');
            const notesTextarea = document.getElementById('recipe-notes');

            if (recipeNameInput) recipeNameInput.value = recipe.name || '';
            if (headerRecipeNameInput) headerRecipeNameInput.value = recipe.name || '';
            if (conceptInput) conceptInput.value = recipe.description ? recipe.description.substring(0, 100) + '...' : '';
            if (initialIdeasTextarea) initialIdeasTextarea.value = recipe.description || '';
            if (notesTextarea) {
                let notes = [];
                if (recipe.prep_time) notes.push(`Prep Time: ${recipe.prep_time}`);
                if (recipe.cook_time) notes.push(`Cook Time: ${recipe.cook_time}`);
                if (recipe.servings) notes.push(`Servings: ${recipe.servings}`);
                if (recipe.author) notes.push(`Original Author: ${recipe.author}`);
                if (recipe.source) notes.push(`Source: ${recipe.source}`);
                if (recipe.source_url) notes.push(`URL: ${recipe.source_url}`);
                
                notesTextarea.value = notes.join('\n') + '\n\nIngredients:\n' + 
                    (recipe.ingredients ? recipe.ingredients.map(ing => `‚Ä¢ ${ing}`).join('\n') : '') +
                    '\n\nInstructions:\n' + 
                    (recipe.instructions ? recipe.instructions.map((inst, i) => `${i + 1}. ${inst}`).join('\n') : '');
            }

            // Sync the recipe names
            syncRecipeName();
        }

        function saveRecentRecipeUrl(url, source) {
            try {
                let recentUrls = JSON.parse(localStorage.getItem('recentRecipeUrls') || '[]');
                
                // Remove if already exists
                recentUrls = recentUrls.filter(item => item.url !== url);
                
                // Add to beginning
                recentUrls.unshift({
                    url: url,
                    source: source,
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 5
                recentUrls = recentUrls.slice(0, 5);
                
                localStorage.setItem('recentRecipeUrls', JSON.stringify(recentUrls));
                loadRecentRecipeUrls();
            } catch (error) {
                console.error('Error saving recent URL:', error);
            }
        }

        function loadRecentRecipeUrls() {
            try {
                const recentUrls = JSON.parse(localStorage.getItem('recentRecipeUrls') || '[]');
                const container = document.getElementById('recent-recipe-urls');
                const section = document.getElementById('recent-recipe-urls-section');
                
                container.innerHTML = '';
                
                if (recentUrls.length > 0) {
                    section.classList.remove('hidden');
                    recentUrls.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded border';
                        div.innerHTML = `
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 truncate">${item.source}</div>
                                <div class="text-xs text-gray-500 truncate">${item.url}</div>
                            </div>
                            <div class="flex gap-2 ml-3">
                                <button onclick="useRecentRecipeUrl('${item.url}')" class="text-blue-600 hover:text-blue-700 text-sm">Use</button>
                                <button onclick="removeRecentRecipeUrl('${item.url}')" class="text-red-600 hover:text-red-700 text-sm">Remove</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    section.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading recent URLs:', error);
            }
        }

        function useRecentRecipeUrl(url) {
            document.getElementById('recipe-url-input').value = url;
            parseRecipeUrl();
        }

        function removeRecentRecipeUrl(url) {
            try {
                let recentUrls = JSON.parse(localStorage.getItem('recentRecipeUrls') || '[]');
                recentUrls = recentUrls.filter(item => item.url !== url);
                localStorage.setItem('recentRecipeUrls', JSON.stringify(recentUrls));
                loadRecentRecipeUrls();
            } catch (error) {
                console.error('Error removing recent URL:', error);
            }
        }

        // Add keyboard shortcut for Enter key in URL input
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('recipe-url-input');
            if (urlInput) {
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        parseRecipeUrl();
                    }
                });
            }
        });
    </script>
    <!-- Recipe URL Import Modal -->
    <div id="recipe-url-import-modal" class="modal-overlay hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="modal-header bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">üîó Import Recipe from URL</h3>
                        <p class="text-blue-100 text-sm mt-1">Automatically extract recipe details from cooking websites</p>
                    </div>
                    <button onclick="closeRecipeUrlImportModal()" class="text-white hover:text-blue-200 text-2xl font-bold">&times;</button>
                </div>
            </div>
            
            <div class="modal-body p-6">
                <!-- Supported Sites -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">üìç Supported Recipe Websites</h4>
                    <div class="flex flex-wrap gap-2">
                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">AllRecipes</span>
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">Food Network</span>
                        <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm">Bon App√©tit</span>
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">Serious Eats</span>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Epicurious</span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">Food.com</span>
                        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">Taste of Home</span>
                        <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">King Arthur Baking</span>
                        <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">+ Many More</span>
                    </div>
                </div>
                
                <!-- URL Input -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Recipe URL</label>
                    <div class="flex gap-3">
                        <input type="url" id="recipe-url-input" placeholder="https://www.allrecipes.com/recipe/..." 
                               class="flex-1 border-2 border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="parseRecipeUrl()" id="parse-recipe-btn" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                            Parse Recipe
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Paste any recipe URL above and we'll extract the ingredients, instructions, and details automatically</p>
                </div>
                
                <!-- Loading State -->
                <div id="recipe-url-loading" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="text-gray-600 mt-3">Parsing recipe from URL...</p>
                </div>
                
                <!-- Error State -->
                <div id="recipe-url-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="text-red-500 text-lg mr-3">‚ö†Ô∏è</div>
                        <div>
                            <h4 class="font-semibold text-red-800">Parsing Failed</h4>
                            <p id="recipe-url-error-message" class="text-red-700 text-sm mt-1"></p>
                            <p class="text-red-600 text-sm mt-2">Try a different URL or manually enter the recipe details.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Parsed Recipe Preview -->
                <div id="recipe-url-results" class="hidden">
                    <h4 class="font-semibold text-gray-800 mb-4">üìã Parsed Recipe Details</h4>
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <!-- Recipe Header -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Recipe Name</label>
                                <div id="parsed-recipe-name" class="text-lg font-bold text-gray-900"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Source</label>
                                <div id="parsed-recipe-source" class="text-sm text-blue-600"></div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                            <div id="parsed-recipe-description" class="text-gray-800 text-sm"></div>
                        </div>
                        
                        <!-- Recipe Metadata -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Prep Time</label>
                                <div id="parsed-recipe-prep-time" class="text-sm text-gray-800"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Cook Time</label>
                                <div id="parsed-recipe-cook-time" class="text-sm text-gray-800"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Total Time</label>
                                <div id="parsed-recipe-total-time" class="text-sm text-gray-800"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Servings</label>
                                <div id="parsed-recipe-servings" class="text-sm text-gray-800"></div>
                            </div>
                        </div>
                        
                        <!-- Ingredients -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ingredients (<span id="parsed-ingredients-count">0</span>)</label>
                            <div id="parsed-recipe-ingredients" class="max-h-32 overflow-y-auto bg-white border rounded p-3">
                                <!-- Ingredients will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Instructions -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Instructions (<span id="parsed-instructions-count">0</span>)</label>
                            <div id="parsed-recipe-instructions" class="max-h-32 overflow-y-auto bg-white border rounded p-3">
                                <!-- Instructions will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="importParsedRecipe()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200">
                            ‚úì Import Recipe
                        </button>
                        <button onclick="editParsedRecipe()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200">
                            ‚úèÔ∏è Edit Before Importing
                        </button>
                        <button onclick="clearRecipeUrlResults()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                            Clear
                        </button>
                    </div>
                </div>
                
                <!-- Recently Parsed URLs -->
                <div id="recent-recipe-urls-section" class="hidden mt-8">
                    <h4 class="font-semibold text-gray-800 mb-3">üïí Recently Parsed URLs</h4>
                    <div id="recent-recipe-urls" class="space-y-2">
                        <!-- Recent URLs will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <svg class="pea-bg-sketch" viewBox="0 0 120 180" fill="none" style="">
      <path d="M60 160 Q60 120 60 80" stroke="#7bb661" stroke-width="3" fill="none" stroke-linecap="round"/>
      <ellipse cx="60" cy="80" rx="22" ry="9" fill="#b6e388" stroke="#7bb661" stroke-width="2"/>
      <ellipse cx="52" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="60" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <ellipse cx="68" cy="80" rx="4" ry="4" fill="#eafcd7" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q40 110 50 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="48" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
      <path d="M60 120 Q80 110 70 90" stroke="#7bb661" stroke-width="2" fill="none" stroke-linecap="round"/>
      <ellipse cx="72" cy="100" rx="7" ry="3.5" fill="#b6e388" stroke="#7bb661" stroke-width="1"/>
    </svg>
</body>
</html> 